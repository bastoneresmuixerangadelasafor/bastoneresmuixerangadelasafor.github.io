<!-- Main Content Area -->
<main id="main-content" class="main-content">

    <!-- Home View -->
    <div id="view-home" class="view" data-view="home" style="display: none;">
        <div class="hero">
            <h1>Hola <span id="home-user-name"></span>!</h1>
            <div class="features-grid">
                <div class="feature-card" data-route="planning-event" style="cursor: pointer;">
                    <div class="feature-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"
                            width="64px" height="64px" aria-hidden="true" style="flex-shrink: 0;">
                            <rect x="44" y="10" width="12" height="80" rx="4" ry="4" fill="#8b5a2b"
                                stroke="#000" stroke-width="5" transform="rotate(45 50 50)" />
                            <rect x="44" y="10" width="12" height="80" rx="4" ry="4" fill="#a86830"
                                stroke="#000" stroke-width="5" transform="rotate(-45 50 50)" />
                        </svg></div>
                    <h3>Properes actuacions</h3>
                    <span id="next-event-text">Carregant...</span>
                </div>
                <div class="feature-card" data-route="planning-training" style="cursor: pointer;">
                    <div class="feature-icon">💪</div>
                    <h3>Assajos programats</h3>
                    <span id="next-training-text">Carregant...</span>
                </div>
            </div>
        </div>
    </div>
<div id="view-home-guest" class="view" data-view="home-guest">
        <div class="hero">
            <div class="hero-content">
                <h1>Benvingudes a {{ title }}</h1>
                <p class="subtitle">Inicia sessió per accedir a les teues dades personals a més de la informació
                    d'assajos i actuacions</p>

                <div class="hero-actions">
                    <a href="#" class="btn btn-outline" data-route="login">
                        <span class="mail-icon" aria-hidden="true">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                            </svg>
                        </span>
                        <span>Accedir amb compte</span>
                    </a>

                    <button type="button" class="btn btn-mail" id="mail-login-btn-guest"
                        aria-label="Enviar accés al correu">
                        <span class="mail-icon" aria-hidden="true">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                <polyline points="22,6 12,13 2,6"></polyline>
                            </svg>
                        </span>
                        <span>Enviar accés al correu</span>
                    </button>
                </div>

                <p class="redirect-message">Has estat redirigit aquí perquè no tens una sessió activa. Si us
                    plau, inicia sessió per accedir al tauler.</p>

                <p style="margin-top:6px;color:rgba(255,255,255,0.9);">No tens compte? <a href="#"
                        data-route="register" class="register-link">Registra't</a></p>
            </div>

            <div class="hero-illustration" aria-hidden="true">
                <svg width="480" height="320" viewBox="0 0 480 320" xmlns="http://www.w3.org/2000/svg"
                    role="img" aria-hidden="true">
                    <defs>
                        <linearGradient id="g1" x1="0" x2="1">
                            <stop offset="0" stop-color="#fff" stop-opacity="0.9" />
                            <stop offset="1" stop-color="#fff" stop-opacity="0.6" />
                        </linearGradient>
                    </defs>
                    <rect x="0" y="0" width="100%" height="100%" fill="none" />
                    <!-- Simple abstract illustration: staff and notes -->
                    <g transform="translate(40,40)">
                        <rect x="0" y="40" width="280" height="6" rx="3" fill="#ffffff" fill-opacity="0.12" />
                        <rect x="0" y="70" width="240" height="6" rx="3" fill="#ffffff" fill-opacity="0.08" />
                        <circle cx="60" cy="50" r="14" fill="#ffffff" fill-opacity="0.92" />
                        <circle cx="120" cy="50" r="10" fill="#ffffff" fill-opacity="0.85" />
                        <path d="M170 30 v40 a8 8 0 1 0 0-16 v-24" fill="#ffffff" fill-opacity="0.9" />
                    </g>
                </svg>
            </div>
        </div>

        <div class="container">
            <div class="features-grid" style="margin-top:30px">
                <div class="feature-card">
                    <div class="feature-icon">📅</div>
                    <h3>Planifica el teu temps</h3>
                    <p>Calendari i recordatoris d'assajos i actuacions.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">👥</div>
                    <h3>Accés familiar</h3>
                    <p>Gestiona l'assistència dels membres de la teua familia.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">🔒</div>
                    <h3>Autenticació segura</h3>
                    <p>Inicia sessió amb el teu correu per accedir a la teua informació de forma
                        segura.</p>
                </div>
            </div>
        </div>
    </div>
<!-- Dashboard View (Auth Required) -->
    <div id="view-dashboard" class="view" data-view="dashboard" data-auth="required" style="display: none;">
        <div class="container">
            <div class="page-header">
                <h1>Tauler</h1>
                <p>Informació sobre <span class="user-display-name"></span></p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="stat-training-count">-</div>
                    <div class="stat-label">Assajos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-event-count">-</div>
                    <div class="stat-label">Actuacions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-dance-count">-</div>
                    <div class="stat-label">Balls</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-position-count">-</div>
                    <div class="stat-label">Posicions diferents</div>
                </div>
            </div>

            <div class="card">
                <h2>Activitat recent</h2>
                <div id="activity-list" class="activity-list">
                    <p class="loading">Carregant activitat...</p>
                </div>
            </div>
        </div>
    </div>
<!-- Profile View (Auth Required) -->
    <div id="view-profile" class="view" data-view="profile" data-auth="required" style="display: none;">
        <div class="container">
            <div class="page-header">
                <h1>Perfil</h1>
            </div>

            <div class="card profile-card">
                <div class="profile-header">
                    <img id="profile-avatar" class="profile-avatar" src="" alt="Perfil">
                    <div class="profile-info">
                        <h2 id="profile-name"></h2>
                        <p id="profile-email" class="text-muted"></p>
                        <p id="profile-member-type" class="member-type-badge"></p>
                    </div>
                </div>

                <!-- Related Members Section -->
                <div id="related-members-section" class="related-members-section" style="display: none;">
                    <div id="related-members-list" class="related-members-list">
                        <!-- Each related member will use profile-header structure -->
                    </div>
                </div>
            </div>
        </div>
    </div>
<!-- Login Dialog Modal -->
    <dialog id="view-login" class="login-dialog">
        <div class="login-card">
            <button type="button" class="login-close-btn" id="login-close-btn" aria-label="Tancar">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <div class="login-header">
                <h1>Benvingut/da de nou</h1>
            </div>
            <div class="login-body">
                <form id="login-form" class="login-form">
                    <div class="form-group">
                        <label for="login-email">Correu electrònic</label>
                        <input type="email" id="login-email" name="email"
                            placeholder="Introdueix el teu correu electrònic" autocomplete="email" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Contrasenya</label>
                        <input type="password" id="login-password" name="password"
                            placeholder="Introdueix la teua contrasenya" autocomplete="current-password" required>
                    </div>
                    <div class="form-group form-actions-login">
                        <a href="#" id="forgot-password-link" class="forgot-password-link">Has oblidat la
                            contrasenya?</a>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block" id="email-login-btn">Iniciar
                        sessió</button>

                    <div class="divider"><span>o</span></div>

                    <button type="button" class="btn btn-mail btn-block" id="mail-login-btn"
                        aria-label="Enviar accés al correu">
                        <span class="mail-icon" aria-hidden="true">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                <polyline points="22,6 12,13 2,6"></polyline>
                            </svg>
                        </span>
                        <span>Enviar accés al correu</span>
                    </button>
                </form>
                <p class="login-info">
                    No tens un compte? <a href="#" id="signup-link" class="signup-link">Registra't</a>
                </p>
            </div>
        </div>
    </dialog>
<!-- Register Dialog Modal -->
    <dialog id="view-register" class="register-dialog">
        <div class="login-card">
            <button type="button" class="login-close-btn" id="register-close-btn" aria-label="Tancar">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <div class="login-header">
                <h1>Registre</h1>
            </div>
            <div class="login-body">
                <form id="register-form" class="login-form">
                    <div class="form-group">
                        <label for="register-name">Nom en la colla</label>
                        <input type="text" id="register-name" name="name"
                            placeholder="Introdueix el teu nom en la colla" autocomplete="name" required>
                    </div>
                    <div class="form-group">
                        <label for="register-email">Email</label>
                        <input type="email" id="register-email" name="email"
                            placeholder="Introdueix el teu correu electrònic" autocomplete="email" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block"
                        id="register-btn">Registrar-se</button>
                </form>
                <p class="login-info">
                    Ja tens un compte? <a href="#" id="login-link" class="login-link">Inicia sessió</a>
                </p>
            </div>
        </div>
    </dialog>
<!-- Planning View -->
    <div id="view-planning-event" class="view" data-view="planning-event" style="display: none;">
        <div class="container">
            <div class="page-header d-flex justify-content-between align-items-start admin-only">
                <div>
                    <h1>Planificació</h1>
                    <p class="lead">Gestiona i planifica les teues actuacions aquí.</p>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-primary" data-route="edit-event">Nova actuació</button>
                </div>
            </div>

            <!-- Events List Section -->
            <div class="planning-event-section">
                <div class="section-header">
                    <h2>Actuacions</h2>
                    <button type="button" class="btn-refresh" id="refresh-event-btn" style="display: none;"
                        title="Actualitzar llista">
                        <svg class="refresh-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8" />
                            <path d="M21 3v5h-5" />
                        </svg>
                    </button>
                </div>

                <!-- Upcoming/Current Events -->
                <div id="planning-event-list" class="planning-event-list">
                    <div class="events-loading">
                        <div class="spinner"></div>
                        <span>Carregant actuacions...</span>
                    </div>
                </div>

                <!-- Past Events Collapsible -->
                <div class="past-event-collapsible">
                    <button type="button" class="collapsible-toggle" id="past-event-toggle"
                        style="display: none;">
                        <span class="toggle-icon">▶</span>
                        <span class="toggle-text">Actuacions passades</span>
                        <span class="past-event-count" id="past-event-count"></span>
                    </button>
                    <div class="collapsible-content" id="past-event-list" style="display: none;">
                        <!-- Past events will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
<!-- Training Planning View -->
    <div id="view-planning-training" class="view" data-view="planning-training" style="display: none;">
        <div class="container">
            <div class="page-header d-flex justify-content-between align-items-start admin-only">
                <div>
                    <h1>Planificació d'assajos</h1>
                    <p class="lead">Gestiona i planifica els teus assajos aquí.</p>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-primary" data-route="edit-training">Nou assaig</button>
                </div>
            </div>

            <!-- Trainings List Section -->
            <div class="planning-training-section">
                <div class="section-header">
                    <h2>Assajos</h2>
                    <button type="button" class="btn-refresh" id="refresh-training-btn" style="display: none;"
                        title="Actualitzar llista">
                        <svg class="refresh-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8" />
                            <path d="M21 3v5h-5" />
                        </svg>
                    </button>
                </div>

                <!-- Upcoming/Current Trainings -->
                <div id="planning-training-list" class="planning-training-list">
                    <div class="trainings-loading">
                        <div class="spinner"></div>
                        <span>Carregant assajos...</span>
                    </div>
                </div>

                <!-- Past Trainings Collapsible -->
                <div class="past-training-collapsible">
                    <button type="button" class="collapsible-toggle" id="past-training-toggle"
                        style="display: none;">
                        <span class="toggle-icon">▶</span>
                        <span class="toggle-text">Assajos passats</span>
                        <span class="past-training-count" id="past-training-count"></span>
                    </button>
                    <div class="collapsible-content" id="past-training-list" style="display: none;">
                        <!-- Past trainings will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-training" class="view" data-view="edit-training" style="display: none;">
        <div class="container">
            <div class="page-header">
                <h1>Nou assaig</h1>
            </div>
            <div class="training-fields-column">
                <div class="training-field">
                    <label for="training-datetime-input">Data <span class="required">*</span></label>
                    <input type="datetime-local" id="training-datetime-input" required>
                    <span id="training-datetime-label" class="training-field-label" style="display: none;"></span>
                </div>
                <div class="training-field">
                    <label for="training-description-input">Descripció</label>
                    <textarea id="training-description-input" placeholder="Introdueix la descripció de l'assaig..." rows="8"></textarea>
                    <span id="training-description-label" class="training-field-label" style="display: none;"></span>
                </div>
            </div>
            <!-- Detected dances section -->
            <div class="training-detected-dances" id="training-detected-dances-section" style="display: none;">
                <div class="training-detected-dances-header">
                    <h3>Balls assajats</h3>
                </div>
                <div id="training-detected-dances" class="training-detected-dances-chips">
                </div>
            </div>
            <!-- Floating save button (admin only) -->
            <button id="floating-save-training-btn" class="floating-save-btn" title="Desar assaig" disabled style="display: none;">
                <svg class="save-icon" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
            </button>
        </div>
    </div>

    <!-- Dance Audio Dialog -->
    <dialog id="dance-audio-dialog" class="dance-audio-dialog">
        <div class="dance-audio-card">
            <button type="button" class="dance-audio-close-btn" id="dance-audio-close-btn" aria-label="Tancar">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <div class="dance-audio-header">
                <h2 id="dance-audio-title"></h2>
            </div>
            <div class="dance-audio-body">
                <div id="dance-audio-list" class="dance-audio-list">
                </div>
            </div>
        </div>
    </dialog>
<div id="view-events" class="view" data-view="edit-event" style="display: none;">
        <div class="container">
            <div class="page-header">
                <!-- Admin view: editable inputs -->
                <div class="event-fields-row admin-only">
                    <div class="event-field">
                        <label for="event-name-input">Nom de l'actuació <span class="required">*</span></label>
                        <input type="text" id="event-name-input"
                            placeholder="Introdueix el nom de l'actuació..." required>
                        <span id="event-name-label" class="event-field-label" style="display: none;"></span>
                    </div>
                    <div class="event-field">
                        <label for="event-datetime-input">Data <span class="required">*</span></label>
                        <input type="datetime-local" id="event-datetime-input" required>
                        <span id="event-datetime-label" class="event-field-label" style="display: none;"></span>
                    </div>
                    <div class="event-field">
                        <label for="event-meeting-place-input">Lloc de trobada</label>
                        <input type="text" id="event-meeting-place-input"
                            placeholder="Introdueix el lloc de trobada...">
                        <span id="event-meeting-place-label" class="event-field-label" style="display: none;"></span>
                    </div>
                </div>
                <!-- Non-admin view: plain text -->
                <div class="event-info-row non-admin-only">
                    <h2 id="event-name-display" class="event-name-display"></h2>
                    <span id="event-date-display" class="event-date-display"></span>
                    <span id="event-meeting-place-display" class="event-meeting-place-display"></span>
                </div>
                <div class="dance-selector-row admin-only" id="dance-selector-section" style="display: none;">
                    <div id="dance-chips" class="dance-chips admin-only">
                        <span class="dance-chips-loading">Carregant balls...</span>
                    </div>
                </div>
            </div>
            <div id="diagrams-list" class="diagrams-list">
                <!-- Diagrams will be added here dynamically -->
            </div>
            <!-- Dialog for person selection -->
            <dialog id="person-dialog" class="admin-only">
                <form method="dialog" id="person-form" style="margin:0;">
                    <div id="position-info" class="position-info"></div>
                    <h3 style="margin-top:0; text-align:center;">Selecciona un nom</h3>
                    <div id="person-loading" style="display:none; text-align:center; padding:1em 0;">
                        <div class="dialog-spinner"></div>
                        <p style="margin:0.5em 0 0 0; color:#666;">Carregant membres...</p>
                    </div>
                    <div class="person-combo-wrapper">
                        <input id="person-combo" placeholder="Cerca o selecciona..."
                            style="width:100%; padding:0.4em; border-radius:6px; border:1px solid #ccc; font-size:1em;"
                            autocomplete="off">
                        <ul id="person-list" class="person-dropdown"></ul>
                    </div>
                    <button type="button" id="clear-person-btn" class="clear-person-btn" style="display:none;">âœ•
                        Esborrar selecció</button>
                </form>
            </dialog>
            <!-- Floating save button -->
            <button id="floating-save-btn" class="floating-save-btn" title="Desar actuació" disabled>
                <svg class="save-icon" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
            </button>
            <!-- Floating lock button (for past events) -->
            <button id="floating-lock-btn" class="floating-lock-btn" title="Long-press per 3 segons per fer editable">
                <svg class="progress-ring-container" width="48" height="48" viewBox="0 0 48 48" style="position: absolute; top: 0; left: 0;">
                    <circle class="progress-ring" cx="24" cy="24" r="22" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-dasharray="138.23" stroke-dashoffset="138.23"></circle>
                </svg>
                <svg class="lock-icon" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
            </button>
            <!-- Floating share button -->
            <button id="floating-share-btn" class="floating-share-btn" title="Compartir com a imatge">
                <svg class="share-icon" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="18" cy="5" r="3"></circle>
                    <circle cx="6" cy="12" r="3"></circle>
                    <circle cx="18" cy="19" r="3"></circle>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                </svg>
            </button>
        </div>
    </div>


<script>
        // State for all diagrams: array of { id, danceName, groups }
        let diagrams = [];
        let diagramIdCounter = 0;
        // Track if diagram has unsaved changes
        var diagramsIsDirty = false;
        // Dances data loaded from server
        var dancesData = [];
        // Track if current event is editable
        var isEventEditable = true;
        // Track if user manually unlocked the event via long-press
        var isEventManuallyUnlocked = false;

        // Check if the event is in the past
        function checkIfEventIsEditable() {
            // If manually unlocked via long-press, always consider editable
            if (isEventManuallyUnlocked) {
                return true;
            }

            const eventDatetimeInput = document.getElementById('event-datetime-input');
            if (!eventDatetimeInput || !eventDatetimeInput.value) {
                return true; // Assume editable if no date set
            }
            const eventDate = new Date(eventDatetimeInput.value);
            const now = new Date();
            isEventEditable = eventDate >= now;
            return isEventEditable;
        }

        // Apply or remove read-only state to event
        function applyEditableState() {
            const isEditable = checkIfEventIsEditable();
            const eventNameInput = document.getElementById('event-name-input');
            const eventDatetimeInput = document.getElementById('event-datetime-input');
            const eventMeetingPlaceInput = document.getElementById('event-meeting-place-input');
            const eventNameLabel = document.getElementById('event-name-label');
            const eventDatetimeLabel = document.getElementById('event-datetime-label');
            const eventMeetingPlaceLabel = document.getElementById('event-meeting-place-label');
            const danceSelectorSection = document.getElementById('dance-selector-section');
            const floatingSaveBtn = document.getElementById('floating-save-btn');
            const floatingLockBtn = document.getElementById('floating-lock-btn');

            if (isEditable) {
                // Show inputs, hide labels
                if (eventNameInput) {
                    eventNameInput.disabled = false;
                    eventNameInput.style.display = 'block';
                }
                if (eventDatetimeInput) {
                    eventDatetimeInput.disabled = false;
                    eventDatetimeInput.style.display = 'block';
                }
                if (eventMeetingPlaceInput) {
                    eventMeetingPlaceInput.disabled = false;
                    eventMeetingPlaceInput.style.display = 'block';
                }
                if (eventNameLabel) eventNameLabel.style.display = 'none';
                if (eventDatetimeLabel) eventDatetimeLabel.style.display = 'none';
                if (eventMeetingPlaceLabel) eventMeetingPlaceLabel.style.display = 'none';
            } else {
                // Update label values and show labels, hide inputs
                if (eventNameInput && eventNameLabel) {
                    eventNameLabel.textContent = eventNameInput.value || '';
                    eventNameInput.style.display = 'none';
                    eventNameLabel.style.display = 'block';
                }
                if (eventDatetimeInput && eventDatetimeLabel) {
                    const datetimeValue = eventDatetimeInput.value;
                    let formattedDatetime = datetimeValue;
                    if (datetimeValue) {
                        // Parse the datetime-local format (YYYY-MM-DDTHH:mm)
                        const date = new Date(datetimeValue + ':00');
                        const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                        formattedDatetime = date.toLocaleDateString('ca-ES', options);
                    }
                    eventDatetimeLabel.textContent = formattedDatetime;
                    eventDatetimeInput.style.display = 'none';
                    eventDatetimeLabel.style.display = 'block';
                }
                if (eventMeetingPlaceInput && eventMeetingPlaceLabel) {
                    eventMeetingPlaceLabel.textContent = eventMeetingPlaceInput.value || '';
                    eventMeetingPlaceInput.style.display = 'none';
                    eventMeetingPlaceLabel.style.display = 'block';
                }
            }

            // Show/hide dance selector
            if (danceSelectorSection) {
                if (!isEditable) {
                    danceSelectorSection.style.display = 'none';
                }
                danceSelectorSection.style.pointerEvents = isEditable ? 'auto' : 'none';
            }

            // Hide floating save button when not editable
            if (floatingSaveBtn) {
                floatingSaveBtn.style.display = isEditable ? 'flex' : 'none';
            }

            // Show floating lock button only when not editable
            if (floatingLockBtn) {
                floatingLockBtn.style.display = isEditable ? 'none' : 'flex';
            }

            // Disable canvas interactions and dance operations
            updateDiagramsEditableState(isEditable);
        }

        // Disable/enable diagram interactions based on editability
        function updateDiagramsEditableState(isEditable) {
            const diagramsList = document.getElementById('diagrams-list');
            if (!diagramsList) return;

            // Disable dragging
            const diagramItems = diagramsList.querySelectorAll('.diagram-item');
            diagramItems.forEach(function (item) {
                item.style.pointerEvents = isEditable ? 'auto' : 'none';
                item.draggable = isEditable;
                item.style.cursor = isEditable ? 'grab' : 'default';
            });

            // Disable all action buttons (including main-btn variants)
            const actionButtons = diagramsList.querySelectorAll('.add-group-btn, .remove-diagram-btn, .edit-description-btn, .add-description-link, .main-btn');
            actionButtons.forEach(function (btn) {
                btn.disabled = !isEditable;
                btn.style.cursor = isEditable ? 'pointer' : 'not-allowed';
                btn.style.pointerEvents = isEditable ? 'auto' : 'none';
            });

            // Hide diagram header actions when not editable
            const diagramHeaderActions = diagramsList.querySelectorAll('.diagram-header-actions');
            diagramHeaderActions.forEach(function (headerActions) {
                headerActions.style.display = isEditable ? 'flex' : 'none';
            });

            // Hide edit-description-btn when not editable
            const editDescriptionBtns = diagramsList.querySelectorAll('.edit-description-btn');
            editDescriptionBtns.forEach(function (btn) {
                btn.style.display = isEditable ? 'block' : 'none';
            });

            // Hide add-description-link when not editable
            const addDescriptionLinks = diagramsList.querySelectorAll('.add-description-link');
            addDescriptionLinks.forEach(function (link) {
                link.style.display = isEditable ? 'block' : 'none';
            });

            // Disable canvas click handlers
            const canvases = diagramsList.querySelectorAll('canvas');
            canvases.forEach(function (canvas) {
                canvas.style.cursor = isEditable ? 'pointer' : 'default';
                canvas.style.pointerEvents = isEditable ? 'auto' : 'none';
            });
        }

        // Update save button enabled/disabled state based on dirty flag
        function updateSaveButtonState() {
            const btn = document.getElementById('floating-save-btn');
            if (btn) {
                btn.disabled = !diagramsIsDirty || !isEventEditable;
            }
        }

        // Set dirty flag and update button state
        function setDiagramsDirty(isDirty) {
            diagramsIsDirty = isDirty;
            updateSaveButtonState();
        }

        // Calculate diagram dimensions that scale based on group count
        function calcDiagramLayout(canvas, groupCount, rows, cols) {
            // Base dimensions for 1-2 groups
            const baseSquareWidth = 180;
            const baseSquareHeight = 90;
            const baseSquareSpacingX = 24;
            const baseSquareSpacingY = 24;
            const baseSpacing = 120;
            const baseOffsetY = 40;
            const minPadding = 40; // minimum padding on left/right

            // Calculate what the total width would be at base size
            const baseGridWidth = baseSquareWidth * cols + baseSquareSpacingX * (cols - 1);
            const baseTotalWidth = groupCount * baseGridWidth + (groupCount - 1) * baseSpacing;
            const availableWidth = canvas.width - (minPadding * 2);

            // Calculate scale factor to fit all groups
            let scale = 1;
            if (baseTotalWidth > availableWidth) {
                scale = availableWidth / baseTotalWidth;
            }

            // Apply scale to all dimensions
            const squareWidth = baseSquareWidth * scale;
            const squareHeight = baseSquareHeight * scale;
            const squareSpacingX = baseSquareSpacingX * scale;
            const squareSpacingY = baseSquareSpacingY * scale;
            const spacing = baseSpacing * scale;
            const offsetY = baseOffsetY;

            const gridWidth = squareWidth * cols + squareSpacingX * (cols - 1);
            const gridHeight = squareHeight * rows + squareSpacingY * (rows - 1);
            const totalWidth = groupCount * gridWidth + (groupCount - 1) * spacing;
            const offsetX0 = (canvas.width - totalWidth) / 2;

            // Calculate required canvas height
            const placaHeight = Math.max(25, 40 * scale);
            const placaY = offsetY + gridHeight + 60 * scale;
            const requiredHeight = placaY + placaHeight + 15; // 15px padding below PLAÇA

            return {
                squareWidth,
                squareHeight,
                squareSpacingX,
                squareSpacingY,
                spacing,
                gridWidth,
                gridHeight,
                totalWidth,
                offsetX0,
                offsetY,
                scale,
                requiredHeight
            };
        }

        // Draw a specific diagram
        function drawDiagram(diagram) {
            const canvas = document.getElementById('diagram-canvas-' + diagram.id);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const groups = diagram.groups;
            const rows = diagram.rows || 2;
            const cols = diagram.columns || 2;
            const positions = diagram.positions || [];
            const diagramColors = diagram.diagram || { backgroundColor: {}, textColor: {} };
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Layout: stack groups horizontally, centered vertically
            const groupCount = groups.length;

            // Calculate scaled layout based on group count
            const layout = calcDiagramLayout(canvas, groupCount, rows, cols);
            const { squareWidth, squareHeight, squareSpacingX, squareSpacingY, spacing, gridWidth, gridHeight, totalWidth, offsetX0, offsetY, scale, requiredHeight } = layout;

            // Resize canvas height if needed
            if (canvas.height !== Math.round(requiredHeight)) {
                canvas.height = Math.round(requiredHeight);
            }

            // Get background color for a cell from diagram.backgroundColor using position label
            // Grid layout: top-left is order 1, going left-to-right, top-to-bottom
            // Formula: order = row * cols + col + 1
            function getCellBackgroundColor(row, col) {
                const order = row * cols + col + 1;
                const pos = positions.find(function (p) { return p.order === order; });
                if (pos && pos.positionType.label && diagramColors.backgroundColor && diagramColors.backgroundColor[pos.positionType.label]) {
                    return diagramColors.backgroundColor[pos.positionType.label];
                }
                return '#808080'; // default gray
            }

            // Get text color for a cell from diagram.textColor using position label
            function getCellTextColor(row, col) {
                const order = row * cols + col + 1;
                const pos = positions.find(function (p) { return p.order === order; });
                if (pos && pos.positionType.label && diagramColors.textColor && diagramColors.textColor[pos.positionType.label]) {
                    return diagramColors.textColor[pos.positionType.label];
                }
                return '#FFFFFF'; // default white
            }

            for (let g = 0; g < groupCount; g++) {
                const group = groups[g];
                const offsetX = offsetX0 + g * (gridWidth + spacing);
                if (groupCount > 1) {
                    ctx.save();
                    const groupLabelFontSize = Math.max(12, Math.round(22 * scale));
                    ctx.font = 'bold ' + groupLabelFontSize + 'px sans-serif';
                    ctx.fillStyle = '#555';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'bottom';
                    const groupLetter = String.fromCharCode(65 + g);
                    const blockName = diagramColors.blockName || '';
                    const groupLabel = blockName ? blockName + ' ' + groupLetter : groupLetter;
                    ctx.fillText(groupLabel, offsetX + gridWidth / 2, offsetY - 10 * scale);
                    ctx.restore();
                }
                for (let row = 0; row < rows; row++) {
                    for (let col = 0; col < cols; col++) {
                        const i = row * cols + col;
                        const x = offsetX + col * (squareWidth + squareSpacingX);
                        const y = offsetY + row * (squareHeight + squareSpacingY);
                        ctx.fillStyle = getCellBackgroundColor(row, col);
                        ctx.fillRect(x, y, squareWidth, squareHeight);
                        ctx.strokeStyle = '#fff';
                        ctx.lineWidth = Math.max(2, 4 * scale);
                        ctx.strokeRect(x, y, squareWidth, squareHeight);

                        // Draw position tag in bottom right corner of each cell (admin only)
                        const userRoles = (AppState && AppState.currentUser && AppState.currentUser.roles) || [];
                        const isAdmin = userRoles.includes('ADMIN');
                        if (isAdmin) {
                            const cellOrder = row * cols + col + 1;
                            const cellPos = positions.find(function (p) { return p.order === cellOrder; });
                            const cellTag = cellPos && cellPos.tag ? cellPos.tag : '';
                            ctx.save();
                            const orderFontSize = Math.max(8, Math.round(12 * scale));
                            ctx.font = orderFontSize + 'px sans-serif';
                            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                            ctx.textAlign = 'right';
                            ctx.textBaseline = 'bottom';
                            ctx.fillText(cellTag, x + squareWidth - 4 * scale, y + squareHeight - 3 * scale);
                            ctx.restore();
                        }

                        if (group[i]) {
                            ctx.fillStyle = getCellTextColor(row, col);
                            const nameFontSize = Math.max(10, Math.round(20 * scale));
                            ctx.font = 'bold ' + nameFontSize + 'px sans-serif';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            const displayName =  group[i];
                            ctx.fillText(displayName, x + squareWidth / 2, y + squareHeight / 2);
                        }
                    }
                }
            }
            // Draw individual PLAÇA for each group
            const placaHeight = Math.max(25, 40 * scale);
            const placaY = offsetY + gridHeight + 60 * scale;
            const placaFontSize = Math.max(12, Math.round(20 * scale));

            for (let g = 0; g < groupCount; g++) {
                const placaX = offsetX0 + g * (gridWidth + spacing);
                const placaWidth = gridWidth;

                ctx.save();
                ctx.fillStyle = '#fff';
                ctx.strokeStyle = '#000';
                ctx.lineWidth = Math.max(1, 2 * scale);
                ctx.fillRect(placaX, placaY, placaWidth, placaHeight);
                ctx.strokeRect(placaX, placaY, placaWidth, placaHeight);
                ctx.fillStyle = '#000';
                ctx.font = 'bold ' + placaFontSize + 'px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('PLAÇA', placaX + placaWidth / 2, placaY + placaHeight / 2);
                ctx.restore();
            }
        }

        // Draw all diagrams
        function drawAllDiagrams() {
            diagrams.forEach(function (diagram) {
                drawDiagram(diagram);
            });
        }

        // Create HTML for a diagram item
        function createDiagramElement(diagram) {
            const div = document.createElement('div');
            div.className = 'diagram-item';
            div.id = 'diagram-item-' + diagram.id;
            div.draggable = true;
            div.dataset.diagramId = diagram.id;

            // Generate legend items from positions (unique labels only)
            const rows = diagram.rows || 2;
            const cols = diagram.columns || 2;
            const positions = diagram.positions || [];
            const diagramColors = diagram.diagram || { backgroundColor: {}, textColor: {} };
            const blockName = diagramColors.blockName || 'grup';
            let legendHtml = '';
            const seenLabels = new Set();
            positions.forEach(function (pos) {
                if (seenLabels.has(pos.positionType.label)) return;
                seenLabels.add(pos.positionType.label);
                const color = (diagramColors.backgroundColor && diagramColors.backgroundColor[pos.positionType.label]) || '#808080';
                legendHtml += `
<div class="diagram-legend-item">
    <span class="legend-color-box" style="background: ${color};"></span>
    <span>${pos.positionType.label}</span>
</div>`;
            });

            // Hide legend if only one item
            const showLegend = seenLabels.size > 1;
            const legendStyle = showLegend ? '' : 'display: none;';

            // Check if user is admin
            const userRoles = (AppState && AppState.currentUser && AppState.currentUser.roles) || [];
            const isAdmin = userRoles.includes('ADMIN');
            const adminOnlyStyle = isAdmin ? '' : 'display: none;';

            const description = diagram.description || '';
            const hasDescription = description.trim().length > 0;

            // Description HTML based on admin status
            let descriptionHtml = '';
            if (isAdmin) {
                if (hasDescription) {
                    descriptionHtml = `
    <div class="diagram-description-container">
    <span class="diagram-description-text" id="desc-text-${diagram.id}">${description}</span>
    <button type="button" class="edit-description-btn" data-id="${diagram.id}" title="Editar descripció">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
        </svg>
    </button>
    <input type="text" class="diagram-description-input" id="desc-input-${diagram.id}" value="${description}" style="display: none;" placeholder="Descripció...">
    </div>`;
                } else {
                    descriptionHtml = `
    <div class="diagram-description-container">
    <a href="#" class="add-description-link" data-id="${diagram.id}">+ Afegir descripció</a>
    <input type="text" class="diagram-description-input" id="desc-input-${diagram.id}" value="" style="display: none;" placeholder="Descripció...">
    </div>`;
                }
            } else {
                if (hasDescription) {
                    descriptionHtml = `<div class="diagram-description-container"><span class="diagram-description-text">${description}</span></div>`;
                }
            }

            div.innerHTML = `
<div class="diagram-header">
${descriptionHtml}
<div class="diagram-title-row">
    <h3 class="diagram-title">${diagram.danceName}</h3>
</div>
<div class="diagram-legend" style="${legendStyle}">
    ${legendHtml}
</div>
<div class="diagram-header-actions" style="${adminOnlyStyle}">
    <button class="main-btn add-group-btn" style="${adminOnlyStyle}" data-id="${diagram.id}">+ Afegir ${blockName}</button>
    <button class="remove-diagram-btn" style="${adminOnlyStyle}" data-id="${diagram.id}">Eliminar ball</button>
</div>
</div>
<div class="diagrams-canvas-container">
<div class="diagrams-canvas-wrapper">
    <canvas id="diagram-canvas-${diagram.id}" width="1200" height="350"></canvas>
</div>
</div>
`;
            return div;
        }
        // Handle canvas click
        document.addEventListener('DOMContentLoaded', function () {
            const dialog = document.getElementById('person-dialog');
            const personCombo = document.getElementById('person-combo');
            const personList = document.getElementById('person-list');
            const personLoading = document.getElementById('person-loading');
            const danceChips = document.getElementById('dance-chips');
            const clearPersonBtn = document.getElementById('clear-person-btn');
            const diagramsList = document.getElementById('diagrams-list');
            // Use window variables for selection state to share with javascript.html handlers
            window.selectedDiagramId = null;
            window.selectedGroup = null;
            window.selectedSquare = null;
            window.currentOptions = [];

            // Load dances from server and populate chips
            function loadDancesData() {
                API.getDances()
                    .then(function (dances) {
                        if (Array.isArray(dances) && dances.length > 0) {
                            dancesData = dances;
                            danceChips.innerHTML = '';
                            dances.forEach(function (dance) {
                                const chip = document.createElement('button');
                                chip.type = 'button';
                                chip.className = 'dance-chip';
                                chip.dataset.name = dance.name;
                                chip.textContent = dance.name;
                                chip.addEventListener('click', function () {
                                    addDanceFromChip(dance.name);
                                });
                                danceChips.appendChild(chip);
                            });
                        }
                    })
                    .catch(function (error) {
                        console.error('Error loading dances:', error);
                        danceChips.innerHTML = '<span class="dance-chips-loading">Error carregant balls</span>';
                    });
            }

            // Add new diagram from chip click
            function addDanceFromChip(danceName) {
                if (!danceName) return;

                const danceInfo = dancesData.find(d => d.name === danceName);
                const structure = danceInfo && danceInfo.structure ? danceInfo.structure : { rows: 2, columns: 2 };
                const rows = structure ? structure.rows : 2;
                const cols = structure ? structure.columns : 2;
                const positions = danceInfo ? danceInfo.positions : [];
                const diagramData = danceInfo ? danceInfo.diagram : { backgroundColor: {}, textColor: {} };
                const minGroups = danceInfo && danceInfo.minGroups ? danceInfo.minGroups : 1;
                const cellCount = rows * cols;

                // Create initial groups based on minGroups
                const initialGroups = [];
                for (let i = 0; i < minGroups; i++) {
                    initialGroups.push(Array(cellCount).fill(null));
                }

                const newDiagram = {
                    id: diagramIdCounter++,
                    danceName: danceName,
                    description: '',
                    rows: rows,
                    columns: cols,
                    positions: positions,
                    diagram: diagramData,
                    groups: initialGroups
                };
                diagrams.push(newDiagram);
                setDiagramsDirty(true);

                const element = createDiagramElement(newDiagram);
                diagramsList.appendChild(element);

                // Setup canvas click handler for the new diagram
                setupCanvasClickHandler(newDiagram.id);

                drawDiagram(newDiagram);

                // Scroll to the new diagram
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            // Setup canvas click handler for a diagram
            function setupCanvasClickHandler(diagramId) {
                const canvas = document.getElementById('diagram-canvas-' + diagramId);
                if (!canvas) return;

                canvas.addEventListener('click', function (e) {
                    const diagram = diagrams.find(d => d.id === diagramId);
                    if (!diagram) return;

                    const rect = canvas.getBoundingClientRect();
                    const groups = diagram.groups;
                    const rows = diagram.rows || 2;
                    const cols = diagram.columns || 2;
                    const groupCount = groups.length;

                    // Use the same layout calculation as drawing
                    const layout = calcDiagramLayout(canvas, groupCount, rows, cols);
                    const { squareWidth, squareHeight, squareSpacingX, squareSpacingY, spacing, gridWidth, offsetX0, offsetY } = layout;

                    const scaleX = canvas.width / rect.width;
                    const scaleY = canvas.height / rect.height;
                    const clickX = (e.clientX - rect.left) * scaleX;
                    const clickY = (e.clientY - rect.top) * scaleY;

                    for (let g = 0; g < groupCount; g++) {
                        const offsetX = offsetX0 + g * (gridWidth + spacing);
                        const groupAreaWidth = squareWidth * cols + squareSpacingX * (cols - 1);
                        const groupAreaHeight = squareHeight * rows + squareSpacingY * (rows - 1);
                        if (
                            clickX >= offsetX && clickX <= offsetX + groupAreaWidth &&
                            clickY >= offsetY && clickY <= offsetY + groupAreaHeight
                        ) {
                            const x = clickX - offsetX;
                            const y = clickY - offsetY;
                            const col = Math.floor(x / (squareWidth + squareSpacingX));
                            const row = Math.floor(y / (squareHeight + squareSpacingY));
                            if (col >= cols || row >= rows) return;
                            const idx = row * cols + col;
                            window.selectedDiagramId = diagramId;
                            window.selectedGroup = g;
                            window.selectedSquare = idx;

                            if (!membersData || membersData.length === 0) {
                                setDialogLoading(true);
                                dialog.showModal();
                                const checkInterval = setInterval(function () {
                                    if (membersData && membersData.length > 0) {
                                        clearInterval(checkInterval);
                                        setDialogLoading(false);
                                        populatePersonList(diagramId, g, idx);
                                    }
                                }, 200);
                                return;
                            }

                            setDialogLoading(false);
                            populatePersonList(diagramId, g, idx);
                            return;
                        }
                    }
                });
            }

            // Load dances data on initialization
            loadDancesData();

            // Event name and datetime validation - show dance selection when both filled
            const eventNameInput = document.getElementById('event-name-input');
            const eventDatetimeInput = document.getElementById('event-datetime-input');
            const eventMeetingPlaceInput = document.getElementById('event-meeting-place-input');
            const danceSelectorSection = document.getElementById('dance-selector-section');

            function checkEventFieldsAndShowDances() {
                const nameValid = eventNameInput.value.trim().length > 0;
                const dateValid = eventDatetimeInput.value.length > 0;
                if (nameValid && dateValid) {
                    danceSelectorSection.style.display = 'flex';
                } else {
                    danceSelectorSection.style.display = 'none';
                }
                // Check if event is in the past and update editability
                applyEditableState();
                // Mark event data as dirty when any event field changes
                setDiagramsDirty(true);
            }

            eventNameInput.addEventListener('input', checkEventFieldsAndShowDances);
            eventDatetimeInput.addEventListener('input', checkEventFieldsAndShowDances);
            if (eventMeetingPlaceInput) {
                eventMeetingPlaceInput.addEventListener('input', checkEventFieldsAndShowDances);
            }

            // Helper to show/hide loading state in dialog
            function setDialogLoading(isLoading) {
                personLoading.style.display = isLoading ? 'block' : 'none';
                personCombo.style.display = isLoading ? 'none' : 'block';
            }

            // Helper to populate the person list
            function populatePersonList(diagramId, g, squareIdx) {
                const diagram = diagrams.find(d => d.id === diagramId);
                if (!diagram) return;

                // Update position info in dialog
                const positionInfo = document.getElementById('position-info');
                const positions = diagram.positions || [];
                const order = squareIdx + 1;
                const pos = positions.find(function (p) { return p.order === order; });
                const groupLetter = String.fromCharCode(65 + g);
                const diagramColors = diagram.diagram || {};
                const blockName = diagramColors.blockName || 'Grup';

                // Show specifications if available
                if (pos && pos.specifications) {
                    positionInfo.textContent = pos.specifications;
                } else if (pos && pos.positionType.label) {
                    positionInfo.textContent = pos.positionType.label;
                } else {
                    positionInfo.textContent = blockName + ' ' + groupLetter;
                }

                const cellCount = (diagram.rows || 2) * (diagram.columns || 2);
                let usedIds = [];
                for (let gi = 0; gi < diagram.groups.length; gi++) {
                    for (let si = 0; si < cellCount; si++) {
                        if (gi === g && si === squareIdx) continue;
                        if (diagram.groups[gi][si]) usedIds.push(diagram.groups[gi][si]);
                    }
                }

                // Check if event is in the past - if so, include inactive members
                let isEventInPast = false;
                const eventDateValue = eventDatetimeInput.value;
                if (eventDateValue) {
                    const eventDate = new Date(eventDateValue);
                    const now = new Date();
                    isEventInPast = eventDate < now;
                }

                // Filter members: only active for future events, all for past events
                const personAliases = membersData
                    .filter(m => isEventInPast || m.active)
                    .map(m => m.alias)
                    .filter(Boolean);
                window.currentOptions = personAliases.filter(id => !usedIds.includes(id) || diagram.groups[g][squareIdx] === id);
                personList.innerHTML = '';

                if (window.currentOptions.length === 0) {
                    personCombo.style.display = 'none';
                    personLoading.style.display = 'block';
                    personLoading.querySelector('.dialog-spinner').style.display = 'none';
                    personLoading.querySelector('p').textContent = 'No hi ha membres disponibles';
                } else {
                    personCombo.style.display = 'block';
                    personLoading.style.display = 'none';
                    personLoading.querySelector('.dialog-spinner').style.display = 'block';
                    personLoading.querySelector('p').textContent = 'Carregant membres...';
                    personCombo.placeholder = 'Cerca o selecciona...';
                    personCombo.disabled = false;
                    // Populate dropdown with all options initially
                    updateDropdownOptions(window.currentOptions);
                }

                personCombo.value = diagram.groups[g][squareIdx] || '';
                clearPersonBtn.style.display = diagram.groups[g][squareIdx] ? 'block' : 'none';
                dialog.showModal();
                // Focus and show dropdown
                setTimeout(function () {
                    personCombo.focus();
                    personList.classList.add('open');
                }, 100);
            }

            // Handle clear button click
            clearPersonBtn.addEventListener('click', function () {
                if (window.selectedDiagramId !== null && window.selectedGroup !== null && window.selectedSquare !== null) {
                    const diagram = diagrams.find(d => d.id === window.selectedDiagramId);
                    if (diagram) {
                        diagram.groups[window.selectedGroup][window.selectedSquare] = null;
                        setDiagramsDirty(true);
                        drawDiagram(diagram);
                        personCombo.value = '';
                        clearPersonBtn.style.display = 'none';
                    }
                }
            });

            // Handle dialog form - auto-submit when a valid ID is selected
            // If openNextBlock is true, automatically open the dialog for the next empty block
            function handlePersonSelection(openNextBlock) {
                const id = personCombo.value.trim();
                if (window.selectedDiagramId !== null && window.selectedGroup !== null && window.selectedSquare !== null && id && window.currentOptions.includes(id)) {
                    const diagram = diagrams.find(d => d.id === window.selectedDiagramId);
                    if (diagram) {
                        diagram.groups[window.selectedGroup][window.selectedSquare] = id;
                        setDiagramsDirty(true);
                        drawDiagram(diagram);

                        // If openNextBlock is true, find and open the next empty block
                        if (openNextBlock) {
                            const cellCount = (diagram.rows || 2) * (diagram.columns || 2);
                            let nextEmptyIdx = -1;

                            // Search for the next empty block starting from current position + 1
                            for (let i = window.selectedSquare + 1; i < cellCount; i++) {
                                if (!diagram.groups[window.selectedGroup][i]) {
                                    nextEmptyIdx = i;
                                    break;
                                }
                            }

                            // If found an empty block, open dialog for it
                            if (nextEmptyIdx !== -1) {
                                window.selectedSquare = nextEmptyIdx;
                                populatePersonList(window.selectedDiagramId, window.selectedGroup, nextEmptyIdx);
                                return; // Don't close the dialog, it's already re-opened
                            }
                        }

                        dialog.close();
                    }
                }
            }

            personCombo.addEventListener('input', function () { handlePersonSelection(false); });
            personCombo.addEventListener('change', function () { handlePersonSelection(false); });

            // Helper function to normalize text by removing accents
            function normalizeText(text) {
                return text.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
            }

            // Track highlighted index for keyboard navigation
            let highlightedIndex = -1;

            function updateDropdownOptions(options) {
                personList.innerHTML = '';
                highlightedIndex = -1;
                options.forEach(function (id, index) {
                    const li = document.createElement('li');
                    li.textContent = id;
                    li.dataset.value = id;
                    li.addEventListener('click', function () {
                        personCombo.value = id;
                        personList.classList.remove('open');
                        handlePersonSelection(true);
                    });
                    personList.appendChild(li);
                });
            }

            // Filter dropdown options as user types (accent-insensitive)
            personCombo.addEventListener('input', function () {
                const typedValue = normalizeText(personCombo.value.trim());

                let filteredOptions;
                if (typedValue === '') {
                    filteredOptions = window.currentOptions;
                } else {
                    filteredOptions = window.currentOptions.filter(function (id) {
                        return normalizeText(id).includes(typedValue);
                    });
                }

                updateDropdownOptions(filteredOptions);
                personList.classList.add('open');
            });

            // Show dropdown on focus
            personCombo.addEventListener('focus', function () {
                const typedValue = normalizeText(personCombo.value.trim());
                let filteredOptions;
                if (typedValue === '') {
                    filteredOptions = window.currentOptions;
                } else {
                    filteredOptions = window.currentOptions.filter(function (id) {
                        return normalizeText(id).includes(typedValue);
                    });
                }
                updateDropdownOptions(filteredOptions);
                personList.classList.add('open');
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', function (e) {
                if (!personCombo.contains(e.target) && !personList.contains(e.target)) {
                    personList.classList.remove('open');
                }
            });

            // Handle Enter key and keyboard navigation
            personCombo.addEventListener('keydown', function (e) {
                const items = personList.querySelectorAll('li');

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    highlightedIndex = Math.min(highlightedIndex + 1, items.length - 1);
                    updateHighlight(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    highlightedIndex = Math.max(highlightedIndex - 1, 0);
                    updateHighlight(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (highlightedIndex >= 0 && items[highlightedIndex]) {
                        personCombo.value = items[highlightedIndex].dataset.value;
                        personList.classList.remove('open');
                        handlePersonSelection(true);
                    } else {
                        // Auto-select if only one match
                        const typedValue = normalizeText(personCombo.value.trim());
                        const matchingOptions = window.currentOptions.filter(name =>
                            normalizeText(name).includes(typedValue)
                        );
                        if (matchingOptions.length === 1) {
                            personCombo.value = matchingOptions[0];
                            personList.classList.remove('open');
                            handlePersonSelection(true);
                        }
                    }
                } else if (e.key === 'Escape') {
                    personList.classList.remove('open');
                }
            });

            function updateHighlight(items) {
                items.forEach(function (item, index) {
                    item.classList.toggle('highlighted', index === highlightedIndex);
                });
                // Scroll highlighted item into view
                if (items[highlightedIndex]) {
                    items[highlightedIndex].scrollIntoView({ block: 'nearest' });
                }
            }

            // Drag and drop functionality for reordering diagrams
            let draggedItem = null;

            diagramsList.addEventListener('dragstart', function (e) {
                const item = e.target.closest('.diagram-item');
                if (!item) return;
                draggedItem = item;
                item.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', item.dataset.diagramId);
            });

            diagramsList.addEventListener('dragend', function (e) {
                const item = e.target.closest('.diagram-item');
                if (item) {
                    item.classList.remove('dragging');
                }
                // Remove drag-over class from all items
                diagramsList.querySelectorAll('.diagram-item').forEach(function (el) {
                    el.classList.remove('drag-over');
                });
                draggedItem = null;
            });

            diagramsList.addEventListener('dragover', function (e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                const targetItem = e.target.closest('.diagram-item');
                if (targetItem && targetItem !== draggedItem) {
                    // Remove drag-over from all, add to current target
                    diagramsList.querySelectorAll('.diagram-item').forEach(function (el) {
                        el.classList.remove('drag-over');
                    });
                    targetItem.classList.add('drag-over');
                }
            });

            diagramsList.addEventListener('dragleave', function (e) {
                const targetItem = e.target.closest('.diagram-item');
                if (targetItem && !targetItem.contains(e.relatedTarget)) {
                    targetItem.classList.remove('drag-over');
                }
            });

            diagramsList.addEventListener('drop', function (e) {
                e.preventDefault();
                const targetItem = e.target.closest('.diagram-item');
                if (!targetItem || !draggedItem || targetItem === draggedItem) return;

                // Get positions in DOM
                const items = Array.from(diagramsList.querySelectorAll('.diagram-item'));
                const draggedIndex = items.indexOf(draggedItem);
                const targetIndex = items.indexOf(targetItem);

                // Reorder DOM
                if (draggedIndex < targetIndex) {
                    targetItem.after(draggedItem);
                } else {
                    targetItem.before(draggedItem);
                }

                // Reorder diagrams array to match DOM order
                const newItems = Array.from(diagramsList.querySelectorAll('.diagram-item'));
                const newDiagrams = [];
                newItems.forEach(function (el) {
                    const id = parseInt(el.dataset.diagramId);
                    const diagram = diagrams.find(d => d.id === id);
                    if (diagram) newDiagrams.push(diagram);
                });
                diagrams = newDiagrams;
                setDiagramsDirty(true);

                // Clean up
                targetItem.classList.remove('drag-over');
            });

            // Event delegation for add group and remove diagram buttons
            diagramsList.addEventListener('click', function (e) {
                // Add description link
                if (e.target.classList.contains('add-description-link')) {
                    e.preventDefault();
                    const diagramId = parseInt(e.target.dataset.id);
                    const input = document.getElementById('desc-input-' + diagramId);
                    if (input) {
                        e.target.style.display = 'none';
                        input.style.display = 'block';
                        input.focus();
                    }
                }
                // Edit description button
                if (e.target.closest('.edit-description-btn')) {
                    const btn = e.target.closest('.edit-description-btn');
                    const diagramId = parseInt(btn.dataset.id);
                    const input = document.getElementById('desc-input-' + diagramId);
                    const text = document.getElementById('desc-text-' + diagramId);
                    if (input && text) {
                        text.style.display = 'none';
                        btn.style.display = 'none';
                        input.style.display = 'block';
                        input.focus();
                    }
                }
                // Add group button
                if (e.target.classList.contains('add-group-btn')) {
                    const diagramId = parseInt(e.target.dataset.id);
                    const diagram = diagrams.find(d => d.id === diagramId);
                    if (diagram) {
                        const cellCount = (diagram.rows || 2) * (diagram.columns || 2);
                        diagram.groups.push(Array(cellCount).fill(null));
                        setDiagramsDirty(true);
                        drawDiagram(diagram);
                    }
                }
                // Remove diagram button
                if (e.target.classList.contains('remove-diagram-btn')) {
                    const diagramId = parseInt(e.target.dataset.id);
                    const diagram = diagrams.find(d => d.id === diagramId);
                    if (diagram && confirm('Segur que vols eliminar el ball "' + diagram.danceName + '"?')) {
                        diagrams = diagrams.filter(d => d.id !== diagramId);
                        const element = document.getElementById('diagram-item-' + diagramId);
                        if (element) element.remove();
                        setDiagramsDirty(true);
                    }
                }
            });

            // Handle description input blur and enter key
            diagramsList.addEventListener('blur', function (e) {
                if (e.target.classList.contains('diagram-description-input')) {
                    saveDescriptionFromInput(e.target);
                }
            }, true);

            diagramsList.addEventListener('keydown', function (e) {
                if (e.target.classList.contains('diagram-description-input') && e.key === 'Enter') {
                    e.preventDefault();
                    e.target.blur();
                }
                if (e.target.classList.contains('diagram-description-input') && e.key === 'Escape') {
                    e.preventDefault();
                    const diagramId = parseInt(e.target.id.replace('desc-input-', ''));
                    const diagram = diagrams.find(d => d.id === diagramId);
                    if (diagram) {
                        e.target.value = diagram.description || '';
                    }
                    e.target.blur();
                }
            });

            function saveDescriptionFromInput(input) {
                const diagramId = parseInt(input.id.replace('desc-input-', ''));
                const diagram = diagrams.find(d => d.id === diagramId);
                if (!diagram) return;

                const newDescription = input.value.trim();
                diagram.description = newDescription;
                setDiagramsDirty(true);

                // Re-render the diagram element to update the description UI
                const oldElement = document.getElementById('diagram-item-' + diagramId);
                if (oldElement) {
                    const newElement = createDiagramElement(diagram);
                    oldElement.replaceWith(newElement);
                    setupCanvasClickHandler(diagramId);
                    drawDiagram(diagram);
                }
            }

            // Close dialog when clicking outside or pressing Escape
            dialog.addEventListener('click', function (e) {
                if (e.target === dialog) {
                    dialog.close();
                }
            });

            // Floating save button functionality
            const floatingSaveBtn = document.getElementById('floating-save-btn');
            const saveIcon = floatingSaveBtn.querySelector('.save-icon');

            floatingSaveBtn.addEventListener('click', function () {
                // Validate required fields
                const eventName = eventNameInput.value.trim();
                const eventDatetime = eventDatetimeInput.value;
                const eventMeetingPlace = eventMeetingPlaceInput ? eventMeetingPlaceInput.value.trim() : '';

                if (!eventName) {
                    alert('Si us plau, introdueix el nom de l\'actuació.');
                    eventNameInput.focus();
                    return;
                }

                if (!eventDatetime) {
                    alert('Si us plau, introdueix la data de l\'actuació.');
                    eventDatetimeInput.focus();
                    return;
                }

                if (diagrams.length === 0) {
                    alert('Si us plau, afegeix almenys un ball.');
                    return;
                }

                // Prepare data for saving
                const eventData = {
                    name: eventName,
                    datetime: eventDatetime,
                    meetingPlace: eventMeetingPlace,
                    diagrams: diagrams.map(function (d) {
                        return {
                            danceName: d.danceName,
                            description: d.description || '',
                            rows: d.rows,
                            columns: d.columns,
                            positions: d.positions,
                            groups: d.groups
                        };
                    })
                };

                // Show saving state
                floatingSaveBtn.disabled = true;
                floatingSaveBtn.classList.add('saving');
                saveIcon.innerHTML = '<circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="32" stroke-dashoffset="32"><animate attributeName="stroke-dashoffset" values="32;0" dur="1s" repeatCount="indefinite"/></circle>';

                // Call server-side function to save
                API.saveEvent({ event: eventData })
                    .then(function (result) {
                        floatingSaveBtn.classList.remove('saving');
                        floatingSaveBtn.classList.add('success');
                        saveIcon.innerHTML = '<polyline points="20 6 9 17 4 12" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"></polyline>';
                        setDiagramsDirty(false);

                        // Update URL hash with event ID so refresh works
                        if (result && result.sheetName) {
                            window.location.hash = 'events/' + encodeURIComponent(result.sheetName);
                            localStorage.setItem('currentRoute', 'events/' + encodeURIComponent(result.sheetName));
                        }

                        setTimeout(function () {
                            floatingSaveBtn.disabled = false;
                            floatingSaveBtn.classList.remove('success');
                            saveIcon.innerHTML = '<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline>';
                        }, 2000);
                    })
                    .catch(function (error) {
                        console.error('Error saving event:', error);
                        floatingSaveBtn.classList.remove('saving');
                        floatingSaveBtn.classList.add('error');
                        saveIcon.innerHTML = '<line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"></line><line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"></line>';

                        setTimeout(function () {
                            floatingSaveBtn.disabled = false;
                            floatingSaveBtn.classList.remove('error');
                            saveIcon.innerHTML = '<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline>';
                        }, 3000);

                        alert('Error desant l\'actuació: ' + (error.message || error));
                    });
            });

            // Floating share button functionality
            const floatingShareBtn = document.getElementById('floating-share-btn');

            floatingShareBtn.addEventListener('click', async function () {
                if (diagrams.length === 0) {
                    alert('No hi ha cap ball per compartir.');
                    return;
                }

                floatingShareBtn.disabled = true;

                try {
                    // Get event name and date for the image header
                    const eventName = eventNameInput.value.trim() || document.getElementById('event-name-display').textContent || 'Actuació';
                    const eventDateValue = eventDatetimeInput.value;
                    let eventDateFormatted = '';
                    if (eventDateValue) {
                        const date = new Date(eventDateValue);
                        if (!isNaN(date.getTime())) {
                            eventDateFormatted = date.toLocaleDateString('ca-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                        }
                    }

                    // Create separate image for each diagram
                    const files = [];

                    diagrams.forEach(function (diagram, index) {
                        const canvas = document.getElementById('diagram-canvas-' + diagram.id);
                        if (!canvas) return;

                        // Calculate height for this individual image
                        const headerHeight = 80;
                        const padding = 30;
                        const descriptionHeight = diagram.description ? 30 : 0;
                        const titleHeight = 35;
                        const totalHeight = headerHeight + titleHeight + descriptionHeight + canvas.height + padding * 2;

                        // Create a canvas for this diagram
                        const imageCanvas = document.createElement('canvas');
                        const ctx = imageCanvas.getContext('2d');
                        imageCanvas.width = 1200;
                        imageCanvas.height = totalHeight;

                        // Fill background
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(0, 0, imageCanvas.width, imageCanvas.height);

                        // Draw header
                        ctx.fillStyle = '#1976d2';
                        ctx.fillRect(0, 0, imageCanvas.width, headerHeight);

                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 28px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(`${eventName} - ${eventDateFormatted}`, imageCanvas.width / 2, headerHeight / 2 - 12);

                        if (diagram.description) {
                            ctx.font = '20px sans-serif';
                            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                            ctx.fillText(diagram.description, imageCanvas.width / 2, headerHeight / 2 + 18);
                        }

                        let yOffset = headerHeight + padding;
                        // Draw dance name
                        ctx.fillStyle = '#333';
                        ctx.font = 'bold 22px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.fillText(diagram.danceName, imageCanvas.width / 2, yOffset + 18);
                        yOffset += 35;

                        // Draw the diagram canvas
                        ctx.drawImage(canvas, 0, yOffset);

                        // Convert to blob and create file
                        imageCanvas.toBlob(function (blob) {
                            const fileName = eventName + ' - ' + diagram.danceName + '.png';
                            const file = new File([blob], fileName, { type: 'image/png' });
                            files.push(file);
                        }, 'image/png');
                    });

                    // Wait for all files to be created
                    const maxWait = 5000;
                    const startTime = Date.now();
                    while (files.length < diagrams.length && Date.now() - startTime < maxWait) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }

                    // Share files using Web Share API, fall back to download
                    if (navigator.share && navigator.canShare && files.length > 0 && navigator.canShare({ files: files })) {
                        await navigator.share({
                            files: files,
                            title: eventName,
                            text: `${eventName}\n ${eventDateFormatted}`,
                        });
                        floatingShareBtn.classList.add('success');
                        setTimeout(function () {
                            floatingShareBtn.classList.remove('success');
                        }, 2000);
                    } else if (files.length > 0) {
                        // Fallback: download each image
                        files.forEach(function (file) {
                            const url = URL.createObjectURL(file);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = file.name;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                        });

                        floatingShareBtn.classList.add('success');
                        setTimeout(function () {
                            floatingShareBtn.classList.remove('success');
                        }, 2000);
                    }
                } catch (error) {
                    console.error('Error sharing event:', error);
                    alert('Error compartint l\'actuació: ' + (error.message || error));
                } finally {
                    floatingShareBtn.disabled = false;
                }
            });

            // Floating lock button long-press functionality
            const floatingLockBtn = document.getElementById('floating-lock-btn');
            let lockBtnPressTimer = null;
            let lockBtnPressed = false;

            function resetLockBtnProgress() {
                floatingLockBtn.classList.remove('pressing');
                const progressRing = floatingLockBtn.querySelector('.progress-ring');
                progressRing.style.strokeDashoffset = '138.23';
                lockBtnPressed = false;
            }

            floatingLockBtn.addEventListener('mousedown', function () {
                if (isEventEditable) return; // Only work when event is locked

                lockBtnPressed = true;
                floatingLockBtn.classList.add('pressing');
                let pressedTime = 0;
                const pressDuration = 3000; // 3 seconds
                const maxDashOffset = 138.23;
                const progressRing = floatingLockBtn.querySelector('.progress-ring');

                lockBtnPressTimer = setInterval(function () {
                    if (!lockBtnPressed) {
                        clearInterval(lockBtnPressTimer);
                        resetLockBtnProgress();
                        return;
                    }

                    pressedTime += 50;
                    const progress = Math.min(pressedTime / pressDuration, 1);
                    const dashOffset = maxDashOffset * (1 - progress);
                    progressRing.style.strokeDashoffset = dashOffset;

                    if (pressedTime >= pressDuration) {
                        clearInterval(lockBtnPressTimer);
                        floatingLockBtn.classList.remove('pressing');
                        
                        // Make event editable again
                        isEventManuallyUnlocked = true;
                        isEventEditable = true;
                        applyEditableState();
                        
                        // Show success feedback
                        floatingLockBtn.style.background = '#43a047';
                        setTimeout(function () {
                            floatingLockBtn.style.background = '#757575';
                            resetLockBtnProgress();
                        }, 1000);
                    }
                }, 50);
            });

            floatingLockBtn.addEventListener('mouseup', function () {
                if (lockBtnPressTimer) {
                    clearInterval(lockBtnPressTimer);
                    resetLockBtnProgress();
                }
            });

            floatingLockBtn.addEventListener('mouseleave', function () {
                if (lockBtnPressTimer) {
                    clearInterval(lockBtnPressTimer);
                    resetLockBtnProgress();
                }
            });

            // Touch events for mobile devices
            floatingLockBtn.addEventListener('touchstart', function () {
                if (isEventEditable) return; // Only work when event is locked

                lockBtnPressed = true;
                floatingLockBtn.classList.add('pressing');
                let pressedTime = 0;
                const pressDuration = 3000; // 3 seconds
                const maxDashOffset = 138.23;
                const progressRing = floatingLockBtn.querySelector('.progress-ring');

                lockBtnPressTimer = setInterval(function () {
                    if (!lockBtnPressed) {
                        clearInterval(lockBtnPressTimer);
                        resetLockBtnProgress();
                        return;
                    }

                    pressedTime += 50;
                    const progress = Math.min(pressedTime / pressDuration, 1);
                    const dashOffset = maxDashOffset * (1 - progress);
                    progressRing.style.strokeDashoffset = dashOffset;

                    if (pressedTime >= pressDuration) {
                        clearInterval(lockBtnPressTimer);
                        floatingLockBtn.classList.remove('pressing');
                        
                        // Make event editable again
                        isEventManuallyUnlocked = true;
                        isEventEditable = true;
                        applyEditableState();
                        
                        // Show success feedback
                        floatingLockBtn.style.background = '#43a047';
                        setTimeout(function () {
                            floatingLockBtn.style.background = '#757575';
                            resetLockBtnProgress();
                        }, 1000);
                    }
                }, 50);
            });

            floatingLockBtn.addEventListener('touchend', function () {
                if (lockBtnPressTimer) {
                    clearInterval(lockBtnPressTimer);
                    resetLockBtnProgress();
                }
            });

            floatingLockBtn.addEventListener('touchcancel', function () {
                if (lockBtnPressTimer) {
                    clearInterval(lockBtnPressTimer);
                    resetLockBtnProgress();
                }
            });
        });
    </script>

    <!-- Members View -->
    <div id="view-members" class="view" data-view="members" style="display: none;">
        <div class="container">
            <div class="page-header">
                <div class="page-title">
                    <h1>Llista de Membres</h1>
                    <button type="button" class="btn-refresh" id="refresh-members-btn"
                        title="Actualitzar llista">
                        <svg class="refresh-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8" />
                            <path d="M21 3v5h-5" />
                        </svg>
                    </button>
                </div>
                <div class="page-actions">
                    <button type="button" class="btn btn-secondary" id="edit-all-members-btn">
                        <span class="btn-icon">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </span>
                        <span class="btn-label">Editar</span>
                    </button>
                    <button type="button" class="btn btn-primary" id="add-member-btn">
                        <span class="btn-icon">+</span> <span class="btn-label">Afegir membre</span>
                    </button>
                </div>
            </div>

            <!-- Inline edit action bar (shown when editing) -->
            <div id="members-edit-actions" class="members-edit-actions" style="display: none;">
                <span class="edit-info">Editant membres...</span>
                <div class="edit-buttons">
                    <button type="button" class="btn btn-secondary" id="members-edit-discard">Descartar</button>
                    <button type="button" class="btn btn-primary" id="members-edit-apply">
                        <span class="btn-text">Aplicar canvis</span>
                        <span class="btn-loading" style="display: none;">
                            <span class="spinner-small"></span> Desant...
                        </span>
                    </button>
                </div>
            </div>

            <div class="card members-card">
                <div class="members-filter" id="members-filter" style="display: none;">
                    <input type="text" id="members-search" class="members-search-input"
                        placeholder="Cercar membres...">
                </div>
                <div id="members-filter-summary" class="members-filter-summary" style="display: none;">
                    <span id="filter-summary-text" class="filter-summary-text"></span>
                    <a href="#" id="clear-all-filters" class="clear-filters-link">Netejar filtres</a>
                </div>
                <div class="members-table-wrapper">
                    <table id="members-table" class="responsive-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="name">
                                    Nom <span class="sort-icon"></span>
                                    <span class="filter-icon" id="name-filter-toggle" title="Cercar per nom">
                                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round">
                                            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3">
                                            </polygon>
                                        </svg>
                                    </span>
                                </th>
                                <th class="sortable" data-sort="email">
                                    Email <span class="sort-icon"></span>
                                    <span class="filter-icon" id="email-filter-toggle" title="Cercar per email">
                                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round">
                                            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3">
                                            </polygon>
                                        </svg>
                                    </span>
                                </th>
                                <th class="sortable" data-sort="type" style="position: relative;">
                                    Tipus <span class="sort-icon"></span>
                                    <span class="filter-icon" id="type-filter-toggle" title="Filtrar per tipus">
                                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round">
                                            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3">
                                            </polygon>
                                        </svg>
                                    </span>
                                    <div id="type-filter-dropdown" class="type-filter-dropdown"
                                        style="display: none;">
                                        <div class="type-filter-option" data-value="">Tots</div>
                                        <div class="type-filter-option" data-value="ADULT">Adult</div>
                                        <div class="type-filter-option" data-value="KID">Xiquet/a</div>
                                    </div>
                                </th>
                                <th style="position: relative;">
                                    Rols
                                    <span class="filter-icon" id="rols-filter-toggle" title="Filtrar per rol">
                                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round">
                                            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3">
                                            </polygon>
                                        </svg>
                                    </span>
                                    <div id="rols-filter-dropdown" class="type-filter-dropdown"
                                        style="display: none;">
                                        <div class="type-filter-option" data-value="">Tots</div>
                                        <div class="type-filter-option" data-value="ADMIN">Amb ADMIN</div>
                                        <div class="type-filter-option" data-value="NO_ADMIN">Sense ADMIN</div>
                                    </div>
                                </th>
                                <th style="position: relative;">
                                    Accés a
                                    <span class="filter-icon" id="access-filter-toggle"
                                        title="Filtrar per accés">
                                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round">
                                            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3">
                                            </polygon>
                                        </svg>
                                    </span>
                                    <div id="access-filter-dropdown" class="type-filter-dropdown"
                                        style="display: none;">
                                        <div class="type-filter-option" data-value="">Tots</div>
                                        <div class="type-filter-option" data-value="HAS_ACCESS">Té accés a
                                            altres</div>
                                        <div class="type-filter-option" data-value="NO_ACCESS">No té accés a
                                            altres</div>
                                    </div>
                                </th>
                                <th class="active-column" style="display: none;">En actiu</th>
                                <th id="active-filter-header" style="width: 40px; position: relative;"
                                    title="Filtrar per actiu">
                                    <span class="filter-icon" id="active-filter-toggle"
                                        title="Filtrar per actiu">
                                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                            <circle cx="12" cy="12" r="3"></circle>
                                        </svg>
                                    </span>
                                    <div id="active-filter-dropdown" class="type-filter-dropdown"
                                        style="display: none; right: 0; left: auto;">
                                        <div class="type-filter-option" data-value="">Tots</div>
                                        <div class="type-filter-option" data-value="true">Actius</div>
                                        <div class="type-filter-option" data-value="false">Inactius</div>
                                    </div>
                                </th>
                                <th style="width: 40px; text-align: center; vertical-align: middle;"
                                    title="Canviar contrasenya">
                                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none"
                                        stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" style="vertical-align: middle;">
                                        <path
                                            d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4">
                                        </path>
                                    </svg>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Members will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
<!-- Access Link Dialog -->
    <dialog id="access-link-dialog">
        <div class="password-dialog-content">
            <h3>Sol·licitar accés</h3>
            <p>Introdueix el teu correu electrònic per rebre un enllaç d'accés</p>
            <div class="form-group">
                <label for="access-link-email">Correu electrònic</label>
                <input type="email" id="access-link-email" placeholder="Introdueix el teu correu electrònic" autocomplete="email" required>
            </div>
        </div>
        <div class="password-dialog-actions">
            <button type="button" class="btn btn-secondary" id="access-link-cancel-btn">Cancel·lar</button>
            <button type="button" class="btn btn-primary" id="access-link-send-btn">Enviar accés</button>
        </div>
    </dialog>

    <!-- Password Change Dialog -->
    <dialog id="password-change-dialog">
        <div class="password-dialog-content">
            <h3>Canviar contrasenya</h3>
            <p id="password-change-member-name"></p>
            <div class="form-group">
                <label for="new-password">Nova contrasenya</label>
                <input type="password" id="new-password" placeholder="Mínim 8 caràcters" autocomplete="new-password" required>
            </div>
            <div class="form-group">
                <label for="confirm-password">Confirmar contrasenya</label>
                <input type="password" id="confirm-password" placeholder="Repeteix la contrasenya" autocomplete="new-password" required>
            </div>
        </div>
        <div class="password-dialog-actions">
            <button type="button" class="btn btn-secondary" id="password-cancel-btn">Cancel·lar</button>
            <button type="button" class="btn btn-primary" id="password-save-btn">Desar</button>
        </div>
    </dialog>

    <script>
        (function () {
            const nameFilterToggle = document.getElementById('name-filter-toggle');
            const emailFilterToggle = document.getElementById('email-filter-toggle');
            const typeFilterToggle = document.getElementById('type-filter-toggle');
            const typeFilterDropdown = document.getElementById('type-filter-dropdown');
            const rolsFilterToggle = document.getElementById('rols-filter-toggle');
            const rolsFilterDropdown = document.getElementById('rols-filter-dropdown');
            const accessFilterToggle = document.getElementById('access-filter-toggle');
            const accessFilterDropdown = document.getElementById('access-filter-dropdown');
            const activeFilterToggle = document.getElementById('active-filter-toggle');
            const activeFilterDropdown = document.getElementById('active-filter-dropdown');
            const membersFilter = document.getElementById('members-filter');
            const searchInput = document.getElementById('members-search');
            const filterSummary = document.getElementById('members-filter-summary');
            const filterSummaryText = document.getElementById('filter-summary-text');
            const clearAllFiltersLink = document.getElementById('clear-all-filters');

            // Update filter summary based on active filters
            function updateFilterSummary() {
                const parts = [];

                // Check search filter
                const searchValue = searchInput ? searchInput.value.trim() : '';
                if (searchValue) {
                    parts.push('cerca "' + searchValue + '"');
                }

                // Check type filter
                if (typeof membersTypeFilterValue !== 'undefined' && membersTypeFilterValue) {
                    const typeLabel = membersTypeFilterValue === 'ADULT' ? 'Adults' : 'Xiquets/es';
                    parts.push(typeLabel);
                }

                // Check rols filter
                if (typeof membersRolsFilterValue !== 'undefined' && membersRolsFilterValue) {
                    const rolLabel = membersRolsFilterValue === 'ADMIN' ? 'amb ADMIN' : 'sense ADMIN';
                    parts.push(rolLabel);
                }

                // Check access filter
                if (typeof membersAccessFilterValue !== 'undefined' && membersAccessFilterValue) {
                    const accessLabel = membersAccessFilterValue === 'HAS_ACCESS' ? 'amb accés a altres' : 'sense accés a altres';
                    parts.push(accessLabel);
                }

                // Check active filter
                if (typeof membersActiveFilterValue !== 'undefined' && membersActiveFilterValue) {
                    const activeLabel = membersActiveFilterValue === 'true' ? 'actius' : 'inactius';
                    parts.push(activeLabel);
                }

                if (parts.length > 0 && filterSummary && filterSummaryText) {
                    filterSummaryText.textContent = 'Mostrant: ' + parts.join(', ');
                    filterSummary.style.display = 'flex';
                } else if (filterSummary) {
                    filterSummary.style.display = 'none';
                }
            }

            // Clear all filters
            function clearAllFilters(e) {
                if (e) e.preventDefault();

                // Clear search
                if (searchInput) {
                    searchInput.value = '';
                }
                membersFilter.style.display = 'none';
                [nameFilterToggle, emailFilterToggle].forEach(function (el) {
                    if (el) el.classList.remove('active');
                });

                // Clear type filter
                if (typeof membersTypeFilterValue !== 'undefined') {
                    membersTypeFilterValue = '';
                }
                if (typeFilterDropdown) {
                    const options = typeFilterDropdown.querySelectorAll('.type-filter-option');
                    options.forEach(function (opt, i) {
                        opt.classList.toggle('selected', i === 0);
                    });
                }
                if (typeFilterToggle) typeFilterToggle.classList.remove('active');

                // Clear rols filter
                if (typeof membersRolsFilterValue !== 'undefined') {
                    membersRolsFilterValue = '';
                }
                if (rolsFilterDropdown) {
                    const options = rolsFilterDropdown.querySelectorAll('.type-filter-option');
                    options.forEach(function (opt, i) {
                        opt.classList.toggle('selected', i === 0);
                    });
                }
                if (rolsFilterToggle) rolsFilterToggle.classList.remove('active');

                // Clear access filter
                if (typeof membersAccessFilterValue !== 'undefined') {
                    membersAccessFilterValue = '';
                }
                if (accessFilterDropdown) {
                    const options = accessFilterDropdown.querySelectorAll('.type-filter-option');
                    options.forEach(function (opt, i) {
                        opt.classList.toggle('selected', i === 0);
                    });
                }
                if (accessFilterToggle) accessFilterToggle.classList.remove('active');

                // Clear active filter
                if (typeof membersActiveFilterValue !== 'undefined') {
                    membersActiveFilterValue = '';
                }
                if (activeFilterDropdown) {
                    const options = activeFilterDropdown.querySelectorAll('.type-filter-option');
                    options.forEach(function (opt, i) {
                        opt.classList.toggle('selected', i === 0);
                    });
                }
                if (activeFilterToggle) activeFilterToggle.classList.remove('active');

                // Re-render and update summary
                if (typeof renderMembersTable === 'function') {
                    renderMembersTable();
                }
                updateFilterSummary();
            }

            // Attach clear all filters handler
            if (clearAllFiltersLink) {
                clearAllFiltersLink.addEventListener('click', clearAllFilters);
            }

            // Update filter summary when search input changes
            if (searchInput) {
                searchInput.addEventListener('input', function () {
                    updateFilterSummary();
                });
            }

            // Make updateFilterSummary available globally
            window.updateMembersFilterSummary = updateFilterSummary;

            function toggleTextFilter(toggleElement) {
                if (!membersFilter) return;
                const isVisible = membersFilter.style.display !== 'none';
                membersFilter.style.display = isVisible ? 'none' : 'block';

                // Update active state for text filter toggles
                [nameFilterToggle, emailFilterToggle].forEach(function (el) {
                    if (el) el.classList.toggle('active', !isVisible);
                });

                if (!isVisible && searchInput) {
                    searchInput.focus();
                }
            }

            function toggleTypeDropdown(e) {
                if (!typeFilterDropdown) return;
                if (rolsFilterDropdown) rolsFilterDropdown.style.display = 'none';
                if (accessFilterDropdown) accessFilterDropdown.style.display = 'none';
                if (activeFilterDropdown) activeFilterDropdown.style.display = 'none';
                const isVisible = typeFilterDropdown.style.display !== 'none';
                typeFilterDropdown.style.display = isVisible ? 'none' : 'block';
            }

            function toggleRolsDropdown(e) {
                if (!rolsFilterDropdown) return;
                if (typeFilterDropdown) typeFilterDropdown.style.display = 'none';
                if (accessFilterDropdown) accessFilterDropdown.style.display = 'none';
                if (activeFilterDropdown) activeFilterDropdown.style.display = 'none';
                const isVisible = rolsFilterDropdown.style.display !== 'none';
                rolsFilterDropdown.style.display = isVisible ? 'none' : 'block';
            }

            function toggleAccessDropdown(e) {
                if (!accessFilterDropdown) return;
                if (typeFilterDropdown) typeFilterDropdown.style.display = 'none';
                if (rolsFilterDropdown) rolsFilterDropdown.style.display = 'none';
                if (activeFilterDropdown) activeFilterDropdown.style.display = 'none';
                const isVisible = accessFilterDropdown.style.display !== 'none';
                accessFilterDropdown.style.display = isVisible ? 'none' : 'block';
            }

            function toggleActiveDropdown(e) {
                if (!activeFilterDropdown) return;
                if (typeFilterDropdown) typeFilterDropdown.style.display = 'none';
                if (rolsFilterDropdown) rolsFilterDropdown.style.display = 'none';
                if (accessFilterDropdown) accessFilterDropdown.style.display = 'none';
                const isVisible = activeFilterDropdown.style.display !== 'none';
                activeFilterDropdown.style.display = isVisible ? 'none' : 'block';
            }

            // Close dropdown when clicking outside
            document.addEventListener('click', function (e) {
                if (typeFilterDropdown && !typeFilterToggle.contains(e.target) && !typeFilterDropdown.contains(e.target)) {
                    typeFilterDropdown.style.display = 'none';
                }
                if (rolsFilterDropdown && !rolsFilterToggle.contains(e.target) && !rolsFilterDropdown.contains(e.target)) {
                    rolsFilterDropdown.style.display = 'none';
                }
                if (accessFilterDropdown && !accessFilterToggle.contains(e.target) && !accessFilterDropdown.contains(e.target)) {
                    accessFilterDropdown.style.display = 'none';
                }
                if (activeFilterDropdown && !activeFilterToggle.contains(e.target) && !activeFilterDropdown.contains(e.target)) {
                    activeFilterDropdown.style.display = 'none';
                }
            });

            // Handle type filter selection
            if (typeFilterDropdown) {
                const options = typeFilterDropdown.querySelectorAll('.type-filter-option');
                options.forEach(function (option) {
                    option.addEventListener('click', function (e) {
                        e.stopPropagation();
                        const selectedValue = this.getAttribute('data-value');

                        // Update selected state
                        options.forEach(function (opt) {
                            opt.classList.remove('selected');
                        });
                        this.classList.add('selected');

                        // Set global filter value and re-render
                        if (typeof membersTypeFilterValue !== 'undefined') {
                            membersTypeFilterValue = selectedValue;
                            renderMembersTable();
                        }

                        // Update active state for type filter
                        typeFilterToggle.classList.toggle('active', selectedValue !== '');
                        typeFilterDropdown.style.display = 'none';
                        updateFilterSummary();
                    });
                });

                // Set initial selected state
                options[0].classList.add('selected');
            }

            // Handle rols filter selection
            if (rolsFilterDropdown) {
                const options = rolsFilterDropdown.querySelectorAll('.type-filter-option');
                options.forEach(function (option) {
                    option.addEventListener('click', function (e) {
                        e.stopPropagation();
                        const selectedValue = this.getAttribute('data-value');

                        // Update selected state
                        options.forEach(function (opt) {
                            opt.classList.remove('selected');
                        });
                        this.classList.add('selected');

                        // Set global filter value and re-render
                        if (typeof membersRolsFilterValue !== 'undefined') {
                            membersRolsFilterValue = selectedValue;
                            renderMembersTable();
                        }

                        // Update active state for rols filter
                        rolsFilterToggle.classList.toggle('active', selectedValue !== '');
                        rolsFilterDropdown.style.display = 'none';
                        updateFilterSummary();
                    });
                });

                // Set initial selected state
                options[0].classList.add('selected');
            }

            // Handle access filter selection
            if (accessFilterDropdown) {
                const options = accessFilterDropdown.querySelectorAll('.type-filter-option');
                options.forEach(function (option) {
                    option.addEventListener('click', function (e) {
                        e.stopPropagation();
                        const selectedValue = this.getAttribute('data-value');

                        // Update selected state
                        options.forEach(function (opt) {
                            opt.classList.remove('selected');
                        });
                        this.classList.add('selected');

                        // Set global filter value and re-render
                        if (typeof membersAccessFilterValue !== 'undefined') {
                            membersAccessFilterValue = selectedValue;
                            renderMembersTable();
                        }

                        // Update active state for access filter
                        accessFilterToggle.classList.toggle('active', selectedValue !== '');
                        accessFilterDropdown.style.display = 'none';
                        updateFilterSummary();
                    });
                });

                // Set initial selected state
                options[0].classList.add('selected');
            }

            // Handle active filter selection
            if (activeFilterDropdown) {
                const options = activeFilterDropdown.querySelectorAll('.type-filter-option');
                options.forEach(function (option) {
                    option.addEventListener('click', function (e) {
                        e.stopPropagation();
                        const selectedValue = this.getAttribute('data-value');

                        // Update selected state
                        options.forEach(function (opt) {
                            opt.classList.remove('selected');
                        });
                        this.classList.add('selected');

                        // Set global filter value and re-render
                        if (typeof membersActiveFilterValue !== 'undefined') {
                            membersActiveFilterValue = selectedValue;
                            renderMembersTable();
                        }

                        // Update active state for active filter
                        activeFilterToggle.classList.toggle('active', selectedValue !== '');
                        activeFilterDropdown.style.display = 'none';
                        updateFilterSummary();
                    });
                });

                // Set initial selected state
                options[0].classList.add('selected');
            }

            if (nameFilterToggle) {
                nameFilterToggle.addEventListener('click', function (e) {
                    e.stopPropagation();
                    toggleTextFilter(this);
                });
            }

            if (emailFilterToggle) {
                emailFilterToggle.addEventListener('click', function (e) {
                    e.stopPropagation();
                    toggleTextFilter(this);
                });
            }

            if (typeFilterToggle) {
                typeFilterToggle.addEventListener('click', function (e) {
                    e.stopPropagation();
                    toggleTypeDropdown(e);
                });
            }

            if (rolsFilterToggle) {
                rolsFilterToggle.addEventListener('click', function (e) {
                    e.stopPropagation();
                    toggleRolsDropdown(e);
                });
            }

            if (accessFilterToggle) {
                accessFilterToggle.addEventListener('click', function (e) {
                    e.stopPropagation();
                    toggleAccessDropdown(e);
                });
            }

            if (activeFilterToggle) {
                activeFilterToggle.addEventListener('click', function (e) {
                    e.stopPropagation();
                    toggleActiveDropdown(e);
                });
            }

            // Global edit button - calls startEditAllMembers from javascript.html
            const editAllBtn = document.getElementById('edit-all-members-btn');
            if (editAllBtn) {
                editAllBtn.addEventListener('click', function () {
                    if (typeof startEditAllMembers === 'function') {
                        startEditAllMembers();
                    }
                });
            }
        })();
    </script>



    <!-- 404 Not Found View -->
    <div id="view-404" class="view" data-view="404" style="display: none;">
        <div class="error-page">
            <h1>404</h1>
            <p>Pàgina no trobada</p>
            <a href="#" data-route="home" class="btn btn-primary">Anar a l'inici</a>
        </div>
    </div>
</main>

