<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>API Benchmark Suite</title>
    <script>
    {% include "../../docs/scripts/dances.js" %}
    </script>

    <script>
    {% include "../../docs/scripts/api.js" %}
    </script>
    
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --bg-primary: #0a0a0f;
        --bg-secondary: #12121a;
        --bg-card: #1a1a25;
        --accent-cyan: #00f5ff;
        --accent-purple: #bf5af2;
        --accent-pink: #ff2d92;
        --accent-green: #30d158;
        --accent-orange: #ff9f0a;
        --accent-red: #ff453a;
        --text-primary: #ffffff;
        --text-secondary: #8e8e93;
        --border-glow: rgba(0, 245, 255, 0.3);
      }

      body {
        font-family:
          "SF Pro Display",
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          Roboto,
          sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        min-height: 100vh;
        overflow-x: hidden;
      }

      .background-grid {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image:
          linear-gradient(rgba(0, 245, 255, 0.03) 1px, transparent 1px),
          linear-gradient(90deg, rgba(0, 245, 255, 0.03) 1px, transparent 1px);
        background-size: 50px 50px;
        pointer-events: none;
        z-index: 0;
      }

      .glow-orb {
        position: fixed;
        border-radius: 50%;
        filter: blur(100px);
        pointer-events: none;
        z-index: 0;
      }

      .orb-1 {
        width: 400px;
        height: 400px;
        background: rgba(191, 90, 242, 0.15);
        top: -100px;
        right: -100px;
        animation: float 8s ease-in-out infinite;
      }

      .orb-2 {
        width: 300px;
        height: 300px;
        background: rgba(0, 245, 255, 0.1);
        bottom: -50px;
        left: -50px;
        animation: float 10s ease-in-out infinite reverse;
      }

      @keyframes float {
        0%,
        100% {
          transform: translate(0, 0);
        }
        50% {
          transform: translate(30px, 30px);
        }
      }

      .container {
        position: relative;
        z-index: 1;
        max-width: 1400px;
        margin: 0 auto;
        padding: 40px 20px;
      }

      header {
        text-align: center;
        margin-bottom: 50px;
      }

      h1 {
        font-size: 3.5rem;
        font-weight: 700;
        background: linear-gradient(
          135deg,
          var(--accent-cyan),
          var(--accent-purple),
          var(--accent-pink)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 10px;
        letter-spacing: -1px;
      }

      .subtitle {
        color: var(--text-secondary);
        font-size: 1.1rem;
        font-weight: 400;
      }

      .controls {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 40px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 14px 32px;
        border: none;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--accent-cyan),
          var(--accent-purple)
        );
        color: var(--bg-primary);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 40px rgba(0, 245, 255, 0.3);
      }

      .btn-secondary {
        background: var(--bg-card);
        color: var(--text-primary);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .btn-secondary:hover {
        border-color: var(--accent-cyan);
        box-shadow: 0 0 20px rgba(0, 245, 255, 0.2);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }

      .stat-card {
        background: var(--bg-card);
        border-radius: 16px;
        padding: 24px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        position: relative;
        overflow: hidden;
      }

      .stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(
          90deg,
          var(--accent-cyan),
          var(--accent-purple)
        );
      }

      .stat-label {
        color: var(--text-secondary);
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        font-variant-numeric: tabular-nums;
      }

      .stat-value.cyan {
        color: var(--accent-cyan);
      }
      .stat-value.purple {
        color: var(--accent-purple);
      }
      .stat-value.green {
        color: var(--accent-green);
      }
      .stat-value.orange {
        color: var(--accent-orange);
      }
      .stat-value.red {
        color: var(--accent-red);
      }

      .progress-container {
        background: var(--bg-card);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 40px;
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .progress-title {
        font-size: 1.1rem;
        font-weight: 600;
      }

      .progress-percent {
        color: var(--accent-cyan);
        font-weight: 600;
      }

      .progress-bar {
        height: 8px;
        background: var(--bg-secondary);
        border-radius: 4px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(
          90deg,
          var(--accent-cyan),
          var(--accent-purple)
        );
        border-radius: 4px;
        transition: width 0.3s ease;
        position: relative;
      }

      .progress-fill::after {
        content: "";
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        width: 20px;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3)
        );
        animation: shimmer 1s infinite;
      }

      @keyframes shimmer {
        0% {
          opacity: 0;
        }
        50% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }

      .test-suites {
        display: grid;
        gap: 20px;
      }

      .suite-card {
        background: var(--bg-card);
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        overflow: hidden;
        transition: all 0.3s ease;
      }

      .suite-card:hover {
        border-color: rgba(0, 245, 255, 0.2);
      }

      .suite-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        background: rgba(255, 255, 255, 0.02);
        cursor: pointer;
      }

      .suite-info {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .suite-icon {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
      }

      .suite-icon.api {
        background: linear-gradient(
          135deg,
          rgba(0, 245, 255, 0.2),
          rgba(191, 90, 242, 0.2)
        );
      }
      .suite-icon.auth {
        background: linear-gradient(
          135deg,
          rgba(48, 209, 88, 0.2),
          rgba(0, 245, 255, 0.2)
        );
      }
      .suite-icon.data {
        background: linear-gradient(
          135deg,
          rgba(255, 159, 10, 0.2),
          rgba(255, 45, 146, 0.2)
        );
      }
      .suite-icon.perf {
        background: linear-gradient(
          135deg,
          rgba(191, 90, 242, 0.2),
          rgba(255, 45, 146, 0.2)
        );
      }

      .suite-name {
        font-size: 1.1rem;
        font-weight: 600;
      }

      .suite-description {
        color: var(--text-secondary);
        font-size: 0.85rem;
        margin-top: 2px;
      }

      .suite-stats {
        display: flex;
        gap: 24px;
        align-items: center;
      }

      .suite-stat {
        text-align: right;
      }

      .suite-stat-value {
        font-size: 1.2rem;
        font-weight: 600;
      }

      .suite-stat-label {
        color: var(--text-secondary);
        font-size: 0.75rem;
        text-transform: uppercase;
      }

      .suite-status {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .status-pending {
        background: rgba(142, 142, 147, 0.2);
        color: var(--text-secondary);
      }
      .status-running {
        background: rgba(0, 245, 255, 0.2);
        color: var(--accent-cyan);
        animation: pulse 1.5s infinite;
      }
      .status-passed {
        background: rgba(48, 209, 88, 0.2);
        color: var(--accent-green);
      }
      .status-failed {
        background: rgba(255, 69, 58, 0.2);
        color: var(--accent-red);
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.6;
        }
      }

      .suite-tests {
        padding: 0 24px 24px;
        display: none;
      }

      .suite-card.expanded .suite-tests {
        display: block;
      }

      .test-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 16px;
        background: var(--bg-secondary);
        border-radius: 10px;
        margin-top: 10px;
        transition: all 0.3s ease;
      }

      .test-item:hover {
        background: rgba(255, 255, 255, 0.05);
      }

      .test-name {
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .test-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--text-secondary);
      }

      .test-indicator.running {
        background: var(--accent-cyan);
        box-shadow: 0 0 10px var(--accent-cyan);
        animation: pulse 1s infinite;
      }

      .test-indicator.passed {
        background: var(--accent-green);
      }
      .test-indicator.failed {
        background: var(--accent-red);
      }

      .test-metrics {
        display: flex;
        gap: 20px;
        align-items: center;
      }

      .test-time {
        color: var(--text-secondary);
        font-size: 0.85rem;
        font-variant-numeric: tabular-nums;
        min-width: 80px;
        text-align: right;
      }

      .test-calls {
        color: var(--accent-purple);
        font-size: 0.85rem;
        min-width: 60px;
        text-align: right;
      }

      .log-container {
        background: var(--bg-card);
        border-radius: 16px;
        padding: 24px;
        margin-top: 40px;
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      .log-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .log-title {
        font-size: 1.1rem;
        font-weight: 600;
      }

      .log-content {
        background: var(--bg-primary);
        border-radius: 10px;
        padding: 16px;
        max-height: 300px;
        overflow-y: auto;
        font-family: "SF Mono", "Fira Code", monospace;
        font-size: 0.85rem;
        line-height: 1.6;
      }

      .log-entry {
        padding: 4px 0;
        display: flex;
        gap: 12px;
      }

      .log-time {
        color: var(--text-secondary);
        flex-shrink: 0;
      }

      .log-message {
        color: var(--text-primary);
      }
      .log-message.info {
        color: var(--accent-cyan);
      }
      .log-message.success {
        color: var(--accent-green);
      }
      .log-message.error {
        color: var(--accent-red);
      }
      .log-message.warning {
        color: var(--accent-orange);
      }

      .chevron {
        transition: transform 0.3s ease;
      }

      .suite-card.expanded .chevron {
        transform: rotate(180deg);
      }

      .config-panel {
        background: var(--bg-card);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 40px;
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      .config-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 20px;
      }

      .config-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
      }

      .config-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .config-label {
        color: var(--text-secondary);
        font-size: 0.85rem;
      }

      .config-input {
        background: var(--bg-secondary);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 12px 16px;
        color: var(--text-primary);
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .config-input:focus {
        outline: none;
        border-color: var(--accent-cyan);
        box-shadow: 0 0 0 3px rgba(0, 245, 255, 0.1);
      }

      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: var(--bg-secondary);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.3);
      }
    </style>
  </head>
  <body>
    <div class="background-grid"></div>
    <div class="glow-orb orb-1"></div>
    <div class="glow-orb orb-2"></div>

    <div class="container">
      <header>
        <h1>‚ö° API Benchmark Suite</h1>
        <p class="subtitle">
          High-performance testing framework for API endpoints
        </p>
      </header>

      <div class="config-panel">
        <div class="config-title">‚öôÔ∏è Configuration</div>
        <div class="config-grid">
          <div class="config-item">
            <label class="config-label">API Base URL</label>
            <input
              type="text"
              class="config-input"
              id="apiBaseUrl"
              value="/api"
              placeholder="https://api.example.com"
            />
          </div>
          <div class="config-item">
            <label class="config-label">Iterations per Test</label>
            <input
              type="number"
              class="config-input"
              id="iterations"
              value="10"
              min="1"
              max="1000"
            />
          </div>
          <div class="config-item">
            <label class="config-label">Concurrent Requests</label>
            <input
              type="number"
              class="config-input"
              id="concurrent"
              value="1"
              min="1"
              max="50"
            />
          </div>
          <div class="config-item">
            <label class="config-label">Timeout (ms)</label>
            <input
              type="number"
              class="config-input"
              id="timeout"
              value="5000"
              min="100"
              max="60000"
            />
          </div>
        </div>
      </div>

      <div class="controls">
        <button
          class="btn btn-primary"
          id="runAllBtn"
          onclick="runAllBenchmarks()"
        >
          ‚ñ∂ Run All Benchmarks
        </button>
        <button
          class="btn btn-secondary"
          id="stopBtn"
          onclick="stopBenchmarks()"
          disabled
        >
          ‚èπ Stop
        </button>
        <button class="btn btn-secondary" onclick="resetResults()">
          ‚Üª Reset
        </button>
        <button class="btn btn-secondary" onclick="exportResults()">
          ‚¨á Export Results
        </button>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Total Tests</div>
          <div class="stat-value cyan" id="totalTests">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Passed</div>
          <div class="stat-value green" id="passedTests">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Failed</div>
          <div class="stat-value red" id="failedTests">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Avg Response</div>
          <div class="stat-value purple" id="avgResponse">0ms</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Calls</div>
          <div class="stat-value orange" id="totalCalls">0</div>
        </div>
      </div>

      <div class="progress-container">
        <div class="progress-header">
          <span class="progress-title">Overall Progress</span>
          <span class="progress-percent" id="progressPercent">0%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
      </div>

      <div class="test-suites" id="testSuites"></div>

      <div class="log-container">
        <div class="log-header">
          <span class="log-title">üìã Live Log</span>
          <button
            class="btn btn-secondary"
            style="padding: 8px 16px; font-size: 0.85rem"
            onclick="clearLog()"
          >
            Clear
          </button>
        </div>
        <div class="log-content" id="logContent"></div>
      </div>
    </div>

    <script>
      // Benchmark State
      let isRunning = false;
      let shouldStop = false;
      let results = {
        totalTests: 0,
        passed: 0,
        failed: 0,
        totalCalls: 0,
        responseTimes: [],
      };

      // Test Suites Definition
      const testSuites = [
        {
          id: "token-management",
          name: "Token Management",
          description: "Token storage and retrieval functions",
          icon: "üîë",
          iconClass: "auth",
          tests: [
            { name: "getToken()", fn: () => API.getToken(), expectType: "any" },
            {
              name: "saveToken()",
              fn: () => API.saveToken({ token: "test-token-" + Date.now() }),
              expectType: "undefined",
            },
            {
              name: "getToken() after save",
              fn: () => API.getToken(),
              expectType: "string",
            },
          ],
        },
        {
          id: "auth",
          name: "Authentication",
          description: "Login, logout, and access link operations",
          icon: "üîê",
          iconClass: "auth",
          tests: [
            {
              name: "loginWithEmailPassword()",
              fn: () =>
                API.loginWithEmailPassword({
                  email: "test@example.com",
                  password: "testpass",
                }),
              expectError: true,
            },
            {
              name: "sendAccessLink()",
              fn: () => API.sendAccessLink({ email: "test@example.com" }),
              expectError: true,
            },
            {
              name: "sendRegistrationRequest()",
              fn: () =>
                API.sendRegistrationRequest({
                  name: "Test User",
                  email: "test@example.com",
                }),
              expectError: true,
            },
            {
              name: "logoutUser()",
              fn: () => API.logoutUser(),
              expectError: true,
            },
            {
              name: "changeUserPassword()",
              fn: () =>
                API.changeUserPassword({
                  email: "test@example.com",
                  newPassword: "newpass123",
                }),
              expectError: true,
            },
          ],
        },
        {
          id: "user-data",
          name: "User & Dashboard",
          description: "User information and dashboard statistics",
          icon: "üë§",
          iconClass: "api",
          tests: [
            {
              name: "getCurrentUser()",
              fn: () => API.getCurrentUser(),
              expectType: "object",
            },
            {
              name: "getDashboardStats()",
              fn: () => API.getDashboardStats(),
              expectType: "object",
            },
          ],
        },
        {
          id: "data-retrieval",
          name: "Data Retrieval",
          description: "Fetching dances, events, and members",
          icon: "üìä",
          iconClass: "data",
          tests: [
            {
              name: "getDances()",
              fn: () => API.getDances(),
              expectType: "array",
            },
            {
              name: "getEvents()",
              fn: () => API.getEvents(),
              expectType: "array",
            },
            {
              name: "getEventById()",
              fn: () => API.getEventById({ eventId: "1" }),
              expectType: "object",
            },
            {
              name: "getMembers()",
              fn: () => API.getMembers(),
              expectType: "array",
            },
          ],
        },
        {
          id: "data-mutation",
          name: "Data Mutation",
          description: "Saving and updating data",
          icon: "üíæ",
          iconClass: "perf",
          tests: [
            {
              name: "saveMember()",
              fn: () =>
                API.saveMember({ member: { id: "test", name: "Test Member" } }),
              expectError: true,
            },
            {
              name: "saveAllMembers()",
              fn: () => API.saveAllMembers({ members: [] }),
              expectError: true,
            },
            {
              name: "saveEvent()",
              fn: () =>
                API.saveEvent({ event: { id: "test", name: "Test Event" } }),
              expectError: true,
            },
          ],
        },
      ];

      // Initialize UI
      function initUI() {
        const container = document.getElementById("testSuites");
        container.innerHTML = testSuites
          .map(
            (suite) => `
        <div class="suite-card" id="suite-${suite.id}">
          <div class="suite-header" onclick="toggleSuite('${suite.id}')">
            <div class="suite-info">
              <div class="suite-icon ${suite.iconClass}">${suite.icon}</div>
              <div>
                <div class="suite-name">${suite.name}</div>
                <div class="suite-description">${suite.description}</div>
              </div>
            </div>
            <div class="suite-stats">
              <div class="suite-stat">
                <div class="suite-stat-value" id="suite-${suite.id}-time">--</div>
                <div class="suite-stat-label">Avg Time</div>
              </div>
              <div class="suite-stat">
                <div class="suite-stat-value" id="suite-${suite.id}-calls">0</div>
                <div class="suite-stat-label">Calls</div>
              </div>
              <div class="suite-status status-pending" id="suite-${suite.id}-status">Pending</div>
              <svg class="chevron" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
              </svg>
            </div>
          </div>
          <div class="suite-tests">
            ${suite.tests
              .map(
                (test, idx) => `
              <div class="test-item" id="test-${suite.id}-${idx}">
                <div class="test-name">
                  <div class="test-indicator" id="indicator-${suite.id}-${idx}"></div>
                  <span>${test.name}</span>
                </div>
                <div class="test-metrics">
                  <span class="test-calls" id="calls-${suite.id}-${idx}">0 calls</span>
                  <span class="test-time" id="time-${suite.id}-${idx}">--</span>
                </div>
              </div>
            `,
              )
              .join("")}
          </div>
        </div>
      `,
          )
          .join("");

        updateTotalTests();
      }

      function toggleSuite(id) {
        const card = document.getElementById(`suite-${id}`);
        card.classList.toggle("expanded");
      }

      function updateTotalTests() {
        const total = testSuites.reduce(
          (sum, suite) => sum + suite.tests.length,
          0,
        );
        document.getElementById("totalTests").textContent = total;
      }

      // Logging
      function log(message, type = "info") {
        const logContent = document.getElementById("logContent");
        const time = new Date().toLocaleTimeString("en-US", { hour12: false });
        const entry = document.createElement("div");
        entry.className = "log-entry";
        entry.innerHTML = `
        <span class="log-time">[${time}]</span>
        <span class="log-message ${type}">${message}</span>
      `;
        logContent.appendChild(entry);
        logContent.scrollTop = logContent.scrollHeight;
      }

      function clearLog() {
        document.getElementById("logContent").innerHTML = "";
      }

      // Benchmark Functions
      async function makeRequest(endpoint, method, body, timeout) {
        const baseUrl = document.getElementById("apiBaseUrl").value;
        const url = baseUrl + endpoint;
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);

        const startTime = performance.now();

        try {
          const options = {
            method: method,
            headers: { "Content-Type": "application/json" },
            signal: controller.signal,
          };

          if (
            body &&
            (method === "POST" || method === "PUT" || method === "PATCH")
          ) {
            options.body = JSON.stringify(body);
          }

          const response = await fetch(url, options);
          const endTime = performance.now();
          clearTimeout(timeoutId);

          return {
            success: response.ok,
            status: response.status,
            time: endTime - startTime,
          };
        } catch (error) {
          clearTimeout(timeoutId);
          const endTime = performance.now();
          return {
            success: false,
            error: error.name === "AbortError" ? "Timeout" : error.message,
            time: endTime - startTime,
          };
        }
      }

      async function runTest(suiteId, testIdx, test) {
        if (shouldStop) return null;

        const iterations = parseInt(
          document.getElementById("iterations").value,
        );
        const concurrent = parseInt(
          document.getElementById("concurrent").value,
        );
        const timeout = parseInt(document.getElementById("timeout").value);

        const indicator = document.getElementById(
          `indicator-${suiteId}-${testIdx}`,
        );
        const timeEl = document.getElementById(`time-${suiteId}-${testIdx}`);
        const callsEl = document.getElementById(`calls-${suiteId}-${testIdx}`);

        indicator.className = "test-indicator running";

        let times = [];
        let successCount = 0;
        let callCount = 0;

        // Helper function to run API test
        async function runApiTest() {
          const startTime = performance.now();
          try {
            const result = await Promise.race([
              test.fn(),
              new Promise((_, reject) =>
                setTimeout(() => reject(new Error("Timeout")), timeout),
              ),
            ]);
            const endTime = performance.now();

            // Validate result type if specified
            let typeValid = true;
            if (test.expectType) {
              if (test.expectType === "array") {
                typeValid = Array.isArray(result);
              } else if (test.expectType === "object") {
                typeValid =
                  result !== null &&
                  typeof result === "object" &&
                  !Array.isArray(result);
              } else if (test.expectType === "string") {
                typeValid = typeof result === "string";
              } else if (test.expectType === "any") {
                typeValid = true;
              } else {
                typeValid = typeof result === test.expectType;
              }
            }

            return {
              success: test.expectError ? false : typeValid,
              time: endTime - startTime,
              result: result,
            };
          } catch (error) {
            const endTime = performance.now();
            // If we expect an error, this is actually a success
            return {
              success: test.expectError === true,
              time: endTime - startTime,
              error: error.message || error,
            };
          }
        }

        for (let i = 0; i < iterations && !shouldStop; i += concurrent) {
          const batch = Math.min(concurrent, iterations - i);
          const promises = [];

          for (let j = 0; j < batch; j++) {
            promises.push(runApiTest());
          }

          const batchResults = await Promise.all(promises);

          batchResults.forEach((result) => {
            callCount++;
            if (result.success) {
              successCount++;
            }
            times.push(result.time);

            // Update UI
            callsEl.textContent = `${callCount} calls`;
            if (times.length > 0) {
              const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
              timeEl.textContent = `${avgTime.toFixed(1)}ms`;
            }
          });

          // Update global stats
          results.totalCalls = (results.totalCalls || 0) + batch;
          document.getElementById("totalCalls").textContent =
            results.totalCalls;
        }

        const passed = successCount === callCount;
        indicator.className = `test-indicator ${passed ? "passed" : "failed"}`;

        return {
          passed,
          calls: callCount,
          avgTime:
            times.length > 0
              ? times.reduce((a, b) => a + b, 0) / times.length
              : 0,
          times,
        };
      }

      async function runSuite(suite) {
        if (shouldStop) return;

        const statusEl = document.getElementById(`suite-${suite.id}-status`);
        const timeEl = document.getElementById(`suite-${suite.id}-time`);
        const callsEl = document.getElementById(`suite-${suite.id}-calls`);

        statusEl.className = "suite-status status-running";
        statusEl.textContent = "Running";

        log(`Starting suite: ${suite.name}`, "info");

        let suitePassed = true;
        let totalCalls = 0;
        let allTimes = [];

        for (let i = 0; i < suite.tests.length && !shouldStop; i++) {
          const test = suite.tests[i];
          log(`  Running: ${test.name}`, "info");

          const result = await runTest(suite.id, i, test);

          if (result) {
            if (!result.passed) suitePassed = false;
            totalCalls += result.calls;
            allTimes = allTimes.concat(result.times);

            results.totalCalls += result.calls;
            results.responseTimes = results.responseTimes.concat(result.times);

            if (result.passed) {
              results.passed++;
              log(
                `  ‚úì ${test.name} passed (${result.avgTime.toFixed(1)}ms avg)`,
                "success",
              );
            } else {
              results.failed++;
              log(`  ‚úó ${test.name} failed`, "error");
            }

            updateStats();
          }
        }

        // Update suite stats
        callsEl.textContent = totalCalls;
        if (allTimes.length > 0) {
          const avgTime = allTimes.reduce((a, b) => a + b, 0) / allTimes.length;
          timeEl.textContent = `${avgTime.toFixed(0)}ms`;
        }

        statusEl.className = `suite-status ${suitePassed ? "status-passed" : "status-failed"}`;
        statusEl.textContent = suitePassed ? "Passed" : "Failed";

        log(
          `Suite ${suite.name}: ${suitePassed ? "PASSED" : "FAILED"}`,
          suitePassed ? "success" : "error",
        );
      }

      async function runAllBenchmarks() {
        if (isRunning) return;

        isRunning = true;
        shouldStop = false;

        document.getElementById("runAllBtn").disabled = true;
        document.getElementById("stopBtn").disabled = false;

        resetResults();
        log("üöÄ Starting benchmark suite...", "info");

        const totalSuites = testSuites.length;

        for (let i = 0; i < testSuites.length && !shouldStop; i++) {
          await runSuite(testSuites[i]);
          updateProgress(((i + 1) / totalSuites) * 100);
        }

        if (shouldStop) {
          log("‚èπ Benchmark stopped by user", "warning");
        } else {
          log("‚úÖ All benchmarks completed!", "success");
          log(
            `üìä Results: ${results.passed} passed, ${results.failed} failed, ${results.totalCalls} total calls`,
            "info",
          );
        }

        isRunning = false;
        document.getElementById("runAllBtn").disabled = false;
        document.getElementById("stopBtn").disabled = true;
      }

      function stopBenchmarks() {
        shouldStop = true;
        log("Stopping benchmarks...", "warning");
      }

      function updateProgress(percent) {
        document.getElementById("progressFill").style.width = `${percent}%`;
        document.getElementById("progressPercent").textContent =
          `${Math.round(percent)}%`;
      }

      function updateStats() {
        document.getElementById("passedTests").textContent = results.passed;
        document.getElementById("failedTests").textContent = results.failed;
        document.getElementById("totalCalls").textContent = results.totalCalls;

        if (results.responseTimes.length > 0) {
          const avg =
            results.responseTimes.reduce((a, b) => a + b, 0) /
            results.responseTimes.length;
          document.getElementById("avgResponse").textContent =
            `${avg.toFixed(1)}ms`;
        }
      }

      function resetResults() {
        results = {
          totalTests: 0,
          passed: 0,
          failed: 0,
          totalCalls: 0,
          responseTimes: [],
        };

        // Reset UI
        document.getElementById("passedTests").textContent = "0";
        document.getElementById("failedTests").textContent = "0";
        document.getElementById("totalCalls").textContent = "0";
        document.getElementById("avgResponse").textContent = "0ms";
        updateProgress(0);

        // Reset all test indicators
        testSuites.forEach((suite) => {
          document.getElementById(`suite-${suite.id}-status`).className =
            "suite-status status-pending";
          document.getElementById(`suite-${suite.id}-status`).textContent =
            "Pending";
          document.getElementById(`suite-${suite.id}-time`).textContent = "--";
          document.getElementById(`suite-${suite.id}-calls`).textContent = "0";

          suite.tests.forEach((_, idx) => {
            document.getElementById(`indicator-${suite.id}-${idx}`).className =
              "test-indicator";
            document.getElementById(`time-${suite.id}-${idx}`).textContent =
              "--";
            document.getElementById(`calls-${suite.id}-${idx}`).textContent =
              "0 calls";
          });
        });

        log("Results reset", "info");
      }

      function exportResults() {
        const data = {
          timestamp: new Date().toISOString(),
          config: {
            baseUrl: document.getElementById("apiBaseUrl").value,
            iterations: document.getElementById("iterations").value,
            concurrent: document.getElementById("concurrent").value,
            timeout: document.getElementById("timeout").value,
          },
          results: results,
          suites: testSuites.map((suite) => ({
            id: suite.id,
            name: suite.name,
            status: document.getElementById(`suite-${suite.id}-status`)
              .textContent,
            avgTime: document.getElementById(`suite-${suite.id}-time`)
              .textContent,
            calls: document.getElementById(`suite-${suite.id}-calls`)
              .textContent,
          })),
        };

        const blob = new Blob([JSON.stringify(data, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `benchmark-results-${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);

        log("Results exported to JSON", "success");
      }

      // Initialize
      initUI();
      log(
        'Benchmark suite initialized. Configure settings and click "Run All Benchmarks" to start.',
        "info",
      );
    </script>
  </body>
</html>
