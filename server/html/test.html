<!DOCTYPE html>
<html lang="ca">
    <head>
        <base target="_top">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
        <meta http-equiv="Pragma" content="no-cache">
        <meta http-equiv="Expires" content="0">
        <meta name="theme-color" content="#7C3AED">
        <meta name="theme-color" content="#7C3AED" media="(prefers-color-scheme: light)">
        <meta name="theme-color" content="#7C3AED" media="(prefers-color-scheme: dark)">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-title" content="TEST">
        <meta name="application-name" content="TEST">
        <meta name="msapplication-TileColor" content="#7C3AED">
        
        <title>TEST</title>

        
        

        
        
        
        
        <style>
        /* Access link dialog */
#access-link-dialog {
  padding: 0;
  border: none;
  border-radius: 16px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
  min-width: 380px;
  max-width: 90vw;
  background: #fff;
  color: #1f2937;
  text-align: left;
}

#access-link-dialog::backdrop {
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
}

#access-link-dialog[open] {
  display: flex;
  flex-direction: column;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 1000;
}

body.dark-mode #access-link-dialog {
  background: #2d3748;
  color: #e2e8f0;
}

/* CSS Variables for theming */
:root {
  /* Modern Light Theme */
  --primary-color: #7c3aed; /* A vibrant purple */
  --primary-dark: #6d28d9;
  --secondary-color: #9f7aea; /* A lighter, complementary purple */
  --success-color: #34d399; /* A modern, bright green */
  --warning-color: #fbbf24; /* A warm, modern yellow */
  --danger-color: #f87171; /* A softer, modern red */
  --info-color: #60a5fa; /* A clear, modern blue */

  --text-color: #1f2937; /* Darker grey for better contrast */
  --text-muted: #6b7280; /* Softer grey for muted text */

  --bg-color: #e5e7eb; /* A darker grey background */
  --card-bg: #f3f4f6; /* A very light grey for cards, replacing white */
  --border-color: #d1d5db; /* A slightly softer border color */

  --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.07), 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow-lg:
    0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);

  --radius: 12px;
  --radius-sm: 8px;

  /* Baton colors - can be updated if they need to match the new theme */
  --baton-left: #8b5a2b;
  --baton-right: #a86830;
}

/* Dark mode variables */
body.dark-mode {
  --text-color: #e2e8f0;
  --text-muted: #a0aec0;
  --bg-color: #1a202c;
  --card-bg: #2d3748;
  --border-color: #4a5568;
}

/* Base styles */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

/* Ensure the document fills the viewport so flex layout can position footer correctly */
html,
body {
  height: 100%;
  background-color: #7c3aed;
}

body {
  font-family:
    "Segoe UI",
    -apple-system,
    BlinkMacSystemFont,
    Roboto,
    "Helvetica Neue",
    sans-serif;
  background: var(--bg-color);
  color: var(--text-color);
  min-height: 100vh;
  line-height: 1.6;
}

/* Loading Screen */
.loading-screen {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(
    135deg,
    var(--primary-color) 0%,
    var(--secondary-color) 100%
  );
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

/* Container to keep both SVGs aligned */
.loader-container {
  position: relative;
  width: 200px;
  height: 200px;
}

/* Separate SVGs to allow z-index swapping */
.baton-svg {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  animation-duration: 2s;
  animation-iteration-count: infinite;
  animation-timing-function: ease-in-out;
}

.baton {
  transform-origin: center 180px;
  /* Pivot from the bottom */
}

/* LEFT BATON LOGIC */
.svg-left {
  animation-name: left-kick-layer;
}

@keyframes left-kick-layer {
  0%,
  100% {
    transform: rotate(0deg);
    z-index: 20;
  }

  25% {
    transform: rotate(40deg);
    z-index: 20;
  }

  /* Hits on TOP (z-index 20) */
  50% {
    transform: rotate(0deg);
    z-index: 10;
  }

  75% {
    transform: rotate(40deg);
    z-index: 10;
  }

  /* Hits BEHIND (z-index 10) */
}

/* RIGHT BATON LOGIC */
.svg-right {
  animation-name: right-kick-layer;
}

@keyframes right-kick-layer {
  0%,
  100% {
    transform: rotate(0deg);
    z-index: 15;
  }

  25% {
    transform: rotate(-40deg);
    z-index: 15;
  }

  /* Hits BEHIND (z-index 15) */
  50% {
    transform: rotate(0deg);
    z-index: 25;
  }

  75% {
    transform: rotate(-40deg);
    z-index: 25;
  }

  /* Hits on TOP (z-index 25) */
}

/* App Container */
.app-container {
  min-height: 100vh;
  /* fill viewport but allow content to grow beyond it */
  display: flex;
  min-height: 100vh;
  flex-direction: column;
  justify-content: space-between;
}

/* Navbar */
.navbar {
  background: var(--card-bg);
  padding: 0 20px;
  height: 64px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: var(--shadow);
  position: sticky;
  top: 0;
  z-index: 100;
}

.navbar-brand a {
  font-size: 1.5em;
  font-weight: 700;
  color: var(--primary-color);
  text-decoration: none;
}

.navbar-menu {
  display: flex;
  gap: 10px;
}

.nav-link {
  padding: 8px 16px;
  color: var(--text-color);
  text-decoration: none;
  border-radius: var(--radius-sm);
  transition: all 0.2s ease;
  font-weight: 500;
}

.nav-link:hover {
  background: rgba(102, 126, 234, 0.1);
  color: var(--primary-color);
}

.nav-link.active {
  background: var(--primary-color);
  color: white;
}

.navbar-auth {
  display: flex;
  align-items: center;
  gap: 15px;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 10px;
}

.user-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  object-fit: cover;
}

.navbar-toggle {
  display: none;
  background: none;
  border: none;
  font-size: 1.5em;
  cursor: pointer;
  color: var(--text-color);
}

/* Mobile navbar */
@media (max-width: 768px) {
  .navbar-menu {
    position: absolute;
    top: 64px;
    left: 0;
    right: 0;
    background: var(--card-bg);
    flex-direction: column;
    padding: 20px;
    display: none;
    box-shadow: var(--shadow);
  }

  .navbar-menu.active {
    display: flex;
  }

  .navbar-toggle {
    display: block;
  }

  .user-info span {
    display: none;
  }
}

/* Main Content */
.main-content {
  flex: 1 0 auto;
  /* allow main to grow but not shrink, occupying remaining space reliably */
  min-height: auto;
  /* allow content to expand naturally */
  padding: 20px;
  display: flex;
  flex-direction: column;
  overflow: auto;
  /* allow content to scroll within available space */
}

.container {
  max-width: 1000px;
  margin: 0 auto;
}

/* Hero Section */
.hero {
  text-align: center;
  padding: 80px 20px;
  background: linear-gradient(
    135deg,
    var(--primary-color) 0%,
    var(--secondary-color) 100%
  );
  border-radius: var(--radius);
  color: white;
  margin-bottom: 40px;
}

.hero h1 {
  font-size: 3em;
  margin-bottom: 15px;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
}

.hero .subtitle {
  font-size: 1.3em;
  opacity: 0.9;
  margin-bottom: 30px;
}

.hero-actions {
  display: flex;
  gap: 15px;
  justify-content: center;
  flex-wrap: wrap;
}

/* Features Grid */
.features-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 25px;
  max-width: 1000px;
  margin: 0 auto;
}

.feature-card {
  background: var(--card-bg);
  padding: 30px;
  border-radius: var(--radius);
  text-align: center;
  box-shadow: var(--shadow);
  transition: transform 0.3s ease;
}

.feature-card:hover {
  transform: translateY(-5px);
}

.feature-icon {
  font-size: 3em;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  justify-content: center;
  height: 80px;
}

.feature-card h3 {
  margin-bottom: 10px;
  color: var(--primary-color);
}

.feature-card p {
  color: var(--text-color);
}

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: var(--card-bg);
  padding: 25px;
  border-radius: var(--radius);
  text-align: center;
  box-shadow: var(--shadow);
}

.stat-value {
  font-size: 2.5em;
  font-weight: 700;
  color: var(--primary-color);
}

.stat-label {
  color: var(--text-muted);
  font-size: 0.9em;
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* Cards */
.card {
  background: var(--card-bg);
  border-radius: var(--radius);
  padding: 25px;
  margin-bottom: 20px;
  box-shadow: var(--shadow);
}

.card h2 {
  margin-bottom: 20px;
  color: var(--primary-color);
  border-bottom: 2px solid var(--border-color);
  padding-bottom: 10px;
}

/* Tables */
.members-filter {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.members-search-input {
  flex: 1;
  min-width: 200px;
  padding: 10px 14px;
  border: 2px solid var(--border-color);
  border-radius: var(--radius-sm);
  font-size: 1em;
  background: var(--card-bg);
  color: var(--text-color);
  transition:
    border-color 0.3s,
    box-shadow 0.3s;
}

.members-search-input:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
}

.members-filter-select {
  padding: 10px 14px;
  border: 2px solid var(--border-color);
  border-radius: var(--radius-sm);
  font-size: 1em;
  background: var(--card-bg);
  color: var(--text-color);
  cursor: pointer;
  min-width: 150px;
}

.members-filter-select:focus {
  outline: none;
  border-color: var(--primary-color);
}

.members-table-wrapper {
  overflow-x: auto;
}

table th.sortable {
  cursor: pointer;
  user-select: none;
  transition: background 0.2s;
}

table th.sortable:hover {
  background: rgba(102, 126, 234, 0.1);
}

.sort-icon {
  font-size: 0.8em;
  color: var(--primary-color);
}

table {
  width: 100%;
  border-collapse: collapse;
  background: var(--card-bg);
}

table th,
table td {
  padding: 12px 16px;
  text-align: left;
  border-bottom: 1px solid var(--border-color);
}

table th {
  background: var(--bg-color);
  font-weight: 600;
  color: var(--text-color);
  text-transform: uppercase;
  font-size: 0.85em;
  letter-spacing: 0.5px;
}

table tbody tr:hover {
  background: rgba(102, 126, 234, 0.05);
}

table tbody tr:last-child td {
  border-bottom: none;
}

.role {
  display: inline-block;
  background: rgba(102, 126, 234, 0.15);
  color: var(--primary-color);
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 0.85em;
  font-weight: 500;
  margin-right: 4px;
  margin-bottom: 4px;
}

.type-adult {
  color: var(--success-color);
  font-weight: 600;
}

.type-kid {
  color: var(--warning-color);
  font-weight: 600;
}

/* Clickable table rows */
.clickable-row {
  cursor: pointer;
  transition:
    background 0.2s,
    transform 0.1s;
}

.clickable-row:hover {
  background: rgba(102, 126, 234, 0.1) !important;
}

.clickable-row:active {
  transform: scale(0.995);
}

/* Inline edit action bar */
.members-edit-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--primary-color);
  color: white;
  padding: 12px 20px;
  border-radius: 8px;
  margin-bottom: 16px;
  box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.members-edit-actions .edit-info {
  font-weight: 500;
}

.members-edit-actions .edit-buttons {
  display: flex;
  gap: 12px;
}

.members-edit-actions .btn-secondary {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.members-edit-actions .btn-secondary:hover {
  background: rgba(255, 255, 255, 0.3);
}

.members-edit-actions .btn-primary {
  background: white;
  color: var(--primary-color);
}

.members-edit-actions .btn-primary:hover {
  background: rgba(255, 255, 255, 0.9);
}

/* Editing row styles */
.editing-row {
  background: rgba(102, 126, 234, 0.08) !important;
}

.editing-row:hover {
  background: rgba(102, 126, 234, 0.12) !important;
}

.inline-edit-input,
.inline-edit-select {
  width: 100%;
  padding: 8px 10px;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  font-size: 0.95em;
  background: var(--card-bg);
  color: var(--text-color);
  transition: border-color 0.2s;
}

.inline-edit-input:focus,
.inline-edit-select:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.15);
}

.inline-checkbox {
  font-size: 0.9em;
}

/* Edit button icon */
.btn-icon {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 1em;
  padding: 4px 8px;
  border-radius: 4px;
  transition: background 0.2s;
}

.btn-icon:hover {
  background: rgba(102, 126, 234, 0.15);
}

.btn-edit {
  opacity: 0.6;
  transition: opacity 0.2s;
}

.clickable-row:hover .btn-edit {
  opacity: 1;
}

/* Relations dropdown */
.inline-relations-dropdown {
  position: relative;
}

.btn-dropdown {
  padding: 6px 12px;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  background: var(--card-bg);
  color: var(--text-color);
  cursor: pointer;
  font-size: 0.9em;
  transition: border-color 0.2s;
}

.btn-dropdown:hover {
  border-color: var(--primary-color);
}

.relations-dropdown-content {
  position: absolute;
  top: 100%;
  left: 0;
  min-width: 200px;
  max-height: 200px;
  overflow-y: auto;
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 4px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  z-index: 100;
  padding: 8px;
}

.relations-dropdown-content .checkbox-label {
  display: block;
  padding: 6px 8px;
  border-radius: 4px;
}

.relations-dropdown-content .checkbox-label:hover {
  background: rgba(102, 126, 234, 0.1);
}

.text-muted {
  color: var(--text-secondary);
  font-style: italic;
}

.page-header .btn-back {
  margin-bottom: 15px;
}

.checkbox-group {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.checkbox-label {
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  font-weight: normal;
}

.checkbox-label input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.form-help {
  display: block;
  margin-top: 5px;
  font-size: 0.85em;
  color: var(--text-muted);
}

/* Checkbox list styling */
.checkbox-list {
  max-height: 150px;
  overflow-y: auto;
  padding: 10px;
  border: 2px solid var(--border-color);
  border-radius: var(--radius-sm);
  background: var(--card-bg);
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.checkbox-list .checkbox-label {
  margin: 0;
  padding: 6px 8px;
  border-radius: 4px;
  transition: background 0.2s;
}

.checkbox-list .checkbox-label:hover {
  background: rgba(102, 126, 234, 0.1);
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  flex-wrap: wrap;
  gap: 15px;
}

.page-header h1 {
  font-size: 2em;
  margin-bottom: 0;
}

.page-header p {
  color: var(--text-muted);
  width: 100%;
}

.page-header .btn .btn-icon {
  font-size: 1.2em;
  font-weight: bold;
  margin-right: 4px;
}

.page-title {
  display: flex;
  align-items: center;
  gap: 12px;
}

.btn-refresh {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 50%;
  cursor: pointer;
  color: var(--text-muted);
  transition: all 0.25s ease;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
}

.btn-refresh:hover {
  color: var(--primary-color);
  border-color: var(--primary-color);
  background: rgba(102, 126, 234, 0.08);
  box-shadow: 0 2px 6px rgba(102, 126, 234, 0.2);
  transform: scale(1.05);
}

.btn-refresh:active {
  transform: scale(0.95);
}

.btn-refresh:disabled {
  cursor: not-allowed;
  opacity: 0.6;
}

.btn-refresh .refresh-icon {
  width: 16px;
  height: 16px;
  flex-shrink: 0;
  transition: transform 0.3s ease;
}

.btn-refresh:hover .refresh-icon {
  transform: rotate(45deg);
}

.btn-refresh.refreshing .refresh-icon {
  transition: none;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  from {
    transform: rotate(0deg);
  }

  to {
    transform: rotate(360deg);
  }
}

/* Activity List */
.activity-list {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.activity-item {
  display: flex;
  align-items: flex-start;
  gap: 15px;
  padding: 15px;
  background: var(--bg-color);
  border-radius: var(--radius-sm);
}

.activity-icon {
  font-size: 1.5em;
}

.activity-content p {
  margin-bottom: 5px;
}

.activity-time {
  color: var(--text-muted);
  font-size: 0.85em;
}

/* Profile */
.profile-card {
  max-width: 600px;
}

.profile-header {
  display: flex;
  align-items: center;
  gap: 20px;
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 2px solid var(--border-color);
}

.profile-avatar {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  object-fit: cover;
  box-shadow: var(--shadow);
}

.profile-info h2 {
  border: none;
  padding: 0;
  margin: 0;
}

.member-type-badge {
  display: inline-block;
  padding: 4px 12px;
  background: var(--primary-color);
  color: white;
  border-radius: 20px;
  font-size: 0.85em;
  font-weight: 500;
  margin-top: 8px;
}

.profile-details {
  margin-bottom: 30px;
  padding: 20px;
  background: var(--background-color);
  border-radius: var(--radius-sm);
}

.detail-group {
  margin-bottom: 15px;
}

.detail-group:last-child {
  margin-bottom: 0;
}

.detail-group label {
  display: block;
  font-weight: 600;
  color: var(--text-muted);
  font-size: 0.85em;
  margin-bottom: 5px;
}

.detail-group span {
  color: var(--text-color);
}

.roles-list,
.relations-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 15px;
  font-size: 0.85em;
  font-weight: 500;
}

.badge-role {
  background: #e3f2fd;
  color: #1565c0;
}

.badge-relation {
  background: #f3e5f5;
  color: #7b1fa2;
}

/* Forms */
.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: var(--text-color);
}

.form-group input,
.form-group textarea,
.form-group select {
  width: 100%;
  padding: 12px 15px;
  border: 2px solid var(--border-color);
  border-radius: var(--radius-sm);
  font-size: 1em;
  background: var(--card-bg);
  color: var(--text-color);
  transition:
    border-color 0.3s,
    box-shadow 0.3s;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
}

.form-actions {
  margin-top: 25px;
}

/* Settings */
.settings-list {
  display: flex;
  flex-direction: column;
}

.setting-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 0;
  border-bottom: 1px solid var(--border-color);
}

.setting-item:last-child {
  border-bottom: none;
}

.setting-info h4 {
  margin-bottom: 5px;
}

.setting-info p {
  color: var(--text-muted);
  font-size: 0.9em;
}

/* Toggle Switch */
.toggle {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 28px;
}

.toggle input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--border-color);
  border-radius: 28px;
  transition: 0.3s;
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 22px;
  width: 22px;
  left: 3px;
  bottom: 3px;
  background: white;
  border-radius: 50%;
  transition: 0.3s;
}

.toggle input:checked + .toggle-slider {
  background: var(--primary-color);
}

.toggle input:checked + .toggle-slider:before {
  transform: translateX(22px);
}

/* Danger Zone */
.danger-zone h2 {
  color: var(--danger-color);
}

/* Buttons */
.btn {
  padding: 12px 25px;
  border: none;
  border-radius: var(--radius-sm);
  font-size: 1em;
  font-weight: 600;
  cursor: pointer;
  transition:
    transform 0.2s,
    box-shadow 0.2s,
    opacity 0.2s;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
}

.btn:active {
  transform: translateY(0);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.btn:focus {
  outline: none;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.4);
}

.btn:focus:not(:focus-visible) {
  box-shadow: none;
}

.btn:focus-visible {
  outline: none;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.4);
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

/* Button ripple effect */
.btn-ripple {
  position: absolute;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.4);
  transform: scale(0);
  animation: ripple-animation 0.6s ease-out forwards;
  pointer-events: none;
}

.btn-primary .btn-ripple,
.btn-success .btn-ripple,
.btn-danger .btn-ripple,
.floating-save-btn .btn-ripple,
.floating-share-btn .btn-ripple {
  background: rgba(255, 255, 255, 0.35);
}

.btn-outline .btn-ripple,
.btn-secondary .btn-ripple {
  background: rgba(102, 126, 234, 0.25);
}

@keyframes ripple-animation {
  0% {
    transform: scale(0);
    opacity: 1;
  }
  100% {
    transform: scale(2.5);
    opacity: 0;
  }
}

.btn-sm {
  padding: 8px 16px;
  font-size: 0.9em;
}

.btn-lg {
  padding: 16px 32px;
  font-size: 1.1em;
}

.btn-primary {
  background: linear-gradient(
    135deg,
    var(--primary-color) 0%,
    var(--secondary-color) 100%
  );
  color: white;
}

.btn-outline {
  background: transparent;
  border: 2px solid currentColor;
  color: var(--text-color);
}

.btn-outline:hover {
  background: rgba(102, 126, 234, 0.1);
}

.hero .btn-outline {
  color: white;
  border-color: white;
}

.btn-danger {
  background: var(--danger-color);
  color: white;
}

.btn-danger:hover {
  background: #c62828;
}

.btn-danger:active {
  background: #b71c1c;
}

.btn-success {
  background: var(--success-color);
  color: white;
}

.btn-success:hover {
  background: #2cc58a;
  filter: brightness(1.1);
}

.btn-success:active {
  background: #28a578;
  filter: brightness(0.95);
}

.btn-secondary {
  background: var(--bg-secondary, #e0e0e0);
  color: var(--text-color);
  border: 1px solid var(--border-color);
}

.btn-secondary:hover {
  background: var(--bg-hover, #d0d0d0);
}

.btn-secondary:active {
  background: var(--bg-active, #c0c0c0);
}

.dark-mode .btn-secondary {
  background: #424242;
  color: #fff;
  border-color: #616161;
}

.dark-mode .btn-secondary:hover {
  background: #515151;
}

.dark-mode .btn-secondary:active {
  background: #333333;
}

/* Login Page */
.login-container {
  display: flex;
  align-items: center;
  justify-content: center;
  /* Account for sticky navbar height */
  min-height: calc(100vh - 64px);
  padding: 48px 20px;
}

.login-card {
  background: var(--card-bg);
  border-radius: var(--radius);
  box-shadow: var(--shadow-lg);
  width: 100%;
  max-width: 520px;
  /* slightly wider for comfortable form layout */
  overflow: hidden;
}

.login-header {
  background: linear-gradient(
    135deg,
    var(--primary-color) 0%,
    var(--secondary-color) 100%
  );
  color: white;
  padding: 44px 32px;
  text-align: center;
}

.login-header h1 {
  font-size: 2.2em;
  margin-bottom: 6px;
  font-weight: 700;
}

.login-body {
  padding: 32px;
}

/* Make full-width Google button more usable */
.btn-google.btn-block {
  justify-content: flex-start;
}

.btn-google.btn-block .google-icon {
  margin-left: 6px;
  margin-right: 12px;
}

.btn-google .google-icon {
  background: transparent;
  padding: 0;
  border-radius: 3px;
}

.login-divider {
  display: flex;
  align-items: center;
  margin: 25px 0;
  color: var(--text-muted);
}

.login-divider::before,
.login-divider::after {
  content: "";
  flex: 1;
  height: 1px;
  background: var(--border-color);
}

.login-divider span {
  padding: 0 15px;
  font-size: 0.9em;
}

.login-info {
  color: var(--text-muted);
  font-size: 0.9em;
  line-height: 1.6;
}

/* Error Page */
.error-page {
  text-align: center;
  padding: 80px 20px;
}

.error-page h1 {
  font-size: 8em;
  color: var(--primary-color);
  line-height: 1;
  margin-bottom: 20px;
}

.error-page p {
  font-size: 1.5em;
  color: var(--text-muted);
  margin-bottom: 30px;
}

/* Toast Notifications */
.toast-container {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 2147483647;
  display: flex;
  flex-direction: column;
  gap: 10px;
  align-items: center;
  pointer-events: none;
}

.toast {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 15px 20px;
  background: var(--card-bg);
  border-radius: var(--radius-sm);
  box-shadow:
    0 10px 40px rgba(0, 0, 0, 0.3),
    0 0 0 1px rgba(0, 0, 0, 0.1);
  min-width: 280px;
  pointer-events: auto;
  animation: slideUpToast 0.3s ease forwards;
  border: 2px solid rgba(0, 0, 0, 0.08);
}

@keyframes slideUpToast {
  from {
    opacity: 0;
    transform: translateY(100px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.toast-remove {
  animation: slideDownToast 0.3s ease forwards !important;
}

@keyframes slideDownToast {
  from {
    opacity: 1;
    transform: translateY(0);
  }
  to {
    opacity: 0;
    transform: translateY(100px);
  }
}

.toast-icon {
  font-size: 1.2em;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.toast-success .toast-icon {
  background: var(--success-color);
  color: white;
}

.toast-error .toast-icon {
  background: var(--danger-color);
  color: white;
}

.toast-warning .toast-icon {
  background: var(--warning-color);
  color: white;
}

.toast-info .toast-icon {
  background: var(--info-color);
  color: white;
}

/* Footer */
.footer {
  background: var(--card-bg);
  padding: 20px;
  text-align: center;
  color: var(--text-muted);
  border-top: 1px solid var(--border-color);
  margin-top: auto;
  flex-shrink: 0;
  /* prevent footer from shrinking; keeps it at bottom */
}

/* Ensure footer content does not add extra space below */
.footer p {
  margin: 0;
}

/* Utility Classes */
.text-muted {
  color: var(--text-muted);
}

.loading {
  text-align: center;
  color: var(--text-muted);
  padding: 20px;
}

/* Animations */
.view {
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }

  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Responsive adjustments */

/* Tablet breakpoint */
@media (max-width: 992px) {
  .container {
    max-width: 100%;
    padding: 0 15px;
  }

  .hero {
    padding: 60px 20px;
  }

  .hero h1 {
    font-size: 2.5em;
  }

  .features-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
  }

  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }

  .profile-card {
    max-width: 100%;
  }
}

/* Mobile breakpoint */
@media (max-width: 768px) {
  /* Main content padding */
  .main-content {
    padding: 15px;
  }

  /* Navbar adjustments */
  .navbar {
    padding: 0 15px;
  }

  .navbar-brand a span {
    font-size: 0.9em;
  }

  .navbar-auth {
    gap: 10px;
  }

  /* Hero section */
  .hero {
    padding: 50px 20px;
    margin-bottom: 25px;
    border-radius: var(--radius-sm);
  }

  .hero h1 {
    font-size: 2em;
    margin-bottom: 10px;
  }

  .hero .subtitle {
    font-size: 1em;
    margin-bottom: 20px;
  }

  .hero-actions {
    flex-direction: column;
    gap: 10px;
  }

  .hero-actions .btn {
    width: 100%;
  }

  /* Features grid */
  .features-grid {
    grid-template-columns: 1fr;
    gap: 15px;
  }

  .feature-card {
    padding: 25px 20px;
  }

  .feature-icon {
    font-size: 2.5em;
  }

  /* Page headers */
  .page-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 15px;
    margin-bottom: 20px;
  }

  .page-header h1 {
    font-size: 1.6em;
  }

  .page-header .btn {
    width: 100%;
  }

  .page-title {
    width: 100%;
    justify-content: space-between;
  }

  /* Stats grid */
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }

  .stat-card {
    padding: 20px 15px;
  }

  .stat-value {
    font-size: 1.8em;
  }

  .stat-label {
    font-size: 0.75em;
  }

  /* Cards */
  .card {
    padding: 20px 15px;
    border-radius: var(--radius-sm);
  }

  .card h2 {
    font-size: 1.3em;
    margin-bottom: 15px;
  }

  /* Tables */
  .members-filter {
    flex-direction: column;
    gap: 10px;
  }

  .members-search-input,
  .members-filter-select {
    width: 100%;
    min-width: auto;
  }

  .members-table-wrapper {
    margin: 0 -15px;
    padding: 0 15px;
    overflow-x: auto;
    overflow-y: visible;
    -webkit-overflow-scrolling: touch;
  }

  table {
    min-width: 600px;
  }

  table th,
  table td {
    padding: 10px 12px;
    font-size: 0.9em;
  }

  table th {
    font-size: 0.75em;
  }

  /* Members edit actions */
  .members-edit-actions {
    flex-direction: column;
    gap: 12px;
    text-align: center;
  }

  .members-edit-actions .edit-buttons {
    width: 100%;
    justify-content: center;
  }

  /* Profile page */
  .profile-card {
    max-width: 100%;
  }

  .profile-header {
    flex-direction: column;
    text-align: center;
    gap: 15px;
  }

  .profile-avatar {
    width: 80px;
    height: 80px;
  }

  .profile-info h2 {
    font-size: 1.4em;
  }

  .profile-details {
    padding: 15px;
  }

  .roles-list,
  .relations-list {
    justify-content: center;
  }

  /* Login page */
  .login-container {
    padding: 20px 15px;
    min-height: calc(100vh - 180px);
  }

  .login-card {
    border-radius: var(--radius-sm);
  }

  .login-header {
    padding: 30px 20px;
  }

  .login-header h1 {
    font-size: 1.6em;
  }

  .login-body {
    padding: 25px 20px;
  }

  /* Forms */
  .form-group input,
  .form-group textarea,
  .form-group select {
    padding: 12px;
    font-size: 16px;
    /* Prevents zoom on iOS */
  }

  .form-actions-login {
    text-align: center;
  }

  /* Buttons */
  .btn {
    padding: 12px 20px;
  }

  .btn-lg {
    padding: 14px 24px;
    font-size: 1em;
  }

  .btn-block {
    width: 100%;
  }

  /* Activity list */
  .activity-item {
    flex-direction: column;
    gap: 10px;
    padding: 12px;
  }

  /* Settings */
  .setting-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 15px;
  }

  /* Toast notifications */
  .toast-container {
    left: 10px;
    right: 10px;
    transform: none;
    bottom: 15px;
  }

  .toast {
    min-width: auto;
    width: 100%;
  }

  /* Error page */
  .error-page {
    padding: 40px 20px;
  }

  .error-page h1 {
    font-size: 5em;
  }

  .error-page p {
    font-size: 1.2em;
  }

  /* Footer */
  .footer {
    padding: 15px;
    font-size: 0.9em;
  }
}

/* Small mobile breakpoint */
@media (max-width: 480px) {
  .navbar-brand a {
    font-size: 1.2em;
  }

  .navbar-brand a span {
    max-width: 185px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .hero h1 {
    font-size: 1.6em;
  }

  .hero .subtitle {
    font-size: 0.9em;
  }

  .stats-grid {
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  .stat-card {
    padding: 15px 10px;
  }

  .stat-value {
    font-size: 1.5em;
  }

  .feature-card {
    padding: 20px 15px;
  }

  .page-header h1 {
    font-size: 1.4em;
  }

  .card {
    padding: 15px 12px;
  }

  .login-header {
    padding: 25px 15px;
  }

  .login-header h1 {
    font-size: 1.4em;
  }

  .login-body {
    padding: 20px 15px;
  }

  /* Inline edit inputs */
  .inline-edit-input,
  .inline-edit-select {
    padding: 6px 8px;
    font-size: 0.85em;
  }

  /* Dropdown */
  .relations-dropdown-content {
    min-width: 180px;
    max-width: calc(100vw - 40px);
  }

  .user-menu {
    min-width: 150px;
    right: -10px;
  }
}

/* Extra small devices */
@media (max-width: 360px) {
  .navbar {
    height: 56px;
    padding: 0 10px;
  }

  .navbar-brand a {
    font-size: 1em;
  }

  .navbar-brand a span {
    max-width: 175px;
  }

  .navbar-toggle {
    font-size: 1.3em;
  }

  .main-content {
    padding: 10px;
  }

  .hero {
    padding: 35px 15px;
  }

  .hero h1 {
    font-size: 1.4em;
  }

  .page-header h1 {
    font-size: 1.2em;
  }

  .btn {
    padding: 10px 16px;
    font-size: 0.9em;
  }

  .toast {
    width: 100%;
    padding: 12px 15px;
  }

/* Touch-friendly improvements for mobile */
@media (hover: none) and (pointer: coarse) {
  .nav-link {
    padding: 12px 16px;
  }

  .btn {
    min-height: 44px;
  }

  .clickable-row td {
    padding: 14px 12px;
  }

  .checkbox-label {
    padding: 10px;
    gap: 12px;
  }

  .checkbox-label input[type="checkbox"] {
    width: 22px;
    height: 22px;
  }

  .user-menu .user-menu-item {
    padding: 12px 16px;
  }

  .toggle {
    width: 56px;
    height: 32px;
  }

  .toggle-slider:before {
    height: 26px;
    width: 26px;
  }

  .toggle input:checked + .toggle-slider:before {
    transform: translateX(24px);
  }
}

/* Landscape orientation on mobile */
@media (max-height: 500px) and (orientation: landscape) {
  .login-container {
    min-height: auto;
    padding: 20px;
  }

  .login-header {
    padding: 20px;
  }

  .hero {
    padding: 30px 20px;
  }
}

/* Print styles */
@media print {
  .navbar,
  .footer,
  .toast-container,
  .btn,
  .navbar-toggle {
    display: none !important;
  }

  .main-content {
    padding: 0;
  }

  .card {
    box-shadow: none;
    border: 1px solid #ccc;
  }
}

        </style>
        
    </head>
    <body>
        <!-- Loading Screen -->
<div id="loading-screen" class="loading-screen">
    <div class="loader-container">
        <!-- Left Baton SVG -->
        <svg viewBox="0 0 200 200" class="baton-svg svg-left">
            <rect class="baton" x="40" y="20" width="20" height="160" rx="10" fill="var(--baton-left)" stroke="#000"
                stroke-width="4" />
        </svg>
        <!-- Right Baton SVG -->
        <svg viewBox="0 0 200 200" class="baton-svg svg-right">
            <rect class="baton" x="140" y="20" width="20" height="160" rx="10" fill="var(--baton-right)"
                stroke="#000" stroke-width="4" />
        </svg>
    </div>
    <!--<p>Carregant...</p>-->
</div>
        
        <!-- App Container -->
<div id="app" class="app-container" style="display: none;">
    <!-- Navigation Bar -->
<nav id="navbar" class="navbar">
    <div class="navbar-brand">
        <a href="#" data-route="home" style="display: flex; align-items: center; gap: 8px;">
            <span class="brand-text">TEST</span>
        </a>
    </div>
    <button class="navbar-toggle auth-required" id="navbar-toggle" aria-label="Toggle navigation menu" style="display: none;">‚ò∞</button>
    <div class="navbar-menu" id="navbar-menu">
        <!-- Mobile user info section (shown only in mobile menu) -->
        <div id="mobile-user-section" class="mobile-user-section auth-required" style="display: none;">
            <div class="mobile-user-info">
                <img id="mobile-user-avatar" class="mobile-user-avatar" src="" alt="User">
                <span id="mobile-user-name" class="mobile-user-name"></span>
            </div>
            <div class="mobile-user-actions">
                <a href="#" class="nav-link" data-menu-view="profile">Perfil</a>
                <a href="#" class="nav-link" data-menu-view="dashboard">Tauler</a>
                <a href="#" id="mobile-logout-btn" class="nav-link mobile-logout">Tancar sessi√≥</a>
            </div>
            <div class="mobile-user-divider"></div>
        </div>
        <a href="#" data-route="members" class="nav-link auth-required admin-only">Administraci√≥</a>
        <a href="#" data-route="planning-event" class="nav-link auth-required">Actuacions</a>
        <a href="#" data-route="planning-training" class="nav-link auth-required">Assajos</a>
    </div>
    <div class="navbar-auth">
        <div id="user-info" class="user-info" style="display: none;">
            <div class="user-menu-trigger">
                <div class="member-name" style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;">
                    <img id="user-avatar" class="user-avatar" src="" alt="User" style="cursor:pointer;">
                    <span id="user-name" class="user-name-text"></span>
                </div>
                <div id="user-menu" class="user-menu">
                    <a href="#" class="user-menu-item" data-menu-view="profile">Perfil</a>
                    <a href="#" class="user-menu-item" data-menu-view="dashboard">Tauler</a>
                    <div class="user-menu-divider" style="height:1px;background:#eee;margin:0.3rem 0;"></div>
                    <a href="#" id="logout-btn" class="user-menu-item" style="font-weight:600;">Tancar
                        sessi√≥</a>
                </div>
            </div>
        </div>
    </div>
</nav>

<style>
/* Mobile navbar enhancements */

/* Ensure navbar toggle is hidden on desktop */
.navbar-toggle {
  display: none !important;
}

@media (max-width: 768px) {
  .navbar-menu {
    position: fixed;
    top: 64px;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--card-bg);
    flex-direction: column;
    padding: 20px;
    display: none;
    box-shadow: var(--shadow);
    z-index: 99;
    overflow-y: auto;
  }

  .navbar-menu.active {
    display: flex;
  }

  .navbar-menu .nav-link {
    padding: 15px 20px;
    font-size: 1.1em;
    border-bottom: 1px solid var(--border-color);
  }

  .navbar-toggle:not(.auth-required[style*="display: none"]) {
    display: flex !important;
    align-items: center;
    justify-content: center;
    order: 3;
    width: 44px;
    height: 44px;
    margin-left: auto;
  }

  .navbar-toggle.auth-required {
    display: none !important;
  }

  .navbar-auth {
    order: 2;
  }

  /* Hide desktop user info on mobile */
  .navbar-auth .user-info {
    display: none !important;
  }

  /* Mobile user section styles */
  .mobile-user-section {
    display: flex !important;
    flex-direction: column;
    padding-bottom: 10px;
    margin-bottom: 10px;
  }

  .mobile-user-info {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 15px 20px;
    background: rgba(102, 126, 234, 0.05);
    border-radius: var(--radius-sm);
    margin-bottom: 10px;
  }

  .mobile-user-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--primary-color);
  }

  .mobile-user-name {
    font-weight: 600;
    font-size: 1.1em;
    color: var(--text-color);
  }

  .mobile-user-actions {
    display: flex;
    flex-direction: column;
  }

  .mobile-user-actions .nav-link {
    padding: 12px 20px;
    font-size: 1em;
  }

  .mobile-logout {
    color: var(--danger-color) !important;
    font-weight: 600;
  }

  .mobile-user-divider {
    height: 1px;
    background: var(--border-color);
    margin: 15px 0 5px 0;
  }

  .user-name-text {
    display: none;
  }

  .brand-text {
    max-width: 250px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
}

/* Hide mobile user section on desktop */
.mobile-user-section {
  display: none;
}

@media (max-width: 480px) {
  .brand-text {
    max-width: 250px;
  }
}

@media (max-width: 360px) {
  .brand-text {
    max-width: 250px;
    font-size: 0.85em;
  }

  .navbar-brand svg {
    width: 28px;
    height: 28px;
  }
}

.user-menu {
  display: none;
  position: absolute;
  right: 0;
  top: 100%;
  background: #fff;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
  z-index: 1000;
  min-width: 170px;
  padding: 0.5rem 0;
  font-size: 1rem;
  margin-top: 0.5rem;
}

.user-menu .user-menu-item {
  display: block;
  padding: 0.6rem 1.2rem;
  color: #333;
  text-decoration: none;
  transition:
    background 0.2s,
    color 0.2s;
  border: none;
  background: none;
  cursor: pointer;
}

.user-menu .user-menu-item:hover,
.user-menu .user-menu-item:focus {
  background: #f5f5f5;
  color: #1976d2;
  outline: none;
}

.user-menu .user-menu-item:active {
  background: #e3e3e3;
  color: #0d47a1;
}

#logout-btn {
  color: var(--danger-color) !important;
  font-weight: 600;
}

.user-menu-trigger {
  position: relative;
}

.member-name {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  cursor: pointer;
}

@media (max-width: 768px) {
  .user-menu {
    right: -10px;
    min-width: 160px;
  }
}

</style>


    <!-- Main Content Area -->
<main id="main-content" class="main-content">

    <!-- Home View -->
    <div id="view-home" class="view" data-view="home" style="display: none;">
        <div class="hero">
            <h1>Hola <span id="home-user-name"></span>!</h1>
            <div class="features-grid">
                <div class="feature-card" data-route="planning-event" style="cursor: pointer;">
                    <div class="feature-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"
                            width="64px" height="64px" aria-hidden="true" style="flex-shrink: 0;">
                            <rect x="44" y="10" width="12" height="80" rx="4" ry="4" fill="#8b5a2b"
                                stroke="#000" stroke-width="5" transform="rotate(45 50 50)" />
                            <rect x="44" y="10" width="12" height="80" rx="4" ry="4" fill="#a86830"
                                stroke="#000" stroke-width="5" transform="rotate(-45 50 50)" />
                        </svg></div>
                    <h3>Properes actuacions</h3>
                    <span id="next-event-text">Carregant...</span>
                </div>
                <div class="feature-card" data-route="planning-training" style="cursor: pointer;">
                    <div class="feature-icon">üí™</div>
                    <h3>Assajos programats</h3>
                    <span id="next-training-text">Carregant...</span>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Home page mobile styles */
        @media (max-width: 768px) {
            #view-home {
                padding: 0;
            }

            #view-home .hero {
                margin: 0 0 25px 0;
                border-radius: 0;
            }

            #view-home .features-grid {
                padding: 0 15px 15px;
            }
        }

        @media (max-width: 480px) {
            #view-home .hero {
                padding: 40px 20px;
            }

            #view-home .feature-card h3 {
                font-size: 1.1em;
            }

            #view-home .feature-card p {
                font-size: 0.9em;
            }
        }
    </style>

    <div id="view-home-guest" class="view" data-view="home-guest">
        <div class="hero">
            <div class="hero-content">
                <h1>Benvingudes a TEST</h1>
                <p class="subtitle">Inicia sessi√≥ per accedir a les teues dades personals a m√©s de la informaci√≥
                    d'assajos i actuacions</p>

                <div class="hero-actions">
                    <a href="#" class="btn btn-outline" data-route="login">
                        <span class="mail-icon" aria-hidden="true">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                            </svg>
                        </span>
                        <span>Accedir amb compte</span>
                    </a>

                    <button type="button" class="btn btn-mail" id="mail-login-btn-guest"
                        aria-label="Enviar acc√©s al correu">
                        <span class="mail-icon" aria-hidden="true">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                <polyline points="22,6 12,13 2,6"></polyline>
                            </svg>
                        </span>
                        <span>Enviar acc√©s al correu</span>
                    </button>
                </div>

                <p class="redirect-message">Has estat redirigit ac√≠ perqu√® no tens una sessi√≥ activa. Si us
                    plau, inicia sessi√≥ per accedir al tauler.</p>

                <p style="margin-top:6px;color:rgba(255,255,255,0.9);">No tens compte? <a href="#"
                        data-route="register" class="register-link">Registra't</a></p>
            </div>

            <div class="hero-illustration" aria-hidden="true">
                <svg width="480" height="320" viewBox="0 0 480 320" xmlns="http://www.w3.org/2000/svg"
                    role="img" aria-hidden="true">
                    <defs>
                        <linearGradient id="g1" x1="0" x2="1">
                            <stop offset="0" stop-color="#fff" stop-opacity="0.9" />
                            <stop offset="1" stop-color="#fff" stop-opacity="0.6" />
                        </linearGradient>
                    </defs>
                    <rect x="0" y="0" width="100%" height="100%" fill="none" />
                    <!-- Simple abstract illustration: staff and notes -->
                    <g transform="translate(40,40)">
                        <rect x="0" y="40" width="280" height="6" rx="3" fill="#ffffff" fill-opacity="0.12" />
                        <rect x="0" y="70" width="240" height="6" rx="3" fill="#ffffff" fill-opacity="0.08" />
                        <circle cx="60" cy="50" r="14" fill="#ffffff" fill-opacity="0.92" />
                        <circle cx="120" cy="50" r="10" fill="#ffffff" fill-opacity="0.85" />
                        <path d="M170 30 v40 a8 8 0 1 0 0-16 v-24" fill="#ffffff" fill-opacity="0.9" />
                    </g>
                </svg>
            </div>
        </div>

        <div class="container">
            <div class="features-grid" style="margin-top:30px">
                <div class="feature-card">
                    <div class="feature-icon">üìÖ</div>
                    <h3>Planifica el teu temps</h3>
                    <p>Calendari i recordatoris d'assajos i actuacions.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üë•</div>
                    <h3>Acc√©s familiar</h3>
                    <p>Gestiona l'assist√®ncia dels membres de la teua familia.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üîí</div>
                    <h3>Autenticaci√≥ segura</h3>
                    <p>Inicia sessi√≥ amb el teu correu per accedir a la teua informaci√≥ de forma
                        segura.</p>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Guest home specifics */
        #view-home-guest .hero {
            padding: 72px 20px;
            border-radius: var(--radius);
            color: white;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        #view-home-guest .hero .hero-content {
            position: relative;
            z-index: 2;
            max-width: 980px;
            margin: 0 auto;
        }

        #view-home-guest .hero .hero-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            align-items: center;
            margin-top: 22px;
            flex-direction: column;
        }

        /* On larger screens align actions horizontally like the reference */
        @media (min-width: 720px) {
            #view-home-guest .hero .hero-actions {
                flex-direction: row;
                justify-content: center;
                gap: 16px;
            }

            .btn.full-width {
                width: auto;
                min-width: 240px;
            }
        }

        #view-home-guest .hero-illustration {
            position: absolute;
            right: -20px;
            top: 10px;
            width: 45%;
            max-width: 440px;
            opacity: 0.14;
            pointer-events: none;
            z-index: 1;
        }

        #view-home-guest .redirect-message {
            font-size: 0.95em;
            margin-top: 12px;
            background: rgba(255, 255, 255, 0.06);
            padding: 10px 14px;
            border-radius: 8px;
            display: inline-block;
            color: rgba(255, 255, 255, 0.95);
        }

        #view-home-guest .hero h1 {
            font-size: 2.2em;
            margin-bottom: 8px;
        }

        #view-home-guest .hero .subtitle {
            font-size: 1.05em;
            opacity: 0.95;
            margin-bottom: 20px;
        }

        .btn.btn-outline {
            display: inline-flex;
            align-items: center;
            justify-content: flex-start;
            padding: 10px 16px;
            border: 1px solid #dadce0;
            color: rgba(0, 0, 0, 0.87);
            background: #fff;
            border-radius: 4px;
            text-decoration: none;
            font-weight: 600;
            transition: background 0.12s ease, border-color 0.12s ease;
            width: auto;
        }

        .btn.btn-outline:hover {
            background: #f7f7f7;
            border-color: #cfcfcf;
        }

        @media (max-width: 768px) {
            #view-home-guest .hero {
                padding: 40px 16px;
            }

            .hero-actions {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
                width: 100%;
                max-width: 280px;
                margin: 0 auto;
            }

            .hero-actions .btn {
                width: 100%;
                justify-content: center;
            }

            #view-home-guest .hero-illustration {
                display: none;
            }
        }
    </style>

    <!-- Dashboard View (Auth Required) -->
    <div id="view-dashboard" class="view" data-view="dashboard" data-auth="required" style="display: none;">
        <div class="container">
            <div class="page-header">
                <h1>Tauler</h1>
                <p>Informaci√≥ sobre <span class="user-display-name"></span></p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="stat-training-count">-</div>
                    <div class="stat-label">Assajos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-event-count">-</div>
                    <div class="stat-label">Actuacions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-dance-count">-</div>
                    <div class="stat-label">Balls</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-position-count">-</div>
                    <div class="stat-label">Posicions diferents</div>
                </div>
            </div>

            <div class="card">
                <h2>Activitat recent</h2>
                <div id="activity-list" class="activity-list">
                    <p class="loading">Carregant activitat...</p>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Dashboard page mobile styles */
        @media (max-width: 768px) {
            #view-dashboard .page-header {
                text-align: center;
            }

            #view-dashboard .page-header p {
                margin-top: 5px;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .stat-card {
                padding: 15px 10px;
            }

            .stat-value {
                font-size: 1.6em;
            }

            .stat-label {
                font-size: 0.7em;
            }

            .activity-item {
                padding: 10px;
            }

            .activity-icon {
                font-size: 1.2em;
            }

            .activity-content p {
                font-size: 0.9em;
            }

            .activity-time {
                font-size: 0.75em;
            }
        }
    </style>

    <!-- Profile View (Auth Required) -->
    <div id="view-profile" class="view" data-view="profile" data-auth="required" style="display: none;">
        <div class="container">
            <div class="page-header">
                <h1>Perfil</h1>
            </div>

            <div class="card profile-card">
                <div class="profile-header">
                    <img id="profile-avatar" class="profile-avatar" src="" alt="Perfil">
                    <div class="profile-info">
                        <h2 id="profile-name"></h2>
                        <p id="profile-email" class="text-muted"></p>
                        <p id="profile-member-type" class="member-type-badge"></p>
                    </div>
                </div>

                <!-- Related Members Section -->
                <div id="related-members-section" class="related-members-section" style="display: none;">
                    <div id="related-members-list" class="related-members-list">
                        <!-- Each related member will use profile-header structure -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Related Members Section */
        .related-members-section {
            margin-top: 20px;
        }

        .related-members-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .related-members-list .profile-header {
            margin-bottom: 0;
        }

        /* Profile page mobile styles */
        @media (max-width: 768px) {
            .profile-card {
                max-width: 100%;
            }

            .profile-header {
                flex-direction: column;
                text-align: center;
                padding-bottom: 15px;
                margin-bottom: 20px;
            }

            .profile-info h2 {
                font-size: 1.3em;
            }

            .profile-info .text-muted {
                font-size: 0.9em;
                word-break: break-all;
            }

            .profile-details {
                padding: 15px;
            }

            .detail-group {
                margin-bottom: 20px;
            }

            .roles-list,
            .relations-list {
                justify-content: flex-start;
            }

            .badge {
                font-size: 0.8em;
                padding: 3px 8px;
            }

            .related-members-list {
                grid-template-columns: 1fr;
            }

            .related-member-card {
                padding: 10px;
            }
        }

        @media (max-width: 480px) {
            .profile-avatar {
                width: 70px;
                height: 70px;
            }

            .member-type-badge {
                font-size: 0.8em;
                padding: 3px 10px;
            }
        }
    </style>

    <!-- Login Dialog Modal -->
    <dialog id="view-login" class="login-dialog">
        <div class="login-card">
            <button type="button" class="login-close-btn" id="login-close-btn" aria-label="Tancar">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <div class="login-header">
                <h1>Benvingut/da de nou</h1>
            </div>
            <div class="login-body">
                <form id="login-form" class="login-form">
                    <div class="form-group">
                        <label for="login-email">Correu electr√≤nic</label>
                        <input type="email" id="login-email" name="email"
                            placeholder="Introdueix el teu correu electr√≤nic" autocomplete="email" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Contrasenya</label>
                        <input type="password" id="login-password" name="password"
                            placeholder="Introdueix la teua contrasenya" autocomplete="current-password" required>
                    </div>
                    <div class="form-group form-actions-login">
                        <a href="#" id="forgot-password-link" class="forgot-password-link">Has oblidat la
                            contrasenya?</a>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block" id="email-login-btn">Iniciar
                        sessi√≥</button>

                    <div class="divider"><span>o</span></div>

                    <button type="button" class="btn btn-mail btn-block" id="mail-login-btn"
                        aria-label="Enviar acc√©s al correu">
                        <span class="mail-icon" aria-hidden="true">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                                <polyline points="22,6 12,13 2,6"></polyline>
                            </svg>
                        </span>
                        <span>Enviar acc√©s al correu</span>
                    </button>
                </form>
                <p class="login-info">
                    No tens un compte? <a href="#" id="signup-link" class="signup-link">Registra't</a>
                </p>
            </div>
        </div>
    </dialog>

    <style>
        /* Login dialog modal styles */
        #view-login {
            padding: 0;
            border: none;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
            max-width: 420px;
            width: 90vw;
            background: var(--card-bg);
            color: var(--text-color);
            overflow: visible;
        }

        #view-login::backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        #view-login[open] {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }

        .login-card {
            position: relative;
            width: 100%;
            padding: 1.5em;
            padding-top: 3em;
        }

        .login-close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s;
            z-index: 10;
        }

        .login-close-btn:hover {
            background: rgba(0, 0, 0, 0.06);
        }

        .dark-mode .login-close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .login-close-btn:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.3);
        }

        .login-close-btn svg {
            width: 24px;
            height: 24px;
            stroke-width: 2;
        }

        /* Login page anchor styles */
        .forgot-password-link,
        .login-info a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s ease;
        }

        .forgot-password-link:hover,
        .login-info a:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }

        /* Readability improvements */
        .login-body {
            font-size: 15px;
            line-height: 1.65;
            color: var(--text-color);
        }

        .login-body .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 8px;
        }

        .form-group input {
            padding: 14px 16px;
            font-size: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            width: 100%;
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.12);
        }

        input::placeholder {
            color: #9aa2ad;
        }

        .btn-primary {
            padding: 12px 18px;
            font-size: 1rem;
            border-radius: 8px;
            font-weight: 700;
        }

        .btn:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.12);
        }

        .login-info {
            margin-top: 14px;
            color: var(--text-muted);
        }

        .login-info a {
            font-weight: 600;
        }

        /* Google sign-in button */
        .divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 16px 0;
            color: var(--text-muted);
            font-weight: 600;
        }

        .divider::before,
        .divider::after {
            content: "";
            flex: 1 1 auto;
            height: 1px;
            background: var(--border-color);
        }

        .divider span {
            display: inline-block;
            padding: 0 12px;
            background: var(--card-bg);
            color: var(--text-muted);
            font-size: 0.95em;
            border-radius: 999px;
            z-index: 1;
        }

        .btn-mail {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            height: 40px;
            padding: 0 16px;
            background: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.35);
            border-radius: 4px;
            font-weight: 500;
            font-size: 14px;
            line-height: 40px;
            cursor: pointer;
            transition: background 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
            box-shadow: none;
            text-align: left;
        }

        .btn-mail:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.6);
        }

        .btn-mail:active {
            background: #f0f0f0;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.06);
        }

        .btn-mail:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.3);
        }

        .btn-mail:focus:not(:focus-visible) {
            box-shadow: none;
        }

        .btn-mail:disabled {
            opacity: 0.6;
            cursor: default;
        }

        .btn-mail .mail-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
        }

        .btn-mail .mail-icon svg {
            width: 18px;
            height: 18px;
            display: block;
            flex-shrink: 0;
        }

        .btn-mail>span:last-child {
            display: inline-block;
            vertical-align: middle;
            margin-top: -1px;
        }

        @media (max-width: 768px) {
            #view-login {
                max-width: 90vw;
            }
        }

        @media (max-width: 480px) {
            #view-login {
                max-width: 95vw;
            }

            .login-card {
                padding: 1.5em;
                padding-top: 2.5em;
            }

            .login-header h1 {
                font-size: 1.5em;
            }

            .login-header p {
                font-size: 0.95em;
            }

            .login-body {
                font-size: 14px;
            }

            .form-group label {
                font-size: 0.95em;
            }

            .form-group input {
                font-size: 16px;
                /* Prevents zoom on iOS */
            }

            .forgot-password-link {
                font-size: 0.95em;
            }

            .login-info {
                font-size: 0.9em;
            }

            .btn-mail {
                height: 36px;
                font-size: 13px;
                padding: 0 12px;
                gap: 10px;
            }

            .btn-mail .mail-icon {
                width: 16px;
                height: 16px;
            }
        }
    </style>

    <!-- Register Dialog Modal -->
    <dialog id="view-register" class="register-dialog">
        <div class="login-card">
            <button type="button" class="login-close-btn" id="register-close-btn" aria-label="Tancar">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <div class="login-header">
                <h1>Registre</h1>
            </div>
            <div class="login-body">
                <form id="register-form" class="login-form">
                    <div class="form-group">
                        <label for="register-name">Nom en la colla</label>
                        <input type="text" id="register-name" name="name"
                            placeholder="Introdueix el teu nom en la colla" autocomplete="name" required>
                    </div>
                    <div class="form-group">
                        <label for="register-email">Email</label>
                        <input type="email" id="register-email" name="email"
                            placeholder="Introdueix el teu correu electr√≤nic" autocomplete="email" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block"
                        id="register-btn">Registrar-se</button>
                </form>
                <p class="login-info">
                    Ja tens un compte? <a href="#" id="login-link" class="login-link">Inicia sessi√≥</a>
                </p>
            </div>
        </div>
    </dialog>

    <style>
        /* Register dialog modal styles */
        #view-register {
            padding: 0;
            border: none;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
            max-width: 420px;
            width: 90vw;
            background: var(--card-bg);
            color: var(--text-color);
            overflow: visible;
        }

        #view-register::backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        #view-register[open] {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }

        #view-register .login-card {
            position: relative;
            width: 100%;
            padding: 1.5em;
            padding-top: 3em;
        }

        #register-close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s;
            z-index: 10;
        }

        #register-close-btn:hover {
            background: rgba(0, 0, 0, 0.06);
        }

        .dark-mode #register-close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        #register-close-btn:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.3);
        }

        #register-close-btn svg {
            width: 24px;
            height: 24px;
            stroke-width: 2;
        }

        @media (max-width: 768px) {
            #view-register {
                max-width: 90vw;
            }
        }

        @media (max-width: 480px) {
            #view-register {
                max-width: 95vw;
            }

            #view-register .login-card {
                padding: 1.5em;
                padding-top: 2.5em;
            }

            #view-register .login-header h1 {
                font-size: 1.5em;
            }

            #view-register .login-header p {
                font-size: 0.9em;
            }

            #view-register .login-body {
                font-size: 14px;
            }

            #view-register .form-group label {
                font-size: 0.9em;
            }

            #view-register .form-group input {
                font-size: 16px;
                /* Prevents zoom on iOS */
            }

            #view-register .login-info {
                font-size: 0.85em;
            }
        }
    </style>


    <!-- Planning View -->
    <div id="view-planning-event" class="view" data-view="planning-event" style="display: none;">
        <div class="container">
            <div class="page-header d-flex justify-content-between align-items-start admin-only">
                <div>
                    <h1>Planificaci√≥</h1>
                    <p class="lead">Gestiona i planifica les teues actuacions ac√≠.</p>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-primary" data-route="edit-event">Nova actuaci√≥</button>
                </div>
            </div>

            <!-- Events List Section -->
            <div class="planning-event-section">
                <div class="section-header">
                    <h2>Actuacions</h2>
                    <button type="button" class="btn-refresh" id="refresh-event-btn" style="display: none;"
                        title="Actualitzar llista">
                        <svg class="refresh-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8" />
                            <path d="M21 3v5h-5" />
                        </svg>
                    </button>
                </div>

                <!-- Upcoming/Current Events -->
                <div id="planning-event-list" class="planning-event-list">
                    <div class="events-loading">
                        <div class="spinner"></div>
                        <span>Carregant actuacions...</span>
                    </div>
                </div>

                <!-- Past Events Collapsible -->
                <div class="past-event-collapsible">
                    <button type="button" class="collapsible-toggle" id="past-event-toggle"
                        style="display: none;">
                        <span class="toggle-icon">‚ñ∂</span>
                        <span class="toggle-text">Actuacions passades</span>
                        <span class="past-event-count" id="past-event-count"></span>
                    </button>
                    <div class="collapsible-content" id="past-event-list" style="display: none;">
                        <!-- Past events will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Planning Events Section Styles */
        .planning-event-section {
            margin-top: 30px;
        }

        .planning-event-section .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 12px;
        }

        .planning-event-section .section-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: #333;
            flex: 0 0 auto;
        }

        .dark-mode .planning-event-section .section-header h2 {
            color: #fff;
        }

        .planning-event-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .past-event-collapsible {
            margin-top: 30px;
        }

        .collapsible-toggle {
            width: 100%;
            padding: 14px 16px;
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
        }

        .collapsible-toggle:hover {
            background: #eeeeee;
            border-color: #1976d2;
        }

        .collapsible-toggle:active {
            background: #e0e0e0;
            transform: scale(0.99);
        }

        .collapsible-toggle:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.3);
        }

        .collapsible-toggle:focus:not(:focus-visible) {
            box-shadow: none;
        }

        .dark-mode .collapsible-toggle {
            background: #3a3a3a;
            border-color: #555;
            color: #fff;
        }

        .dark-mode .collapsible-toggle:hover {
            background: #444;
            border-color: #4fc3f7;
        }

        .dark-mode .collapsible-toggle:active {
            background: #383838;
        }

        .toggle-icon {
            display: inline-block;
            transition: transform 0.3s ease;
            font-size: 0.9rem;
        }

        .collapsible-toggle.active .toggle-icon {
            transform: rotate(90deg);
        }

        .toggle-text {
            flex: 1;
            text-align: left;
        }

        .past-event-count {
            font-size: 0.9rem;
            background: #1976d2;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            min-width: 28px;
            text-align: center;
        }

        .dark-mode .past-event-count {
            background: #4fc3f7;
            color: #000;
        }

        .collapsible-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 12px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 8px;
            border-left: 3px solid #999;
        }

        .dark-mode .collapsible-content {
            background: rgba(255, 255, 255, 0.05);
            border-left-color: #666;
        }

        /* Planning Training Section Styles - same as event section */
        .planning-training-section {
            margin-top: 30px;
        }

        .planning-training-section .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 12px;
        }

        .planning-training-section .section-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: #333;
            flex: 0 0 auto;
        }

        .dark-mode .planning-training-section .section-header h2 {
            color: #fff;
        }

        .planning-training-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .past-training-collapsible {
            margin-top: 30px;
        }

        .past-training-count {
            font-size: 0.9rem;
            background: #1976d2;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            min-width: 28px;
            text-align: center;
        }

        .dark-mode .past-training-count {
            background: #4fc3f7;
            color: #000;
        }

        .past-event-empty {
            padding: 20px;
            text-align: center;
            color: #999;
            font-size: 0.9rem;
        }

        .dark-mode .past-event-empty {
            color: #777;
        }

        .events-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 40px;
            color: #666;
        }

        .events-loading .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #e0e0e0;
            border-top-color: #1976d2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .dark-mode .events-loading {
            color: #aaa;
        }

        .event-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            transition: all 0.2s;
        }

        .event-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-color: #1976d2;
        }

        .dark-mode .event-card {
            background: #2a2a2a;
            border-color: #444;
        }

        .dark-mode .event-card:hover {
            border-color: #4fc3f7;
        }

        .event-card-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
            min-width: 0;
        }

        .event-card-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            word-break: break-word;
        }

        .dark-mode .event-card-name {
            color: #fff;
        }

        .event-card-date {
            font-size: 0.9rem;
            color: #666;
        }

        .dark-mode .event-card-date {
            color: #aaa;
        }

        .event-card-place {
            font-size: 0.85rem;
            color: #888;
            text-decoration: none;
        }

        .dark-mode .event-card-place {
            color: #999;
        }

        .event-card-actions {
            display: flex;
            gap: 8px;
        }

        .event-card-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .event-card-btn.view-btn {
            background: #1976d2;
            color: #fff;
        }

        .event-card-btn.view-btn:hover {
            background: #1565c0;
        }

        .event-card-btn.view-btn:active {
            background: #0d47a1;
            transform: scale(0.97);
        }

        .event-card-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.3);
        }

        .event-card-btn:focus:not(:focus-visible) {
            box-shadow: none;
        }

        .events-empty {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .dark-mode .events-empty {
            color: #aaa;
        }

        .events-empty-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        @media (max-width: 600px) {
            .planning-event-section {
                width: 100%;
                box-sizing: border-box;
            }

            .planning-event-list {
                width: 100%;
                box-sizing: border-box;
            }

            .event-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
                width: 100%;
                box-sizing: border-box;
            }

            .event-card-actions {
                width: 100%;
            }

            .event-card-btn {
                flex: 1;
            }
        }

        /* Training Card Styles */
        .training-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            transition: all 0.2s;
        }

        .training-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-color: #1976d2;
        }

        .dark-mode .training-card {
            background: #2a2a2a;
            border-color: #444;
        }

        .dark-mode .training-card:hover {
            border-color: #4fc3f7;
        }

        .training-card-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
            min-width: 0;
        }

        .training-card-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            word-break: break-word;
        }

        .dark-mode .training-card-name {
            color: #fff;
        }

        .training-card-date {
            font-size: 0.9rem;
            color: #666;
        }

        .dark-mode .training-card-date {
            color: #aaa;
        }

        .training-card-location {
            font-size: 0.85rem;
            color: #888;
        }

        .dark-mode .training-card-location {
            color: #999;
        }

        .training-card-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .training-card-action-group {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .training-card-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .training-card-btn.view-btn {
            background: #1976d2;
            color: #fff;
        }

        .training-card-btn.view-btn:hover {
            background: #1565c0;
        }

        .training-card-btn.view-btn:active {
            background: #0d47a1;
            transform: scale(0.97);
        }

        .training-card-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.3);
        }

        .training-card-btn:focus:not(:focus-visible) {
            box-shadow: none;
        }

        .training-count {
            font-style: italic;
            color: #666;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .dark-mode .training-count {
            color: #aaa;
        }

        .training-tbc {
            font-style: italic;
            color: #666;
        }

        .dark-mode .training-tbc {
            color: #aaa;
        }

        @media (max-width: 600px) {
            .planning-training-section {
                width: 100%;
                box-sizing: border-box;
            }

            .planning-training-list {
                width: 100%;
                box-sizing: border-box;
            }

            .training-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
                width: 100%;
                box-sizing: border-box;
            }

            .training-card-actions {
                width: 100%;
            }

            .training-card-action-group {
                flex-direction: column;
                width: 100%;
                gap: 8px;
            }

            .training-card-btn {
                flex: 1;
                width: 100%;
            }

            .training-count {
                width: 100%;
                text-align: center;
            }
        }
    </style>

    <!-- Training Planning View -->
    <div id="view-planning-training" class="view" data-view="planning-training" style="display: none;">
        <div class="container">
            <div class="page-header d-flex justify-content-between align-items-start admin-only">
                <div>
                    <h1>Planificaci√≥ d'assajos</h1>
                    <p class="lead">Gestiona i planifica els teus assajos ac√≠.</p>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-primary" data-route="edit-training">Nou assaig</button>
                </div>
            </div>

            <!-- Trainings List Section -->
            <div class="planning-training-section">
                <div class="section-header">
                    <h2>Assajos</h2>
                    <button type="button" class="btn-refresh" id="refresh-training-btn" style="display: none;"
                        title="Actualitzar llista">
                        <svg class="refresh-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8" />
                            <path d="M21 3v5h-5" />
                        </svg>
                    </button>
                </div>

                <!-- Upcoming/Current Trainings -->
                <div id="planning-training-list" class="planning-training-list">
                    <div class="trainings-loading">
                        <div class="spinner"></div>
                        <span>Carregant assajos...</span>
                    </div>
                </div>

                <!-- Past Trainings Collapsible -->
                <div class="past-training-collapsible">
                    <button type="button" class="collapsible-toggle" id="past-training-toggle"
                        style="display: none;">
                        <span class="toggle-icon">‚ñ∂</span>
                        <span class="toggle-text">Assajos passats</span>
                        <span class="past-training-count" id="past-training-count"></span>
                    </button>
                    <div class="collapsible-content" id="past-training-list" style="display: none;">
                        <!-- Past trainings will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-training" class="view" data-view="edit-training" style="display: none;">
        <div class="container">
            <div class="page-header">
                <h1>Nou assaig</h1>
            </div>
            <div class="training-fields-column">
                <div class="training-field">
                    <label for="training-datetime-input">Data <span class="required">*</span></label>
                    <input type="datetime-local" id="training-datetime-input" required>
                    <span id="training-datetime-label" class="training-field-label" style="display: none;"></span>
                </div>
                <div class="training-field">
                    <label for="training-description-input">Descripci√≥</label>
                    <textarea id="training-description-input" placeholder="Introdueix la descripci√≥ de l'assaig..." rows="8"></textarea>
                    <span id="training-description-label" class="training-field-label" style="display: none;"></span>
                </div>
            </div>
            <!-- Detected dances section -->
            <div class="training-detected-dances" id="training-detected-dances-section" style="display: none;">
                <div class="training-detected-dances-header">
                    <h3>Balls assajats</h3>
                </div>
                <div id="training-detected-dances" class="training-detected-dances-chips">
                </div>
            </div>
            <!-- Floating save button (admin only) -->
            <button id="floating-save-training-btn" class="floating-save-btn" title="Desar assaig" disabled style="display: none;">
                <svg class="save-icon" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
            </button>
        </div>
    </div>

    <!-- Dance Audio Dialog -->
    <dialog id="dance-audio-dialog" class="dance-audio-dialog">
        <div class="dance-audio-card">
            <button type="button" class="dance-audio-close-btn" id="dance-audio-close-btn" aria-label="Tancar">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <div class="dance-audio-header">
                <h2 id="dance-audio-title"></h2>
            </div>
            <div class="dance-audio-body">
                <div id="dance-audio-list" class="dance-audio-list">
                </div>
            </div>
        </div>
    </dialog>

    <style>
        /* Training field styles */
        .training-fields-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
            align-items: flex-start;
        }

        .training-field {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
            width: 100%;
        }

        .training-field label {
            font-weight: bold;
            font-size: 1rem;
            color: #fff;
            white-space: nowrap;
        }

        .training-field label .required {
            color: #d32f2f;
        }

        .training-field input,
        .training-field textarea {
            padding: 0.5em 0.8em;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .training-field input[type="datetime-local"] {
            min-width: 200px;
        }

        .training-field textarea {
            min-width: 300px;
            resize: vertical;
        }

        .training-field input:focus,
        .training-field textarea:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.2);
        }

        /* Training field label (for read-only past trainings) */
        .training-field-label {
            padding: 0.5em 0.8em;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            font-size: 1rem;
            color: #fff;
            display: block;
            word-break: break-word;
            white-space: pre-wrap;
            overflow-wrap: break-word;
        }

        /* Detected dances section */
        .training-detected-dances {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(25, 118, 210, 0.1);
            border-left: 4px solid #1976d2;
            border-radius: 8px;
        }

        .training-detected-dances-header h3 {
            margin: 0;
            font-size: 1rem;
            color: #fff;
            font-weight: 600;
        }

        .training-detected-dances-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .training-detected-dance-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 0.5em 1em;
            border-radius: 16px;
            border: 1px solid #1976d2;
            background: #1976d2;
            color: #fff;
            font-size: 0.9rem;
            font-weight: 500;
            user-select: none;
        }

        .training-detected-dance-chip.empty {
            color: #999;
            background: transparent;
            border: 1px solid #666;
        }

        .training-detected-dance-chip {
            cursor: pointer;
            transition: all 0.2s;
        }

        .training-detected-dance-chip:hover {
            background: #1565c0;
            border-color: #1565c0;
            transform: translateY(-2px);
        }

        /* Dance Audio Dialog Styles */
        #dance-audio-dialog {
            padding: 0;
            border: none;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
            max-width: 600px;
            width: 90vw;
            background: var(--card-bg);
            color: var(--text-color);
            overflow: visible;
        }

        #dance-audio-dialog::backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        #dance-audio-dialog[open] {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }

        .dance-audio-card {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 0;
            position: relative;
        }

        .dance-audio-close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .dance-audio-header {
            padding: 20px 20px 0 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dance-audio-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            color: #fff;
        }

        .dance-audio-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .dance-audio-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .dance-audio-item {
            padding: 16px;
            border-radius: 8px;
            background: rgba(25, 118, 210, 0.1);
            border: 1px solid rgba(25, 118, 210, 0.3);
            transition: all 0.2s;
        }

        .dance-audio-item:hover {
            background: rgba(25, 118, 210, 0.2);
            border-color: rgba(25, 118, 210, 0.5);
        }

        .dance-audio-item-title {
            font-weight: 600;
            color: #fff;
            margin: 0 0 8px 0;
            font-size: 1rem;
        }

        .dance-audio-item-artist {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            margin: 0 0 12px 0;
        }

        .dance-audio-player-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 48px;
        }

        .dance-audio-play-btn {
            background: #1976d2;
            border: none;
            color: #fff;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.3);
        }

        .dance-audio-play-btn:hover {
            background: #1565c0;
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.5);
            transform: scale(1.05);
        }

        .dance-audio-play-btn:active {
            transform: scale(0.95);
        }

        .dance-audio-play-btn svg {
            width: 24px;
            height: 24px;
        }

        .dance-audio-player {
            width: 100%;
            height: 200px;
            border-radius: 4px;
            border: none;
        }

        .dance-audio-empty {
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            padding: 40px 20px;
            font-size: 0.95rem;
        }

        @media (max-width: 600px) {
            .training-fields-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .training-field {
                width: 100%;
                flex-direction: column;
            }

            .training-field input,
            .training-field textarea {
                min-width: 0;
                width: 100%;
            }
        }

        #view-training .container {
            width: 100%;
            max-width: 100%;
            padding: 0 15px;
            box-sizing: border-box;
        }
    </style>

    <div id="view-events" class="view" data-view="edit-event" style="display: none;">
        <div class="container">
            <div class="page-header">
                <!-- Admin view: editable inputs -->
                <div class="event-fields-row admin-only">
                    <div class="event-field">
                        <label for="event-name-input">Nom de l'actuaci√≥ <span class="required">*</span></label>
                        <input type="text" id="event-name-input"
                            placeholder="Introdueix el nom de l'actuaci√≥..." required>
                        <span id="event-name-label" class="event-field-label" style="display: none;"></span>
                    </div>
                    <div class="event-field">
                        <label for="event-datetime-input">Data <span class="required">*</span></label>
                        <input type="datetime-local" id="event-datetime-input" required>
                        <span id="event-datetime-label" class="event-field-label" style="display: none;"></span>
                    </div>
                    <div class="event-field">
                        <label for="event-meeting-place-input">Lloc de trobada</label>
                        <input type="text" id="event-meeting-place-input"
                            placeholder="Introdueix el lloc de trobada...">
                        <span id="event-meeting-place-label" class="event-field-label" style="display: none;"></span>
                    </div>
                </div>
                <!-- Non-admin view: plain text -->
                <div class="event-info-row non-admin-only">
                    <h2 id="event-name-display" class="event-name-display"></h2>
                    <span id="event-date-display" class="event-date-display"></span>
                    <span id="event-meeting-place-display" class="event-meeting-place-display"></span>
                </div>
                <div class="dance-selector-row admin-only" id="dance-selector-section" style="display: none;">
                    <div id="dance-chips" class="dance-chips admin-only">
                        <span class="dance-chips-loading">Carregant balls...</span>
                    </div>
                </div>
            </div>
            <div id="diagrams-list" class="diagrams-list">
                <!-- Diagrams will be added here dynamically -->
            </div>
            <!-- Dialog for person selection -->
            <dialog id="person-dialog" class="admin-only">
                <form method="dialog" id="person-form" style="margin:0;">
                    <div id="position-info" class="position-info"></div>
                    <h3 style="margin-top:0; text-align:center;">Selecciona un nom</h3>
                    <div id="person-loading" style="display:none; text-align:center; padding:1em 0;">
                        <div class="dialog-spinner"></div>
                        <p style="margin:0.5em 0 0 0; color:#666;">Carregant membres...</p>
                    </div>
                    <div class="person-combo-wrapper">
                        <input id="person-combo" placeholder="Cerca o selecciona..."
                            style="width:100%; padding:0.4em; border-radius:6px; border:1px solid #ccc; font-size:1em;"
                            autocomplete="off">
                        <ul id="person-list" class="person-dropdown"></ul>
                    </div>
                    <button type="button" id="clear-person-btn" class="clear-person-btn" style="display:none;">‚úï
                        Esborrar selecci√≥</button>
                </form>
            </dialog>
            <!-- Floating save button -->
            <button id="floating-save-btn" class="floating-save-btn" title="Desar actuaci√≥" disabled>
                <svg class="save-icon" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
            </button>
            <!-- Floating lock button (for past events) -->
            <button id="floating-lock-btn" class="floating-lock-btn" title="Long-press per 3 segons per fer editable">
                <svg class="progress-ring-container" width="48" height="48" viewBox="0 0 48 48" style="position: absolute; top: 0; left: 0;">
                    <circle class="progress-ring" cx="24" cy="24" r="22" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-dasharray="138.23" stroke-dashoffset="138.23"></circle>
                </svg>
                <svg class="lock-icon" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
            </button>
            <!-- Floating share button -->
            <button id="floating-share-btn" class="floating-share-btn" title="Compartir com a imatge">
                <svg class="share-icon" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="18" cy="5" r="3"></circle>
                    <circle cx="6" cy="12" r="3"></circle>
                    <circle cx="18" cy="19" r="3"></circle>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                </svg>
            </button>
        </div>
    </div>

    <style>
        /* Event fields styles */
        .event-fields-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
        }

        .event-info-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            align-items: baseline;
        }

        .event-name-display {
            color: #fff;
            margin: 0;
            font-size: 1.5rem;
        }

        .event-date-display {
            color: rgba(255, 255, 255, 0.85);
            font-size: 1.1rem;
            background: rgba(255, 255, 255, 0.15);
            padding: 0.3em 0.8em;
            border-radius: 6px;
        }

        .event-meeting-place-display {
            color: rgba(255, 255, 255, 0.85);
            font-size: 1.1rem;
            background: rgba(255, 255, 255, 0.15);
            padding: 0.3em 0.8em;
            border-radius: 6px;
        }

        .event-meeting-place-display:empty {
            display: none;
        }

        .event-field {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 10px;
        }

        .event-field label {
            font-weight: bold;
            font-size: 1rem;
            color: #fff;
            white-space: nowrap;
        }

        .event-field label .required {
            color: #d32f2f;
        }

        .event-field input {
            padding: 0.5em 0.8em;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .event-field input[type="text"] {
            min-width: 125px;
            max-width: 175px;
        }

        .event-field input:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.2);
        }

        /* Event field label (for read-only past events) */
        .event-field-label {
            padding: 0.5em 0.8em;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            font-size: 1rem;
            color: #fff;
            min-width: 125px;
            max-width: 175px;
            display: inline-block;
            word-break: break-word;
        }

        @media (max-width: 600px) {
            .event-fields-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .event-field {
                width: 100%;
            }

            .event-field input[type="text"] {
                min-width: 0;
                flex: 1;
            }
        }

        /* View planning container */
        #view-planning-event .container {
            width: 100%;
            max-width: 100%;
            padding: 0 15px;
            box-sizing: border-box;
        }

        #view-planning-training .container {
            width: 100%;
            max-width: 100%;
            padding: 0 15px;
            box-sizing: border-box;
        }

        #view-events .container {
            width: 100%;
            max-width: 100%;
            padding: 0 15px;
            box-sizing: border-box;
        }

        /* Events list styles */
        .diagrams-list {
            display: flex;
            flex-direction: column;
            gap: 30px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .diagram-item {
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 20px;
            background: #fafafa;
            position: relative;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow: hidden;
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
        }

        .diagram-item:active {
            cursor: grabbing;
        }

        .diagram-item.dragging {
            opacity: 0.5;
            transform: scale(0.98);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .diagram-item.drag-over {
            border: 2px dashed #1976d2;
            background: #e3f2fd;
        }

        .diagram-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .diagram-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .diagram-structure {
            font-size: 0.9rem;
            color: #666;
            background: #e0e0e0;
            padding: 4px 10px;
            border-radius: 12px;
        }

        .diagram-title-row {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .diagram-description-container {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            flex-basis: 100%;
            order: -1;
            margin-bottom: 4px;
        }

        .diagram-description-text {
            font-size: 0.95rem;
            color: #555;
            font-style: italic;
        }

        .add-description-link {
            font-size: 0.9rem;
            color: #1976d2;
            text-decoration: none;
            cursor: pointer;
        }

        .add-description-link:hover {
            text-decoration: underline;
        }

        .edit-description-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s, color 0.2s, transform 0.1s;
        }

        .edit-description-btn:hover {
            background: #e0e0e0;
            color: #333;
        }

        .edit-description-btn:active {
            background: #d0d0d0;
            transform: scale(0.95);
        }

        .edit-description-btn:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.3);
        }

        .edit-description-btn:focus:not(:focus-visible) {
            box-shadow: none;
        }

        .diagram-description-input {
            padding: 0.4em 0.6em;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 0.95rem;
            min-width: 250px;
            font-style: italic;
        }

        .diagram-description-input:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
        }

        .diagram-legend {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px 16px;
            font-size: 0.85rem;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 6px 12px;
            background: #fff;
            margin: 0 20px;
        }

        .diagram-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-color-box {
            width: 18px;
            height: 18px;
            border-radius: 3px;
            border: 2px solid #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .legend-color-box.orange {
            background: orange;
        }

        .legend-color-box.purple {
            background: purple;
        }

        .remove-diagram-btn {
            padding: 0.5em 1.2em;
            border-radius: 8px;
            border: none;
            background: #d32f2f;
            color: #fff;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
        }

        .remove-diagram-btn:hover {
            background: #c62828;
        }

        .remove-diagram-btn:active {
            background: #b71c1c;
            transform: scale(0.97);
        }

        .remove-diagram-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.3);
        }

        .remove-diagram-btn:focus:not(:focus-visible) {
            box-shadow: none;
        }

        .diagram-header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Diagrams canvas responsive styles */
        .diagrams-canvas-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
            padding: 10px 0;
        }

        .diagrams-canvas-wrapper {
            position: relative;
            width: 100%;
            max-width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        #diagrams-canvas,
        .diagrams-canvas-wrapper canvas {
            width: 100%;
            max-width: 100%;
            height: auto;
            border: 1px solid #ccc;
            background: #fff;
            display: block;
        }

        @media (max-width: 768px) {
            .diagrams-canvas-container {
                min-height: 250px;
                margin: 0 -15px;
                padding: 10px 15px;
            }

            .diagrams-canvas-wrapper {
                padding-bottom: 10px;
            }

            #diagrams-canvas {
                min-width: 500px;
            }

            .diagram-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .diagram-header-actions {
                width: 100%;
                justify-content: space-between;
            }
        }

        @media (max-width: 480px) {
            .diagrams-canvas-container {
                min-height: 200px;
            }

            #diagrams-canvas {
                min-width: 450px;
            }
        }

        #person-dialog {
            padding: 0;
            border: none;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
            min-width: 380px;
            max-width: 90vw;
            background: #fff;
            color: #1f2937;
            text-align: left;
            overflow: visible;
        }

        body.dark-mode #person-dialog {
            background: #2d3748;
            color: #e2e8f0;
        }

        #person-dialog::backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        #person-dialog[open] {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }

        #person-form {
            padding: 1.5em;
            padding-bottom: 2em;
            border-radius: 16px;
            background: #fff;
            box-sizing: border-box;
            overflow: visible;
            min-height: 320px;
            text-align: center;
        }

        body.dark-mode #person-form {
            background: #2d3748;
            color: #e2e8f0;
        }

        .position-info {
            text-align: center;
            margin-bottom: 0.8em;
            padding: 0.5em 1em;
            background: #e3f2fd;
            border-radius: 8px;
            font-weight: bold;
            color: #1565c0;
            font-size: 1rem;
        }

        body.dark-mode .position-info {
            background: #1e3a5f;
            color: #60a5fa;
        }

        .position-info:empty {
            display: none;
        }

        .dialog-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #e0e0e0;
            border-top-color: #1976d2;
            border-radius: 50%;
            animation: dialog-spin 0.8s linear infinite;
            margin: 0 auto;
        }

        body.dark-mode .dialog-spinner {
            border-color: #4a5568;
            border-top-color: #60a5fa;
        }

        @keyframes dialog-spin {
            to {
                transform: rotate(360deg);
            }
        }

        .clear-person-btn {
            width: 100%;
            margin-top: 1em;
            padding: 0.5em 1em;
            border-radius: 8px;
            border: 1px solid #d32f2f;
            background: #fff;
            color: #d32f2f;
            font-size: 0.95rem;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, transform 0.1s;
        }

        body.dark-mode .clear-person-btn {
            background: transparent;
            border-color: #fc8181;
            color: #fc8181;
        }

        .clear-person-btn:hover {
            background: #ffebee;
        }

        body.dark-mode .clear-person-btn:hover {
            background: rgba(252, 129, 129, 0.1);
        }

        .clear-person-btn:active {
            background: #d32f2f;
            color: #fff;
            transform: scale(0.98);
        }

        body.dark-mode .clear-person-btn:active {
            background: #fc8181;
            color: #2d3748;
        }

        .clear-person-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.3);
        }

        body.dark-mode .clear-person-btn:focus {
            box-shadow: 0 0 0 3px rgba(252, 129, 129, 0.3);
        }

        .clear-person-btn:focus:not(:focus-visible) {
            box-shadow: none;
        }

        .person-combo-wrapper {
            position: relative;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .person-combo-wrapper input {
            width: 100%;
            max-width: 300px;
            background: #fff;
            color: #1f2937;
            border: 1px solid #ccc;
        }

        body.dark-mode .person-combo-wrapper input {
            background: #3d4a5c;
            color: #e2e8f0;
            border-color: #4a5568;
        }

        .person-dropdown {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 300px;
            max-height: 250px;
            overflow-y: auto;
            background: #fff;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 6px 6px;
            margin: 0;
            padding: 0;
            list-style: none;
            z-index: 1002;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        body.dark-mode .person-dropdown {
            background: #3d4a5c;
            border-color: #4a5568;
        }

        .person-dropdown.open {
            display: block;
        }

        .person-dropdown li {
            padding: 0.5em 0.6em;
            cursor: pointer;
            transition: background 0.15s;
            color: #1f2937;
        }

        body.dark-mode .person-dropdown li {
            color: #e2e8f0;
        }

        .person-dropdown li:hover,
        .person-dropdown li.highlighted {
            background: #e3f2fd;
        }

        body.dark-mode .person-dropdown li:hover,
        body.dark-mode .person-dropdown li.highlighted {
            background: #1e3a5f;
        }

        .person-dropdown li.selected {
            background: #1976d2;
            color: #fff;
        }

        body.dark-mode .person-dropdown li.selected {
            background: #60a5fa;
            color: #1f2937;
        }
    </style>
    <style>
        .dance-selector-row {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 15px;
        }

        .dance-selector-row label {
            font-weight: bold;
            font-size: 1rem;
            color: #333;
            padding-top: 0.5em;
        }

        .dance-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            flex: 1;
        }

        .dance-chips-loading {
            color: #666;
            font-size: 0.95rem;
            padding: 0.5em 0;
        }

        .dance-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 0.5em 1.2em;
            border-radius: 8px;
            border: none;
            background: #1976d2;
            color: #fff;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .dance-chip::before {
            content: '+';
            font-size: 1.1em;
            font-weight: bold;
        }

        .dance-chip:hover {
            background: #1565c0;
        }

        .dance-chip:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.3);
        }

        .dance-chip:active {
            transform: scale(0.97);
        }

        @media (max-width: 480px) {
            .dance-selector-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .dance-chips {
                width: 100%;
            }
        }
    </style>
    <style>
        .main-btn {
            padding: 0.5em 1.2em;
            border-radius: 8px;
            border: none;
            background: #1976d2;
            color: #fff;
            font-size: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: background 0.2s, transform 0.1s, box-shadow 0.2s;
        }

        .main-btn:hover {
            background: #1565c0;
        }

        .main-btn:active {
            background: #0d47a1;
            transform: scale(0.97);
        }

        .main-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.3), 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .main-btn:focus:not(:focus-visible) {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .secondary-btn {
            background: #e0e0e0;
            color: #333;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .secondary-btn:hover {
            background: #d0d0d0;
        }

        .secondary-btn:active {
            background: #bdbdbd;
            transform: scale(0.97);
        }

        .secondary-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.15), 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .secondary-btn:focus:not(:focus-visible) {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        /* Floating save button */
        .floating-save-btn {
            position: fixed;
            bottom: 24px;
            right: 144px;
            z-index: 999;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: #2e7d32;
            color: #fff;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: background 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        /* Ensure hidden admin-only elements don't occupy space */
        .floating-save-btn.admin-only[style*="display: none"],
        .admin-only[style*="display: none"] {
            display: none !important;
            visibility: hidden !important;
            width: 0 !important;
            height: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
            overflow: hidden !important;
        }

        .floating-save-btn:hover {
            background: #388e3c;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.25);
        }

        .floating-save-btn:active {
            background: #1b5e20;
            transform: scale(0.95);
        }

        .floating-save-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.4), 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .floating-save-btn:focus:not(:focus-visible) {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .floating-save-btn:disabled {
            background: #9e9e9e;
            cursor: not-allowed;
        }

        .floating-save-btn .save-icon {
            display: block;
            width: 20px;
            height: 20px;
        }

        .floating-save-btn.success {
            background: #43a047;
        }

        .floating-save-btn.error {
            background: #d32f2f;
        }

        /* Floating lock button */
        .floating-lock-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 999;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: #757575;
            color: #fff;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: background 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .floating-lock-btn:hover {
            background: #616161;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .floating-lock-btn:active {
            background: #424242;
            transform: scale(0.97);
        }

        .floating-lock-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.3), 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .floating-lock-btn:focus:not(:focus-visible) {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .floating-lock-btn .lock-icon {
            width: 20px;
            height: 20px;
            display: block;
            flex-shrink: 0;
            position: relative;
            z-index: 2;
        }

        .floating-lock-btn .progress-ring-container {
            position: absolute;
            top: 0;
            left: 0;
        }

        .floating-lock-btn .progress-ring {
            transition: stroke-dashoffset 0.05s linear;
            stroke: #fff;
            opacity: 0;
        }

        .floating-lock-btn.pressing .progress-ring {
            opacity: 0.8;
        }

        /* Floating share button */
        .floating-share-btn {
            position: fixed;
            bottom: 24px;
            right: 84px;
            z-index: 999;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: #1976d2;
            color: #fff;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: background 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .floating-share-btn:hover {
            background: #1565c0;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.25);
        }

        .floating-share-btn:active {
            background: #0d47a1;
            transform: scale(0.95);
        }

        .floating-share-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.4), 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .floating-share-btn:focus:not(:focus-visible) {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .floating-share-btn:disabled {
            background: #9e9e9e;
            cursor: not-allowed;
        }

        .floating-share-btn .share-icon {
            display: block;
            width: 20px;
            height: 20px;
        }

        .floating-share-btn.success {
            background: #43a047;
        }
    </style>
    <script>
        // State for all diagrams: array of { id, danceName, groups }
        let diagrams = [];
        let diagramIdCounter = 0;
        // Track if diagram has unsaved changes
        var diagramsIsDirty = false;
        // Dances data loaded from server
        var dancesData = [];
        // Track if current event is editable
        var isEventEditable = true;
        // Track if user manually unlocked the event via long-press
        var isEventManuallyUnlocked = false;

        // Check if the event is in the past
        function checkIfEventIsEditable() {
            // If manually unlocked via long-press, always consider editable
            if (isEventManuallyUnlocked) {
                return true;
            }

            const eventDatetimeInput = document.getElementById('event-datetime-input');
            if (!eventDatetimeInput || !eventDatetimeInput.value) {
                return true; // Assume editable if no date set
            }
            const eventDate = new Date(eventDatetimeInput.value);
            const now = new Date();
            isEventEditable = eventDate >= now;
            return isEventEditable;
        }

        // Apply or remove read-only state to event
        function applyEditableState() {
            const isEditable = checkIfEventIsEditable();
            const eventNameInput = document.getElementById('event-name-input');
            const eventDatetimeInput = document.getElementById('event-datetime-input');
            const eventMeetingPlaceInput = document.getElementById('event-meeting-place-input');
            const eventNameLabel = document.getElementById('event-name-label');
            const eventDatetimeLabel = document.getElementById('event-datetime-label');
            const eventMeetingPlaceLabel = document.getElementById('event-meeting-place-label');
            const danceSelectorSection = document.getElementById('dance-selector-section');
            const floatingSaveBtn = document.getElementById('floating-save-btn');
            const floatingLockBtn = document.getElementById('floating-lock-btn');

            if (isEditable) {
                // Show inputs, hide labels
                if (eventNameInput) {
                    eventNameInput.disabled = false;
                    eventNameInput.style.display = 'block';
                }
                if (eventDatetimeInput) {
                    eventDatetimeInput.disabled = false;
                    eventDatetimeInput.style.display = 'block';
                }
                if (eventMeetingPlaceInput) {
                    eventMeetingPlaceInput.disabled = false;
                    eventMeetingPlaceInput.style.display = 'block';
                }
                if (eventNameLabel) eventNameLabel.style.display = 'none';
                if (eventDatetimeLabel) eventDatetimeLabel.style.display = 'none';
                if (eventMeetingPlaceLabel) eventMeetingPlaceLabel.style.display = 'none';
            } else {
                // Update label values and show labels, hide inputs
                if (eventNameInput && eventNameLabel) {
                    eventNameLabel.textContent = eventNameInput.value || '';
                    eventNameInput.style.display = 'none';
                    eventNameLabel.style.display = 'block';
                }
                if (eventDatetimeInput && eventDatetimeLabel) {
                    const datetimeValue = eventDatetimeInput.value;
                    let formattedDatetime = datetimeValue;
                    if (datetimeValue) {
                        // Parse the datetime-local format (YYYY-MM-DDTHH:mm)
                        const date = new Date(datetimeValue + ':00');
                        const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                        formattedDatetime = date.toLocaleDateString('ca-ES', options);
                    }
                    eventDatetimeLabel.textContent = formattedDatetime;
                    eventDatetimeInput.style.display = 'none';
                    eventDatetimeLabel.style.display = 'block';
                }
                if (eventMeetingPlaceInput && eventMeetingPlaceLabel) {
                    eventMeetingPlaceLabel.textContent = eventMeetingPlaceInput.value || '';
                    eventMeetingPlaceInput.style.display = 'none';
                    eventMeetingPlaceLabel.style.display = 'block';
                }
            }

            // Show/hide dance selector
            if (danceSelectorSection) {
                if (!isEditable) {
                    danceSelectorSection.style.display = 'none';
                }
                danceSelectorSection.style.pointerEvents = isEditable ? 'auto' : 'none';
            }

            // Hide floating save button when not editable
            if (floatingSaveBtn) {
                floatingSaveBtn.style.display = isEditable ? 'flex' : 'none';
            }

            // Show floating lock button only when not editable
            if (floatingLockBtn) {
                floatingLockBtn.style.display = isEditable ? 'none' : 'flex';
            }

            // Disable canvas interactions and dance operations
            updateDiagramsEditableState(isEditable);
        }

        // Disable/enable diagram interactions based on editability
        function updateDiagramsEditableState(isEditable) {
            const diagramsList = document.getElementById('diagrams-list');
            if (!diagramsList) return;

            // Disable dragging
            const diagramItems = diagramsList.querySelectorAll('.diagram-item');
            diagramItems.forEach(function (item) {
                item.style.pointerEvents = isEditable ? 'auto' : 'none';
                item.draggable = isEditable;
                item.style.cursor = isEditable ? 'grab' : 'default';
            });

            // Disable all action buttons (including main-btn variants)
            const actionButtons = diagramsList.querySelectorAll('.add-group-btn, .remove-diagram-btn, .edit-description-btn, .add-description-link, .main-btn');
            actionButtons.forEach(function (btn) {
                btn.disabled = !isEditable;
                btn.style.cursor = isEditable ? 'pointer' : 'not-allowed';
                btn.style.pointerEvents = isEditable ? 'auto' : 'none';
            });

            // Hide diagram header actions when not editable
            const diagramHeaderActions = diagramsList.querySelectorAll('.diagram-header-actions');
            diagramHeaderActions.forEach(function (headerActions) {
                headerActions.style.display = isEditable ? 'flex' : 'none';
            });

            // Hide edit-description-btn when not editable
            const editDescriptionBtns = diagramsList.querySelectorAll('.edit-description-btn');
            editDescriptionBtns.forEach(function (btn) {
                btn.style.display = isEditable ? 'block' : 'none';
            });

            // Hide add-description-link when not editable
            const addDescriptionLinks = diagramsList.querySelectorAll('.add-description-link');
            addDescriptionLinks.forEach(function (link) {
                link.style.display = isEditable ? 'block' : 'none';
            });

            // Disable canvas click handlers
            const canvases = diagramsList.querySelectorAll('canvas');
            canvases.forEach(function (canvas) {
                canvas.style.cursor = isEditable ? 'pointer' : 'default';
                canvas.style.pointerEvents = isEditable ? 'auto' : 'none';
            });
        }

        // Update save button enabled/disabled state based on dirty flag
        function updateSaveButtonState() {
            const btn = document.getElementById('floating-save-btn');
            if (btn) {
                btn.disabled = !diagramsIsDirty || !isEventEditable;
            }
        }

        // Set dirty flag and update button state
        function setDiagramsDirty(isDirty) {
            diagramsIsDirty = isDirty;
            updateSaveButtonState();
        }

        // Calculate diagram dimensions that scale based on group count
        function calcDiagramLayout(canvas, groupCount, rows, cols) {
            // Base dimensions for 1-2 groups
            const baseSquareWidth = 180;
            const baseSquareHeight = 90;
            const baseSquareSpacingX = 24;
            const baseSquareSpacingY = 24;
            const baseSpacing = 120;
            const baseOffsetY = 40;
            const minPadding = 40; // minimum padding on left/right

            // Calculate what the total width would be at base size
            const baseGridWidth = baseSquareWidth * cols + baseSquareSpacingX * (cols - 1);
            const baseTotalWidth = groupCount * baseGridWidth + (groupCount - 1) * baseSpacing;
            const availableWidth = canvas.width - (minPadding * 2);

            // Calculate scale factor to fit all groups
            let scale = 1;
            if (baseTotalWidth > availableWidth) {
                scale = availableWidth / baseTotalWidth;
            }

            // Apply scale to all dimensions
            const squareWidth = baseSquareWidth * scale;
            const squareHeight = baseSquareHeight * scale;
            const squareSpacingX = baseSquareSpacingX * scale;
            const squareSpacingY = baseSquareSpacingY * scale;
            const spacing = baseSpacing * scale;
            const offsetY = baseOffsetY;

            const gridWidth = squareWidth * cols + squareSpacingX * (cols - 1);
            const gridHeight = squareHeight * rows + squareSpacingY * (rows - 1);
            const totalWidth = groupCount * gridWidth + (groupCount - 1) * spacing;
            const offsetX0 = (canvas.width - totalWidth) / 2;

            // Calculate required canvas height
            const placaHeight = Math.max(25, 40 * scale);
            const placaY = offsetY + gridHeight + 60 * scale;
            const requiredHeight = placaY + placaHeight + 15; // 15px padding below PLA√áA

            return {
                squareWidth,
                squareHeight,
                squareSpacingX,
                squareSpacingY,
                spacing,
                gridWidth,
                gridHeight,
                totalWidth,
                offsetX0,
                offsetY,
                scale,
                requiredHeight
            };
        }

        // Draw a specific diagram
        function drawDiagram(diagram) {
            const canvas = document.getElementById('diagram-canvas-' + diagram.id);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const groups = diagram.groups;
            const rows = diagram.rows || 2;
            const cols = diagram.columns || 2;
            const positions = diagram.positions || [];
            const diagramColors = diagram.diagram || { backgroundColor: {}, textColor: {} };
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Layout: stack groups horizontally, centered vertically
            const groupCount = groups.length;

            // Calculate scaled layout based on group count
            const layout = calcDiagramLayout(canvas, groupCount, rows, cols);
            const { squareWidth, squareHeight, squareSpacingX, squareSpacingY, spacing, gridWidth, gridHeight, totalWidth, offsetX0, offsetY, scale, requiredHeight } = layout;

            // Resize canvas height if needed
            if (canvas.height !== Math.round(requiredHeight)) {
                canvas.height = Math.round(requiredHeight);
            }

            // Get background color for a cell from diagram.backgroundColor using position label
            // Grid layout: top-left is order 1, going left-to-right, top-to-bottom
            // Formula: order = row * cols + col + 1
            function getCellBackgroundColor(row, col) {
                const order = row * cols + col + 1;
                const pos = positions.find(function (p) { return p.order === order; });
                if (pos && pos.positionType.label && diagramColors.backgroundColor && diagramColors.backgroundColor[pos.positionType.label]) {
                    return diagramColors.backgroundColor[pos.positionType.label];
                }
                return '#808080'; // default gray
            }

            // Get text color for a cell from diagram.textColor using position label
            function getCellTextColor(row, col) {
                const order = row * cols + col + 1;
                const pos = positions.find(function (p) { return p.order === order; });
                if (pos && pos.positionType.label && diagramColors.textColor && diagramColors.textColor[pos.positionType.label]) {
                    return diagramColors.textColor[pos.positionType.label];
                }
                return '#FFFFFF'; // default white
            }

            for (let g = 0; g < groupCount; g++) {
                const group = groups[g];
                const offsetX = offsetX0 + g * (gridWidth + spacing);
                if (groupCount > 1) {
                    ctx.save();
                    const groupLabelFontSize = Math.max(12, Math.round(22 * scale));
                    ctx.font = 'bold ' + groupLabelFontSize + 'px sans-serif';
                    ctx.fillStyle = '#555';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'bottom';
                    const groupLetter = String.fromCharCode(65 + g);
                    const blockName = diagramColors.blockName || '';
                    const groupLabel = blockName ? blockName + ' ' + groupLetter : groupLetter;
                    ctx.fillText(groupLabel, offsetX + gridWidth / 2, offsetY - 10 * scale);
                    ctx.restore();
                }
                for (let row = 0; row < rows; row++) {
                    for (let col = 0; col < cols; col++) {
                        const i = row * cols + col;
                        const x = offsetX + col * (squareWidth + squareSpacingX);
                        const y = offsetY + row * (squareHeight + squareSpacingY);
                        ctx.fillStyle = getCellBackgroundColor(row, col);
                        ctx.fillRect(x, y, squareWidth, squareHeight);
                        ctx.strokeStyle = '#fff';
                        ctx.lineWidth = Math.max(2, 4 * scale);
                        ctx.strokeRect(x, y, squareWidth, squareHeight);

                        // Draw position tag in bottom right corner of each cell (admin only)
                        const userRoles = (AppState && AppState.currentUser && AppState.currentUser.roles) || [];
                        const isAdmin = userRoles.includes('ADMIN');
                        if (isAdmin) {
                            const cellOrder = row * cols + col + 1;
                            const cellPos = positions.find(function (p) { return p.order === cellOrder; });
                            const cellTag = cellPos && cellPos.tag ? cellPos.tag : '';
                            ctx.save();
                            const orderFontSize = Math.max(8, Math.round(12 * scale));
                            ctx.font = orderFontSize + 'px sans-serif';
                            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                            ctx.textAlign = 'right';
                            ctx.textBaseline = 'bottom';
                            ctx.fillText(cellTag, x + squareWidth - 4 * scale, y + squareHeight - 3 * scale);
                            ctx.restore();
                        }

                        if (group[i]) {
                            ctx.fillStyle = getCellTextColor(row, col);
                            const nameFontSize = Math.max(10, Math.round(20 * scale));
                            ctx.font = 'bold ' + nameFontSize + 'px sans-serif';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(group[i], x + squareWidth / 2, y + squareHeight / 2);
                        }
                    }
                }
            }
            // Draw individual PLA√áA for each group
            const placaHeight = Math.max(25, 40 * scale);
            const placaY = offsetY + gridHeight + 60 * scale;
            const placaFontSize = Math.max(12, Math.round(20 * scale));

            for (let g = 0; g < groupCount; g++) {
                const placaX = offsetX0 + g * (gridWidth + spacing);
                const placaWidth = gridWidth;

                ctx.save();
                ctx.fillStyle = '#fff';
                ctx.strokeStyle = '#000';
                ctx.lineWidth = Math.max(1, 2 * scale);
                ctx.fillRect(placaX, placaY, placaWidth, placaHeight);
                ctx.strokeRect(placaX, placaY, placaWidth, placaHeight);
                ctx.fillStyle = '#000';
                ctx.font = 'bold ' + placaFontSize + 'px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('PLA√áA', placaX + placaWidth / 2, placaY + placaHeight / 2);
                ctx.restore();
            }
        }

        // Draw all diagrams
        function drawAllDiagrams() {
            diagrams.forEach(function (diagram) {
                drawDiagram(diagram);
            });
        }

        // Create HTML for a diagram item
        function createDiagramElement(diagram) {
            const div = document.createElement('div');
            div.className = 'diagram-item';
            div.id = 'diagram-item-' + diagram.id;
            div.draggable = true;
            div.dataset.diagramId = diagram.id;

            // Generate legend items from positions (unique labels only)
            const rows = diagram.rows || 2;
            const cols = diagram.columns || 2;
            const positions = diagram.positions || [];
            const diagramColors = diagram.diagram || { backgroundColor: {}, textColor: {} };
            const blockName = diagramColors.blockName || 'grup';
            let legendHtml = '';
            const seenLabels = new Set();
            positions.forEach(function (pos) {
                if (seenLabels.has(pos.positionType.label)) return;
                seenLabels.add(pos.positionType.label);
                const color = (diagramColors.backgroundColor && diagramColors.backgroundColor[pos.positionType.label]) || '#808080';
                legendHtml += `
<div class="diagram-legend-item">
    <span class="legend-color-box" style="background: ${color};"></span>
    <span>${pos.positionType.label}</span>
</div>`;
            });

            // Hide legend if only one item
            const showLegend = seenLabels.size > 1;
            const legendStyle = showLegend ? '' : 'display: none;';

            // Check if user is admin
            const userRoles = (AppState && AppState.currentUser && AppState.currentUser.roles) || [];
            const isAdmin = userRoles.includes('ADMIN');
            const adminOnlyStyle = isAdmin ? '' : 'display: none;';

            const description = diagram.description || '';
            const hasDescription = description.trim().length > 0;

            // Description HTML based on admin status
            let descriptionHtml = '';
            if (isAdmin) {
                if (hasDescription) {
                    descriptionHtml = `
    <div class="diagram-description-container">
    <span class="diagram-description-text" id="desc-text-${diagram.id}">${description}</span>
    <button type="button" class="edit-description-btn" data-id="${diagram.id}" title="Editar descripci√≥">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
        </svg>
    </button>
    <input type="text" class="diagram-description-input" id="desc-input-${diagram.id}" value="${description}" style="display: none;" placeholder="Descripci√≥...">
    </div>`;
                } else {
                    descriptionHtml = `
    <div class="diagram-description-container">
    <a href="#" class="add-description-link" data-id="${diagram.id}">+ Afegir descripci√≥</a>
    <input type="text" class="diagram-description-input" id="desc-input-${diagram.id}" value="" style="display: none;" placeholder="Descripci√≥...">
    </div>`;
                }
            } else {
                if (hasDescription) {
                    descriptionHtml = `<div class="diagram-description-container"><span class="diagram-description-text">${description}</span></div>`;
                }
            }

            div.innerHTML = `
<div class="diagram-header">
${descriptionHtml}
<div class="diagram-title-row">
    <h3 class="diagram-title">${diagram.danceName}</h3>
</div>
<div class="diagram-legend" style="${legendStyle}">
    ${legendHtml}
</div>
<div class="diagram-header-actions" style="${adminOnlyStyle}">
    <button class="main-btn add-group-btn" style="${adminOnlyStyle}" data-id="${diagram.id}">+ Afegir ${blockName}</button>
    <button class="remove-diagram-btn" style="${adminOnlyStyle}" data-id="${diagram.id}">Eliminar ball</button>
</div>
</div>
<div class="diagrams-canvas-container">
<div class="diagrams-canvas-wrapper">
    <canvas id="diagram-canvas-${diagram.id}" width="1200" height="350"></canvas>
</div>
</div>
`;
            return div;
        }
        // Handle canvas click
        document.addEventListener('DOMContentLoaded', function () {
            const dialog = document.getElementById('person-dialog');
            const personCombo = document.getElementById('person-combo');
            const personList = document.getElementById('person-list');
            const personLoading = document.getElementById('person-loading');
            const danceChips = document.getElementById('dance-chips');
            const clearPersonBtn = document.getElementById('clear-person-btn');
            const diagramsList = document.getElementById('diagrams-list');
            // Use window variables for selection state to share with javascript.html handlers
            window.selectedDiagramId = null;
            window.selectedGroup = null;
            window.selectedSquare = null;
            window.currentOptions = [];

            // Load dances from server and populate chips
            function loadDancesData() {
                API.getDances()
                    .then(function (dances) {
                        if (Array.isArray(dances) && dances.length > 0) {
                            dancesData = dances;
                            danceChips.innerHTML = '';
                            dances.forEach(function (dance) {
                                const chip = document.createElement('button');
                                chip.type = 'button';
                                chip.className = 'dance-chip';
                                chip.dataset.name = dance.name;
                                chip.textContent = dance.name;
                                chip.addEventListener('click', function () {
                                    addDanceFromChip(dance.name);
                                });
                                danceChips.appendChild(chip);
                            });
                        }
                    })
                    .catch(function (error) {
                        console.error('Error loading dances:', error);
                        danceChips.innerHTML = '<span class="dance-chips-loading">Error carregant balls</span>';
                    });
            }

            // Add new diagram from chip click
            function addDanceFromChip(danceName) {
                if (!danceName) return;

                const danceInfo = dancesData.find(d => d.name === danceName);
                const structure = danceInfo && danceInfo.structure ? danceInfo.structure : { rows: 2, columns: 2 };
                const rows = structure ? structure.rows : 2;
                const cols = structure ? structure.columns : 2;
                const positions = danceInfo ? danceInfo.positions : [];
                const diagramData = danceInfo ? danceInfo.diagram : { backgroundColor: {}, textColor: {} };
                const minGroups = danceInfo && danceInfo.minGroups ? danceInfo.minGroups : 1;
                const cellCount = rows * cols;

                // Create initial groups based on minGroups
                const initialGroups = [];
                for (let i = 0; i < minGroups; i++) {
                    initialGroups.push(Array(cellCount).fill(null));
                }

                const newDiagram = {
                    id: diagramIdCounter++,
                    danceName: danceName,
                    description: '',
                    rows: rows,
                    columns: cols,
                    positions: positions,
                    diagram: diagramData,
                    groups: initialGroups
                };
                diagrams.push(newDiagram);
                setDiagramsDirty(true);

                const element = createDiagramElement(newDiagram);
                diagramsList.appendChild(element);

                // Setup canvas click handler for the new diagram
                setupCanvasClickHandler(newDiagram.id);

                drawDiagram(newDiagram);

                // Scroll to the new diagram
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            // Setup canvas click handler for a diagram
            function setupCanvasClickHandler(diagramId) {
                const canvas = document.getElementById('diagram-canvas-' + diagramId);
                if (!canvas) return;

                canvas.addEventListener('click', function (e) {
                    const diagram = diagrams.find(d => d.id === diagramId);
                    if (!diagram) return;

                    const rect = canvas.getBoundingClientRect();
                    const groups = diagram.groups;
                    const rows = diagram.rows || 2;
                    const cols = diagram.columns || 2;
                    const groupCount = groups.length;

                    // Use the same layout calculation as drawing
                    const layout = calcDiagramLayout(canvas, groupCount, rows, cols);
                    const { squareWidth, squareHeight, squareSpacingX, squareSpacingY, spacing, gridWidth, offsetX0, offsetY } = layout;

                    const scaleX = canvas.width / rect.width;
                    const scaleY = canvas.height / rect.height;
                    const clickX = (e.clientX - rect.left) * scaleX;
                    const clickY = (e.clientY - rect.top) * scaleY;

                    for (let g = 0; g < groupCount; g++) {
                        const offsetX = offsetX0 + g * (gridWidth + spacing);
                        const groupAreaWidth = squareWidth * cols + squareSpacingX * (cols - 1);
                        const groupAreaHeight = squareHeight * rows + squareSpacingY * (rows - 1);
                        if (
                            clickX >= offsetX && clickX <= offsetX + groupAreaWidth &&
                            clickY >= offsetY && clickY <= offsetY + groupAreaHeight
                        ) {
                            const x = clickX - offsetX;
                            const y = clickY - offsetY;
                            const col = Math.floor(x / (squareWidth + squareSpacingX));
                            const row = Math.floor(y / (squareHeight + squareSpacingY));
                            if (col >= cols || row >= rows) return;
                            const idx = row * cols + col;
                            window.selectedDiagramId = diagramId;
                            window.selectedGroup = g;
                            window.selectedSquare = idx;

                            if (!membersData || membersData.length === 0) {
                                setDialogLoading(true);
                                dialog.showModal();
                                const checkInterval = setInterval(function () {
                                    if (membersData && membersData.length > 0) {
                                        clearInterval(checkInterval);
                                        setDialogLoading(false);
                                        populatePersonList(diagramId, g, idx);
                                    }
                                }, 200);
                                return;
                            }

                            setDialogLoading(false);
                            populatePersonList(diagramId, g, idx);
                            return;
                        }
                    }
                });
            }

            // Load dances data on initialization
            loadDancesData();

            // Event name and datetime validation - show dance selection when both filled
            const eventNameInput = document.getElementById('event-name-input');
            const eventDatetimeInput = document.getElementById('event-datetime-input');
            const danceSelectorSection = document.getElementById('dance-selector-section');

            function checkEventFieldsAndShowDances() {
                const nameValid = eventNameInput.value.trim().length > 0;
                const dateValid = eventDatetimeInput.value.length > 0;
                if (nameValid && dateValid) {
                    danceSelectorSection.style.display = 'flex';
                } else {
                    danceSelectorSection.style.display = 'none';
                }
                // Check if event is in the past and update editability
                applyEditableState();
            }

            eventNameInput.addEventListener('input', checkEventFieldsAndShowDances);
            eventDatetimeInput.addEventListener('input', checkEventFieldsAndShowDances);

            // Helper to show/hide loading state in dialog
            function setDialogLoading(isLoading) {
                personLoading.style.display = isLoading ? 'block' : 'none';
                personCombo.style.display = isLoading ? 'none' : 'block';
            }

            // Helper to populate the person list
            function populatePersonList(diagramId, g, squareIdx) {
                const diagram = diagrams.find(d => d.id === diagramId);
                if (!diagram) return;

                // Update position info in dialog
                const positionInfo = document.getElementById('position-info');
                const positions = diagram.positions || [];
                const order = squareIdx + 1;
                const pos = positions.find(function (p) { return p.order === order; });
                const groupLetter = String.fromCharCode(65 + g);
                const diagramColors = diagram.diagram || {};
                const blockName = diagramColors.blockName || 'Grup';

                // Show specifications if available
                if (pos && pos.specifications) {
                    positionInfo.textContent = pos.specifications;
                } else if (pos && pos.positionType.label) {
                    positionInfo.textContent = pos.positionType.label;
                } else {
                    positionInfo.textContent = blockName + ' ' + groupLetter;
                }

                const cellCount = (diagram.rows || 2) * (diagram.columns || 2);
                let usedNames = [];
                for (let gi = 0; gi < diagram.groups.length; gi++) {
                    for (let si = 0; si < cellCount; si++) {
                        if (gi === g && si === squareIdx) continue;
                        if (diagram.groups[gi][si]) usedNames.push(diagram.groups[gi][si]);
                    }
                }

                // Check if event is in the past - if so, include inactive members
                let isEventInPast = false;
                const eventDateValue = eventDatetimeInput.value;
                if (eventDateValue) {
                    const eventDate = new Date(eventDateValue);
                    const now = new Date();
                    isEventInPast = eventDate < now;
                }

                // Filter members: only active for future events, all for past events
                const personNames = membersData
                    .filter(m => isEventInPast || m.active)
                    .map(m => m.name)
                    .filter(Boolean);
                window.currentOptions = personNames.filter(name => !usedNames.includes(name) || diagram.groups[g][squareIdx] === name);
                personList.innerHTML = '';

                if (window.currentOptions.length === 0) {
                    personCombo.style.display = 'none';
                    personLoading.style.display = 'block';
                    personLoading.querySelector('.dialog-spinner').style.display = 'none';
                    personLoading.querySelector('p').textContent = 'No hi ha membres disponibles';
                } else {
                    personCombo.style.display = 'block';
                    personLoading.style.display = 'none';
                    personLoading.querySelector('.dialog-spinner').style.display = 'block';
                    personLoading.querySelector('p').textContent = 'Carregant membres...';
                    personCombo.placeholder = 'Cerca o selecciona...';
                    personCombo.disabled = false;
                    // Populate dropdown with all options initially
                    updateDropdownOptions(window.currentOptions);
                }

                personCombo.value = diagram.groups[g][squareIdx] || '';
                clearPersonBtn.style.display = diagram.groups[g][squareIdx] ? 'block' : 'none';
                dialog.showModal();
                // Focus and show dropdown
                setTimeout(function () {
                    personCombo.focus();
                    personList.classList.add('open');
                }, 100);
            }

            // Handle clear button click
            clearPersonBtn.addEventListener('click', function () {
                if (window.selectedDiagramId !== null && window.selectedGroup !== null && window.selectedSquare !== null) {
                    const diagram = diagrams.find(d => d.id === window.selectedDiagramId);
                    if (diagram) {
                        diagram.groups[window.selectedGroup][window.selectedSquare] = null;
                        setDiagramsDirty(true);
                        drawDiagram(diagram);
                        personCombo.value = '';
                        clearPersonBtn.style.display = 'none';
                    }
                }
            });

            // Handle dialog form - auto-submit when a valid name is selected
            // If openNextBlock is true, automatically open the dialog for the next empty block
            function handlePersonSelection(openNextBlock) {
                const name = personCombo.value.trim();
                if (window.selectedDiagramId !== null && window.selectedGroup !== null && window.selectedSquare !== null && name && window.currentOptions.includes(name)) {
                    const diagram = diagrams.find(d => d.id === window.selectedDiagramId);
                    if (diagram) {
                        diagram.groups[window.selectedGroup][window.selectedSquare] = name;
                        setDiagramsDirty(true);
                        drawDiagram(diagram);

                        // If openNextBlock is true, find and open the next empty block
                        if (openNextBlock) {
                            const cellCount = (diagram.rows || 2) * (diagram.columns || 2);
                            let nextEmptyIdx = -1;

                            // Search for the next empty block starting from current position + 1
                            for (let i = window.selectedSquare + 1; i < cellCount; i++) {
                                if (!diagram.groups[window.selectedGroup][i]) {
                                    nextEmptyIdx = i;
                                    break;
                                }
                            }

                            // If found an empty block, open dialog for it
                            if (nextEmptyIdx !== -1) {
                                window.selectedSquare = nextEmptyIdx;
                                populatePersonList(window.selectedDiagramId, window.selectedGroup, nextEmptyIdx);
                                return; // Don't close the dialog, it's already re-opened
                            }
                        }

                        dialog.close();
                    }
                }
            }

            personCombo.addEventListener('input', function () { handlePersonSelection(false); });
            personCombo.addEventListener('change', function () { handlePersonSelection(false); });

            // Helper function to normalize text by removing accents
            function normalizeText(text) {
                return text.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
            }

            // Track highlighted index for keyboard navigation
            let highlightedIndex = -1;

            // Update dropdown options with filtered list
            function updateDropdownOptions(options) {
                personList.innerHTML = '';
                highlightedIndex = -1;
                options.forEach(function (name, index) {
                    const li = document.createElement('li');
                    li.textContent = name;
                    li.dataset.value = name;
                    li.addEventListener('click', function () {
                        personCombo.value = name;
                        personList.classList.remove('open');
                        handlePersonSelection(true);
                    });
                    personList.appendChild(li);
                });
            }

            // Filter dropdown options as user types (accent-insensitive)
            personCombo.addEventListener('input', function () {
                const typedValue = normalizeText(personCombo.value.trim());

                let filteredOptions;
                if (typedValue === '') {
                    filteredOptions = window.currentOptions;
                } else {
                    filteredOptions = window.currentOptions.filter(function (name) {
                        return normalizeText(name).includes(typedValue);
                    });
                }

                updateDropdownOptions(filteredOptions);
                personList.classList.add('open');
            });

            // Show dropdown on focus
            personCombo.addEventListener('focus', function () {
                const typedValue = normalizeText(personCombo.value.trim());
                let filteredOptions;
                if (typedValue === '') {
                    filteredOptions = window.currentOptions;
                } else {
                    filteredOptions = window.currentOptions.filter(function (name) {
                        return normalizeText(name).includes(typedValue);
                    });
                }
                updateDropdownOptions(filteredOptions);
                personList.classList.add('open');
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', function (e) {
                if (!personCombo.contains(e.target) && !personList.contains(e.target)) {
                    personList.classList.remove('open');
                }
            });

            // Handle Enter key and keyboard navigation
            personCombo.addEventListener('keydown', function (e) {
                const items = personList.querySelectorAll('li');

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    highlightedIndex = Math.min(highlightedIndex + 1, items.length - 1);
                    updateHighlight(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    highlightedIndex = Math.max(highlightedIndex - 1, 0);
                    updateHighlight(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (highlightedIndex >= 0 && items[highlightedIndex]) {
                        personCombo.value = items[highlightedIndex].dataset.value;
                        personList.classList.remove('open');
                        handlePersonSelection(true);
                    } else {
                        // Auto-select if only one match
                        const typedValue = normalizeText(personCombo.value.trim());
                        const matchingOptions = window.currentOptions.filter(name =>
                            normalizeText(name).includes(typedValue)
                        );
                        if (matchingOptions.length === 1) {
                            personCombo.value = matchingOptions[0];
                            personList.classList.remove('open');
                            handlePersonSelection(true);
                        }
                    }
                } else if (e.key === 'Escape') {
                    personList.classList.remove('open');
                }
            });

            function updateHighlight(items) {
                items.forEach(function (item, index) {
                    item.classList.toggle('highlighted', index === highlightedIndex);
                });
                // Scroll highlighted item into view
                if (items[highlightedIndex]) {
                    items[highlightedIndex].scrollIntoView({ block: 'nearest' });
                }
            }

            // Drag and drop functionality for reordering diagrams
            let draggedItem = null;

            diagramsList.addEventListener('dragstart', function (e) {
                const item = e.target.closest('.diagram-item');
                if (!item) return;
                draggedItem = item;
                item.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', item.dataset.diagramId);
            });

            diagramsList.addEventListener('dragend', function (e) {
                const item = e.target.closest('.diagram-item');
                if (item) {
                    item.classList.remove('dragging');
                }
                // Remove drag-over class from all items
                diagramsList.querySelectorAll('.diagram-item').forEach(function (el) {
                    el.classList.remove('drag-over');
                });
                draggedItem = null;
            });

            diagramsList.addEventListener('dragover', function (e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                const targetItem = e.target.closest('.diagram-item');
                if (targetItem && targetItem !== draggedItem) {
                    // Remove drag-over from all, add to current target
                    diagramsList.querySelectorAll('.diagram-item').forEach(function (el) {
                        el.classList.remove('drag-over');
                    });
                    targetItem.classList.add('drag-over');
                }
            });

            diagramsList.addEventListener('dragleave', function (e) {
                const targetItem = e.target.closest('.diagram-item');
                if (targetItem && !targetItem.contains(e.relatedTarget)) {
                    targetItem.classList.remove('drag-over');
                }
            });

            diagramsList.addEventListener('drop', function (e) {
                e.preventDefault();
                const targetItem = e.target.closest('.diagram-item');
                if (!targetItem || !draggedItem || targetItem === draggedItem) return;

                // Get positions in DOM
                const items = Array.from(diagramsList.querySelectorAll('.diagram-item'));
                const draggedIndex = items.indexOf(draggedItem);
                const targetIndex = items.indexOf(targetItem);

                // Reorder DOM
                if (draggedIndex < targetIndex) {
                    targetItem.after(draggedItem);
                } else {
                    targetItem.before(draggedItem);
                }

                // Reorder diagrams array to match DOM order
                const newItems = Array.from(diagramsList.querySelectorAll('.diagram-item'));
                const newDiagrams = [];
                newItems.forEach(function (el) {
                    const id = parseInt(el.dataset.diagramId);
                    const diagram = diagrams.find(d => d.id === id);
                    if (diagram) newDiagrams.push(diagram);
                });
                diagrams = newDiagrams;
                setDiagramsDirty(true);

                // Clean up
                targetItem.classList.remove('drag-over');
            });

            // Event delegation for add group and remove diagram buttons
            diagramsList.addEventListener('click', function (e) {
                // Add description link
                if (e.target.classList.contains('add-description-link')) {
                    e.preventDefault();
                    const diagramId = parseInt(e.target.dataset.id);
                    const input = document.getElementById('desc-input-' + diagramId);
                    if (input) {
                        e.target.style.display = 'none';
                        input.style.display = 'block';
                        input.focus();
                    }
                }
                // Edit description button
                if (e.target.closest('.edit-description-btn')) {
                    const btn = e.target.closest('.edit-description-btn');
                    const diagramId = parseInt(btn.dataset.id);
                    const input = document.getElementById('desc-input-' + diagramId);
                    const text = document.getElementById('desc-text-' + diagramId);
                    if (input && text) {
                        text.style.display = 'none';
                        btn.style.display = 'none';
                        input.style.display = 'block';
                        input.focus();
                    }
                }
                // Add group button
                if (e.target.classList.contains('add-group-btn')) {
                    const diagramId = parseInt(e.target.dataset.id);
                    const diagram = diagrams.find(d => d.id === diagramId);
                    if (diagram) {
                        const cellCount = (diagram.rows || 2) * (diagram.columns || 2);
                        diagram.groups.push(Array(cellCount).fill(null));
                        setDiagramsDirty(true);
                        drawDiagram(diagram);
                    }
                }
                // Remove diagram button
                if (e.target.classList.contains('remove-diagram-btn')) {
                    const diagramId = parseInt(e.target.dataset.id);
                    const diagram = diagrams.find(d => d.id === diagramId);
                    if (diagram && confirm('Segur que vols eliminar el ball "' + diagram.danceName + '"?')) {
                        diagrams = diagrams.filter(d => d.id !== diagramId);
                        const element = document.getElementById('diagram-item-' + diagramId);
                        if (element) element.remove();
                        setDiagramsDirty(true);
                    }
                }
            });

            // Handle description input blur and enter key
            diagramsList.addEventListener('blur', function (e) {
                if (e.target.classList.contains('diagram-description-input')) {
                    saveDescriptionFromInput(e.target);
                }
            }, true);

            diagramsList.addEventListener('keydown', function (e) {
                if (e.target.classList.contains('diagram-description-input') && e.key === 'Enter') {
                    e.preventDefault();
                    e.target.blur();
                }
                if (e.target.classList.contains('diagram-description-input') && e.key === 'Escape') {
                    e.preventDefault();
                    const diagramId = parseInt(e.target.id.replace('desc-input-', ''));
                    const diagram = diagrams.find(d => d.id === diagramId);
                    if (diagram) {
                        e.target.value = diagram.description || '';
                    }
                    e.target.blur();
                }
            });

            function saveDescriptionFromInput(input) {
                const diagramId = parseInt(input.id.replace('desc-input-', ''));
                const diagram = diagrams.find(d => d.id === diagramId);
                if (!diagram) return;

                const newDescription = input.value.trim();
                diagram.description = newDescription;
                setDiagramsDirty(true);

                // Re-render the diagram element to update the description UI
                const oldElement = document.getElementById('diagram-item-' + diagramId);
                if (oldElement) {
                    const newElement = createDiagramElement(diagram);
                    oldElement.replaceWith(newElement);
                    setupCanvasClickHandler(diagramId);
                    drawDiagram(diagram);
                }
            }

            // Close dialog when clicking outside or pressing Escape
            dialog.addEventListener('click', function (e) {
                if (e.target === dialog) {
                    dialog.close();
                }
            });

            // Floating save button functionality
            const floatingSaveBtn = document.getElementById('floating-save-btn');
            const saveIcon = floatingSaveBtn.querySelector('.save-icon');
            const eventMeetingPlaceInput = document.getElementById('event-meeting-place-input');

            floatingSaveBtn.addEventListener('click', function () {
                // Validate required fields
                const eventName = eventNameInput.value.trim();
                const eventDatetime = eventDatetimeInput.value;
                const eventMeetingPlace = eventMeetingPlaceInput ? eventMeetingPlaceInput.value.trim() : '';

                if (!eventName) {
                    alert('Si us plau, introdueix el nom de l\'actuaci√≥.');
                    eventNameInput.focus();
                    return;
                }

                if (!eventDatetime) {
                    alert('Si us plau, introdueix la data de l\'actuaci√≥.');
                    eventDatetimeInput.focus();
                    return;
                }

                if (diagrams.length === 0) {
                    alert('Si us plau, afegeix almenys un ball.');
                    return;
                }

                // Prepare data for saving
                const eventData = {
                    name: eventName,
                    datetime: eventDatetime,
                    meetingPlace: eventMeetingPlace,
                    diagrams: diagrams.map(function (d) {
                        return {
                            danceName: d.danceName,
                            description: d.description || '',
                            rows: d.rows,
                            columns: d.columns,
                            positions: d.positions,
                            groups: d.groups
                        };
                    })
                };

                // Show saving state
                floatingSaveBtn.disabled = true;
                floatingSaveBtn.classList.add('saving');
                saveIcon.innerHTML = '<circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="32" stroke-dashoffset="32"><animate attributeName="stroke-dashoffset" values="32;0" dur="1s" repeatCount="indefinite"/></circle>';

                // Call server-side function to save
                API.saveEvent({ event: eventData })
                    .then(function (result) {
                        floatingSaveBtn.classList.remove('saving');
                        floatingSaveBtn.classList.add('success');
                        saveIcon.innerHTML = '<polyline points="20 6 9 17 4 12" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"></polyline>';
                        setDiagramsDirty(false);

                        // Update URL hash with event ID so refresh works
                        if (result && result.sheetName) {
                            window.location.hash = 'events/' + encodeURIComponent(result.sheetName);
                            localStorage.setItem('currentRoute', 'events/' + encodeURIComponent(result.sheetName));
                        }

                        setTimeout(function () {
                            floatingSaveBtn.disabled = false;
                            floatingSaveBtn.classList.remove('success');
                            saveIcon.innerHTML = '<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline>';
                        }, 2000);
                    })
                    .catch(function (error) {
                        console.error('Error saving event:', error);
                        floatingSaveBtn.classList.remove('saving');
                        floatingSaveBtn.classList.add('error');
                        saveIcon.innerHTML = '<line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"></line><line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"></line>';

                        setTimeout(function () {
                            floatingSaveBtn.disabled = false;
                            floatingSaveBtn.classList.remove('error');
                            saveIcon.innerHTML = '<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline>';
                        }, 3000);

                        alert('Error desant l\'actuaci√≥: ' + (error.message || error));
                    });
            });

            // Floating share button functionality
            const floatingShareBtn = document.getElementById('floating-share-btn');

            floatingShareBtn.addEventListener('click', async function () {
                if (diagrams.length === 0) {
                    alert('No hi ha cap ball per compartir.');
                    return;
                }

                floatingShareBtn.disabled = true;

                try {
                    // Get event name and date for the image header
                    const eventName = eventNameInput.value.trim() || document.getElementById('event-name-display').textContent || 'Actuaci√≥';
                    const eventDateValue = eventDatetimeInput.value;
                    let eventDateFormatted = '';
                    if (eventDateValue) {
                        const date = new Date(eventDateValue);
                        if (!isNaN(date.getTime())) {
                            eventDateFormatted = date.toLocaleDateString('ca-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                        }
                    }

                    // Create separate image for each diagram
                    const files = [];

                    diagrams.forEach(function (diagram, index) {
                        const canvas = document.getElementById('diagram-canvas-' + diagram.id);
                        if (!canvas) return;

                        // Calculate height for this individual image
                        const headerHeight = 80;
                        const padding = 30;
                        const descriptionHeight = diagram.description ? 30 : 0;
                        const titleHeight = 35;
                        const totalHeight = headerHeight + titleHeight + descriptionHeight + canvas.height + padding * 2;

                        // Create a canvas for this diagram
                        const imageCanvas = document.createElement('canvas');
                        const ctx = imageCanvas.getContext('2d');
                        imageCanvas.width = 1200;
                        imageCanvas.height = totalHeight;

                        // Fill background
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(0, 0, imageCanvas.width, imageCanvas.height);

                        // Draw header
                        ctx.fillStyle = '#1976d2';
                        ctx.fillRect(0, 0, imageCanvas.width, headerHeight);

                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 28px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(`${eventName} - ${eventDateFormatted}`, imageCanvas.width / 2, headerHeight / 2 - 12);

                        if (diagram.description) {
                            ctx.font = '20px sans-serif';
                            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                            ctx.fillText(diagram.description, imageCanvas.width / 2, headerHeight / 2 + 18);
                        }

                        let yOffset = headerHeight + padding;
                        // Draw dance name
                        ctx.fillStyle = '#333';
                        ctx.font = 'bold 22px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.fillText(diagram.danceName, imageCanvas.width / 2, yOffset + 18);
                        yOffset += 35;

                        // Draw the diagram canvas
                        ctx.drawImage(canvas, 0, yOffset);

                        // Convert to blob and create file
                        imageCanvas.toBlob(function (blob) {
                            const fileName = eventName + ' - ' + diagram.danceName + '.png';
                            const file = new File([blob], fileName, { type: 'image/png' });
                            files.push(file);
                        }, 'image/png');
                    });

                    // Wait for all files to be created
                    const maxWait = 5000;
                    const startTime = Date.now();
                    while (files.length < diagrams.length && Date.now() - startTime < maxWait) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }

                    // Share files using Web Share API, fall back to download
                    if (navigator.share && navigator.canShare && files.length > 0 && navigator.canShare({ files: files })) {
                        await navigator.share({
                            files: files,
                            title: eventName,
                            text: `${eventName}\n ${eventDateFormatted}`,
                        });
                        floatingShareBtn.classList.add('success');
                        setTimeout(function () {
                            floatingShareBtn.classList.remove('success');
                        }, 2000);
                    } else if (files.length > 0) {
                        // Fallback: download each image
                        files.forEach(function (file) {
                            const url = URL.createObjectURL(file);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = file.name;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                        });

                        floatingShareBtn.classList.add('success');
                        setTimeout(function () {
                            floatingShareBtn.classList.remove('success');
                        }, 2000);
                    }
                } catch (error) {
                    console.error('Error sharing event:', error);
                    alert('Error compartint l\'actuaci√≥: ' + (error.message || error));
                } finally {
                    floatingShareBtn.disabled = false;
                }
            });

            // Floating lock button long-press functionality
            const floatingLockBtn = document.getElementById('floating-lock-btn');
            let lockBtnPressTimer = null;
            let lockBtnPressed = false;

            function resetLockBtnProgress() {
                floatingLockBtn.classList.remove('pressing');
                const progressRing = floatingLockBtn.querySelector('.progress-ring');
                progressRing.style.strokeDashoffset = '138.23';
                lockBtnPressed = false;
            }

            floatingLockBtn.addEventListener('mousedown', function () {
                if (isEventEditable) return; // Only work when event is locked

                lockBtnPressed = true;
                floatingLockBtn.classList.add('pressing');
                let pressedTime = 0;
                const pressDuration = 3000; // 3 seconds
                const maxDashOffset = 138.23;
                const progressRing = floatingLockBtn.querySelector('.progress-ring');

                lockBtnPressTimer = setInterval(function () {
                    if (!lockBtnPressed) {
                        clearInterval(lockBtnPressTimer);
                        resetLockBtnProgress();
                        return;
                    }

                    pressedTime += 50;
                    const progress = Math.min(pressedTime / pressDuration, 1);
                    const dashOffset = maxDashOffset * (1 - progress);
                    progressRing.style.strokeDashoffset = dashOffset;

                    if (pressedTime >= pressDuration) {
                        clearInterval(lockBtnPressTimer);
                        floatingLockBtn.classList.remove('pressing');
                        
                        // Make event editable again
                        isEventManuallyUnlocked = true;
                        isEventEditable = true;
                        applyEditableState();
                        
                        // Show success feedback
                        floatingLockBtn.style.background = '#43a047';
                        setTimeout(function () {
                            floatingLockBtn.style.background = '#757575';
                            resetLockBtnProgress();
                        }, 1000);
                    }
                }, 50);
            });

            floatingLockBtn.addEventListener('mouseup', function () {
                if (lockBtnPressTimer) {
                    clearInterval(lockBtnPressTimer);
                    resetLockBtnProgress();
                }
            });

            floatingLockBtn.addEventListener('mouseleave', function () {
                if (lockBtnPressTimer) {
                    clearInterval(lockBtnPressTimer);
                    resetLockBtnProgress();
                }
            });

            // Touch events for mobile devices
            floatingLockBtn.addEventListener('touchstart', function () {
                if (isEventEditable) return; // Only work when event is locked

                lockBtnPressed = true;
                floatingLockBtn.classList.add('pressing');
                let pressedTime = 0;
                const pressDuration = 3000; // 3 seconds
                const maxDashOffset = 138.23;
                const progressRing = floatingLockBtn.querySelector('.progress-ring');

                lockBtnPressTimer = setInterval(function () {
                    if (!lockBtnPressed) {
                        clearInterval(lockBtnPressTimer);
                        resetLockBtnProgress();
                        return;
                    }

                    pressedTime += 50;
                    const progress = Math.min(pressedTime / pressDuration, 1);
                    const dashOffset = maxDashOffset * (1 - progress);
                    progressRing.style.strokeDashoffset = dashOffset;

                    if (pressedTime >= pressDuration) {
                        clearInterval(lockBtnPressTimer);
                        floatingLockBtn.classList.remove('pressing');
                        
                        // Make event editable again
                        isEventManuallyUnlocked = true;
                        isEventEditable = true;
                        applyEditableState();
                        
                        // Show success feedback
                        floatingLockBtn.style.background = '#43a047';
                        setTimeout(function () {
                            floatingLockBtn.style.background = '#757575';
                            resetLockBtnProgress();
                        }, 1000);
                    }
                }, 50);
            });

            floatingLockBtn.addEventListener('touchend', function () {
                if (lockBtnPressTimer) {
                    clearInterval(lockBtnPressTimer);
                    resetLockBtnProgress();
                }
            });

            floatingLockBtn.addEventListener('touchcancel', function () {
                if (lockBtnPressTimer) {
                    clearInterval(lockBtnPressTimer);
                    resetLockBtnProgress();
                }
            });
        });
    </script>

    <!-- Members View -->
    <div id="view-members" class="view" data-view="members" style="display: none;">
        <div class="container">
            <div class="page-header">
                <div class="page-title">
                    <h1>Llista de Membres</h1>
                    <button type="button" class="btn-refresh" id="refresh-members-btn"
                        title="Actualitzar llista">
                        <svg class="refresh-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8" />
                            <path d="M21 3v5h-5" />
                        </svg>
                    </button>
                </div>
                <div class="page-actions">
                    <button type="button" class="btn btn-secondary" id="edit-all-members-btn">
                        <span class="btn-icon">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </span>
                        <span class="btn-label">Editar</span>
                    </button>
                    <button type="button" class="btn btn-primary" id="add-member-btn">
                        <span class="btn-icon">+</span> <span class="btn-label">Afegir membre</span>
                    </button>
                </div>
            </div>

            <!-- Inline edit action bar (shown when editing) -->
            <div id="members-edit-actions" class="members-edit-actions" style="display: none;">
                <span class="edit-info">Editant membres...</span>
                <div class="edit-buttons">
                    <button type="button" class="btn btn-secondary" id="members-edit-discard">Descartar</button>
                    <button type="button" class="btn btn-primary" id="members-edit-apply">
                        <span class="btn-text">Aplicar canvis</span>
                        <span class="btn-loading" style="display: none;">
                            <span class="spinner-small"></span> Desant...
                        </span>
                    </button>
                </div>
            </div>

            <div class="card members-card">
                <div class="members-filter" id="members-filter" style="display: none;">
                    <input type="text" id="members-search" class="members-search-input"
                        placeholder="Cercar membres...">
                </div>
                <div id="members-filter-summary" class="members-filter-summary" style="display: none;">
                    <span id="filter-summary-text" class="filter-summary-text"></span>
                    <a href="#" id="clear-all-filters" class="clear-filters-link">Netejar filtres</a>
                </div>
                <div class="members-table-wrapper">
                    <table id="members-table" class="responsive-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="name">
                                    Nom <span class="sort-icon"></span>
                                    <span class="filter-icon" id="name-filter-toggle" title="Cercar per nom">
                                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round">
                                            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3">
                                            </polygon>
                                        </svg>
                                    </span>
                                </th>
                                <th class="sortable" data-sort="email">
                                    Email <span class="sort-icon"></span>
                                    <span class="filter-icon" id="email-filter-toggle" title="Cercar per email">
                                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round">
                                            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3">
                                            </polygon>
                                        </svg>
                                    </span>
                                </th>
                                <th class="sortable" data-sort="type" style="position: relative;">
                                    Tipus <span class="sort-icon"></span>
                                    <span class="filter-icon" id="type-filter-toggle" title="Filtrar per tipus">
                                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round">
                                            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3">
                                            </polygon>
                                        </svg>
                                    </span>
                                    <div id="type-filter-dropdown" class="type-filter-dropdown"
                                        style="display: none;">
                                        <div class="type-filter-option" data-value="">Tots</div>
                                        <div class="type-filter-option" data-value="ADULT">Adult</div>
                                        <div class="type-filter-option" data-value="KID">Xiquet/a</div>
                                    </div>
                                </th>
                                <th style="position: relative;">
                                    Rols
                                    <span class="filter-icon" id="rols-filter-toggle" title="Filtrar per rol">
                                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round">
                                            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3">
                                            </polygon>
                                        </svg>
                                    </span>
                                    <div id="rols-filter-dropdown" class="type-filter-dropdown"
                                        style="display: none;">
                                        <div class="type-filter-option" data-value="">Tots</div>
                                        <div class="type-filter-option" data-value="ADMIN">Amb ADMIN</div>
                                        <div class="type-filter-option" data-value="NO_ADMIN">Sense ADMIN</div>
                                    </div>
                                </th>
                                <th style="position: relative;">
                                    Acc√©s a
                                    <span class="filter-icon" id="access-filter-toggle"
                                        title="Filtrar per acc√©s">
                                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round">
                                            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3">
                                            </polygon>
                                        </svg>
                                    </span>
                                    <div id="access-filter-dropdown" class="type-filter-dropdown"
                                        style="display: none;">
                                        <div class="type-filter-option" data-value="">Tots</div>
                                        <div class="type-filter-option" data-value="HAS_ACCESS">T√© acc√©s a
                                            altres</div>
                                        <div class="type-filter-option" data-value="NO_ACCESS">No t√© acc√©s a
                                            altres</div>
                                    </div>
                                </th>
                                <th class="active-column" style="display: none;">En actiu</th>
                                <th id="active-filter-header" style="width: 40px; position: relative;"
                                    title="Filtrar per actiu">
                                    <span class="filter-icon" id="active-filter-toggle"
                                        title="Filtrar per actiu">
                                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                            <circle cx="12" cy="12" r="3"></circle>
                                        </svg>
                                    </span>
                                    <div id="active-filter-dropdown" class="type-filter-dropdown"
                                        style="display: none; right: 0; left: auto;">
                                        <div class="type-filter-option" data-value="">Tots</div>
                                        <div class="type-filter-option" data-value="true">Actius</div>
                                        <div class="type-filter-option" data-value="false">Inactius</div>
                                    </div>
                                </th>
                                <th style="width: 40px; text-align: center; vertical-align: middle;"
                                    title="Canviar contrasenya">
                                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none"
                                        stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" style="vertical-align: middle;">
                                        <path
                                            d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4">
                                        </path>
                                    </svg>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Members will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Members page mobile styles */
        @media (max-width: 768px) {
            .members-card {
                padding: 15px 10px;
            }

            .hide-mobile {
                display: none !important;
            }

            .responsive-table {
                min-width: auto;
            }

            .responsive-table th,
            .responsive-table td {
                padding: 12px 8px;
            }

            #add-member-btn .btn-label {
                display: inline;
            }
        }

        @media (max-width: 480px) {
            #add-member-btn .btn-label {
                display: none;
            }

            #add-member-btn .btn-icon {
                margin-right: 0;
            }

            .members-edit-actions .edit-info {
                font-size: 0.9em;
            }

            .members-edit-actions .btn {
                padding: 8px 12px;
                font-size: 0.85em;
            }
        }

        .filter-icon {
            cursor: pointer;
            opacity: 0.6;
            margin-left: 4px;
            vertical-align: middle;
            transition: opacity 0.2s;
        }

        .filter-icon:hover {
            opacity: 1;
        }

        .filter-icon.active {
            opacity: 1;
            color: var(--primary-color, #007bff);
        }

        .filter-icon svg {
            display: inline-block;
            vertical-align: middle;
        }

        .type-filter-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 100;
            min-width: 120px;
            padding: 8px 0;
        }

        .type-filter-option {
            display: block;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: normal;
            white-space: nowrap;
            color: #333;
            transition: background 0.15s;
        }

        .type-filter-option:hover {
            background: #f5f5f5;
        }

        .type-filter-option.selected {
            background: var(--primary-color, #007bff);
            color: white;
        }

        .type-filter-option.selected:hover {
            background: var(--primary-color-dark, #0056b3);
        }

        .page-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .page-actions .btn {
            height: 40px;
            box-sizing: border-box;
        }

        #edit-all-members-btn .btn-icon {
            display: inline-flex;
            align-items: center;
            margin-right: 4px;
        }

        #edit-all-members-btn .btn-icon svg {
            vertical-align: middle;
        }

        @media (max-width: 480px) {
            #edit-all-members-btn .btn-label {
                display: none;
            }

            #edit-all-members-btn .btn-icon {
                margin-right: 0;
            }
        }

        .members-filter-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .members-filter-summary .filter-summary-text {
            flex: 1;
            font-style: italic;
            font-size: 0.85em;
        }

        .clear-filters-link {
            color: var(--primary-color, #007bff);
            text-decoration: none;
            font-size: 0.9em;
            white-space: nowrap;
            margin-left: 16px;
        }

        .clear-filters-link:hover {
            text-decoration: underline;
        }

        /* Password change button */
        .btn-change-password {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            color: #666;
            transition: color 0.2s, transform 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-change-password:hover {
            color: var(--primary-color, #007bff);
            transform: scale(1.1);
        }

        .btn-change-password svg {
            width: 16px;
            height: 16px;
        }

        /* Password change dialog */
        #password-change-dialog {
            padding: 0;
            border: none;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
            min-width: 380px;
            max-width: 90vw;
            background: #fff;
            color: #1f2937;
            text-align: left;
        }

        body.dark-mode #password-change-dialog {
            background: #2d3748;
            color: #e2e8f0;
        }

        #password-change-dialog::backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        #password-change-dialog[open] {
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }

        .password-dialog-content {
            padding: 1.5em;
            border-radius: 16px 16px 0 0;
            background: #fff;
            box-sizing: border-box;
        }

        body.dark-mode .password-dialog-content {
            background: #2d3748;
        }

        .password-dialog-content h3 {
            margin: 0 0 0.5em 0;
            font-size: 1.2rem;
            color: #333;
        }

        body.dark-mode .password-dialog-content h3 {
            color: #e2e8f0;
        }

        .password-dialog-content p {
            margin: 0 0 1em 0;
            color: #666;
            font-size: 0.95rem;
        }

        body.dark-mode .password-dialog-content p {
            color: #a0aec0;
        }

        .password-dialog-content .form-group {
            margin-bottom: 1em;
        }

        .password-dialog-content label {
            display: block;
            margin-bottom: 0.4em;
            font-weight: 500;
            color: #333;
            font-size: 0.95rem;
        }

        body.dark-mode .password-dialog-content label {
            color: #cbd5e0;
        }

        .password-dialog-content input[type="password"] {
            width: 100%;
            padding: 0.7em 1em;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .password-dialog-content input[type="password"]:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.15);
        }

        .password-dialog-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 1em 1.5em;
            border-top: 1px solid #eee;
            background: #fafafa;
            border-radius: 0 0 16px 16px;
        }

        body.dark-mode .password-dialog-actions {
            border-top-color: #4a5568;
            background: #1a202c;
        }

        .password-dialog-actions .btn {
            padding: 0.6em 1.2em;
            font-size: 0.95rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
    </style>

    <!-- Access Link Dialog -->
    <dialog id="access-link-dialog">
        <div class="password-dialog-content">
            <h3>Sol¬∑licitar acc√©s</h3>
            <p>Introdueix el teu correu electr√≤nic per rebre un enlla√ß d'acc√©s</p>
            <div class="form-group">
                <label for="access-link-email">Correu electr√≤nic</label>
                <input type="email" id="access-link-email" placeholder="Introdueix el teu correu electr√≤nic" autocomplete="email" required>
            </div>
        </div>
        <div class="password-dialog-actions">
            <button type="button" class="btn btn-secondary" id="access-link-cancel-btn">Cancel¬∑lar</button>
            <button type="button" class="btn btn-primary" id="access-link-send-btn">Enviar acc√©s</button>
        </div>
    </dialog>

    <!-- Password Change Dialog -->
    <dialog id="password-change-dialog">
        <div class="password-dialog-content">
            <h3>Canviar contrasenya</h3>
            <p id="password-change-member-name"></p>
            <div class="form-group">
                <label for="new-password">Nova contrasenya</label>
                <input type="password" id="new-password" placeholder="M√≠nim 8 car√†cters" autocomplete="new-password" required>
            </div>
            <div class="form-group">
                <label for="confirm-password">Confirmar contrasenya</label>
                <input type="password" id="confirm-password" placeholder="Repeteix la contrasenya" autocomplete="new-password" required>
            </div>
        </div>
        <div class="password-dialog-actions">
            <button type="button" class="btn btn-secondary" id="password-cancel-btn">Cancel¬∑lar</button>
            <button type="button" class="btn btn-primary" id="password-save-btn">Desar</button>
        </div>
    </dialog>

    <script>
        (function () {
            const nameFilterToggle = document.getElementById('name-filter-toggle');
            const emailFilterToggle = document.getElementById('email-filter-toggle');
            const typeFilterToggle = document.getElementById('type-filter-toggle');
            const typeFilterDropdown = document.getElementById('type-filter-dropdown');
            const rolsFilterToggle = document.getElementById('rols-filter-toggle');
            const rolsFilterDropdown = document.getElementById('rols-filter-dropdown');
            const accessFilterToggle = document.getElementById('access-filter-toggle');
            const accessFilterDropdown = document.getElementById('access-filter-dropdown');
            const activeFilterToggle = document.getElementById('active-filter-toggle');
            const activeFilterDropdown = document.getElementById('active-filter-dropdown');
            const membersFilter = document.getElementById('members-filter');
            const searchInput = document.getElementById('members-search');
            const filterSummary = document.getElementById('members-filter-summary');
            const filterSummaryText = document.getElementById('filter-summary-text');
            const clearAllFiltersLink = document.getElementById('clear-all-filters');

            // Update filter summary based on active filters
            function updateFilterSummary() {
                const parts = [];

                // Check search filter
                const searchValue = searchInput ? searchInput.value.trim() : '';
                if (searchValue) {
                    parts.push('cerca "' + searchValue + '"');
                }

                // Check type filter
                if (typeof membersTypeFilterValue !== 'undefined' && membersTypeFilterValue) {
                    const typeLabel = membersTypeFilterValue === 'ADULT' ? 'Adults' : 'Xiquets/es';
                    parts.push(typeLabel);
                }

                // Check rols filter
                if (typeof membersRolsFilterValue !== 'undefined' && membersRolsFilterValue) {
                    const rolLabel = membersRolsFilterValue === 'ADMIN' ? 'amb ADMIN' : 'sense ADMIN';
                    parts.push(rolLabel);
                }

                // Check access filter
                if (typeof membersAccessFilterValue !== 'undefined' && membersAccessFilterValue) {
                    const accessLabel = membersAccessFilterValue === 'HAS_ACCESS' ? 'amb acc√©s a altres' : 'sense acc√©s a altres';
                    parts.push(accessLabel);
                }

                // Check active filter
                if (typeof membersActiveFilterValue !== 'undefined' && membersActiveFilterValue) {
                    const activeLabel = membersActiveFilterValue === 'true' ? 'actius' : 'inactius';
                    parts.push(activeLabel);
                }

                if (parts.length > 0 && filterSummary && filterSummaryText) {
                    filterSummaryText.textContent = 'Mostrant: ' + parts.join(', ');
                    filterSummary.style.display = 'flex';
                } else if (filterSummary) {
                    filterSummary.style.display = 'none';
                }
            }

            // Clear all filters
            function clearAllFilters(e) {
                if (e) e.preventDefault();

                // Clear search
                if (searchInput) {
                    searchInput.value = '';
                }
                membersFilter.style.display = 'none';
                [nameFilterToggle, emailFilterToggle].forEach(function (el) {
                    if (el) el.classList.remove('active');
                });

                // Clear type filter
                if (typeof membersTypeFilterValue !== 'undefined') {
                    membersTypeFilterValue = '';
                }
                if (typeFilterDropdown) {
                    const options = typeFilterDropdown.querySelectorAll('.type-filter-option');
                    options.forEach(function (opt, i) {
                        opt.classList.toggle('selected', i === 0);
                    });
                }
                if (typeFilterToggle) typeFilterToggle.classList.remove('active');

                // Clear rols filter
                if (typeof membersRolsFilterValue !== 'undefined') {
                    membersRolsFilterValue = '';
                }
                if (rolsFilterDropdown) {
                    const options = rolsFilterDropdown.querySelectorAll('.type-filter-option');
                    options.forEach(function (opt, i) {
                        opt.classList.toggle('selected', i === 0);
                    });
                }
                if (rolsFilterToggle) rolsFilterToggle.classList.remove('active');

                // Clear access filter
                if (typeof membersAccessFilterValue !== 'undefined') {
                    membersAccessFilterValue = '';
                }
                if (accessFilterDropdown) {
                    const options = accessFilterDropdown.querySelectorAll('.type-filter-option');
                    options.forEach(function (opt, i) {
                        opt.classList.toggle('selected', i === 0);
                    });
                }
                if (accessFilterToggle) accessFilterToggle.classList.remove('active');

                // Clear active filter
                if (typeof membersActiveFilterValue !== 'undefined') {
                    membersActiveFilterValue = '';
                }
                if (activeFilterDropdown) {
                    const options = activeFilterDropdown.querySelectorAll('.type-filter-option');
                    options.forEach(function (opt, i) {
                        opt.classList.toggle('selected', i === 0);
                    });
                }
                if (activeFilterToggle) activeFilterToggle.classList.remove('active');

                // Re-render and update summary
                if (typeof renderMembersTable === 'function') {
                    renderMembersTable();
                }
                updateFilterSummary();
            }

            // Attach clear all filters handler
            if (clearAllFiltersLink) {
                clearAllFiltersLink.addEventListener('click', clearAllFilters);
            }

            // Update filter summary when search input changes
            if (searchInput) {
                searchInput.addEventListener('input', function () {
                    updateFilterSummary();
                });
            }

            // Make updateFilterSummary available globally
            window.updateMembersFilterSummary = updateFilterSummary;

            function toggleTextFilter(toggleElement) {
                if (!membersFilter) return;
                const isVisible = membersFilter.style.display !== 'none';
                membersFilter.style.display = isVisible ? 'none' : 'block';

                // Update active state for text filter toggles
                [nameFilterToggle, emailFilterToggle].forEach(function (el) {
                    if (el) el.classList.toggle('active', !isVisible);
                });

                if (!isVisible && searchInput) {
                    searchInput.focus();
                }
            }

            function toggleTypeDropdown(e) {
                if (!typeFilterDropdown) return;
                if (rolsFilterDropdown) rolsFilterDropdown.style.display = 'none';
                if (accessFilterDropdown) accessFilterDropdown.style.display = 'none';
                if (activeFilterDropdown) activeFilterDropdown.style.display = 'none';
                const isVisible = typeFilterDropdown.style.display !== 'none';
                typeFilterDropdown.style.display = isVisible ? 'none' : 'block';
            }

            function toggleRolsDropdown(e) {
                if (!rolsFilterDropdown) return;
                if (typeFilterDropdown) typeFilterDropdown.style.display = 'none';
                if (accessFilterDropdown) accessFilterDropdown.style.display = 'none';
                if (activeFilterDropdown) activeFilterDropdown.style.display = 'none';
                const isVisible = rolsFilterDropdown.style.display !== 'none';
                rolsFilterDropdown.style.display = isVisible ? 'none' : 'block';
            }

            function toggleAccessDropdown(e) {
                if (!accessFilterDropdown) return;
                if (typeFilterDropdown) typeFilterDropdown.style.display = 'none';
                if (rolsFilterDropdown) rolsFilterDropdown.style.display = 'none';
                if (activeFilterDropdown) activeFilterDropdown.style.display = 'none';
                const isVisible = accessFilterDropdown.style.display !== 'none';
                accessFilterDropdown.style.display = isVisible ? 'none' : 'block';
            }

            function toggleActiveDropdown(e) {
                if (!activeFilterDropdown) return;
                if (typeFilterDropdown) typeFilterDropdown.style.display = 'none';
                if (rolsFilterDropdown) rolsFilterDropdown.style.display = 'none';
                if (accessFilterDropdown) accessFilterDropdown.style.display = 'none';
                const isVisible = activeFilterDropdown.style.display !== 'none';
                activeFilterDropdown.style.display = isVisible ? 'none' : 'block';
            }

            // Close dropdown when clicking outside
            document.addEventListener('click', function (e) {
                if (typeFilterDropdown && !typeFilterToggle.contains(e.target) && !typeFilterDropdown.contains(e.target)) {
                    typeFilterDropdown.style.display = 'none';
                }
                if (rolsFilterDropdown && !rolsFilterToggle.contains(e.target) && !rolsFilterDropdown.contains(e.target)) {
                    rolsFilterDropdown.style.display = 'none';
                }
                if (accessFilterDropdown && !accessFilterToggle.contains(e.target) && !accessFilterDropdown.contains(e.target)) {
                    accessFilterDropdown.style.display = 'none';
                }
                if (activeFilterDropdown && !activeFilterToggle.contains(e.target) && !activeFilterDropdown.contains(e.target)) {
                    activeFilterDropdown.style.display = 'none';
                }
            });

            // Handle type filter selection
            if (typeFilterDropdown) {
                const options = typeFilterDropdown.querySelectorAll('.type-filter-option');
                options.forEach(function (option) {
                    option.addEventListener('click', function (e) {
                        e.stopPropagation();
                        const selectedValue = this.getAttribute('data-value');

                        // Update selected state
                        options.forEach(function (opt) {
                            opt.classList.remove('selected');
                        });
                        this.classList.add('selected');

                        // Set global filter value and re-render
                        if (typeof membersTypeFilterValue !== 'undefined') {
                            membersTypeFilterValue = selectedValue;
                            renderMembersTable();
                        }

                        // Update active state for type filter
                        typeFilterToggle.classList.toggle('active', selectedValue !== '');
                        typeFilterDropdown.style.display = 'none';
                        updateFilterSummary();
                    });
                });

                // Set initial selected state
                options[0].classList.add('selected');
            }

            // Handle rols filter selection
            if (rolsFilterDropdown) {
                const options = rolsFilterDropdown.querySelectorAll('.type-filter-option');
                options.forEach(function (option) {
                    option.addEventListener('click', function (e) {
                        e.stopPropagation();
                        const selectedValue = this.getAttribute('data-value');

                        // Update selected state
                        options.forEach(function (opt) {
                            opt.classList.remove('selected');
                        });
                        this.classList.add('selected');

                        // Set global filter value and re-render
                        if (typeof membersRolsFilterValue !== 'undefined') {
                            membersRolsFilterValue = selectedValue;
                            renderMembersTable();
                        }

                        // Update active state for rols filter
                        rolsFilterToggle.classList.toggle('active', selectedValue !== '');
                        rolsFilterDropdown.style.display = 'none';
                        updateFilterSummary();
                    });
                });

                // Set initial selected state
                options[0].classList.add('selected');
            }

            // Handle access filter selection
            if (accessFilterDropdown) {
                const options = accessFilterDropdown.querySelectorAll('.type-filter-option');
                options.forEach(function (option) {
                    option.addEventListener('click', function (e) {
                        e.stopPropagation();
                        const selectedValue = this.getAttribute('data-value');

                        // Update selected state
                        options.forEach(function (opt) {
                            opt.classList.remove('selected');
                        });
                        this.classList.add('selected');

                        // Set global filter value and re-render
                        if (typeof membersAccessFilterValue !== 'undefined') {
                            membersAccessFilterValue = selectedValue;
                            renderMembersTable();
                        }

                        // Update active state for access filter
                        accessFilterToggle.classList.toggle('active', selectedValue !== '');
                        accessFilterDropdown.style.display = 'none';
                        updateFilterSummary();
                    });
                });

                // Set initial selected state
                options[0].classList.add('selected');
            }

            // Handle active filter selection
            if (activeFilterDropdown) {
                const options = activeFilterDropdown.querySelectorAll('.type-filter-option');
                options.forEach(function (option) {
                    option.addEventListener('click', function (e) {
                        e.stopPropagation();
                        const selectedValue = this.getAttribute('data-value');

                        // Update selected state
                        options.forEach(function (opt) {
                            opt.classList.remove('selected');
                        });
                        this.classList.add('selected');

                        // Set global filter value and re-render
                        if (typeof membersActiveFilterValue !== 'undefined') {
                            membersActiveFilterValue = selectedValue;
                            renderMembersTable();
                        }

                        // Update active state for active filter
                        activeFilterToggle.classList.toggle('active', selectedValue !== '');
                        activeFilterDropdown.style.display = 'none';
                        updateFilterSummary();
                    });
                });

                // Set initial selected state
                options[0].classList.add('selected');
            }

            if (nameFilterToggle) {
                nameFilterToggle.addEventListener('click', function (e) {
                    e.stopPropagation();
                    toggleTextFilter(this);
                });
            }

            if (emailFilterToggle) {
                emailFilterToggle.addEventListener('click', function (e) {
                    e.stopPropagation();
                    toggleTextFilter(this);
                });
            }

            if (typeFilterToggle) {
                typeFilterToggle.addEventListener('click', function (e) {
                    e.stopPropagation();
                    toggleTypeDropdown(e);
                });
            }

            if (rolsFilterToggle) {
                rolsFilterToggle.addEventListener('click', function (e) {
                    e.stopPropagation();
                    toggleRolsDropdown(e);
                });
            }

            if (accessFilterToggle) {
                accessFilterToggle.addEventListener('click', function (e) {
                    e.stopPropagation();
                    toggleAccessDropdown(e);
                });
            }

            if (activeFilterToggle) {
                activeFilterToggle.addEventListener('click', function (e) {
                    e.stopPropagation();
                    toggleActiveDropdown(e);
                });
            }

            // Global edit button - calls startEditAllMembers from javascript.html
            const editAllBtn = document.getElementById('edit-all-members-btn');
            if (editAllBtn) {
                editAllBtn.addEventListener('click', function () {
                    if (typeof startEditAllMembers === 'function') {
                        startEditAllMembers();
                    }
                });
            }
        })();
    </script>



    <!-- 404 Not Found View -->
    <div id="view-404" class="view" data-view="404" style="display: none;">
        <div class="error-page">
            <h1>404</h1>
            <p>P√†gina no trobada</p>
            <a href="#" data-route="home" class="btn btn-primary">Anar a l'inici</a>
        </div>
    </div>

    <style>
        /* 404 page mobile styles */
        @media (max-width: 768px) {
            .error-page {
                padding: 60px 20px;
            }

            .error-page h1 {
                font-size: 6em;
            }

            .error-page p {
                font-size: 1.3em;
            }
        }

        @media (max-width: 480px) {
            .error-page {
                padding: 40px 15px;
            }

            .error-page h1 {
                font-size: 4em;
            }

            .error-page p {
                font-size: 1.1em;
                margin-bottom: 25px;
            }

            .error-page .btn {
                width: 100%;
                max-width: 250px;
            }
        }
    </style>  

</main>


    <!-- Media player -->
<style>
  .player-container {
    max-width: 400px;
  }
  .controls-container {
    margin-top: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .playback-rate-slider {
    flex: 1;
  }
  .playback-rate-label {
    min-width: 50px;
    text-align: right;
    font-weight: bold;
  }
</style>
<div class="player-container" style="display: none">
  <h2>Audio demo</h2>
  <audio id="audioPlayer" controls>
    <source src="https://www.w3schools.com/html/horse.mp3" type="audio/mpeg" />
    El teu navegador no suporta l'√†udio.
  </audio>
  <div class="controls-container">
    <label for="playbackRateSlider">Velocitat:</label>
    <input
      type="range"
      id="playbackRateSlider"
      class="playback-rate-slider"
      min="0.5"
      max="2"
      step="0.1"
      value="1"
    />
    <span class="playback-rate-label" id="playbackRateValue">1x</span>
  </div>
</div>
<script>
  var audio = document.getElementById("audioPlayer");
  var slider = document.getElementById("playbackRateSlider");
  var label = document.getElementById("playbackRateValue");

  audio.playbackRate = 1;

  slider.addEventListener("input", function () {
    audio.playbackRate = parseFloat(this.value);
    label.textContent = this.value + "x";
  });

  audio.onplay = function () {
    audio.playbackRate = parseFloat(slider.value);
  };
</script>

    <!-- Footer -->
<footer class="footer">
    <p>&copy; 2026 Fake company.</p>
</footer>
    
    <!-- Toast Notifications -->
<div id="toast-container" class="toast-container"></div>
<div>

        
        <script>
        ////// LOGGER
const LOG_ENABLED = true;
console = new Proxy(console, {
    get(target, prop) {
        if (!LOG_ENABLED) {
            return () => { };
        }
        return target[prop];
    }
});

        </script>
        

        
        <script>
        const DANCES = [
  {
    "name": "La polca",
    "structure": {
      "rows": 2,
      "columns": 4
    },
    "diagram": {
      "blockName": "Grup",
      "backgroundColor": {
        "BAIX": "#FFF2CC",
        "DALT": "#92D050"
      },
      "textColor": {
        "BAIX": "#000000",
        "DALT": "#000000"
      }
    },
    "positions": [
      {
        "order": 1,
        "positionType": {
          "label": "DALT"
        },
        "specifications": "Cant√≥ equerre/cara pla√ßa",
        "tag": "5"
      },
      {
        "order": 2,
        "positionType": {
          "label": "BAIX"
        },
        "specifications": "Mig equerre/cara pla√ßa",
        "tag": "6"
      },
      {
        "order": 3,
        "positionType": {
          "label": "DALT"
        },
        "specifications": "Mig dret/cara pla√ßa",
        "tag": "7"
      },
      {
        "order": 4,
        "positionType": {
          "label": "BAIX"
        },
        "specifications": "Cant√≥ dret/cara pla√ßa",
        "tag": "8"
      },
      {
        "order": 5,
        "positionType": {
          "label": "BAIX"
        },
        "specifications": "Cant√≥ equerre/esquena pla√ßa",
        "tag": "4"
      },
      {
        "order": 6,
        "positionType": {
          "label": "DALT"
        },
        "specifications": "Mig esquerre/esquena pla√ßa",
        "tag": "3"
      },
      {
        "order": 7,
        "positionType": {
          "label": "BAIX"
        },
        "specifications": "Mig dret/esquena pla√ßa",
        "tag": "2"
      },
      {
        "order": 8,
        "positionType": {
          "label": "DALT"
        },
        "specifications": "Cant√≥ dret/esquena pla√ßa",
        "tag": "1"
      }
    ],
    "minGroups": 1,
    "audios": []
  },
  {
    "name": "Ara i sempre",
    "structure": {
      "rows": 2,
      "columns": 1
    },
    "diagram": {
      "blockName": "Parella",
      "backgroundColor": {
        "ANTIHORARI": "#FFF2CC",
        "HORARI": "#92D050"
      },
      "textColor": {
        "ANTIHORARI": "#000000",
        "HORARI": "#000000"
      }
    },
    "positions": [
      {
        "order": 1,
        "positionType": {
          "label": "ANTIHORARI"
        },
        "specifications": "Antihorari",
        "tag": "1"
      },
      {
        "order": 2,
        "positionType": {
          "label": "HORARI"
        },
        "specifications": "Horari",
        "tag": "2"
      }
    ],
    "minGroups": 3,
    "audios": []
  },
  {
    "name": "La boja de 8",
    "structure": {
      "rows": 2,
      "columns": 4
    },
    "diagram": {
      "blockName": "Grup",
      "backgroundColor": {
        "CARLOTETA": "#FFF2CC",
        "CORRER": "#92D050"
      },
      "textColor": {
        "CARLOTETA": "#000000",
        "CORRER": "#000000"
      }
    },
    "positions": [
      {
        "order": 1,
        "positionType": {
          "label": "CORRER"
        },
        "specifications": "Cant√≥ equerre/cara pla√ßa",
        "tag": "5"
      },
      {
        "order": 2,
        "positionType": {
          "label": "CARLOTETA"
        },
        "specifications": "Mig equerre/cara pla√ßa",
        "tag": "6"
      },
      {
        "order": 3,
        "positionType": {
          "label": "CARLOTETA"
        },
        "specifications": "Mig dret/cara pla√ßa",
        "tag": "7"
      },
      {
        "order": 4,
        "positionType": {
          "label": "CORRER"
        },
        "specifications": "Cant√≥ dret/cara pla√ßa",
        "tag": "8"
      },
      {
        "order": 5,
        "positionType": {
          "label": "CORRER"
        },
        "specifications": "Cant√≥ equerre/esquena pla√ßa",
        "tag": "4"
      },
      {
        "order": 6,
        "positionType": {
          "label": "CARLOTETA"
        },
        "specifications": "Mig esquerre/esquena pla√ßa",
        "tag": "3"
      },
      {
        "order": 7,
        "positionType": {
          "label": "CARLOTETA"
        },
        "specifications": "Mig dret/esquena pla√ßa",
        "tag": "2"
      },
      {
        "order": 8,
        "positionType": {
          "label": "CORRER"
        },
        "specifications": "Cant√≥ dret/esquena pla√ßa",
        "tag": "1"
      }
    ],
    "minGroups": 1,
    "audios": [
      {
        "fileId": "1beaLCPNq4jUjrIh3ZUqtCrgYRQgZ8Ajp",
        "title": "La boja - A pla√ßa",
        "artist": "-"
      },
      {
        "fileId": "1mcknQWXDlXidTRYXY6piFQ3NIrcCT76V",
        "title": "La boja - Per assajar",
        "artist": "Reina, Josep i Quim"
      }
    ]
  },
  {
    "name": "La boja de 6",
    "structure": {
      "rows": 2,
      "columns": 3
    },
    "diagram": {
      "blockName": "Grup",
      "backgroundColor": {
        "CARLOTETA": "#FFF2CC",
        "CORRER": "#92D050"
      },
      "textColor": {
        "CARLOTETA": "#000000",
        "CORRER": "#000000"
      }
    },
    "positions": [
      {
        "order": 1,
        "positionType": {
          "label": "CORRER"
        },
        "specifications": "Cant√≥ equerre/cara pla√ßa",
        "tag": "4"
      },
      {
        "order": 2,
        "positionType": {
          "label": "CARLOTETA"
        },
        "specifications": "Mig/cara pla√ßa",
        "tag": "5"
      },
      {
        "order": 3,
        "positionType": {
          "label": "CORRER"
        },
        "specifications": "Cant√≥ dret/cara pla√ßa",
        "tag": "6"
      },
      {
        "order": 4,
        "positionType": {
          "label": "CORRER"
        },
        "specifications": "Cant√≥ equerre/esquena pla√ßa",
        "tag": "3"
      },
      {
        "order": 5,
        "positionType": {
          "label": "CARLOTETA"
        },
        "specifications": "Mig/esquena pla√ßa",
        "tag": "2"
      },
      {
        "order": 6,
        "positionType": {
          "label": "CORRER"
        },
        "specifications": "Cant√≥ dret/esquena pla√ßa",
        "tag": "1"
      }
    ],
    "minGroups": 1,
    "audios": [
      {
        "fileId": "1beaLCPNq4jUjrIh3ZUqtCrgYRQgZ8Ajp",
        "title": "La boja - A pla√ßa",
        "artist": "-"
      },
      {
        "fileId": "1mcknQWXDlXidTRYXY6piFQ3NIrcCT76V",
        "title": "La boja - Per assajar",
        "artist": "Reina, Josep i Quim"
      }
    ]
  },
  {
    "name": "Micalet",
    "structure": {
      "rows": 2,
      "columns": 2
    },
    "diagram": {
      "blockName": "Quadre",
      "backgroundColor": {
        "ANTIHORARI": "#FFF2CC",
        "HORARI": "#92D050"
      },
      "textColor": {
        "ANTIHORARI": "#000000",
        "HORARI": "#000000"
      }
    },
    "positions": [
      {
        "order": 1,
        "positionType": {
          "label": "ANTIHORARI"
        },
        "specifications": "Esquerre/cara pla√ßa",
        "tag": "3"
      },
      {
        "order": 2,
        "positionType": {
          "label": "ANTIHORARI"
        },
        "specifications": "Dreta/cara pla√ßa",
        "tag": "4"
      },
      {
        "order": 3,
        "positionType": {
          "label": "HORARI"
        },
        "specifications": "Esquerre/esquena pla√ßa",
        "tag": "2"
      },
      {
        "order": 4,
        "positionType": {
          "label": "HORARI"
        },
        "specifications": "Dreta/esquena pla√ßa",
        "tag": "1"
      }
    ],
    "minGroups": 1,
    "audios": []
  },
  {
    "name": "No en volem cap",
    "structure": {
      "rows": 2,
      "columns": 2
    },
    "diagram": {
      "blockName": "Quadre",
      "backgroundColor": {
        "FORA": "#92D050",
        "DINS": "#FFF2CC"
      },
      "textColor": {
        "FORA": "#000000",
        "DINS": "#000000"
      }
    },
    "positions": [
      {
        "order": 1,
        "positionType": {
          "label": "FORA"
        },
        "specifications": "Esquerre/cara pla√ßa",
        "tag": "3"
      },
      {
        "order": 2,
        "positionType": {
          "label": "DINS"
        },
        "specifications": "Dreta/cara pla√ßa",
        "tag": "4"
      },
      {
        "order": 3,
        "positionType": {
          "label": "DINS"
        },
        "specifications": "Esquerre/esquena pla√ßa",
        "tag": "2"
      },
      {
        "order": 4,
        "positionType": {
          "label": "FORA"
        },
        "specifications": "Dreta/esquena pla√ßa",
        "tag": "1"
      }
    ],
    "minGroups": 1,
    "audios": []
  },
  {
    "name": "Joan del riu",
    "structure": {
      "rows": 2,
      "columns": 2
    },
    "diagram": {
      "blockName": "Grup",
      "backgroundColor": {
        "BAIX": "#FFF2CC",
        "DALT": "#92D050"
      },
      "textColor": {
        "BAIX": "#000000",
        "DALT": "#000000"
      }
    },
    "positions": [
      {
        "order": 1,
        "positionType": {
          "label": "DALT"
        },
        "specifications": "Cant√≥ equerre/cara pla√ßa",
        "tag": "4"
      },
      {
        "order": 2,
        "positionType": {
          "label": "BAIX"
        },
        "specifications": "Cant√≥ dret/cara pla√ßa",
        "tag": "3"
      },
      {
        "order": 3,
        "positionType": {
          "label": "BAIX"
        },
        "specifications": "Cant√≥ equerre/esquena pla√ßa",
        "tag": "2"
      },
      {
        "order": 4,
        "positionType": {
          "label": "DALT"
        },
        "specifications": "Cant√≥ dret/esquena pla√ßa",
        "tag": "1"
      }
    ],
    "minGroups": 1,
    "audios": []
  },
  {
    "name": "Joan del riu de 16",
    "structure": {
      "rows": 2,
      "columns": 8
    },
    "diagram": {
      "blockName": "Grup",
      "backgroundColor": {
        "BAIX": "#FFF2CC",
        "DALT": "#92D050"
      },
      "textColor": {
        "BAIX": "#000000",
        "DALT": "#000000"
      }
    },
    "positions": [
      {
        "order": 1,
        "positionType": {
          "label": "DALT"
        },
        "specifications": "Cant√≥ equerre/cara pla√ßa",
        "tag": "9"
      },
      {
        "order": 2,
        "positionType": {
          "label": "BAIX"
        },
        "specifications": "Mig equerre/cara pla√ßa",
        "tag": "10"
      },
      {
        "order": 3,
        "positionType": {
          "label": "DALT"
        },
        "specifications": "Mig dret/cara pla√ßa",
        "tag": "11"
      },
      {
        "order": 4,
        "positionType": {
          "label": "BAIX"
        },
        "specifications": "Cant√≥ dret/cara pla√ßa",
        "tag": "12"
      },
      {
        "order": 5,
        "positionType": {
          "label": "DALT"
        },
        "specifications": "Cant√≥ equerre/esquena pla√ßa",
        "tag": "13"
      },
      {
        "order": 6,
        "positionType": {
          "label": "BAIX"
        },
        "specifications": "Mig esquerre/esquena pla√ßa",
        "tag": "14"
      },
      {
        "order": 7,
        "positionType": {
          "label": "DALT"
        },
        "specifications": "Mig dret/esquena pla√ßa",
        "tag": "15"
      },
      {
        "order": 8,
        "positionType": {
          "label": "BAIX"
        },
        "specifications": "Cant√≥ dret/esquena pla√ßa",
        "tag": "16"
      },
      {
        "order": 9,
        "positionType": {
          "label": "BAIX"
        },
        "specifications": "Cant√≥ equerre/cara pla√ßa",
        "tag": "8"
      },
      {
        "order": 10,
        "positionType": {
          "label": "DALT"
        },
        "specifications": "Mig equerre/cara pla√ßa",
        "tag": "7"
      },
      {
        "order": 11,
        "positionType": {
          "label": "BAIX"
        },
        "specifications": "Mig dret/cara pla√ßa",
        "tag": "6"
      },
      {
        "order": 12,
        "positionType": {
          "label": "DALT"
        },
        "specifications": "Cant√≥ dret/cara pla√ßa",
        "tag": "5"
      },
      {
        "order": 13,
        "positionType": {
          "label": "BAIX"
        },
        "specifications": "Cant√≥ equerre/esquena pla√ßa",
        "tag": "4"
      },
      {
        "order": 14,
        "positionType": {
          "label": "DALT"
        },
        "specifications": "Mig esquerre/esquena pla√ßa",
        "tag": "3"
      },
      {
        "order": 15,
        "positionType": {
          "label": "BAIX"
        },
        "specifications": "Mig dret/esquena pla√ßa",
        "tag": "2"
      },
      {
        "order": 16,
        "positionType": {
          "label": "DALT"
        },
        "specifications": "Cant√≥ dret/esquena pla√ßa",
        "tag": "1"
      }
    ],
    "minGroups": 1,
    "audios": []
  },
  {
    "name": "Passi-ho b√©",
    "structure": {
      "rows": 2,
      "columns": 2
    },
    "diagram": {
      "blockName": "Grup",
      "backgroundColor": {
        "POSICI√ì": "#FFF2CC"
      },
      "textColor": {
        "POSICI√ì": "#000000"
      }
    },
    "positions": [
      {
        "order": 1,
        "positionType": {
          "label": "POSICI√ì"
        },
        "specifications": "Cant√≥ equerre/cara pla√ßa",
        "tag": "4"
      },
      {
        "order": 2,
        "positionType": {
          "label": "POSICI√ì"
        },
        "specifications": "Cant√≥ dret/cara pla√ßa",
        "tag": "3"
      },
      {
        "order": 3,
        "positionType": {
          "label": "POSICI√ì"
        },
        "specifications": "Cant√≥ equerre/esquena pla√ßa",
        "tag": "2"
      },
      {
        "order": 4,
        "positionType": {
          "label": "POSICI√ì"
        },
        "specifications": "Cant√≥ dret/esquena pla√ßa",
        "tag": "1"
      }
    ],
    "minGroups": 1,
    "audios": []
  }
];
        </script>
        

        <script>
const LAYOUT = "base.njk"
const PERMALINK = "test.html"
const DEVELOPMENT = true
const SCRIPT_ID = "1RjSSW506qFMuVfksFLZIxeDexoWn-vAWyR8ChMfacdJDpQtREjw87P8E"
const API_URL = "https://script.google.com/macros/s/AKfycbx3Gqjvmtlm88sFA1NDJn1ALVfiRBWR_Ysd8uw_QfN7/dev"
const EMBEDDED = true
const LANGUAGE_CODE = "ca"
const TITLE = "TEST"
const COMPANY = "Fake company"
const WEBSITE_URL = "https://script.google.com/macros/s/AKfycbx3Gqjvmtlm88sFA1NDJn1ALVfiRBWR_Ysd8uw_QfN7/dev"
const MEMBERS_SPREADSHEET_ID = "1wk_-NOVh1LmUT5IafqtfFfcK7DS0j_wtS-KYMOZGzGs"
const MEMBERS_SHEET_NAME = "Membres"
const EVENTS_SPREADSHEET_ID = "1wpkYYOrzypsfdVDP5WGS1aX5OLjL5ITZj_ogtJgzHGE"
const EVENTS_SHEET_NAME = "Llistat"
const TRAINING_SPREADSHEET_ID = "1veNnPWgx4B1NQ1CMt1zejt-q_geJAKd-p2yAUcQObxg"
const ASSISTANCE_SHEET_NAME = "Assistencia"
const MEMBER_CACHE = "MEMBERS"
const EVENT_CACHE = "EVENTS"
const TRAINING_CACHE = "TRAININGS"
const USER_CREDS = "users_credentials"
const USER_SESSION = "users_session"
const SESSION_TOKEN = "session_token"
</script>


        
        <script>
        ////// BACKEND
const API = new (class GAppsApiClient {
  constructor() {}

  getToken() {
    try {
      const tokenData = localStorage.getItem(SESSION_TOKEN);
      if (!tokenData) return null;
      
      // Parse stored token data
      let token, expiryTime;
      try {
        const parsed = JSON.parse(tokenData);
        token = parsed.token;
        expiryTime = parsed.expiryTime;
      } catch (e) {
        // Handle legacy format (plain token string without expiry)
        token = tokenData;
        expiryTime = null;
      }
      
      // Check if token has expired
      if (expiryTime && Date.now() > expiryTime) {
        localStorage.removeItem(SESSION_TOKEN);
        return null;
      }
      
      return token;
    } catch (e) {
      console.log("Failed to retrieve token from storage:", e.message);
      return null;
    }
  }

  isAuthenticated() {
    const token = this.getToken();
    return token != null && token.length > 0;
  }

  saveToken({ token } = {}) {
    try {
      if(!token) {
        localStorage.removeItem(SESSION_TOKEN);
      } else {
        const maxAge = 60 * 60 * 24 * 90; // 90 days in seconds
        const expiryTime = Date.now() + (maxAge * 1000); // Convert to milliseconds
        const tokenData = JSON.stringify({ token, expiryTime });
        localStorage.setItem(SESSION_TOKEN, tokenData);
      }
    } catch (e) {
      console.log("Failed to save token to storage:", e.message);
    }
  }

  clearSession() {
    this.saveToken();
    this._write({ action: "user", data: null });
  }

  _write({ action, data } = {}) {
    if(action){
      if(!data){
        localStorage.removeItem(action);
      }else{
        localStorage.setItem(action, JSON.stringify(data));
      }
    }
  }

  _read({ action } = {}) {
    if(action){
      return JSON.parse(localStorage.getItem(action));
    }
  }

  _performRequest({ action, method = "GET", body = null, parameters, requiresAuth = false, useCache = false } = {}) {
    return new Promise(async (resolve, reject) => {
      if(!action) {
        return reject("No s'ha especificat cap acci√≥.");
      }

      console.log(`API Request - Action: ${action}, Method: ${method}, Requires Auth: ${requiresAuth}`);

      if(requiresAuth && !this.isAuthenticated()) {
        return reject("L'operaci√≥ requereix autenticaci√≥. Si us plau, inicia sessi√≥.");
      }

      if (useCache) {
        const savedData = this._read({ action });
        if (savedData) {
          return resolve(savedData);
        }
      }

      if (!navigator.onLine) {
        return reject(
          "No tens connexi√≥ a Internet. Comprova la teua xarxa i torna a intentar-ho.",
        );
      }

      const token = this.getToken() || "";
      const returnResult = (data) => {
        if (data?.success) {
          this._write({ action, data: data.result });
          resolve(data.result);
        } else {
          let errorMessage = "Ha ocorregut un error en la petici√≥. Si el problema persistix, contacta a l'administrador.";
          if (data) {
            errorMessage = data.error || data.message || errorMessage;
          }
          reject(errorMessage);
        }
      };

      if (typeof google !== "undefined" && google.script && google.script.run) {
        // Development mode using google.script.run
        const devParameters = { ...parameters, token };
        google.script.run
          .withSuccessHandler(returnResult)
          .withFailureHandler(returnResult)
          .test({ action, method, body, parameters: devParameters });
      } else {
        const options = {
          method: method == "GET" ? "GET" : "POST",
          cache: "no-cache",
          mode: "cors", // Use 'cors' to try and read the body
          headers: {
            // CRITICAL: Using 'text/plain' avoids CORS preflight
            "Content-Type": "text/plain;charset=utf-8",
          },
        };
        if (body) {
          options.body = JSON.stringify(body);
        }

        const urlparams = parameters
          ? `&${new URLSearchParams(parameters).toString()}`
          : "";
        try {
          const response = await fetch(
            `${API_URL}?action=${action}&method=${method}&token=${token}${urlparams}`,
            options,
          );

          if (!response.ok) {
            let errorMessage = `Error del servidor (${response.status}). Si el problema persistix, contacta a l'administrador.`;
            if (response.status === 401 || response.status === 403) {
              errorMessage =
                "No tens perm√≠s per a realitzar esta operaci√≥. Potser la teua sessi√≥ ha caducat.";
            }
            // In case of a redirect to a Google login page, the response might be opaque and we can't read the body.
            // For other errors, we can try to get more info.
            if (response.type !== "opaque") {
              try {
                const errorBody = await response.text();
                // Google Apps Script can return HTML with 'requires authentication'
                if (errorBody.includes("requires authentication")) {
                  errorMessage =
                    "La teua sessi√≥ ha caducat. Per favor, torna a iniciar sessi√≥.";
                }
              } catch (e) {
                // Ignore if we can't read body, use the generic message.
              }
            }
            reject(errorMessage);
            return; // Stop further execution
          }

          const data = await response.json();
          returnResult(data);
        } catch (error) {
          this._handleRequestError(error).then(resolve).catch(reject);
        }
      }
    });
  }

  async _handleRequestError(error) {
    if (error instanceof SyntaxError) {
      return {success: false, error:
        "Hi ha hagut un problema en la resposta del servidor. A√ß√≤ pot ser degut a un error intern o de configuraci√≥. Contacta a l'administrador.",
      };
    } else if (
      error instanceof TypeError &&
      error.message === "Failed to fetch"
    ) {
      try {
        // Use no-cors to avoid CORS issues with the check. We just want to see if we can reach the internet.
        await fetch("favicon.ico", { mode: "no-cors" });
        // If this succeeds, the user has internet, but the API server is unreachable or there's a CORS/Firewall issue.
        return {success: false, error:
          "No s'ha pogut connectar al servidor de l'aplicaci√≥. Pot ser que estiga temporalment fora de servei o que un tallafoc estiga bloquejant la connexi√≥.",
        };
      } catch (e) {
        // If this fails, the user likely has no internet connection at all.
        return {success: false, error:
          "No s'ha pogut connectar a Internet. Comprova la teua xarxa i torna a intentar-ho.",
        };
      }
    } else {
      console.error("Error no controlat a l'API:", error);
      return {
        success: false,
        error: "Ha ocorregut un error inesperat. Per favor, intenta-ho de nou m√©s tard.",
      };
    }
  }

  _get({ action, parameters, requiresAuth, useCache = false } = {}) {
    return this._performRequest({ action, method: "GET", parameters, requiresAuth, useCache });
  }

  _post({ action, body = null, parameters, requiresAuth, useCache = false} = {}) {
    return this._performRequest({ action, method: "POST", body, parameters, requiresAuth, useCache });
  }

  _patch({ action, body = null, parameters, requiresAuth, useCache = false } = {}) {
    return this._performRequest({ action, method: "PATCH", body, parameters, requiresAuth, useCache });
  }

  _put({ action, body = null, parameters, requiresAuth, useCache = false } = {}) {
    return this._performRequest({ action, method: "PUT", body, parameters, requiresAuth, useCache });
  }

  getCurrentUser() {
    return this._get({ action: "user", requiresAuth: true, useCache: true });
  }

  getDances() {
    return Promise.resolve(DANCES);
  }

  getEvents({ forceRefresh = false } = {}) {
    return this._get({ action: "events", parameters: { forceRefresh }, requiresAuth: true, useCache: !forceRefresh });
  }

  getEventById({ eventId } = {}) {
    return this._get({ action: "event", parameters: { eventId }, requiresAuth: true });
  }

  getNextEvent() {
    return this._get({ action: "nextEvent", requiresAuth: true });
  }
  
  getTrainings({ forceRefresh = false } = {}) {
    return this._get({ action: "trainings", parameters: { forceRefresh }, requiresAuth: true, useCache: !forceRefresh });
  }

  getTrainingById({ trainingId } = {}) {
    return this._get({ action: "training", parameters: { trainingId }, requiresAuth: true });
  }

  getNextTraining() {
    return this._get({ action: "nextTraining", requiresAuth: true });
  }

  getDashboardStats() {
    //return this._get({ action: "dashboard/stats", requiresAuth: true });
  }

  getUserActivity() {
    //return this._get({ action: "dashboard/activity", requiresAuth: true });
  }

  getMembers({ forceRefresh = false } = {}) {
    return this._get({ action: "members", parameters: { forceRefresh }, requiresAuth: true, useCache: !forceRefresh });
  }

  loginWithEmailPassword({ email, password } = {}) {
    return this._post({ action: "login", body: { email, password } });
  }

  sendAccessLink({ email } = {}) {
    return this._post({ action: "sendAccessLink", body: { email } });
  }

  sendRegistrationRequest({ name, email } = {}) {
    return this._post({ action: "register", body: { name, email } });
  }

  logoutUser() {
    return this._post({ action: "logout" })
    .then(() => {
      this.clearSession();
    });
  }

  changeUserPassword({ email, newPassword } = {}) {
    return this._patch({
      action: "changePassword",
      body: { email, newPassword },
      requiresAuth: true,
    });
  }

  saveMember({ member } = {}) {
    return this._put({ action: "saveMember", body: { member }, requiresAuth: true });
  }

  saveAllMembers({ members } = {}) {
    return this._put({ action: "saveAllMembers", body: { members }, requiresAuth: true });
  }

  saveEvent({ event } = {}) {
    return this._put({ action: "saveEvent", body: { event }, requiresAuth: true });
  }

  getAudioById({ audioId } = {}) {
    return this._get({ action: "audio", parameters: { audioId }, requiresAuth: true });
  }
})();

        </script>
        

        
        <script>
        /**
 * SPA Router and Authentication Manager
 * Handles client-side routing, authentication state, and UI updates
 */

// Global state
const AppState = {
  currentUser: null,
  isAuthenticated: false,
  currentView: null,
  isLoading: true,
  // Store IDs for data that needs to be loaded with the view
  eventIdToLoad: null,
  trainingIdToLoad: null,
  // Track currently loaded IDs to prevent duplicate loading
  currentEventId: null,
  currentTrainingId: null,
};

// Track pending diagram load intervals to prevent stale closures
let pendingDiagramLoadInterval = null;

// Initialize the app when DOM is ready
document.addEventListener("DOMContentLoaded", function () {
  initializeApp();
});

/**
 * Initialize dark mode based on browser preference
 */
function initializeDarkMode() {
  // Check if browser prefers dark mode
  const prefersDark = window.matchMedia("(prefers-color-scheme: dark)");

  // Apply dark mode if preferred
  if (prefersDark.matches) {
    document.body.classList.add("dark-mode");
  }

  // Listen for changes to the system preference
  prefersDark.addEventListener("change", function (e) {
    if (e.matches) {
      document.body.classList.add("dark-mode");
    } else {
      document.body.classList.remove("dark-mode");
    }
  });
}

/**
 * Initialize PWA features like service worker
 */
function initializePwa() {
  if ("serviceWorker" in navigator) {
    if (window.self === window.top) {
      const isLocalFile = window.location.protocol === 'file:' || window.location.origin === 'null';
      if (!isLocalFile) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("./sw.js")
            .then((registration) => {
              console.log(
                "ServiceWorker registration successful with scope: ",
                registration.scope,
              );
            })
            .catch((err) => {
              console.log("ServiceWorker registration failed: ", err);
            });
        });
      }
    }
  }
}

/**
 * Initialize the application
 */
function initializeApp() {
  // Initialize dark mode first for immediate theme application
  initializeDarkMode();

  initializePwa();

  showLoading(true);

  // Check authentication status
  API.getCurrentUser()
    .then(function (result) {
      AppState.isAuthenticated = !!result.user;
      AppState.currentUser = result.user;

      initializeRouter();
      initializeEventListeners();
      updateAuthUI();

      showLoading(false);

      const hash = window.location.hash.substring(1);
      const savedRoute = localStorage.getItem("currentRoute");
      // Show login page if not authenticated, otherwise show home or saved route
      const initialRoute = AppState.isAuthenticated
        ? hash || savedRoute || "home"
        : hash || "home-guest";
      // Check if the initial route contains an event ID (e.g., events/eventId)
      if (initialRoute.startsWith("events/")) {
        const eventId = decodeURIComponent(initialRoute.substring(7)); // Remove 'events/' prefix and decode
        if (eventId) {
          AppState.eventIdToLoad = escapeHtml(eventId);
          navigateTo("edit-event", false);
          return;
        }
      }
      // Check if the initial route contains a training ID (e.g., training/trainingId)
      if (initialRoute.startsWith("training/")) {
        const trainingId = decodeURIComponent(initialRoute.substring(9)); // Remove 'training/' prefix and decode
        if (trainingId) {
          AppState.trainingIdToLoad = escapeHtml(trainingId);
          navigateTo("edit-training", false);
          return;
        }
      }
      navigateTo(initialRoute);
    })
    .catch(function (error) {
      console.error("Auth check failed:", error);
      AppState.isAuthenticated = false;

      initializeRouter();
      initializeEventListeners();
      updateAuthUI();

      showLoading(false);

      navigateTo("home-guest");
    });
}

/**
 * Check if currently in edit mode (members page or events page)
 */
function isInEditMode() {
  // Check members edit mode
  if (currentEditingMemberId !== null) {
    return true;
  }
  // Check events dirty state
  if (typeof diagramsIsDirty !== "undefined" && diagramsIsDirty) {
    return true;
  }
  return false;
}

/**
 * Cancel current edit mode (for navigation confirmation)
 */
function cancelCurrentEditMode() {
  // Cancel members inline edit if active
  if (currentEditingMemberId !== null) {
    cancelInlineEdit();
  }
  // Reset events dirty flag
  if (typeof diagramsIsDirty !== "undefined") {
    diagramsIsDirty = false;
  }
}

// Flag to prevent duplicate toasts when restoring hash
var isRestoringHash = false;

/**
 * Initialize the SPA router
 */
function initializeRouter() {
  // Prevent page reload/close when in edit mode
  window.addEventListener("beforeunload", function (e) {
    if (isInEditMode()) {
      e.preventDefault();
      e.returnValue = "";
      return "";
    }
  });

  // Handle browser back/forward buttons
  window.addEventListener("hashchange", function (e) {
    // Skip if we're restoring the hash after blocking navigation
    if (isRestoringHash) {
      isRestoringHash = false;
      return;
    }
    if (isInEditMode()) {
      const route = window.location.hash.substring(1) || "home";
      // Show confirmation dialog like beforeunload does
      if (confirm("Tens canvis sense desar. Vols sortir sense desar?")) {
        // User confirmed, cancel edit and proceed with navigation
        cancelCurrentEditMode();
        // Check if the route contains an event ID (e.g., events/eventId)
        if (route.startsWith("events/")) {
          const eventId = decodeURIComponent(route.substring(7));
          if (eventId) {
            viewEvent(escapeHtml(eventId));
            return;
          }
        }
        navigateTo(route, false);
      } else {
        // User cancelled, restore the hash (use saved route which includes event ID if present)
        isRestoringHash = true;
        const savedRoute =
          localStorage.getItem("currentRoute") || AppState.currentView;
        window.location.hash = savedRoute;
      }
      return;
    }
    const route = window.location.hash.substring(1) || "home";
    
    // Extract IDs from special hash formats (events/id, training/id)
    if (route.startsWith("events/")) {
      const eventId = decodeURIComponent(route.substring(7));
      if (eventId) {
        AppState.eventIdToLoad = escapeHtml(eventId);
        navigateTo("edit-event", false);
        return;
      }
    }
    if (route.startsWith("training/")) {
      const trainingId = decodeURIComponent(route.substring(9));
      if (trainingId) {
        AppState.trainingIdToLoad = escapeHtml(trainingId);
        navigateTo("edit-training", false);
        return;
      }
    }
    
    navigateTo(route, false);
  });
}

/**
 * Initialize all event listeners
 */
function initializeEventListeners() {
  // Navigation links
  document.querySelectorAll("[data-route]").forEach(function (link) {
    link.addEventListener("click", function (e) {
      e.preventDefault();
      const route = this.getAttribute("data-route");
      navigateTo(route);
    });
  });

  // Email/Password login form
  const loginForm = document.getElementById("login-form");
  if (loginForm) {
    loginForm.addEventListener("submit", handleEmailPasswordLogin);
  }

  // Google login button (login view)
  const mailLoginBtn = document.getElementById("mail-login-btn");
  if (mailLoginBtn) {
    mailLoginBtn.addEventListener("click", handleAccessLink);
  }

  // Google login button (guest landing view)
  const mailLoginGuestBtn = document.getElementById("mail-login-btn-guest");
  if (mailLoginGuestBtn) {
    mailLoginGuestBtn.addEventListener("click", handleAccessLink);
  }

  // Register form
  const registerForm = document.getElementById("register-form");
  if (registerForm) {
    registerForm.addEventListener("submit", handleRegisterSubmit);
  }

  // Logout button
  const logoutBtn = document.getElementById("logout-btn");
  if (logoutBtn) {
    logoutBtn.addEventListener("click", handleLogout);
  }

  // Mobile logout button
  const mobileLogoutBtn = document.getElementById("mobile-logout-btn");
  if (mobileLogoutBtn) {
    mobileLogoutBtn.addEventListener("click", function (e) {
      e.preventDefault();
      document.querySelector(".navbar-menu")?.classList.remove("active");
      handleLogout(e);
    });
  }

  // Mobile nav toggle
  const navbarToggle = document.getElementById("navbar-toggle");
  if (navbarToggle) {
    navbarToggle.addEventListener("click", function () {
      document.querySelector(".navbar-menu").classList.toggle("active");
    });
  }

  // Show profile section when avatar or name is clicked
  // User menu dropdown logic
  const userMenuTrigger = document.querySelector(
    ".user-menu-trigger .member-name",
  );
  const userMenu = document.getElementById("user-menu");
  function toggleUserMenu(e) {
    e.stopPropagation();
    if (userMenu.style.display === "block") {
      userMenu.style.display = "none";
    } else {
      userMenu.style.display = "block";
    }
  }
  if (userMenuTrigger) {
    userMenuTrigger.addEventListener("click", toggleUserMenu);
  }
  // Hide menu when clicking outside
  document.addEventListener("click", function (e) {
    if (
      userMenu &&
      userMenu.style.display === "block" &&
      !userMenu.contains(e.target) &&
      !userMenuTrigger.contains(e.target)
    ) {
      userMenu.style.display = "none";
    }
  });
  // Handle menu item clicks
  if (userMenu) {
    userMenu.querySelectorAll(".user-menu-item").forEach(function (item) {
      item.addEventListener("click", function (e) {
        e.preventDefault();
        userMenu.style.display = "none";
        const view = item.getAttribute("data-menu-view");
        if (view) {
          navigateTo(view);
        }
      });
    });
  }

  // Handle mobile menu navigation items with data-menu-view
  document
    .querySelectorAll(".mobile-user-actions [data-menu-view]")
    .forEach(function (item) {
      item.addEventListener("click", function (e) {
        e.preventDefault();
        document.querySelector(".navbar-menu")?.classList.remove("active");
        const view = item.getAttribute("data-menu-view");
        if (view) {
          navigateTo(view);
        }
      });
    });

  // Add member button
  const addMemberBtn = document.getElementById("add-member-btn");
  if (addMemberBtn) {
    addMemberBtn.addEventListener("click", startAddNewMember);
  }

  // Refresh members button
  const refreshMembersBtn = document.getElementById("refresh-members-btn");
  if (refreshMembersBtn) {
    refreshMembersBtn.addEventListener("click", refreshMembersList);
  }

  // Refresh events button (planning view)
  const refreshEventsBtn = document.getElementById("refresh-event-btn");
  if (refreshEventsBtn) {
    refreshEventsBtn.addEventListener("click", refreshPlanningEvents);
  }

  // Refresh trainings button (planning view)
  const refreshTrainingsBtn = document.getElementById("refresh-training-btn");
  if (refreshTrainingsBtn) {
    refreshTrainingsBtn.addEventListener("click", refreshPlanningTrainings);
  }

  // Login dialog close button
  const loginCloseBtn = document.getElementById("login-close-btn");
  const loginDialog = document.getElementById("view-login");
  if (loginCloseBtn) {
    loginCloseBtn.addEventListener("click", function () {
      if (loginDialog) {
        loginDialog.close();
      }
    });
  }

  // Close login dialog when clicking on backdrop
  if (loginDialog) {
    loginDialog.addEventListener("click", function (e) {
      if (e.target === this) {
        this.close();
      }
    });
  }

  // Signup link in login dialog - close dialog and show register
  const signupLink = document.getElementById("signup-link");
  if (signupLink) {
    signupLink.addEventListener("click", function (e) {
      e.preventDefault();
      const loginDialog = document.getElementById("view-login");
      if (loginDialog) {
        loginDialog.close();
      }
      navigateTo("register");
    });
  }

  // Register dialog close button
  const registerCloseBtn = document.getElementById("register-close-btn");
  const registerDialog = document.getElementById("view-register");
  if (registerCloseBtn) {
    registerCloseBtn.addEventListener("click", function () {
      if (registerDialog) {
        registerDialog.close();
      }
    });
  }

  // Close register dialog when clicking on backdrop
  if (registerDialog) {
    registerDialog.addEventListener("click", function (e) {
      if (e.target === this) {
        this.close();
      }
    });
  }

  // Dance audio dialog close button
  const danceAudioCloseBtn = document.getElementById("dance-audio-close-btn");
  const danceAudioDialog = document.getElementById("dance-audio-dialog");
  if (danceAudioCloseBtn) {
    danceAudioCloseBtn.addEventListener("click", function () {
      if (danceAudioDialog) {
        danceAudioDialog.close();
      }
    });
  }

  // Close dance audio dialog when clicking on backdrop
  if (danceAudioDialog) {
    danceAudioDialog.addEventListener("click", function (e) {
      if (e.target === this) {
        this.close();
      }
    });

    // Stop all audio when dialog closes
    danceAudioDialog.addEventListener("close", function () {
      stopAllAudioInDialog(danceAudioDialog);
    });
  }

  // Login link in register dialog - close register and show login
  const loginLink = document.getElementById("login-link");
  if (loginLink) {
    loginLink.addEventListener("click", function (e) {
      e.preventDefault();
      if (registerDialog) {
        registerDialog.close();
      }
      navigateTo("login");
    });
  }
}

/**
 * Navigate to a route
 * @param {string} route - Route name
 * @param {boolean} updateHash - Whether to update URL hash
 */
function navigateTo(route, updateHash = true) {
  const originalRoute = route; // Track original route for hash updates

  // Handle login as a modal dialog instead of navigation
  if (route === "login") {
    closeAllDialogs();
    const loginDialog = document.getElementById("view-login");
    if (loginDialog) {
      loginDialog.showModal();
    }
    return;
  }

  // Handle register as a modal dialog instead of navigation
  if (route === "register") {
    closeAllDialogs();
    const registerDialog = document.getElementById("view-register");
    if (registerDialog) {
      registerDialog.showModal();
    }
    return;
  }

  // Prevent navigation when in edit mode
  if (isInEditMode() && route !== AppState.currentView) {
    // Show confirmation dialog like beforeunload does
    if (confirm("Tens canvis sense desar. Vols sortir sense desar?")) {
      // User confirmed, cancel edit and proceed with navigation
      cancelCurrentEditMode();
    } else {
      // User cancelled, stay on current view
      return;
    }
  }

  const baseRoute = route.split("/")[0];
  const view = document.querySelector(`[data-view="${baseRoute}"]`);

  if (!view) {
    route = "404";
  } else if (AppState.isAuthenticated) {
    // Logged-in user: redirect from guest pages to home
    if (
      baseRoute === "login" ||
      baseRoute === "register" ||
      baseRoute === "home-guest"
    ) {
      route = "home";
    }
  } else {
    // Guest user: check if route is public
    const publicRoutes = ["home-guest", "login", "register"];
    if (baseRoute === "home") {
      route = "home-guest";
    } else if (!publicRoutes.includes(baseRoute)) {
      showToast(
        "Has de iniciar sessi√≥ per accedir a aquesta p√†gina",
        "warning",
      );
      route = "home-guest";
    }
  }

  // Skip if already on this route (prevents duplicate data loading)
  const alreadyOnRoute = AppState.currentView === route;

  // Hide all views
  document.querySelectorAll(".view").forEach(function (v) {
    v.style.display = "none";
    v.classList.remove("active");
  });

  // Show target view
  const finalView = document.querySelector(`[data-view="${route}"]`);
  if (finalView) {
    finalView.style.display = "block";
    finalView.classList.add("active");
  }

  // Show/hide floating-lock-btn based on current view
  const floatingLockBtn = document.getElementById("floating-lock-btn");
  if (floatingLockBtn) {
    floatingLockBtn.style.display = route === "planning-event" ? "flex" : "none";
  }

  // Reset isEventEditable when leaving planning-event view
  if (route !== "planning-event" && typeof isEventEditable !== "undefined") {
    isEventEditable = false;
    isEventManuallyUnlocked = false;
  }

  // Update active nav link
  document.querySelectorAll(".nav-link").forEach(function (link) {
    link.classList.remove("active");
    if (link.getAttribute("data-route") === route) {
      link.classList.add("active");
    }
  });

  // Update hash if it was changed by parameter or if the route was forced
  const routeWasForced = originalRoute !== route;
  if (updateHash || routeWasForced) {
    window.location.hash = route;
  }

  AppState.currentView = route;

  // Save current route to localStorage for persistence across refreshes
  // Don't persist 404 page as it's typically server-forced
  if (route !== "404") {
    localStorage.setItem("currentRoute", route);
  }

  // Load view-specific data only if navigating to a new route
  // OR if we have an ID to load (for event/training details)
  if (!alreadyOnRoute || AppState.eventIdToLoad || AppState.trainingIdToLoad) {
    loadViewData(route);
  }

  // Close mobile menu
  document.querySelector(".navbar-menu")?.classList.remove("active");

  // Scroll to top
  window.scrollTo(0, 0);
}

/**
 * Close all open dialogs to prevent overlapping
 */
function closeAllDialogs() {
  const dialogs = document.querySelectorAll('dialog[open]');
  dialogs.forEach(function (dialog) {
    if (dialog) dialog.close();
  });
}

/**
 * Load data specific to a view
 * @param {string} view - View name
 */
function loadViewData(view) {
  switch (view) {
    case "home":
      loadHomeData();
      break;
    case "dashboard":
      loadDashboardData();
      break;
    case "profile":
      loadProfileData();
      break;
    case "members":
      loadMembersData();
      break;
    case "edit-event":
      if (!membersData || membersData.length === 0) {
        loadMembersDataForEvents();
      }
      // Load event data if ID is stored
      if (AppState.eventIdToLoad) {
        loadEventData(AppState.eventIdToLoad);
        AppState.eventIdToLoad = null;
      } else {
        resetEventsForm();
      }
      break;
    case "edit-training":
      // Load training data if ID is stored
      if (AppState.trainingIdToLoad) {
        loadTrainingData(AppState.trainingIdToLoad);
        AppState.trainingIdToLoad = null;
      } else {
        resetTrainingForm();
      }
      break;
    case "planning-event":
      loadPlanningEventData();
      break;
    case "planning-training":
      loadPlanningTrainingData();
      break;
  }
}

/**
 * Reset the events form to empty state for creating a new event
 */
function resetEventsForm() {
  // Clear event name, datetime and meeting place inputs
  const eventNameInput = document.getElementById("event-name-input");
  const eventDatetimeInput = document.getElementById("event-datetime-input");
  const eventMeetingPlaceInput = document.getElementById(
    "event-meeting-place-input",
  );

  if (eventNameInput) {
    eventNameInput.value = "";
  }

  if (eventDatetimeInput) {
    eventDatetimeInput.value = "";
  }

  if (eventMeetingPlaceInput) {
    eventMeetingPlaceInput.value = "";
  }

  // Hide dance selector section
  const danceSelectorSection = document.getElementById(
    "dance-selector-section",
  );
  if (danceSelectorSection) {
    danceSelectorSection.style.display = "none";
  }

  // Clear diagrams list
  const diagramsList = document.getElementById("diagrams-list");
  if (diagramsList) {
    diagramsList.innerHTML = "";
  }

  // Reset diagrams array (defined in events.html)
  if (typeof diagrams !== "undefined") {
    diagrams.length = 0;
  }
  if (typeof diagramIdCounter !== "undefined") {
    diagramIdCounter = 0;
  }

  // Reset dirty flag
  if (typeof diagramsIsDirty !== "undefined") {
    diagramsIsDirty = false;
  }
}

/**
 * Reset the training form to empty state for creating a new training
 */
function resetTrainingForm() {
  // Clear training inputs
  const trainingDatetimeInput = document.getElementById("training-datetime-input");
  const trainingDescriptionInput = document.getElementById("training-description-input");

  if (trainingDatetimeInput) {
    trainingDatetimeInput.value = "";
  }

  if (trainingDescriptionInput) {
    trainingDescriptionInput.value = "";
    // Hide detected dances section when form is reset
    const trainingDetectedDancesSection = document.getElementById("training-detected-dances-section");
    if (trainingDetectedDancesSection) {
      trainingDetectedDancesSection.style.display = "none";
    }
  }

  // Update page header to "Nou assaig"
  updateTrainingPageTitle(false);

  // Apply editable state (admin-only)
  applyTrainingEditableState();

  // Initialize form event listeners for dance detection
  initializeTrainingFormListeners();
}

/**
 * Load events list for planning view
 */
function loadPlanningEventData() {
  const container = document.getElementById("planning-event-list");
  if (!container) return;

  // Show loading state
  container.innerHTML = `
        <div class="events-loading">
        <div class="spinner"></div>
        <span>Carregant actuacions...</span>
        </div>
    `;

  API.getEvents()
    .then(function (events) {
      renderPlanningEventsList(events);
    })
    .catch(function (error) {
      console.error("Failed to load events:", error);
      container.innerHTML = `
                <div class="events-empty">
                <div class="events-empty-icon">‚ö†Ô∏è</div>
                <p>No s'han pogut carregar les actuacions</p>
                </div>
            `;
    });
}

function loadPlanningTrainingData() {
  const container = document.getElementById("planning-training-list");
  if (!container) return;

  // Show loading state
  container.innerHTML = `
        <div class="training-loading">
        <div class="spinner"></div>
        <span>Carregant assajos...</span>
        </div>
    `;

  API.getTrainings()
    .then(function (events) {
      renderPlanningTrainingsList(events);
    })
    .catch(function (error) {
      console.error("Failed to load training sessions:", error);
      container.innerHTML = `
                <div class="training-empty">
                <div class="training-empty-icon">‚ö†Ô∏è</div>
                <p>No s'han pogut carregar els assajos</p>
                </div>
            `;
    });
}

/**
 * Render the events list in planning view
 * @param {Array} events - Array of event objects
 */
function renderPlanningEventsList(events) {
  const container = document.getElementById("planning-event-list");
  const pastEventsContainer = document.getElementById("past-event-list");
  const pastEventsToggle = document.getElementById("past-event-toggle");
  const pastEventsCount = document.getElementById("past-event-count");

  if (!container) return;

  if (!events || events.length === 0) {
    container.innerHTML = `
    <div class="events-empty">
    <div class="events-empty-icon">üìÖ</div>
    <p>No hi ha actuacions programades</p>
    <p>Crea un nou assaig o actuaci√≥ per comen√ßar!</p>
    </div>
    `;
    if (pastEventsContainer) pastEventsContainer.innerHTML = "";
    return;
  }

  const now = new Date();
  const upcomingEvents = [];
  const pastEvents = [];

  // Separate upcoming and past events
  events.forEach(function (event) {
    if (event.date) {
      const eventDate = new Date(event.date);
      if (eventDate < now) {
        pastEvents.push(event);
      } else {
        upcomingEvents.push(event);
      }
    } else {
      upcomingEvents.push(event);
    }
  });

  // Helper function to create event card HTML
  function createEventCardHTML(event) {
    const formattedDate = formatEventDate(event.date);
    let meetingPlaceHtml = "";
    if (event.meetingPlace) {
      if (event.placeUrl) {
        meetingPlaceHtml = `<a href="${escapeHtml(event.placeUrl)}" target="_blank" class="event-card-place">üìç ${escapeHtml(event.meetingPlace)}</a>`;
      } else {
        meetingPlaceHtml = `<span class="event-card-place">üìç ${escapeHtml(event.meetingPlace)}</span>`;
      }
    }
    const isAdmin = AppState.currentUser && (AppState.currentUser.roles || []).includes("ADMIN");
    const actionHtml = event.confirmed || isAdmin
      ? `<button type="button" class="event-card-btn view-btn" onclick="viewEvent('${escapeHtml(event.id)}')">Detalls</button>`
      : `<span class="event-tbc" style="font-style: italic; color: var(--text-secondary, #666);">TBC</span>`;
    return `
    <div class="event-card" data-event-id="${event.id}">
    <div class="event-card-info">
    <span class="event-card-name">${event.name}</span>
    <span class="event-card-date">${formattedDate}</span>
    ${meetingPlaceHtml}
    </div>
    <div class="event-card-actions">
    ${actionHtml}
    </div>
    </div>
    `;
  }

  // Render upcoming events
  if (upcomingEvents.length === 0) {
    container.innerHTML = `
    <div class="events-empty">
    <div class="events-empty-icon">üìÖ</div>
    <p>No hi ha actuacions programades</p>
    <p>Crea un nou assaig o actuaci√≥ per comen√ßar!</p>
    </div>
    `;
  } else {
    // Sort upcoming events by date ascending (closest first)
    upcomingEvents.sort(function (a, b) {
      const dateA = a.date ? new Date(a.date).getTime() : Infinity;
      const dateB = b.date ? new Date(b.date).getTime() : Infinity;
      return dateA - dateB;
    });

    const upcomingHTML = upcomingEvents.map(createEventCardHTML).join("");
    container.innerHTML = upcomingHTML;
  }

  // Render past events in collapsible
  if (pastEventsContainer) {
    if (pastEvents.length === 0) {
      pastEventsContainer.innerHTML =
        '<div class="past-event-empty">No hi ha actuacions passades</div>';
    } else {
      const pastHTML = pastEvents.map(createEventCardHTML).join("");
      pastEventsContainer.innerHTML = pastHTML;
    }
  }

  // Update past events count
  if (pastEventsCount) {
    pastEventsCount.textContent = pastEvents.length;
  }

  // Hide past events section if no past events
  if (pastEventsToggle) {
    if (pastEvents.length === 0) {
      pastEventsToggle.style.display = "none";
    } else {
      pastEventsToggle.style.display = "flex";
    }
  }

  // Initialize collapsible toggle listener
  if (pastEventsToggle && !pastEventsToggle.dataset.initialized) {
    pastEventsToggle.addEventListener("click", function () {
      const content = pastEventsContainer;
      pastEventsToggle.classList.toggle("active");
      if (content.style.display === "none") {
        content.style.display = "flex";
      } else {
        content.style.display = "none";
      }
    });
    pastEventsToggle.dataset.initialized = "true";
  }

  // Show refresh button after content is rendered
  const refreshBtn = document.getElementById("refresh-event-btn");
  if (refreshBtn) {
    refreshBtn.style.display = "block";
  }
}

function renderPlanningTrainingsList(trainings) {
  const container = document.getElementById("planning-training-list");
  const pastTrainingsContainer = document.getElementById("past-training-list");
  const pastTrainingsToggle = document.getElementById("past-training-toggle");
  const pastTrainingsCount = document.getElementById("past-training-count");

  if (!container) return;

  if (!trainings || trainings.length === 0) {
    container.innerHTML = `
    <div class="trainings-empty">
    <div class="trainings-empty-icon">üéì</div>
    <p>No hi ha assajos programats</p>
    <p>Crea un nou assaig per comen√ßar!</p>
    </div>
    `;
    if (pastTrainingsContainer) pastTrainingsContainer.innerHTML = "";
    return;
  }

  const now = new Date();
  const upcomingTrainings = [];
  const pastTrainings = [];

  // Separate upcoming and past trainings
  trainings.forEach(function (training) {
    if (training.date) {
      const trainingDate = new Date(training.date);
      if (trainingDate >= now) {
        upcomingTrainings.push(training);
      } else {
        pastTrainings.push(training);
      }
    } else {
      upcomingTrainings.push(training);
    }
  });

  // Helper function to create training card HTML
  function createTrainingCardHTML(training) {
    const formattedDate = formatEventDate(training.date);
    let meetingPlaceHtml = "";
    if (training.meetingPlace) {
      meetingPlaceHtml = `<span class="training-card-location">üìç ${escapeHtml(training.meetingPlace)}</span>`;
    }
    const actionHtml = `
      <div class="training-card-action-group">
        <button type="button" class="btn btn-sm btn-primary" onclick="navigateToTraining('${escapeHtml(training.id)}')">Detalls</button>
      </div>
    `;
    return `
<div class="training-card" data-training-id="${training.id}">
<div class="training-card-info">
    <span class="training-card-name">${escapeHtml(training.name)}</span>
    <span class="training-card-date">${formattedDate}</span>
    <span class="training-count">${training.assistance ? training.assistance.length : 0} persones apuntades</span>
    ${meetingPlaceHtml}
</div>
<div class="training-card-actions">
    ${actionHtml}
</div>
</div>
`;
  }

  // Render upcoming trainings
  if (upcomingTrainings.length === 0) {
    container.innerHTML = `
<div class="trainings-empty">
<div class="trainings-empty-icon">üéì</div>
<p>No hi ha assajos programats</p>
<p>Crea un nou assaig per comen√ßar!</p>
</div>
`;
  } else {
    // Sort upcoming trainings by date ascending (closest first)
    upcomingTrainings.sort(function (a, b) {
      const dateA = new Date(a.date);
      const dateB = new Date(b.date);
      return dateA - dateB;
    });

    const upcomingHTML = upcomingTrainings.map(createTrainingCardHTML).join("");
    container.innerHTML = upcomingHTML;
  }

  // Render past trainings in collapsible
  if (pastTrainingsContainer) {
    if (pastTrainings.length === 0) {
      pastTrainingsContainer.innerHTML = '<div class="past-training-empty">No hi ha assajos passats</div>';
    } else {
      const pastHTML = pastTrainings.map(createTrainingCardHTML).join("");
      pastTrainingsContainer.innerHTML = pastHTML;
    }
  }

  // Update past trainings count
  if (pastTrainingsCount) {
    pastTrainingsCount.textContent = pastTrainings.length;
  }

  // Hide past trainings section if no past trainings
  if (pastTrainingsToggle) {
    if (pastTrainings.length === 0) {
      pastTrainingsToggle.style.display = "none";
    } else {
      pastTrainingsToggle.style.display = "flex";
    }
  }

  // Initialize collapsible toggle listener
  if (pastTrainingsToggle && !pastTrainingsToggle.dataset.initialized) {
    pastTrainingsToggle.addEventListener("click", function () {
      const content = pastTrainingsContainer;
      pastTrainingsToggle.classList.toggle("active");
      if (content.style.display === "none") {
        content.style.display = "flex";
      } else {
        content.style.display = "none";
      }
    });
    pastTrainingsToggle.dataset.initialized = "true";
  }

  // Show refresh button after content is rendered
  const refreshBtn = document.getElementById("refresh-training-btn");
  if (refreshBtn) {
    refreshBtn.style.display = "block";
  }
}

/**
 * Format event date for display
 * @param {string|Date} date - Date to format (expects ISO format)
 * @returns {string} Formatted date string in Catalan
 */
function formatEventDate(date) {
  if (!date) return "Data no especificada";

  try {
    const d = new Date(date);
    if (isNaN(d.getTime())) return String(date);

    const options = {
      weekday: "long",
      year: "numeric",
      month: "long",
      day: "numeric",
      hour: "2-digit",
      minute: "2-digit",
    };
    return d.toLocaleDateString("ca-ES", options);
  } catch (e) {
    return String(date);
  }
}

// Data loading functions are now separate from navigation

/**
 * Load event data into edit-event view
 * @param {string} eventId - Event ID to load
 */
function loadEventData(eventId) {
  if (!eventId) {
    showToast("ID d'desenvolupament no v√†lid", "error");
    return;
  }

  // Prevent loading the same event multiple times
  if (AppState.currentEventId === eventId) {
    return;
  }
  
  AppState.currentEventId = eventId;

  // Set flag to prevent form reset when navigating
  isLoadingExistingEvent = true;
  
  showLoading(true);

  API.getEventById({ eventId })
    .then(function (eventData) {
      showLoading(false);

      if (!eventData) {
        showToast("No s'ha trobat l'esdeveniment", "error");
        isLoadingEventFromHash = false;
        return;
      }

      // Navigate to events view with event ID in hash
      // Use eventData.id (returned from server) as the canonical ID
      const canonicalEventId = eventData.id || eventId;
      const eventHash = "events/" + encodeURIComponent(canonicalEventId);
      localStorage.setItem("currentRoute", eventHash);

      // Populate event fields (admin inputs)
      const eventNameInput = document.getElementById("event-name-input");
      const eventDatetimeInput = document.getElementById(
        "event-datetime-input",
      );
      const eventMeetingPlaceInput = document.getElementById(
        "event-meeting-place-input",
      );
      // Populate display elements (non-admin)
      const eventNameDisplay = document.getElementById("event-name-display");
      const eventDateDisplay = document.getElementById("event-date-display");
      const eventMeetingPlaceDisplay = document.getElementById(
        "event-meeting-place-display",
      );

      if (eventNameInput) {
        eventNameInput.value = eventData.name || "";
      }
      if (eventNameDisplay) {
        eventNameDisplay.textContent = eventData.name || "";
      }

      if (eventDatetimeInput && eventData.datetime) {
        // Date should already be in datetime-local format (YYYY-MM-DDTHH:mm)
        // or ISO format that needs conversion
        try {
          let dateValue = eventData.datetime;
          // If it's an ISO string (contains Z or timezone offset), convert to local
          if (dateValue.includes("Z") || dateValue.match(/[+-]\d{2}:\d{2}$/)) {
            const date = new Date(dateValue);
            if (!isNaN(date.getTime())) {
              const year = date.getFullYear();
              const month = String(date.getMonth() + 1).padStart(2, "0");
              const day = String(date.getDate()).padStart(2, "0");
              const hours = String(date.getHours()).padStart(2, "0");
              const minutes = String(date.getMinutes()).padStart(2, "0");
              dateValue = `${year}-${month}-${day}T${hours}:${minutes}`;
            }
          }
          eventDatetimeInput.value = dateValue;

          // Format date for display (non-admin)
          if (eventDateDisplay && dateValue) {
            const displayDate = new Date(dateValue);
            if (!isNaN(displayDate.getTime())) {
              const options = {
                weekday: "long",
                year: "numeric",
                month: "long",
                day: "numeric",
                hour: "2-digit",
                minute: "2-digit",
              };
              eventDateDisplay.textContent = displayDate.toLocaleDateString(
                "ca-ES",
                options,
              );
            }
          }
        } catch (e) {
          console.error("Error parsing event date:", e);
        }
      }

      // Populate meeting place
      if (eventMeetingPlaceInput) {
        eventMeetingPlaceInput.value = eventData.meetingPlace || "";
      }
      if (eventMeetingPlaceDisplay) {
        eventMeetingPlaceDisplay.textContent = eventData.meetingPlace || "";
      }

      // Trigger input events to show dance selector
      eventNameInput.dispatchEvent(new Event("input"));
      eventDatetimeInput.dispatchEvent(new Event("input"));

      // Load diagrams after a short delay to ensure dances data is loaded
      setTimeout(function () {
        loadEventDiagrams(eventData);
        // Clear flag after diagrams are loaded to allow subsequent hash changes
        isLoadingEventFromHash = false;
      }, 500);

      showToast("Esdeveniment carregat", "success");
    })
    .catch(function (error) {
      showLoading(false);
      console.error("Error loading event:", error);
      showToast("Error carregant l'esdeveniment", "error");
      // Clear flag on error
      isLoadingEventFromHash = false;
    });
}

/**
 * Quick navigate to event (backward compatibility)
 */
function viewEvent(eventId) {
  if (!eventId) return;
  AppState.eventIdToLoad = escapeHtml(eventId);
  window.location.hash = "events/" + encodeURIComponent(eventId);
}

/**
 * Load training data into edit-training view
 * @param {string} trainingId - Training ID to load
 */
function loadTrainingData(trainingId) {
  if (!trainingId) {
    showToast("ID d'assaig no v√†lid", "error");
    return;
  }

  // Prevent loading the same training multiple times
  if (AppState.currentTrainingId === trainingId) {
    return;
  }
  
  AppState.currentTrainingId = trainingId;

  showLoading(true);

  API.getTrainingById({ trainingId })
    .then(function (trainingData) {
      showLoading(false);

      if (!trainingData) {
        showToast("No s'ha trobat l'assaig", "error");
        isLoadingTrainingFromHash = false;
        return;
      }

      // Navigate to edit-training view with training ID in hash
      const canonicalTrainingId = trainingData.id || trainingId;
      const trainingHash = "training/" + encodeURIComponent(canonicalTrainingId);
      localStorage.setItem("currentRoute", trainingHash);
      // Note: hash is already set by navigateToTraining(), don't set it again
      // window.location.hash = trainingHash;

      // Populate training fields
      const trainingDatetimeInput = document.getElementById(
        "training-datetime-input",
      );
      const trainingDescriptionInput = document.getElementById(
        "training-description-input",
      );

      if (trainingDatetimeInput && trainingData.date) {
        try {
          let dateValue = trainingData.date;
          // If it's an ISO string (contains Z or timezone offset), convert to local
          if (dateValue.includes("Z") || dateValue.match(/[+-]\d{2}:\d{2}$/)) {
            const date = new Date(dateValue);
            if (!isNaN(date.getTime())) {
              const year = date.getFullYear();
              const month = String(date.getMonth() + 1).padStart(2, "0");
              const day = String(date.getDate()).padStart(2, "0");
              const hours = String(date.getHours()).padStart(2, "0");
              const minutes = String(date.getMinutes()).padStart(2, "0");
              dateValue = `${year}-${month}-${day}T${hours}:${minutes}`;
            }
          }
          trainingDatetimeInput.value = dateValue;
        } catch (e) {
          console.error("Error parsing training date:", e);
        }
      }

      if (trainingDescriptionInput && trainingData.description) {
        trainingDescriptionInput.value = trainingData.description;
        // Detect dances from the loaded description
        detectAndDisplayDancesFromDescription();
      }

      // Update page header to "Assaig" (editing mode)
      updateTrainingPageTitle(true);

      // Apply editable state based on admin role
      applyTrainingEditableState();

      // Initialize form event listeners for dance detection
      initializeTrainingFormListeners();

      // Clear flag after loading completes
      isLoadingTrainingFromHash = false;

      showToast("Assaig carregat", "success");
    })
    .catch(function (error) {
      showLoading(false);
      console.error("Error loading training:", error);
      showToast("Error carregant l'assaig", "error");
    });
}

/**
 * Apply editable state to training fields based on user role
 * Only admins can edit training details
 */
function applyTrainingEditableState() {
  const isAdmin = AppState.currentUser && (AppState.currentUser.roles || []).includes("ADMIN");
  
  const trainingDatetimeInput = document.getElementById("training-datetime-input");
  const trainingDescriptionInput = document.getElementById("training-description-input");
  const trainingDatetimeLabel = document.getElementById("training-datetime-label");
  const trainingDescriptionLabel = document.getElementById("training-description-label");
  const saveBtnTraining = document.getElementById("floating-save-training-btn");

  if (isAdmin) {
    // Show inputs, hide labels
    if (trainingDatetimeInput) trainingDatetimeInput.style.display = "";
    if (trainingDescriptionInput) trainingDescriptionInput.style.display = "";
    if (trainingDatetimeLabel) trainingDatetimeLabel.style.display = "none";
    if (trainingDescriptionLabel) trainingDescriptionLabel.style.display = "none";
    if (saveBtnTraining) saveBtnTraining.style.display = "";
    
    // Enable fields
    if (trainingDatetimeInput) trainingDatetimeInput.disabled = false;
    if (trainingDescriptionInput) trainingDescriptionInput.disabled = false;
  } else {
    // Show labels, hide inputs
    if (trainingDatetimeInput) trainingDatetimeInput.style.display = "none";
    if (trainingDescriptionInput) trainingDescriptionInput.style.display = "none";
    if (trainingDatetimeLabel) trainingDatetimeLabel.style.display = "";
    if (trainingDescriptionLabel) trainingDescriptionLabel.style.display = "";
    if (saveBtnTraining) saveBtnTraining.style.display = "none";
    
    // Disable fields
    if (trainingDatetimeInput) trainingDatetimeInput.disabled = true;
    if (trainingDescriptionInput) trainingDescriptionInput.disabled = true;
    
    // Populate labels with current values
    if (trainingDatetimeLabel && trainingDatetimeInput && trainingDatetimeInput.value) {
      const dateObj = new Date(trainingDatetimeInput.value + ":00");
      const options = {
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric",
        hour: "2-digit",
        minute: "2-digit",
      };
      trainingDatetimeLabel.textContent = dateObj.toLocaleDateString("ca-ES", options);
    }
    
    if (trainingDescriptionLabel && trainingDescriptionInput && trainingDescriptionInput.value) {
      trainingDescriptionLabel.textContent = trainingDescriptionInput.value;
    }
  }
}

/**
 * Update training page title based on edit/create mode
 * @param {boolean} isEditing - True if editing existing training, false if creating new one
 */
function updateTrainingPageTitle(isEditing) {
  const pageHeader = document.querySelector("#view-training .page-header h1");
  if (pageHeader) {
    pageHeader.textContent = isEditing ? "Assaig" : "Nou assaig";
  }
}

/**
 * Detect dances from training description and update chips display
 */
function detectAndDisplayDancesFromDescription() {
  const trainingDescriptionInput = document.getElementById("training-description-input");
  const trainingDetectedDancesSection = document.getElementById("training-detected-dances-section");
  const trainingDetectedDancesChips = document.getElementById("training-detected-dances");

  if (!trainingDescriptionInput || !trainingDetectedDancesSection || !trainingDetectedDancesChips) {
    return;
  }

  const description = trainingDescriptionInput.value.toLowerCase().trim();

  // If description is empty, hide the section
  if (!description) {
    trainingDetectedDancesSection.style.display = "none";
    return;
  }

  // Detect dances from description
  const detectedDances = detectDancesFromText(description);

  if (detectedDances.length === 0) {
    trainingDetectedDancesSection.style.display = "none";
    return;
  }

  // Show the section and populate chips
  trainingDetectedDancesSection.style.display = "flex";
  trainingDetectedDancesChips.innerHTML = "";

  detectedDances.forEach(function (danceName) {
    const chip = document.createElement("div");
    chip.className = "training-detected-dance-chip";
    chip.textContent = danceName;
    chip.addEventListener("click", function () {
      openDanceAudioDialog(danceName);
    });
    trainingDetectedDancesChips.appendChild(chip);
  });
}

/**
 * Detect dance names from text by checking against available dances
 * @param {string} text - The text to search for dance names
 * @returns {Array<string>} Array of detected dance names
 */
function detectDancesFromText(text) {
  if (!text || typeof dancesData === "undefined" || !Array.isArray(dancesData)) {
    return [];
  }

  const detectedDances = [];
  const seenNames = new Set();

  // Search for each dance name in the text
  dancesData.forEach(function (dance) {
    if (dance.name && !seenNames.has(dance.name)) {
      const danceName = dance.name.toLowerCase();
      // Case-insensitive search for the dance name
      if (text.includes(danceName)) {
        detectedDances.push(dance.name);
        seenNames.add(dance.name);
      }
    }
  });

  return detectedDances;
}

/**
 * Initialize training form event listeners for dance detection
 */
function initializeTrainingFormListeners() {
  const trainingDescriptionInput = document.getElementById("training-description-input");
  
  if (!trainingDescriptionInput) {
    return;
  }

  // Remove any existing listeners to avoid duplicates
  const newInput = trainingDescriptionInput.cloneNode(true);
  trainingDescriptionInput.parentNode.replaceChild(newInput, trainingDescriptionInput);

  // Add input event listener to detect dances as description changes
  newInput.addEventListener("input", detectAndDisplayDancesFromDescription);
}

/**
 * Open dialog showing dance audio information
 * @param {string} danceName - The name of the dance to display audios for
 */
function openDanceAudioDialog(danceName) {
  if (!danceName || typeof dancesData === "undefined") {
    return;
  }

  // Find the dance data
  const dance = dancesData.find(function (d) {
    return d.name === danceName;
  });

  if (!dance) {
    return;
  }

  const dialog = document.getElementById("dance-audio-dialog");
  const titleElement = document.getElementById("dance-audio-title");
  const audioListElement = document.getElementById("dance-audio-list");

  if (!dialog || !titleElement || !audioListElement) {
    return;
  }

  // Set the title
  titleElement.textContent = danceName;

  // Clear and populate audio list
  audioListElement.innerHTML = "";

  if (!dance.audios || dance.audios.length === 0) {
    audioListElement.innerHTML = '<div class="dance-audio-empty">No hi ha audios disponibles per a aquest ball.</div>';
    dialog.showModal();
    return;
  }

  // Create audio items
  dance.audios.forEach(function (audio) {
    const audioItem = document.createElement("div");
    audioItem.className = "dance-audio-item";

    const titleDiv = document.createElement("div");
    titleDiv.className = "dance-audio-item-title";
    titleDiv.textContent = audio.title || "Sense t√≠tol";

    const artistDiv = document.createElement("div");
    artistDiv.className = "dance-audio-item-artist";
    artistDiv.textContent = "Per: " + (audio.artist || "Desconegut");

    // Create a container for the player (button initially, iframe on click)
    const playerContainer = document.createElement("div");
    playerContainer.className = "dance-audio-player-container";

    // Create play button
    const playButton = document.createElement("button");
    playButton.className = "dance-audio-play-btn";
    playButton.type = "button";
    playButton.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>';
    playButton.title = "Reproduir √†udio";

    // Add click handler to replace button with iframe
    playButton.addEventListener("click", function () {
      playButton.style.display = "none";

      // Show loading state
      const loadingDiv = document.createElement("div");
      loadingDiv.className = "dance-audio-loading";
      loadingDiv.innerHTML = '<div class="spinner"></div><span>Carregant √†udio...</span>';
      playerContainer.appendChild(loadingDiv);

      // Request audio data from API
      API.getAudioById({ audioId: audio.fileId })
      .then(function (result) {
        loadingDiv.remove();
        if (result && result.audioData) {
          // Create audio element only on success
          const audioElement = document.createElement("audio");
          audioElement.controls = true;
          audioElement.style.width = "100%";
          audioElement.src = result.audioData;
          playerContainer.appendChild(audioElement);
        } else {
          const errorDiv = document.createElement("div");
          errorDiv.className = "dance-audio-error";
          errorDiv.textContent = "No s'ha pogut carregar l'√†udio";
          playerContainer.appendChild(errorDiv);
        }
      })
      .catch(function (error) {
        loadingDiv.remove();
        const errorDiv = document.createElement("div");
        errorDiv.className = "dance-audio-error";
        errorDiv.textContent = error || "Error carregant l'√†udio";
        playerContainer.appendChild(errorDiv);
      });
    });

    playerContainer.appendChild(playButton);

    audioItem.appendChild(titleDiv);
    audioItem.appendChild(artistDiv);
    audioItem.appendChild(playerContainer);
    audioListElement.appendChild(audioItem);
  });

  // Show the dialog
  dialog.showModal();
}

/**
 * Stop all audio elements in the dialog
 * @param {HTMLElement} dialogElement - The dialog element containing audio elements
 */
function stopAllAudioInDialog(dialogElement) {
  if (!dialogElement) return;
  
  const audioElements = dialogElement.querySelectorAll("audio");
  audioElements.forEach(function (audio) {
    audio.pause();
    audio.currentTime = 0;
  });
}

/**
 * Close dance audio dialog
 */
function closeDanceAudioDialog() {
  const dialog = document.getElementById("dance-audio-dialog");
  if (dialog && dialog.open) {
    stopAllAudioInDialog(dialog);
    dialog.close();
  }
}

/**
 * Quick navigate to training (backward compatibility)
 */
function navigateToTraining(trainingId) {
  if (!trainingId) return;
  AppState.trainingIdToLoad = escapeHtml(trainingId);
  window.location.hash = "training/" + encodeURIComponent(trainingId);
}

/**
 * Load diagrams from event data into the events view
 * @param {Object} eventData - The event data with diagrams
 */
function loadEventDiagrams(eventData) {
  if (!eventData || !eventData.diagrams) return;

  const diagramsList = document.getElementById("diagrams-list");
  if (!diagramsList) return;

  // Clear any existing pending diagram load interval
  if (pendingDiagramLoadInterval !== null) {
    clearInterval(pendingDiagramLoadInterval);
    pendingDiagramLoadInterval = null;
  }

  // Clear existing diagrams
  diagramsList.innerHTML = "";

  // Reset diagrams array (this is defined in events.html)
  if (typeof diagrams !== "undefined") {
    diagrams.length = 0;
    diagramIdCounter = 0;
  }

  // Function to render diagrams once dances data is available
  function renderDiagrams() {
    if (typeof dancesData === "undefined" || !Array.isArray(dancesData) || dancesData.length === 0) {
      return false;
    }

    eventData.diagrams.forEach(function (diagramData) {
      // Find the dance info to get colors and other metadata
      const danceInfo = dancesData.find(function (d) {
        return d.name === diagramData.danceName;
      });

      const newDiagram = {
        id: diagramIdCounter++,
        danceName: diagramData.danceName,
        description: diagramData.description || "",
        rows: diagramData.rows || 2,
        columns: diagramData.columns || 2,
        positions: diagramData.positions || [],
        diagram: danceInfo
          ? danceInfo.diagram
          : { backgroundColor: {}, textColor: {} },
        groups: diagramData.groups || [],
      };

      // If positions don't have colors, try to get them from dance info
      if (danceInfo && danceInfo.positions) {
        newDiagram.positions = danceInfo.positions;
      }

      diagrams.push(newDiagram);

      const element = createDiagramElement(newDiagram);
      diagramsList.appendChild(element);

      // Setup canvas click handler
      const canvas = document.getElementById(
        "diagram-canvas-" + newDiagram.id,
      );
      if (canvas) {
        setupCanvasClickHandlerForDiagram(newDiagram.id);
      }

      drawDiagram(newDiagram);
    });

    // Mark as not dirty since we just loaded
    if (typeof diagramsIsDirty !== "undefined") {
      diagramsIsDirty = false;
    }

    // Apply editability state to hide diagram-header-actions and floating-save-btn when event is not editable
    if (typeof applyEditableState !== "undefined") {
      applyEditableState();
    }

    return true;
  }

  // Try to render immediately if dances are already loaded
  if (renderDiagrams()) {
    return;
  }

  // Wait for dances data to be available
  let attempts = 0;
  const maxAttempts = 50; // 5 seconds with 100ms intervals
  pendingDiagramLoadInterval = setInterval(function () {
    attempts++;
    
    if (renderDiagrams()) {
      clearInterval(pendingDiagramLoadInterval);
      pendingDiagramLoadInterval = null;
    } else if (attempts >= maxAttempts) {
      clearInterval(pendingDiagramLoadInterval);
      pendingDiagramLoadInterval = null;
      console.warn("Failed to load dances data within timeout");
    }
  }, 100);
}

/**
 * Setup canvas click handler for a loaded diagram
 * This wraps the internal setupCanvasClickHandler from events.html
 * @param {number} diagramId - The diagram ID
 */
function setupCanvasClickHandlerForDiagram(diagramId) {
  const canvas = document.getElementById("diagram-canvas-" + diagramId);
  if (!canvas) return;

  const dialog = document.getElementById("person-dialog");
  const personCombo = document.getElementById("person-combo");
  const personList = document.getElementById("person-list");
  const personLoading = document.getElementById("person-loading");

  canvas.addEventListener("click", function (e) {
    const diagram = diagrams.find(function (d) {
      return d.id === diagramId;
    });
    if (!diagram) return;

    const rect = canvas.getBoundingClientRect();
    const groups = diagram.groups;
    const rows = diagram.rows || 2;
    const cols = diagram.columns || 2;
    const groupCount = groups.length;

    // Use the same layout calculation as drawing
    const layout = calcDiagramLayout(canvas, groupCount, rows, cols);
    const {
      squareWidth,
      squareHeight,
      squareSpacingX,
      squareSpacingY,
      spacing,
      gridWidth,
      offsetX0,
      offsetY,
    } = layout;

    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const clickX = (e.clientX - rect.left) * scaleX;
    const clickY = (e.clientY - rect.top) * scaleY;

    for (let g = 0; g < groupCount; g++) {
      const offsetX = offsetX0 + g * (gridWidth + spacing);
      const groupAreaWidth = squareWidth * cols + squareSpacingX * (cols - 1);
      const groupAreaHeight = squareHeight * rows + squareSpacingY * (rows - 1);
      if (
        clickX >= offsetX &&
        clickX <= offsetX + groupAreaWidth &&
        clickY >= offsetY &&
        clickY <= offsetY + groupAreaHeight
      ) {
        const x = clickX - offsetX;
        const y = clickY - offsetY;
        const col = Math.floor(x / (squareWidth + squareSpacingX));
        const row = Math.floor(y / (squareHeight + squareSpacingY));
        if (col >= cols || row >= rows) return;
        const idx = row * cols + col;

        // Store selection in global scope for dialog handling
        window.selectedDiagramId = diagramId;
        window.selectedGroup = g;
        window.selectedSquare = idx;

        // Populate and show dialog
        populatePersonListForDiagram(diagram, g, idx);
        return;
      }
    }
  });
}

/**
 * Populate person list for diagram editing
 * @param {Object} diagram - The diagram object
 * @param {number} g - Group index
 * @param {number} squareIdx - Square index
 */
function populatePersonListForDiagram(diagram, g, squareIdx) {
  closeAllDialogs();
  const dialog = document.getElementById("person-dialog");
  const personCombo = document.getElementById("person-combo");
  const personList = document.getElementById("person-list");
  const personLoading = document.getElementById("person-loading");
  const clearPersonBtn = document.getElementById("clear-person-btn");
  const eventDatetimeInput = document.getElementById("event-datetime-input");

  const cellCount = (diagram.rows || 2) * (diagram.columns || 2);
  let usedNames = [];
  for (let gi = 0; gi < diagram.groups.length; gi++) {
    for (let si = 0; si < cellCount; si++) {
      if (gi === g && si === squareIdx) continue;
      if (diagram.groups[gi][si]) usedNames.push(diagram.groups[gi][si]);
    }
  }

  // Check if event is in the past - if so, include inactive members
  let isEventInPast = false;
  if (eventDatetimeInput && eventDatetimeInput.value) {
    const eventDate = new Date(eventDatetimeInput.value);
    const now = new Date();
    isEventInPast = eventDate < now;
  }

  // Filter members: only active for future events, all for past events
  const personNames = membersData
    .filter(function (m) {
      return isEventInPast || m.active;
    })
    .map(function (m) {
      return m.name;
    })
    .filter(Boolean);
  window.currentOptions = personNames.filter(function (name) {
    return !usedNames.includes(name) || diagram.groups[g][squareIdx] === name;
  });

  personList.innerHTML = "";

  if (window.currentOptions.length === 0) {
    personCombo.style.display = "none";
    personLoading.style.display = "block";
    personLoading.querySelector(".dialog-spinner").style.display = "none";
    personLoading.querySelector("p").textContent =
      "No hi ha membres disponibles";
  } else {
    personCombo.style.display = "block";
    personLoading.style.display = "none";
    personCombo.placeholder = "Cerca o selecciona...";
    personCombo.disabled = false;
    window.currentOptions.forEach(function (name) {
      const option = document.createElement("option");
      option.value = name;
      personList.appendChild(option);
    });
  }

  personCombo.value = diagram.groups[g][squareIdx] || "";
  clearPersonBtn.style.display = diagram.groups[g][squareIdx]
    ? "block"
    : "none";
  if (dialog) {
    dialog.showModal();
  }
}

/**
 * Refresh events list in planning view
 */
function refreshPlanningEvents() {
  const refreshBtn = document.getElementById("refresh-event-btn");

  if (refreshBtn) {
    refreshBtn.classList.add("refreshing");
    refreshBtn.disabled = true;
  }

  API.getEvents({ forceRefresh: true })
    .then(function (events) {
      if (refreshBtn) {
        refreshBtn.classList.remove("refreshing");
        refreshBtn.disabled = false;
      }
      renderPlanningEventsList(events);
      showToast("Llista actualitzada", "success");
    })
    .catch(function (error) {
      if (refreshBtn) {
        refreshBtn.classList.remove("refreshing");
        refreshBtn.disabled = false;
      }
      showToast("Error actualitzant la llista", "error");
    });
}

/**
 * Refresh trainings list in planning view
 */
function refreshPlanningTrainings() {
  const refreshBtn = document.getElementById("refresh-training-btn");

  if (refreshBtn) {
    refreshBtn.classList.add("refreshing");
    refreshBtn.disabled = true;
  }

  API.getTrainings({ forceRefresh: true })
    .then(function (trainings) {
      if (refreshBtn) {
        refreshBtn.classList.remove("refreshing");
        refreshBtn.disabled = false;
      }
      renderPlanningTrainingsList(trainings);
      showToast("Llista actualitzada", "success");
    })
    .catch(function (error) {
      if (refreshBtn) {
        refreshBtn.classList.remove("refreshing");
        refreshBtn.disabled = false;
      }
      showToast("Error actualitzant la llista", "error");
    });
}

/**
 * Load dashboard data
 */
function loadDashboardData() {
  // Update user display name
  document.querySelectorAll(".user-display-name").forEach(function (el) {
    el.textContent = AppState.currentUser?.displayName || "Usuari";
  });

  // Load stats
  // API.getDashboardStats()
  //   .then(function (data) {
  //     document.getElementById("stat-projects").textContent = data.projects || 0;
  //     document.getElementById("stat-tasks").textContent = data.tasks || 0;
  //     document.getElementById("stat-completed").textContent =
  //       data.completed || 0;
  //     document.getElementById("stat-pending").textContent = data.pending || 0;
  //   })
  //   .catch(function (error) {
  //     console.error("Failed to load stats:", error);
  //   });

  // Load activity
  // API.getUserActivity()
  //   .then(function (activities) {
  //     const activityList = document.getElementById("activity-list");
  //     if (activities && activities.length > 0) {
  //       activityList.innerHTML = activities
  //         .map(function (activity) {
  //           return `
  //                       <div class="activity-item">
  //                       <div class="activity-icon">${activity.icon || "üìù"}</div>
  //                       <div class="activity-content">
  //                           <p>${activity.description}</p>
  //                           <span class="activity-time">${formatRelativeTime(activity.timestamp)}</span>
  //                       </div>
  //                       </div>
  //                   `;
  //         })
  //         .join("");
  //     } else {
  //       activityList.innerHTML =
  //         '<p class="text-muted">No hi ha activitat recent</p>';
  //     }
  //   })
  //   .catch(function (error) {
  //     document.getElementById("activity-list").innerHTML =
  //       "<p class=\"text-muted\">No s'ha pogut carregar l'activitat</p>";
  //   });
  showToast("Informaci√≥ detallada no disponible al moment.", "info");
}

// Members table state
var membersData = [];
var membersSortColumn = "active";
var membersSortDirection = "desc";

/**
 * Refresh members list from database with visual feedback
 */
function refreshMembersList() {
  const refreshBtn = document.getElementById("refresh-members-btn");

  // Add spinning animation
  if (refreshBtn) {
    refreshBtn.classList.add("refreshing");
    refreshBtn.disabled = true;
  }

  // Show loading state in the table
  const tbody = document.querySelector("#members-table tbody");
  if (tbody)
    tbody.innerHTML = '<tr><td colspan="6">Actualitzant membres...</td></tr>';

  API.getMembers({ forceRefresh: true })
    .then(function (members) {
      // Remove spinning animation
      if (refreshBtn) {
        refreshBtn.classList.remove("refreshing");
        refreshBtn.disabled = false;
      }

      if (!Array.isArray(members)) {
        tbody.innerHTML =
          '<tr><td colspan="6">No s\'ha pogut carregar la llista de membres</td></tr>';
        return;
      }
      membersData = members;
      renderMembersTable();
      showToast("Llista actualitzada", "success");
    })
    .catch(function (error) {
      // Remove spinning animation
      if (refreshBtn) {
        refreshBtn.classList.remove("refreshing");
        refreshBtn.disabled = false;
      }
      tbody.innerHTML =
        '<tr><td colspan="6">No s\'ha pogut carregar la llista de membres</td></tr>';
      showToast("Error actualitzant la llista", "error");
    });
}

function loadMembersData() {
  // Show loading state in the table
  const tbody = document.querySelector("#members-table tbody");
  if (tbody)
    tbody.innerHTML = '<tr><td colspan="5">Carregant membres...</td></tr>';

  API.getMembers()
    .then(function (members) {
      if (!Array.isArray(members)) {
        tbody.innerHTML =
          '<tr><td colspan="5">No s\'ha pogut carregar la llista de membres</td></tr>';
        return;
      }
      membersData = members;
      initMembersFilters();
      renderMembersTable();
    })
    .catch(function (error) {
      tbody.innerHTML =
        '<tr><td colspan="5">No s\'ha pogut carregar la llista de membres</td></tr>';
    });
}

// Load members data silently for events view (without updating members table)
function loadMembersDataForEvents() {
  API.getMembers()
    .then(function (members) {
      if (Array.isArray(members)) {
        membersData = members;
      }
    })
    .catch(function (error) {
      console.error("Error loading members for events:", error);
    });
}

var membersTypeFilterValue = "";
var membersActiveFilterValue = ""; // '', 'true', 'false'
var membersRolsFilterValue = ""; // '', 'ADMIN', 'NO_ADMIN'
var membersAccessFilterValue = ""; // '', 'HAS_ACCESS', 'NO_ACCESS'

function initMembersFilters() {
  const searchInput = document.getElementById("members-search");
  const sortableHeaders = document.querySelectorAll(
    "#members-table th.sortable",
  );

  // Remove existing listeners by cloning and replacing
  if (searchInput && !searchInput.dataset.initialized) {
    searchInput.addEventListener("input", renderMembersTable);
    searchInput.dataset.initialized = "true";
  }
  sortableHeaders.forEach(function (th) {
    if (!th.dataset.initialized) {
      th.addEventListener("click", function () {
        const column = th.getAttribute("data-sort");
        if (membersSortColumn === column) {
          membersSortDirection =
            membersSortDirection === "asc" ? "desc" : "asc";
        } else {
          membersSortColumn = column;
          membersSortDirection = "asc";
        }
        updateSortIcons();
        renderMembersTable();
      });
      th.dataset.initialized = "true";
    }
  });
  updateSortIcons();

  // Long press on Type header to show filter dropdown
  const typeHeader = document.querySelector(
    '#members-table th[data-sort="type"]',
  );
  if (typeHeader && !typeHeader.dataset.longpressInitialized) {
    let longPressTimer = null;
    let longPressTriggered = false;
    const longPressDuration = 500; // ms

    function showTypeFilterDropdown(e) {
      e.preventDefault();
      e.stopPropagation();
      longPressTriggered = true;

      // Remove any existing dropdown
      const existingDropdown = document.getElementById("type-filter-dropdown");
      if (existingDropdown) existingDropdown.remove();

      // Create dropdown
      const dropdown = document.createElement("div");
      dropdown.id = "type-filter-dropdown";
      dropdown.className = "type-filter-dropdown";
      dropdown.innerHTML = `
<div class="type-filter-option" data-value="">Tots els tipus</div>
<div class="type-filter-option" data-value="ADULT">Adult</div>
<div class="type-filter-option" data-value="KID">Xiquet/a</div>
`;

      // Position dropdown below the header
      const rect = typeHeader.getBoundingClientRect();
      dropdown.style.top = rect.bottom + window.scrollY + "px";
      dropdown.style.left = rect.left + "px";

      // Mark current selection and add click handlers
      dropdown.querySelectorAll(".type-filter-option").forEach(function (opt) {
        if (opt.getAttribute("data-value") === membersTypeFilterValue) {
          opt.classList.add("selected");
        }
        opt.addEventListener("click", function () {
          membersTypeFilterValue = this.getAttribute("data-value");
          dropdown.remove();
          renderMembersTable();
        });
      });

      document.body.appendChild(dropdown);

      // Close on click outside
      function closeDropdown(event) {
        if (!dropdown.contains(event.target)) {
          dropdown.remove();
          document.removeEventListener("click", closeDropdown);
        }
      }
      setTimeout(function () {
        document.addEventListener("click", closeDropdown);
      }, 0);
    }

    function startLongPress(e) {
      longPressTriggered = false;
      longPressTimer = setTimeout(function () {
        showTypeFilterDropdown(e);
      }, longPressDuration);
    }

    function cancelLongPress() {
      if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
      }
    }

    // Prevent click from sorting when long press was triggered
    typeHeader.addEventListener(
      "click",
      function (e) {
        if (longPressTriggered) {
          e.stopImmediatePropagation();
          longPressTriggered = false;
        }
      },
      true,
    );

    // Mouse events
    typeHeader.addEventListener("mousedown", startLongPress);
    typeHeader.addEventListener("mouseup", cancelLongPress);
    typeHeader.addEventListener("mouseleave", cancelLongPress);

    // Touch events for mobile
    typeHeader.addEventListener("touchstart", startLongPress, {
      passive: true,
    });
    typeHeader.addEventListener("touchend", cancelLongPress);
    typeHeader.addEventListener("touchcancel", cancelLongPress);
    typeHeader.addEventListener("touchmove", cancelLongPress);

    // Prevent context menu on long press
    typeHeader.addEventListener("contextmenu", function (e) {
      e.preventDefault();
      showTypeFilterDropdown(e);
    });

    typeHeader.dataset.longpressInitialized = "true";
  }

  // Click on last column header to show Active filter dropdown
  const activeHeader = document.getElementById("active-filter-header");
  if (activeHeader && !activeHeader.dataset.initialized) {
    activeHeader.style.cursor = "pointer";

    activeHeader.addEventListener("click", function (e) {
      e.preventDefault();
      e.stopPropagation();

      // Remove any existing dropdown
      const existingDropdown = document.getElementById(
        "active-filter-dropdown",
      );
      if (existingDropdown) {
        existingDropdown.remove();
        return; // Toggle off if already open
      }

      // Create dropdown
      const dropdown = document.createElement("div");
      dropdown.id = "active-filter-dropdown";
      dropdown.className = "type-filter-dropdown";
      dropdown.innerHTML = `
<div class="type-filter-option" data-value="">Tots</div>
<div class="type-filter-option" data-value="true">En actiu</div>
<div class="type-filter-option" data-value="false">No actiu</div>
`;

      // Position dropdown below the header
      const rect = activeHeader.getBoundingClientRect();
      dropdown.style.top = rect.bottom + window.scrollY + "px";
      dropdown.style.left = rect.right - 160 + "px"; // Align to right edge

      // Mark current selection and add click handlers
      dropdown.querySelectorAll(".type-filter-option").forEach(function (opt) {
        if (opt.getAttribute("data-value") === membersActiveFilterValue) {
          opt.classList.add("selected");
        }
        opt.addEventListener("click", function () {
          membersActiveFilterValue = this.getAttribute("data-value");
          dropdown.remove();
          renderMembersTable();
        });
      });

      document.body.appendChild(dropdown);

      // Close on click outside
      function closeDropdown(event) {
        if (!dropdown.contains(event.target) && event.target !== activeHeader) {
          dropdown.remove();
          document.removeEventListener("click", closeDropdown);
        }
      }
      setTimeout(function () {
        document.addEventListener("click", closeDropdown);
      }, 0);
    });

    activeHeader.dataset.initialized = "true";
  }
}

function updateSortIcons() {
  const headers = document.querySelectorAll("#members-table th.sortable");
  headers.forEach(function (th) {
    const icon = th.querySelector(".sort-icon");
    if (th.getAttribute("data-sort") === membersSortColumn) {
      icon.textContent = membersSortDirection === "asc" ? " ‚ñ≤" : " ‚ñº";
    } else {
      icon.textContent = "";
    }
  });
}

function renderMembersTable() {
  const tbody = document.querySelector("#members-table tbody");
  if (!tbody) return;

  const searchValue = (
    document.getElementById("members-search")?.value || ""
  ).toLowerCase();
  const typeFilter = membersTypeFilterValue || "";
  const rolsFilter = membersRolsFilterValue || "";

  // Filter
  var filtered = membersData.filter(function (member) {
    const matchesSearch =
      !searchValue ||
      (member.alias || "").toLowerCase().includes(searchValue) ||
      (member.name || "").toLowerCase().includes(searchValue) ||
      (member.email || "").toLowerCase().includes(searchValue) ||
      (member.relatedMembers || [])
      .map((m) => m.alias || m.name || "")
      .join(" ").toLowerCase().includes(searchValue);
    const matchesType = !typeFilter || member.type === typeFilter;
    const matchesActive =
      !membersActiveFilterValue ||
      (membersActiveFilterValue === "true" && member.active !== false) ||
      (membersActiveFilterValue === "false" && member.active === false);

    // Rols filter
    let matchesRols = true;
    if (rolsFilter === "ADMIN") {
      matchesRols = (member.roles || []).includes("ADMIN");
    } else if (rolsFilter === "NO_ADMIN") {
      matchesRols = !(member.roles || []).includes("ADMIN");
    }

    // Access filter (Relations)
    let matchesAccess = true;
    const accessFilter = membersAccessFilterValue || "";
    if (accessFilter === "HAS_ACCESS") {
      matchesAccess = (member.relatedMembers || []).length > 0;
    } else if (accessFilter === "NO_ACCESS") {
      matchesAccess = (member.relatedMembers || []).length === 0;
    }

    return (
      matchesSearch &&
      matchesType &&
      matchesActive &&
      matchesRols &&
      matchesAccess
    );
  });

  // Sort
  filtered.sort(function (a, b) {
    var valA, valB;
    switch (membersSortColumn) {
      case "active":
        valA = a.active !== false ? 1 : 0;
        valB = b.active !== false ? 1 : 0;
        break;
      case "type":
        valA = a.type || "";
        valB = b.type || "";
        break;
      case "name":
        valA = (a.name || "").toLowerCase();
        valB = (b.name || "").toLowerCase();
        break;
      case "email":
        valA = (a.email || "").toLowerCase();
        valB = (b.email || "").toLowerCase();
        break;
      default:
        valA = "";
        valB = "";
    }
    if (valA < valB) return membersSortDirection === "asc" ? -1 : 1;
    if (valA > valB) return membersSortDirection === "asc" ? 1 : -1;
    return 0;
  });

  // Render
  tbody.innerHTML = "";
  if (filtered.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8">No s\'han trobat membres</td></tr>';
    return;
  }
  filtered.forEach(function (member) {
    const tr = document.createElement("tr");
    tr.classList.add("clickable-row");
    tr.setAttribute("data-member-id", member.id);
    const isEditing =
      currentEditingMemberId === member.id || isEditingAllMembers;

    if (isEditing) {
      tr.classList.add("editing-row");
      tr.innerHTML = renderEditableRow(member);
    } else {
      const typeLabel =
        member.type === "ADULT"
          ? "Adult"
          : member.type === "KID"
            ? "Xiquet/a"
            : "";
      const rolesHtml =
        (member.roles || [])
          .map(function (role) {
            return `<span class="role">${role}</span>`;
          })
          .join("") || "-";
      const nameStyle =
        member.active === false ? "text-decoration: line-through;" : "";
      const showPasswordBtn = member.type === "ADULT" && member.email;
      const activeIndicator = member.active !== false ? '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #4caf50;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>' : '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #999;"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';
      const passwordBtnHtml = showPasswordBtn
        ? `
        <button type="button" class="btn-change-password" title="Canviar contrasenya" data-member-id="${member.id}" data-member-name="${member.alias}" data-member-email="${member.email}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
            </svg>
        </button>`
        : "";
      tr.innerHTML = `
<td style="${nameStyle}">${member.alias || ""}</td>
<td>${member.email || ""}</td>
<td class="type-${(member.type || "").toLowerCase()}">${typeLabel}</td>
<td>${rolesHtml}</td>
<td>${(member.relatedMembers || []).map(rm => rm.alias || rm.name || "").join(", ") || "-"}</td>
<td class="active-column" style="display: none;"></td>
<td style="text-align: center;">${activeIndicator}</td>
<td style="text-align: center;">${passwordBtnHtml}</td>
`;
    }
    tbody.appendChild(tr);
  });
}

// Current member being edited inline
var currentEditingMemberId = null;
var originalMemberData = null;
var isAddingNewMember = false;

/**
 * Start adding a new member - creates a temporary row for input
 */
function startAddNewMember() {
  // Cancel any existing edit
  if (currentEditingMemberId) {
    cancelInlineEdit();
  }

  // Set flag for new member mode
  isAddingNewMember = true;

  // Create a temporary member object
  const newMember = {
    ID: "__new__",
    Name: "",
    Email: "",
    Type: "ADULT",
    Roles: [],
    Relations: [],
  };

  currentEditingMemberId = "__new__";
  originalMemberData = null;

  // Add temporary member to data array at the beginning
  membersData.unshift(newMember);

  // Show action bar with different text
  const actionsBar = document.getElementById("members-edit-actions");
  const editInfo = actionsBar.querySelector(".edit-info");
  if (actionsBar) {
    actionsBar.style.display = "flex";
    if (editInfo) editInfo.textContent = "Afegint nou membre...";
  }

  // Re-render table to show editable row
  renderMembersTable();

  // Focus on name input
  const nameInput = document.querySelector('input[name="inline-name"]');
  if (nameInput) nameInput.focus();

  // Initialize action bar listeners
  initInlineEditListeners();
}

/**
 * Render an editable row for inline editing
 * @param {Object} member - The member data
 * @returns {string} HTML for the editable row
 */
function renderEditableRow(member) {
  const typeOptions = `
        <option value="ADULT" ${member.type === "ADULT" ? "selected" : ""}>Adult</option>
        <option value="KID" ${member.type === "KID" ? "selected" : ""}>Xiquet/a</option>
    `;

  const isAdmin = (member.roles || []).includes("ADMIN");
  const isKid = member.type === "KID";

  // Email field (disabled for KID)
  const emailHtml = isKid
    ? '<span class="text-muted">-</span>'
    : `<input type="email" class="inline-edit-input" name="inline-email" value="${member.email || ""}">`;

  // Roles field (disabled for KID)
  const rolesHtml = isKid
    ? '<span class="text-muted">-</span>'
    : `<label class="checkbox-label inline-checkbox">
                <input type="checkbox" name="inline-admin" ${isAdmin ? "checked" : ""}> Admin
            </label>`;

  // Build relations checkboxes (only for ADULT members)
  let relationsHtml = "";
  if (isKid) {
    relationsHtml = '<span class="text-muted">-</span>';
  } else {
    relationsHtml =
      '<div class="inline-relations-dropdown" id="inline-relations-container">';
    relationsHtml +=
      '<button type="button" class="btn-dropdown" onclick="toggleRelationsDropdown(this)">Seleccionar ‚ñº</button>';
    relationsHtml +=
      '<div class="relations-dropdown-content" style="display:none;">';
    membersData.forEach(function (m) {
      if (m.id !== member.id) {
        const checked = (member.relations || []).includes(m.id)
          ? "checked"
          : "";
        relationsHtml += `<label class="checkbox-label"><input type="checkbox" name="inline-relations" value="${m.id}" data-name="${m.name}" ${checked}> ${m.name}</label>`;
      }
    });
    relationsHtml += "</div></div>";
  }

  const isActive = member.active !== false;
  return `
        <td><input type="text" class="inline-edit-input" name="inline-name" value="${member.alias || ""}" required></td>
        <td class="email-cell">${emailHtml}</td>
        <td>
        <select class="inline-edit-select" name="inline-type" onchange="handleInlineTypeChange(this)">${typeOptions}</select>
        </td>
        <td class="roles-cell">${rolesHtml}</td>
        <td class="relations-cell">${relationsHtml}</td>
        <td class="active-column">
        <label class="checkbox-label inline-checkbox">
            <input type="checkbox" name="inline-active" ${isActive ? "checked" : ""}> Actiu
        </label>
        </td>
        <td></td>
        <td></td>
    `;
}

/**
 * Toggle relations dropdown visibility
 */
function toggleRelationsDropdown(btn) {
  const dropdown = btn.nextElementSibling;
  dropdown.style.display = dropdown.style.display === "none" ? "block" : "none";
}

/**
 * Handle type change during inline edit - KID cannot have email, roles, or relations
 */
function handleInlineTypeChange(selectEl) {
  const row = selectEl.closest("tr");
  const emailCell = row.querySelector(".email-cell");
  const rolesCell = row.querySelector(".roles-cell");
  const relationsCell = row.querySelector(".relations-cell");
  const memberId = row.getAttribute("data-member-id");
  const member = membersData.find(function (m) {
    return m.id === memberId;
  });

  if (selectEl.value === "KID") {
    // Clear and disable email, roles, and relations for KID
    if (emailCell) emailCell.innerHTML = '<span class="text-muted">-</span>';
    if (rolesCell) rolesCell.innerHTML = '<span class="text-muted">-</span>';
    if (relationsCell)
      relationsCell.innerHTML = '<span class="text-muted">-</span>';
  } else {
    // Restore email field for ADULT
    if (emailCell) {
      const email = member ? member.email || "" : "";
      emailCell.innerHTML = `<input type="email" class="inline-edit-input" name="inline-email" value="${email}">`;
    }

    // Restore roles for ADULT
    if (rolesCell) {
      const isAdmin = member && (member.roles || []).includes("ADMIN");
      rolesCell.innerHTML = `<label class="checkbox-label inline-checkbox">
                <input type="checkbox" name="inline-admin" ${isAdmin ? "checked" : ""}> Admin
            </label>`;
    }

    // Restore relations dropdown for ADULT
    if (relationsCell) {
      let relationsHtml =
        '<div class="inline-relations-dropdown" id="inline-relations-container">';
      relationsHtml +=
        '<button type="button" class="btn-dropdown" onclick="toggleRelationsDropdown(this)">Seleccionar ‚ñº</button>';
      relationsHtml +=
        '<div class="relations-dropdown-content" style="display:none;">';
      membersData.forEach(function (m) {
        if (m.id !== memberId) {
          const checked =
            member && (member.relations || []).includes(m.id)
              ? "checked"
              : "";
          relationsHtml += `<label class="checkbox-label"><input type="checkbox" name="inline-relations" value="${m.id}" data-name="${m.name}" ${checked}> ${m.name}</label>`;
        }
      });
      relationsHtml += "</div></div>";
      relationsCell.innerHTML = relationsHtml;
    }
  }
}

/**
 * Start inline editing for a member
 * @param {string} memberId - ID of the member to edit
 */
function startInlineEdit(memberId) {
  // If already editing another member, cancel that edit first
  if (currentEditingMemberId && currentEditingMemberId !== memberId) {
    cancelInlineEdit();
  }

  const member = membersData.find(function (m) {
    return m.id === memberId;
  });
  if (!member) {
    showToast("Membre no trobat", "error");
    return;
  }

  // Store original data for discard
  currentEditingMemberId = memberId;
  originalMemberData = JSON.parse(JSON.stringify(member));

  // Show action bar
  const actionsBar = document.getElementById("members-edit-actions");
  if (actionsBar) {
    actionsBar.style.display = "flex";
  }

  // Show Active column
  document.querySelectorAll(".active-column").forEach(function (el) {
    el.style.display = "";
  });

  // Re-render table to show editable row
  renderMembersTable();

  // Initialize action bar listeners
  initInlineEditListeners();
}

// Track all original data when editing all members
var allOriginalMemberData = null;
var isEditingAllMembers = false;

/**
 * Start editing all members at once
 */
function startEditAllMembers() {
  // Cancel any existing single edit
  if (currentEditingMemberId) {
    cancelInlineEdit();
  }

  // Store original data for all members
  allOriginalMemberData = JSON.parse(JSON.stringify(membersData));
  isEditingAllMembers = true;
  currentEditingMemberId = "__all__";

  // Show action bar
  const actionsBar = document.getElementById("members-edit-actions");
  const editInfo = actionsBar ? actionsBar.querySelector(".edit-info") : null;
  if (actionsBar) {
    actionsBar.style.display = "flex";
    if (editInfo) editInfo.textContent = "Editant tots els membres...";
  }

  // Hide edit button
  const editAllBtn = document.getElementById("edit-all-members-btn");
  if (editAllBtn) editAllBtn.style.display = "none";

  // Show Active column
  document.querySelectorAll(".active-column").forEach(function (el) {
    el.style.display = "";
  });

  // Re-render table with all rows editable
  renderMembersTable();

  // Initialize action bar listeners
  initInlineEditListeners();
}

/**
 * Initialize inline edit action bar listeners
 */
function initInlineEditListeners() {
  const discardBtn = document.getElementById("members-edit-discard");
  const applyBtn = document.getElementById("members-edit-apply");

  if (discardBtn && !discardBtn.dataset.initialized) {
    discardBtn.addEventListener("click", cancelInlineEdit);
    discardBtn.dataset.initialized = "true";
  }

  if (applyBtn && !applyBtn.dataset.initialized) {
    applyBtn.addEventListener("click", applyInlineEdit);
    applyBtn.dataset.initialized = "true";
  }
}

// Password change dialog handling
var passwordChangeMemberEmail = null;

function initPasswordChangeHandlers() {
  const dialog = document.getElementById("password-change-dialog");
  const cancelBtn = document.getElementById("password-cancel-btn");
  const saveBtn = document.getElementById("password-save-btn");

  if (cancelBtn && !cancelBtn.dataset.initialized) {
    cancelBtn.addEventListener("click", closePasswordDialog);
    cancelBtn.dataset.initialized = "true";
  }

  if (saveBtn && !saveBtn.dataset.initialized) {
    saveBtn.addEventListener("click", saveNewPassword);
    saveBtn.dataset.initialized = "true";
  }

  // Close on backdrop click
  if (dialog && !dialog.dataset.initialized) {
    dialog.addEventListener("click", function (e) {
      if (e.target === dialog) {
        closePasswordDialog();
      }
    });
    dialog.dataset.initialized = "true";
  }
}

function openPasswordDialog(email, name) {
  closeAllDialogs();
  const dialog = document.getElementById("password-change-dialog");
  const memberNameEl = document.getElementById("password-change-member-name");
  const newPasswordInput = document.getElementById("new-password");
  const confirmPasswordInput = document.getElementById("confirm-password");

  if (!dialog) return;

  passwordChangeMemberEmail = email;
  if (memberNameEl) memberNameEl.textContent = name + " (" + email + ")";
  if (newPasswordInput) newPasswordInput.value = "";
  if (confirmPasswordInput) confirmPasswordInput.value = "";

  initPasswordChangeHandlers();
  dialog.showModal();
  if (newPasswordInput) newPasswordInput.focus();
}

function closePasswordDialog() {
  const dialog = document.getElementById("password-change-dialog");
  if (dialog) dialog.close();
  passwordChangeMemberEmail = null;
}

function saveNewPassword() {
  const newPassword = document.getElementById("new-password")?.value || "";
  const confirmPassword =
    document.getElementById("confirm-password")?.value || "";
  const saveBtn = document.getElementById("password-save-btn");

  // Validation
  if (!newPassword) {
    showToast("Cal introduir una contrasenya", "error");
    return;
  }

  if (newPassword.length < 8) {
    showToast("La contrasenya ha de tenir almenys 8 car√†cters", "error");
    return;
  }

  if (newPassword !== confirmPassword) {
    showToast("Les contrasenyes no coincideixen", "error");
    return;
  }

  if (!passwordChangeMemberEmail) {
    showToast("Error: no s'ha seleccionat cap membre", "error");
    return;
  }

  // Disable button during save
  if (saveBtn) {
    saveBtn.disabled = true;
    saveBtn.textContent = "Desant...";
  }

  API.changeUserPassword({ email: passwordChangeMemberEmail, newPassword })
    .then(function (result) {
      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.textContent = "Desar";
      }
      closePasswordDialog();
      showToast(
        result.message || "Contrasenya canviada correctament",
        "success",
      );
    })
    .catch(function (error) {
      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.textContent = "Desar";
      }
      showToast(error || "Error en canviar la contrasenya", "error");
      console.error("Password change error:", error);
    });
}

// Event delegation for password change buttons in members table
document.addEventListener("click", function (e) {
  const btn = e.target.closest(".btn-change-password");
  if (btn) {
    e.preventDefault();
    e.stopPropagation();
    const email = btn.getAttribute("data-member-email");
    const name = btn.getAttribute("data-member-name");
    if (email) {
      openPasswordDialog(email, name);
    }
  }
});

/**
 * Cancel inline edit and restore original data
 */
function cancelInlineEdit() {
  // If adding a new member, remove the temporary entry
  if (isAddingNewMember) {
    membersData = membersData.filter(function (m) {
      return m.id !== "__new__";
    });
    isAddingNewMember = false;
  }

  // If editing all members, restore all original data
  if (isEditingAllMembers && allOriginalMemberData) {
    membersData = allOriginalMemberData;
    allOriginalMemberData = null;
    isEditingAllMembers = false;
  }

  currentEditingMemberId = null;
  originalMemberData = null;

  // Hide action bar and restore text
  const actionsBar = document.getElementById("members-edit-actions");
  const editInfo = actionsBar?.querySelector(".edit-info");
  if (actionsBar) {
    actionsBar.style.display = "none";
    if (editInfo) editInfo.textContent = "Editant membres...";
  }

  // Show edit button again
  const editAllBtn = document.getElementById("edit-all-members-btn");
  if (editAllBtn) editAllBtn.style.display = "";

  // Hide Active column
  document.querySelectorAll(".active-column").forEach(function (el) {
    el.style.display = "none";
  });

  // Re-render table
  renderMembersTable();
}

/**
 * Apply inline edit changes
 */
function applyInlineEdit() {
  if (!currentEditingMemberId) return;

  // Handle editing all members
  if (isEditingAllMembers) {
    applyAllMembersEdit();
    return;
  }

  const applyBtn = document.getElementById("members-edit-apply");
  const btnText = applyBtn.querySelector(".btn-text");
  const btnLoading = applyBtn.querySelector(".btn-loading");

  // Show loading state
  btnText.style.display = "none";
  btnLoading.style.display = "inline";
  applyBtn.disabled = true;

  // Gather data from inline inputs
  const row = document.querySelector(
    `tr[data-member-id="${currentEditingMemberId}"]`,
  );
  if (!row) {
    showToast("Error: fila no trobada", "error");
    return;
  }

  const activeCheckbox = row.querySelector('input[name="inline-active"]');
  const memberData = {
    ID: currentEditingMemberId === "__new__" ? null : currentEditingMemberId,
    Name: row.querySelector('input[name="inline-name"]').value.trim(),
    Email: "",
    Type: row.querySelector('select[name="inline-type"]').value,
    Roles: [],
    Relations: [],
    Active: activeCheckbox ? activeCheckbox.checked : true,
    isNew: isAddingNewMember,
  };

  // Only get email, roles, and relations for ADULT members
  if (memberData.type !== "KID") {
    // Get email
    const emailInput = row.querySelector('input[name="inline-email"]');
    if (emailInput) {
      memberData.email = emailInput.value.trim();
    }

    // Get admin role
    const adminCheckbox = row.querySelector('input[name="inline-admin"]');
    if (adminCheckbox && adminCheckbox.checked) {
      memberData.roles.push("ADMIN");
    }

    // Get selected relations (as IDs)
    const relationCheckboxes = row.querySelectorAll(
      'input[name="inline-relations"]:checked',
    );
    relationCheckboxes.forEach(function (checkbox) {
      memberData.relations.push(checkbox.value);
    });
  }

  // Call server to save
  API.saveMember({ member: memberData })
    .then(function (result) {
      btnText.style.display = "inline";
      btnLoading.style.display = "none";
      applyBtn.disabled = false;

      if (result && result.success) {
        const successMsg = isAddingNewMember
          ? "Membre creat correctament"
          : "Membre desat correctament";
        showToast(successMsg, "success");
        currentEditingMemberId = null;
        originalMemberData = null;
        isAddingNewMember = false;

        // Hide action bar and restore text
        const actionsBar = document.getElementById("members-edit-actions");
        const editInfo = actionsBar?.querySelector(".edit-info");
        if (actionsBar) {
          actionsBar.style.display = "none";
          if (editInfo) editInfo.textContent = "Editant membre...";
        }

        // Hide Active column
        document.querySelectorAll(".active-column").forEach(function (el) {
          el.style.display = "none";
        });

        // Reload members data
        loadMembersData();
      } else {
        showToast(result?.error || "Error desant el membre", "error");
      }
    })
    .catch(function (error) {
      btnText.style.display = "inline";
      btnLoading.style.display = "none";
      applyBtn.disabled = false;
      showToast("Error desant el membre: " + error, "error");
      console.error("Save member error:", error);
    });
}

/**
 * Apply edits for all members at once
 */
function applyAllMembersEdit() {
  const applyBtn = document.getElementById("members-edit-apply");
  const btnText = applyBtn.querySelector(".btn-text");
  const btnLoading = applyBtn.querySelector(".btn-loading");

  // Show loading state
  btnText.style.display = "none";
  btnLoading.style.display = "inline";
  applyBtn.disabled = true;

  // Gather data from all editable rows
  const rows = document.querySelectorAll("#members-table tbody tr.editing-row");
  const allMemberData = [];

  rows.forEach(function (row) {
    const memberId = row.getAttribute("data-member-id");
    if (!memberId || memberId === "__new__") return;

    const activeCheckbox = row.querySelector('input[name="inline-active"]');
    const typeSelect = row.querySelector('select[name="inline-type"]');
    const memberData = {
      ID: memberId,
      Name: row.querySelector('input[name="inline-name"]').value.trim(),
      Email: "",
      Type: typeSelect ? typeSelect.value : "ADULT",
      Roles: [],
      Relations: [],
      Active: activeCheckbox ? activeCheckbox.checked : true,
    };

    // Only get email, roles, and relations for ADULT members
    if (memberData.type !== "KID") {
      const emailInput = row.querySelector('input[name="inline-email"]');
      if (emailInput) {
        memberData.email = emailInput.value.trim();
      }

      const adminCheckbox = row.querySelector('input[name="inline-admin"]');
      if (adminCheckbox && adminCheckbox.checked) {
        memberData.roles.push("ADMIN");
      }

      const relationCheckboxes = row.querySelectorAll(
        'input[name="inline-relations"]:checked',
      );
      relationCheckboxes.forEach(function (checkbox) {
        memberData.relations.push(checkbox.value);
      });
    }

    allMemberData.push(memberData);
  });

  // Call server to save all members
  API.saveAllMembers({ members: allMemberData })
    .then(function (result) {
      btnText.style.display = "inline";
      btnLoading.style.display = "none";
      applyBtn.disabled = false;

      if (result && result.success) {
        showToast("Tots els membres desats correctament", "success");
        currentEditingMemberId = null;
        allOriginalMemberData = null;
        isEditingAllMembers = false;

        // Hide action bar
        const actionsBar = document.getElementById("members-edit-actions");
        if (actionsBar) {
          actionsBar.style.display = "none";
        }

        // Show edit button again
        const editAllBtn = document.getElementById("edit-all-members-btn");
        if (editAllBtn) editAllBtn.style.display = "";

        // Hide Active column
        document.querySelectorAll(".active-column").forEach(function (el) {
          el.style.display = "none";
        });

        // Reload members data
        loadMembersData();
      } else {
        showToast(result?.error || "Error desant els membres", "error");
      }
    })
    .catch(function (error) {
      btnText.style.display = "inline";
      btnLoading.style.display = "none";
      applyBtn.disabled = false;
      showToast("Error desant els membres: " + error, "error");
      console.error("Save all members error:", error);
    });
}

/**
 * Load home data
 */
function loadHomeData() {
  const userNameEl = document.getElementById("home-user-name");
  if (userNameEl) {
    if (AppState.currentUser && AppState.currentUser.displayName) {
      // Build greeting with user name and relations
      const names = [AppState.currentUser.displayName];
      const relations = AppState.currentUser.relatedMembers || [];
      if (relations.length > 0) {
        names.push(...relations.map((rel) => rel.name || rel.name).filter(Boolean));
      }
      userNameEl.textContent = formatNamesList(names);
    } else {
      userNameEl.textContent = "";
    }
  }

  // Load next event text
  const nextEventTextEl = document.getElementById("next-event-text");
  if (nextEventTextEl && AppState.isAuthenticated) {
    API.getNextEvent()
      .then(function (result) {
        if (result && result.eventData) {
          nextEventTextEl.textContent = formatEventDate(result.eventData);
        } else {
          nextEventTextEl.textContent = "Sense proper esdeveniment programat";
        }
      })
      .catch(function (error) {
        console.error("Error loading next event:", error);
        nextEventTextEl.textContent = "Error carregant dades";
      });
  }

  // Load next training text
  const nextTrainingTextEl = document.getElementById("next-training-text");
  if (nextTrainingTextEl && AppState.isAuthenticated) {
    API.getNextTraining()
      .then(function (result) {
        if (result && result.trainingData) {
          nextTrainingTextEl.textContent = formatEventDate(result.trainingData);
        } else {
          nextTrainingTextEl.textContent = "Sense proper assaig programat";
        }
      })
      .catch(function (error) {
        console.error("Error loading next training:", error);
        nextTrainingTextEl.textContent = "Error carregant dades";
      });
  }
}

/**
 * Format a list of names for display in greeting
 * @param {string[]} names - Array of names
 * @returns {string} Formatted names (e.g., "Joan, Maria i Pere")
 */
function formatNamesList(names) {
  if (!names || names.length === 0) return "";
  if (names.length === 1) return names[0];
  if (names.length === 2) return names[0] + " i " + names[1];
  // For 3+ names: "Name1, Name2, ... i LastName"
  const lastIndex = names.length - 1;
  return names.slice(0, lastIndex).join(", ") + " i " + names[lastIndex];
}

/**
 * Load profile data
 */
function loadProfileData() {
  if (!AppState.currentUser) return;

  const avatarEl = document.getElementById("profile-avatar");
  const nameEl = document.getElementById("profile-name");
  const emailEl = document.getElementById("profile-email");
  const memberTypeEl = document.getElementById("profile-member-type");

  if (avatarEl) avatarEl.src = AppState.currentUser.avatar;
  if (nameEl) nameEl.textContent = AppState.currentUser.displayName;
  if (emailEl) emailEl.textContent = AppState.currentUser.email;
  if (memberTypeEl)
    memberTypeEl.textContent = AppState.currentUser.memberType || "";

  // Roles
  const rolesContainer = document.getElementById("profile-roles");
  const roles = AppState.currentUser.roles || [];
  if (rolesContainer) {
    if (roles.length > 0) {
      rolesContainer.innerHTML = roles
        .map(function (role) {
          return '<span class="badge badge-role">' + role + "</span>";
        })
        .join("");
    } else {
      rolesContainer.innerHTML =
        '<span class="text-muted">Cap rol assignat</span>';
    }
  }

  // Relations
  const relationsContainer = document.getElementById("profile-relations");
  const relations = AppState.currentUser.relations || [];
  if (relationsContainer) {
    if (relations.length > 0) {
      relationsContainer.innerHTML = relations
        .map(function (rel) {
          return '<span class="badge badge-relation">' + rel + "</span>";
        })
        .join("");
    } else {
      relationsContainer.innerHTML =
        '<span class="text-muted">Cap relaci√≥</span>';
    }
  }

  // Related Members Cards
  const relatedMembersSection = document.getElementById(
    "related-members-section",
  );
  const relatedMembersList = document.getElementById("related-members-list");
  const relatedMembers = AppState.currentUser.relatedMembers || [];

  if (relatedMembersSection && relatedMembersList) {
    if (relatedMembers.length > 0) {
      relatedMembersSection.style.display = "block";
      relatedMembersList.innerHTML = relatedMembers
        .map(function (member) {
          const avatarUrl =
            member.avatar ||
            "https://ui-avatars.com/api/?name=" +
              encodeURIComponent(member.alias || member.alias || "?") +
              "&background=random";
          const memberName = member.alias || member.alias || "Desconegut";
          const memberType = member.type || member.type || "";
          const memberTypeLabel =
            memberType === "ADULT"
              ? "Adult"
              : memberType === "KID"
                ? "Xiquet/a"
                : memberType;
          return (
            '<div class="profile-header">' +
            '<img class="profile-avatar" src="' +
            avatarUrl +
            '" alt="' +
            memberName +
            '">' +
            '<div class="profile-info">' +
            "<h2>" +
            memberName +
            "</h2>" +
            '<p class="member-type-badge">' +
            memberTypeLabel +
            "</p>" +
            "</div>" +
            "</div>"
          );
        })
        .join("");
    } else {
      relatedMembersSection.style.display = "none";
    }
  }
}

/**
 * Handle registration form submission
 * @param {Event} e - Form submit event
 */
function handleRegisterSubmit(e) {
  e.preventDefault();

  const name = document.getElementById("register-name").value.trim();
  const email = document.getElementById("register-email").value.trim();
  const submitBtn = document.getElementById("register-btn");

  if (!name || !email) {
    showToast("Introdueix el nom i el correu electr√≤nic", "warning");
    return;
  }

  const originalText = submitBtn.textContent;
  submitBtn.textContent = "Enviant...";
  submitBtn.disabled = true;

  API.sendRegistrationRequest({ name, email })
    .then(function (result) {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;

      showToast(
        "Sol¬∑licitud enviada correctament. Ens posarem en contacte amb tu!",
        "success",
      );
      document.getElementById("register-form").reset();
      navigateTo("login");
    })
    .catch(function (error) {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
      showToast(error || "Error en enviar la sol¬∑licitud", "error");
      console.error("Registration error:", error);
    });
}

/**
 * Handle email/password login action
 * @param {Event} e - Form submit event
 */
function handleEmailPasswordLogin(e) {
  e.preventDefault();

  const email = document.getElementById("login-email").value.trim();
  const password = document.getElementById("login-password").value;
  const submitBtn = document.getElementById("email-login-btn");

  if (!email || !password) {
    showToast("Introdueix el correu electr√≤nic i la contrasenya", "warning");
    return;
  }

  const originalHtml = submitBtn ? submitBtn.innerHTML : "";
  if (submitBtn) {
    submitBtn.innerHTML =
      '<span class="spinner-small spinner-dark"></span> Iniciant sessi√≥...';
    submitBtn.disabled = true;
    submitBtn.setAttribute("aria-busy", "true");
  }

  API.loginWithEmailPassword({ email, password })
    .then(function (result) {
      
      API.saveToken({ token: result.token });
      if (submitBtn) {
        submitBtn.innerHTML = originalHtml;
        submitBtn.disabled = false;
        submitBtn.removeAttribute("aria-busy");
      }

      AppState.isAuthenticated = true;
      AppState.currentUser = result.user;

      updateAuthUI();
      showToast(
        "Benvingut/da de nou, " + result.user.displayName + "!",
        "success",
      );
      
      // Close login dialog before navigating
      const loginDialog = document.getElementById("view-login");
      if (loginDialog) {
        loginDialog.close();
      }
      
      navigateTo("home");
    })
    .catch(function (error) {
      if (submitBtn) {
        submitBtn.innerHTML = originalHtml;
        submitBtn.disabled = false;
        submitBtn.removeAttribute("aria-busy");
      }
      showToast(error || "Error d'inici de sessi√≥", "error");
      console.error("Login error:", error);
    });
}

/**
 * Handle access link request
 */
function handleAccessLink(e) {
  if (e && e.preventDefault) e.preventDefault();
  
  openAccessLinkDialog();
}

/**
 * Open the access link dialog
 */
function openAccessLinkDialog() {
  closeAllDialogs();
  const dialog = document.getElementById("access-link-dialog");
  const emailInput = document.getElementById("access-link-email");
  
  if (!dialog) return;
  
  if (emailInput) emailInput.value = "";
  
  initAccessLinkDialogHandlers();
  dialog.showModal();
  if (emailInput) emailInput.focus();
}

/**
 * Close the access link dialog
 */
function closeAccessLinkDialog() {
  const dialog = document.getElementById("access-link-dialog");
  if (dialog) dialog.close();
}

/**
 * Initialize access link dialog button handlers
 */
function initAccessLinkDialogHandlers() {
  const dialog = document.getElementById("access-link-dialog");
  const cancelBtn = document.getElementById("access-link-cancel-btn");
  const sendBtn = document.getElementById("access-link-send-btn");

  if (cancelBtn && !cancelBtn.dataset.initialized) {
    cancelBtn.addEventListener("click", closeAccessLinkDialog);
    cancelBtn.dataset.initialized = "true";
  }

  if (sendBtn && !sendBtn.dataset.initialized) {
    sendBtn.addEventListener("click", sendAccessLink);
    sendBtn.dataset.initialized = "true";
  }

  // Close on backdrop click
  if (dialog && !dialog.dataset.initialized) {
    dialog.addEventListener("click", function (e) {
      if (e.target === dialog) {
        closeAccessLinkDialog();
      }
    });
    dialog.dataset.initialized = "true";
  }
}

/**
 * Send access link with email from dialog
 */
function sendAccessLink() {
  const emailInput = document.getElementById("access-link-email");
  const sendBtn = document.getElementById("access-link-send-btn");
  const email = emailInput ? emailInput.value.trim() : "";

  // Validation
  if (!email) {
    showToast("Cal introduir un correu electr√≤nic", "error");
    return;
  }

  if (!email.includes("@")) {
    showToast("El correu electr√≤nic no √©s v√†lid", "error");
    return;
  }

  // Disable button during save
  if (sendBtn) {
    sendBtn.disabled = true;
    sendBtn.textContent = "Enviant...";
  }

  API.sendAccessLink({ email })
    .then(function (result) {
      if (sendBtn) {
        sendBtn.disabled = false;
        sendBtn.textContent = "Enviar acc√©s";
      }

      showToast(
        result.message || "Enlla√ß d'acc√©s enviat al teu correu electr√≤nic",
        "success",
      );
      closeAccessLinkDialog();
    })
    .catch(function (error) {
      if (sendBtn) {
        sendBtn.disabled = false;
        sendBtn.textContent = "Enviar acc√©s";
      }
      showToast(error || "Error en enviar l'acc√©s", "error");
      console.error("Access link error:", error);
    });
}

/**
 * Handle login action
 */
function handleLogin() {
  // Navigate to login page
  navigateTo("login");
}

/**
 * Handle logout action
 */
function handleLogout() {
  // Show general loading screen
  showLoading(true);

  // Get the logout buttons (desktop and mobile) and provide immediate feedback
  const logoutBtn = document.getElementById("logout-btn");
  const mobileLogoutBtn = document.getElementById("mobile-logout-btn");
  const originalText = logoutBtn ? logoutBtn.textContent : "";
  const originalMobileText = mobileLogoutBtn ? mobileLogoutBtn.textContent : "";

  if (logoutBtn) {
    logoutBtn.innerHTML =
      '<span class="spinner-small spinner-dark"></span> Tancant sessi√≥...';
    logoutBtn.disabled = true;
    logoutBtn.setAttribute("aria-busy", "true");
  }
  if (mobileLogoutBtn) {
    mobileLogoutBtn.innerHTML =
      '<span class="spinner-small spinner-dark"></span> Tancant sessi√≥...';
    mobileLogoutBtn.disabled = true;
    mobileLogoutBtn.setAttribute("aria-busy", "true");
  }

  // Clear server-side session
  API.logoutUser()
    .then(function (result) {
      // Restore button states
      if (logoutBtn) {
        logoutBtn.innerHTML = originalText;
        logoutBtn.disabled = false;
        logoutBtn.removeAttribute("aria-busy");
      }
      if (mobileLogoutBtn) {
        mobileLogoutBtn.innerHTML = originalMobileText;
        mobileLogoutBtn.disabled = false;
        mobileLogoutBtn.removeAttribute("aria-busy");
      }

      // Clear all local state and temporary user data
      clearUserData();

      updateAuthUI();
      navigateTo("home-guest");
      showToast("Has tancat la sessi√≥", "success");
      showLoading(false);
    })
    .catch(function (error) {
      // Restore button states
      if (logoutBtn) {
        logoutBtn.innerHTML = originalText;
        logoutBtn.disabled = false;
        logoutBtn.removeAttribute("aria-busy");
      }
      if (mobileLogoutBtn) {
        mobileLogoutBtn.innerHTML = originalMobileText;
        mobileLogoutBtn.disabled = false;
        mobileLogoutBtn.removeAttribute("aria-busy");
      }

      // Still clear local state even if server call fails
      clearUserData();

      updateAuthUI();
      navigateTo("home-guest");
      showToast("Has tancat la sessi√≥", "success");
      showLoading(false);
    });
}

/**
 * Clear all user data and temporary state on logout
 */
function clearUserData() {
  // Clear app state
  AppState.isAuthenticated = false;
  AppState.currentUser = null;
  AppState.currentView = "home-guest";
  API.clearSession();

  // Clear localStorage
  localStorage.removeItem("currentRoute");

  // Clear members data
  membersData = [];
  currentEditingMemberId = null;
  originalMemberData = null;
  isAddingNewMember = false;
  allOriginalMemberData = null;
  isEditingAllMembers = false;

  // Clear members filters
  membersTypeFilterValue = "";
  membersActiveFilterValue = "";
  membersRolsFilterValue = "";
  membersAccessFilterValue = "";

  // Clear events/diagrams data if defined
  if (typeof diagrams !== "undefined") {
    diagrams.length = 0;
  }
  if (typeof diagramIdCounter !== "undefined") {
    diagramIdCounter = 0;
  }
  if (typeof diagramsIsDirty !== "undefined") {
    diagramsIsDirty = false;
  }
  if (typeof dancesData !== "undefined") {
    dancesData = [];
  }

  // Reset loading event flag
  isLoadingExistingEvent = false;
}

/**
 * Update authentication UI elements
 */
function updateAuthUI() {
  const userInfo = document.getElementById("user-info");
  const authRequiredLinks = document.querySelectorAll(".auth-required");
  const adminOnlyElements = document.querySelectorAll(".admin-only");
  const nonAdminOnlyElements = document.querySelectorAll(".non-admin-only");
  const navbarToggle = document.getElementById("navbar-toggle");

  if (AppState.isAuthenticated && AppState.currentUser) {
    if (navbarToggle) navbarToggle.style.display = "block";
    // Show user info
    if (userInfo) {
      userInfo.style.display = "flex";
      document.getElementById("user-avatar").src = AppState.currentUser.avatar;
      document.getElementById("user-name").textContent =
        AppState.currentUser.displayName;
    }

    // Update mobile user section
    const mobileUserSection = document.getElementById("mobile-user-section");
    const mobileUserAvatar = document.getElementById("mobile-user-avatar");
    const mobileUserName = document.getElementById("mobile-user-name");
    if (mobileUserAvatar) {
      mobileUserAvatar.src = AppState.currentUser.avatar;
    }
    if (mobileUserName) {
      mobileUserName.textContent = AppState.currentUser.displayName;
    }

    // Show auth-required nav links (excluding admin-only which are handled separately)
    authRequiredLinks.forEach(function (link) {
      if (!link.classList.contains("admin-only")) {
        link.style.display = "";
      }
    });

    // Check if user is admin
    const userRoles = AppState.currentUser.roles || [];
    const isAdmin = userRoles.includes("ADMIN");

    // Show/hide admin-only elements based on admin status
    adminOnlyElements.forEach(function (el) {
      el.style.display = isAdmin ? "" : "none";
    });

    // Show/hide non-admin-only elements (opposite of admin-only)
    nonAdminOnlyElements.forEach(function (el) {
      el.style.display = isAdmin ? "none" : "";
    });

    // Update display names
    document.querySelectorAll(".user-display-name").forEach(function (el) {
      el.textContent = AppState.currentUser.displayName;
    });

    // Update home user name
    const homeUserName = document.getElementById("home-user-name");
    if (homeUserName) {
      homeUserName.textContent = AppState.currentUser.displayName;
    }
  } else {
    if (navbarToggle) navbarToggle.style.display = "none";
    // Hide user info
    if (userInfo) userInfo.style.display = "none";

    // Hide auth-required nav links
    authRequiredLinks.forEach(function (link) {
      link.style.display = "none";
    });

    // Hide admin-only elements
    adminOnlyElements.forEach(function (el) {
      el.style.display = "none";
    });

    // Hide non-admin-only elements (only shown for authenticated non-admin users)
    nonAdminOnlyElements.forEach(function (el) {
      el.style.display = "none";
    });
  }
}

/**
 * Show or hide loading screen
 * @param {boolean} show - Whether to show loading
 */
function showLoading(show) {
  const loadingScreen = document.getElementById("loading-screen");
  const app = document.getElementById("app");

  if (show) {
    loadingScreen.style.display = "flex";
    app.style.display = "none";
  } else {
    loadingScreen.style.display = "none";
    app.style.display = "flex";
  }

  AppState.isLoading = show;
}

/**
 * Show a toast notification
 * @param {string} message - Message to show
 * @param {string} type - Type: success, error, warning, info
 */
function showToast(message, type = "info") {
  // Find if there's an open dialog
  const openDialog = document.querySelector("dialog[open]");
  const targetParent = openDialog || document.body;

  // Always use document.body for toast container
  let container = document.getElementById("toast-container");
  
  // Create container if it doesn't exist
  if (!container) {
    container = document.createElement("div");
    container.id = "toast-container";
    document.body.appendChild(container);
  }

  const toast = document.createElement("div");
  toast.className = `toast toast-${type}`;
  
  const icons = {
    success: "‚úì",
    error: "‚úï",
    warning: "‚ö†",
    info: "‚Ñπ",
  };
  
  toast.innerHTML = `
  <span class="toast-icon">${icons[type] || icons.info}</span>
  <span class="toast-message">${message}</span>
  `;
  
  targetParent.appendChild(container);
  container.appendChild(toast);

  // Prevent scroll on dialog when toast appears
  if (openDialog) {
    openDialog.style.overflowY = "hidden";
  }

  // Trigger animation
  setTimeout(function () {
    toast.classList.add("show");
  }, 10);

  // Remove after 3 seconds
  setTimeout(function () {
    toast.classList.add("toast-remove");
    setTimeout(function () {
      toast.remove();
      // Re-enable scroll on dialog when toast is removed
      if (openDialog) {
        openDialog.style.overflowY = "";
      }
    }, 300);
  }, 3000);
}

/**
 * Format relative time
 * @param {string} timestamp - ISO timestamp
 * @returns {string} Relative time string
 */
function formatRelativeTime(timestamp) {
  const now = new Date();
  const date = new Date(timestamp);
  const diff = now - date;

  const seconds = Math.floor(diff / 1000);
  const minutes = Math.floor(seconds / 60);
  const hours = Math.floor(minutes / 60);
  const days = Math.floor(hours / 24);

  if (days > 0) return days + " dia" + (days > 1 ? "s" : "") + " enrere";
  if (hours > 0) return hours + " hora" + (hours > 1 ? "s" : "") + " enrere";
  if (minutes > 0)
    return minutes + " minut" + (minutes > 1 ? "s" : "") + " enrere";
  return "Ara mateix";
}

/**
 * Escape HTML special characters to prevent XSS
 * @param {string} text - Text to escape
 * @returns {string} Escaped text
 */
function escapeHtml(text) {
  if (!text) return "";
  const div = document.createElement("div");
  div.textContent = text;
  return div.innerHTML.replace(/"/g, "").replace(/'/g, "");
}

/**
 * Handle errors globally
 */
window.onerror = function (message, source, lineno, colno, error) {
  console.error("Global error:", message, error);
  showToast("S'ha produ√Øt un error. Torna-ho a provar.", "error");
  return false;
};

        </script>
        

        
        <script>
        // Custom Catalan validation messages for all form inputs
(function () {
  function setCustomValidationMessages(input) {
    input.addEventListener("invalid", function (e) {
      e.target.setCustomValidity("");
      if (!e.target.validity.valid) {
        if (e.target.validity.valueMissing) {
          e.target.setCustomValidity("Aquest camp √©s obligatori.");
        } else if (e.target.validity.typeMismatch) {
          if (e.target.type === "email") {
            e.target.setCustomValidity(
              "Introdueix una adre√ßa de correu electr√≤nic v√†lida.",
            );
          } else if (e.target.type === "url") {
            e.target.setCustomValidity("Introdueix una URL v√†lida.");
          } else {
            e.target.setCustomValidity("El format no √©s v√†lid.");
          }
        } else if (e.target.validity.tooShort) {
          e.target.setCustomValidity(
            "M√≠nim " + e.target.minLength + " car√†cters.",
          );
        } else if (e.target.validity.tooLong) {
          e.target.setCustomValidity(
            "M√†xim " + e.target.maxLength + " car√†cters.",
          );
        } else if (e.target.validity.rangeUnderflow) {
          e.target.setCustomValidity(
            "El valor ha de ser " + e.target.min + " o superior.",
          );
        } else if (e.target.validity.rangeOverflow) {
          e.target.setCustomValidity(
            "El valor ha de ser " + e.target.max + " o inferior.",
          );
        } else if (e.target.validity.patternMismatch) {
          e.target.setCustomValidity(
            e.target.title || "El format no √©s v√†lid.",
          );
        } else if (e.target.validity.stepMismatch) {
          e.target.setCustomValidity("El valor no √©s v√†lid.");
        } else if (e.target.validity.badInput) {
          e.target.setCustomValidity("Introdueix un valor v√†lid.");
        }
      }
    });

    input.addEventListener("input", function (e) {
      e.target.setCustomValidity("");
    });
  }

  function initValidationMessages() {
    var inputs = document.querySelectorAll("input, select, textarea");
    inputs.forEach(setCustomValidationMessages);
  }

  // Initialize on DOM ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initValidationMessages);
  } else {
    initValidationMessages();
  }

  // Also observe for dynamically added inputs
  var observer = new MutationObserver(function (mutations) {
    mutations.forEach(function (mutation) {
      mutation.addedNodes.forEach(function (node) {
        if (node.nodeType === 1) {
          if (node.matches && node.matches("input, select, textarea")) {
            setCustomValidationMessages(node);
          }
          var childInputs =
            node.querySelectorAll &&
            node.querySelectorAll("input, select, textarea");
          if (childInputs) {
            childInputs.forEach(setCustomValidationMessages);
          }
        }
      });
    });
  });

  observer.observe(document.body || document.documentElement, {
    childList: true,
    subtree: true,
  });
})();

        </script>
        

        
        <script>
        // Button click visual feedback with ripple effect
(function () {
  "use strict";

  // Add ripple effect to buttons on click
  function createRipple(event) {
    const button = event.currentTarget;

    // Skip if button is disabled
    if (button.disabled) return;

    // Create ripple element
    const ripple = document.createElement("span");
    ripple.className = "btn-ripple";

    // Calculate ripple size and position
    const rect = button.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);
    const x = event.clientX - rect.left - size / 2;
    const y = event.clientY - rect.top - size / 2;

    ripple.style.width = ripple.style.height = size + "px";
    ripple.style.left = x + "px";
    ripple.style.top = y + "px";

    // Add ripple to button
    button.appendChild(ripple);

    // Remove ripple after animation completes
    ripple.addEventListener("animationend", function () {
      ripple.remove();
    });
  }

  // Apply ripple effect to all buttons
  function initButtonFeedback() {
    const buttons = document.querySelectorAll(
      'button, .btn, [role="button"], .dance-chip, .event-card-btn, .collapsible-toggle, .refresh-event-btn',
    );

    buttons.forEach(function (button) {
      // Skip if already initialized
      if (button.dataset.rippleInit) return;
      button.dataset.rippleInit = "true";

      // Ensure button has relative positioning for ripple
      const computedStyle = window.getComputedStyle(button);
      if (computedStyle.position === "static") {
        button.style.position = "relative";
      }
      button.style.overflow = "hidden";

      button.addEventListener("click", createRipple);
    });
  }

  // Initialize on DOM ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initButtonFeedback);
  } else {
    initButtonFeedback();
  }

  // Also observe for dynamically added buttons
  var observer = new MutationObserver(function (mutations) {
    var shouldInit = false;
    mutations.forEach(function (mutation) {
      if (mutation.addedNodes.length > 0) {
        shouldInit = true;
      }
    });
    if (shouldInit) {
      initButtonFeedback();
    }
  });

  observer.observe(document.body || document.documentElement, {
    childList: true,
    subtree: true,
  });
})();

        </script>
        
    </body>
</html>